---
title: 数据冷热分离详解
description: 本文详解数据冷热分离的核心原理与实践方案，涵盖冷热数据的判定策略（时间维度/访问频率）、三种主流迁移方案对比（任务调度/Binlog监听）、冷数据存储选型（HBase/TiDB/对象存储），以及 TiDB Placement Rules 实现自动化冷热分离。
category: 高性能
head:
  - - meta
    - name: keywords
      content: 数据冷热分离,冷数据迁移,冷数据存储,分层存储,TiDB冷热分离,HBase,数据归档,存储成本优化
---

## 什么是数据冷热分离？

数据冷热分离是指根据数据的**访问频率**和**业务重要性**，将数据划分为冷数据和热数据，并分别存储在不同性能和成本的存储介质中的架构策略。

这种架构的核心目标有三个：

1. **提升查询性能**：热数据存储在高性能介质（如 SSD、内存）中，保障核心业务的响应速度。
2. **降低存储成本**：冷数据迁移至低成本介质（如 HDD、对象存储），大幅削减存储开支。
3. **满足合规要求**：部分行业（如金融、医疗）要求数据长期归档，冷热分离可兼顾合规与成本。

### 冷数据和热数据

**热数据**是指被频繁访问和修改、且需要快速响应的数据；**冷数据**是指访问频率极低、对当前业务价值较小、但需要长期保留的数据。

冷热数据的区分方法主要有两种：

1. **时间维度区分**：按照数据的创建时间、更新时间或过期时间划分。例如，订单系统将 **1 年前**的订单数据标记为冷数据，1 年内的订单数据作为热数据。该方法适用于**数据访问频率与时间强相关**的场景，实现简单、成本低。
2. **访问频率区分**：将高频访问的数据视为热数据，低频访问的数据视为冷数据。例如，内容系统将**浏览量低于阈值**的文章标记为冷数据。该方法需要额外记录访问频率，适用于**访问频率与数据本身特性强相关**的场景。

**如何选择区分策略？**

- 若业务数据天然具有时效性（如订单、日志、账单），优先选择**时间维度**，实现成本最低。
- 若数据价值与时间无关（如文章、商品、用户画像），需结合**访问频率**进行判定。
- 实际项目中，可将两者结合使用：以时间维度为主、访问频率为辅，覆盖更多业务场景。

### 冷热分离的思想

冷热分离的核心思想是**分层存储（Tiered Storage）**，根据数据的访问特性将其分配到不同层级的存储介质中。在企业级存储架构中，通常划分为以下层级：

| 层级                  | 数据特性           | 典型存储介质         | 访问延迟    |
| --------------------- | ------------------ | -------------------- | ----------- |
| **Hot（热层）**       | 高频访问、实时响应 | NVMe SSD、内存       | 毫秒级      |
| **Warm（温层）**      | 中频访问、近期数据 | SATA SSD、高速 HDD   | 百毫秒级    |
| **Cold（冷层）**      | 低频访问、历史数据 | 大容量 HDD、对象存储 | 秒级        |
| **Archive（归档层）** | 极少访问、合规留存 | 磁带库、冰川存储     | 分钟~小时级 |

这种分层思想在 IT 基础设施中被广泛应用，不仅限于数据库，还包括文件系统、对象存储、CDN 缓存等场景。

### 数据冷热分离的优缺点

**优点：**

- **热数据查询性能优化**：热数据集中在高性能存储上，表数据量大幅减少，索引效率显著提升，用户的绝大部分操作体验会更好。
- **存储成本大幅降低**：冷数据可迁移至 HDD 或对象存储，**SSD 与 HDD 的单位成本差距可达 5~10 倍**，对于海量数据场景节省效果显著。
- **系统可维护性增强**：热库数据量可控，备份恢复速度更快，DDL 操作（如加索引）耗时更短。

**缺点：**

- **系统复杂性增加**：需要额外的迁移组件、路由逻辑和监控体系，数据一致性风险增加。
- **跨库查询效率低**：若业务需要同时查询冷热数据（如年度统计报表），需进行跨库关联或数据聚合，查询性能和开发成本均会上升。
- **迁移策略维护成本**：冷热数据的判定规则需要持续调优，避免误判导致热数据被错误迁移。

## 冷数据如何迁移？

冷数据迁移是冷热分离的核心环节，主流方案有以下三种：

| 方案                | 实现原理                                 | 优点                   | 缺点                                         | 适用场景                     |
| ------------------- | ---------------------------------------- | ---------------------- | -------------------------------------------- | ---------------------------- |
| **业务层代码实现**  | 写操作时判断冷热，直接路由到对应库       | 实时性高               | 侵入业务代码、判定逻辑复杂                   | 几乎不使用                   |
| **任务调度迁移**    | 定时任务扫描热库，批量迁移符合条件的数据 | 实现简单、对业务无侵入 | 存在迁移延迟、扫描大表有性能压力             | **时间维度区分场景（推荐）** |
| **Binlog 监听迁移** | 监听数据库变更日志，实时或准实时迁移     | 实时性好、对业务无侵入 | 需要额外组件（如 Canal）、不适合时间维度判定 | 访问频率区分场景             |

**任务调度迁移**是最常用的方案，可借助 XXL-Job、Elastic-Job 等分布式任务调度平台实现。关于任务调度的方案，我也写过文章详细介绍，可以查看这篇文章：[Java 定时任务详解](https://javaguide.cn/system-design/schedule-task.html) 。

典型流程如下：

![冷热分离 - 冷数据迁移](https://oss.javaguide.cn/github/javaguide/high-performance/data-cold-hot-separation.png)

> **实践建议**：若公司有 DBA 支持，可先进行一次**存量冷数据的人工迁移**，将历史数据批量导入冷库；后续再通过任务调度实现**增量迁移**的自动化。

## 冷数据如何存储？

冷数据存储方案的选型原则是：**容量大、成本低、可靠性高，访问速度可适当牺牲**。

### 中小厂方案

直接使用 **MySQL/PostgreSQL** 即可，保持与热库相同的数据库类型，降低运维复杂度。具体实现方式：

- **同库分表**：在同一数据库中新增冷数据表（如 `order_history`），通过表名区分冷热数据。
- **独立冷库**：部署单独的数据库实例作为冷库，热库与冷库通过应用层路由访问。

> **注意**：独立冷库方案涉及**跨库查询**，若业务存在冷热数据联合查询需求，需评估是否引入数据同步或聚合层。

### 大厂方案

大厂通常采用专门针对海量数据优化的存储引擎：

| 存储方案               | 特点                             | 适用场景                         |
| ---------------------- | -------------------------------- | -------------------------------- |
| **HBase**              | 列式存储、高吞吐、支持 PB 级数据 | 日志、用户行为、IoT 数据归档     |
| **RocksDB**            | 高性能 KV 存储、LSM-Tree 结构    | 嵌入式场景、作为其他系统底层存储 |
| **Doris/ClickHouse**   | OLAP 引擎、支持实时分析          | 冷数据需要进行聚合分析的场景     |
| **Cassandra**          | 分布式、高可用、无单点故障       | 跨地域部署、高可用要求的归档场景 |
| **对象存储（OSS/S3）** | 成本极低、无限扩展               | 超大规模冷数据、合规归档         |

### TiDB 方案（推荐）

如果公司技术栈允许，可以直接使用 **TiDB** 这类分布式关系型数据库，原生支持冷热分离，一步到位。

TiDB 6.0 引入了 **基于 SQL 接口的数据放置框架（Placement Rules in SQL）** 功能，用于通过 SQL 接口配置数据在 TiKV 集群中的放置位置。

- **热数据**：通过 Placement Rules 指定存储在 **SSD 节点**上，保障查询性能。
- **冷数据**：指定存储在 **HDD 节点**上，降低存储成本。

```sql
-- 创建放置策略：热数据存储在 SSD 节点
CREATE PLACEMENT POLICY hot_data
  CONSTRAINTS="[+disk=ssd]";

-- 创建放置策略：冷数据存储在 HDD 节点
CREATE PLACEMENT POLICY cold_data
  CONSTRAINTS="[+disk=hdd]";

-- 对表或分区应用放置策略
ALTER TABLE orders PLACEMENT POLICY = hot_data;
ALTER TABLE orders PARTITION p2022 PLACEMENT POLICY = cold_data;
```

这种方案的优势在于：**业务无需感知冷热分离逻辑**，数据路由由 TiDB 自动完成，大幅降低了应用层的复杂度。

## 案例分享

- [如何快速优化几千万数据量的订单表 - 程序员济癫 - 2023](https://www.cnblogs.com/fulongyuanjushi/p/17910420.html)
- [海量数据冷热分离方案与实践 - 字节跳动技术团队 - 2022](https://mp.weixin.qq.com/s/ZKRkZP6rLHuTE1wvnqmAPQ)

<!-- @include: @article-footer.snippet.md -->
