---
title: Rediså¸¸è§é¢è¯•é¢˜æ€»ç»“(ä¸Š)
category: æ•°æ®åº“
tag:
  - Redis
head:
  - - meta
    - name: keywords
      content: RedisåŸºç¡€,Rediså¸¸è§æ•°æ®ç»“æ„,Redisçº¿ç¨‹æ¨¡å‹,Rediså†…å­˜ç®¡ç†,Redisäº‹åŠ¡,Redisæ€§èƒ½ä¼˜åŒ–
  - - meta
    - name: description
      content: ä¸€ç¯‡æ–‡ç« æ€»ç»“Rediså¸¸è§çš„çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜ï¼Œæ¶µç›–RedisåŸºç¡€ã€Rediså¸¸è§æ•°æ®ç»“æ„ã€Redisçº¿ç¨‹æ¨¡å‹ã€Rediså†…å­˜ç®¡ç†ã€Redisäº‹åŠ¡ã€Redisæ€§èƒ½ä¼˜åŒ–ç­‰å†…å®¹ã€‚
---

## Redis åŸºç¡€

### ä»€ä¹ˆæ˜¯ Redisï¼Ÿ

[Redis](https://redis.io/) æ˜¯ä¸€ä¸ªåŸºäº C è¯­è¨€å¼€å‘çš„å¼€æºæ•°æ®åº“ï¼ˆBSD è®¸å¯ï¼‰ï¼Œä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ Redis çš„æ•°æ®æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ï¼ˆå†…å­˜æ•°æ®åº“ï¼‰ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜æ–¹å‘ã€‚å¹¶ä¸”ï¼ŒRedis å­˜å‚¨çš„æ˜¯ KV é”®å€¼å¯¹æ•°æ®ã€‚

ä¸ºäº†æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒRedis å†…ç½®äº†å¤šç§æ•°æ®ç±»å‹å®ç°ï¼ˆæ¯”å¦‚ Stringã€Hashã€Sorted Setã€Bitmapï¼‰ã€‚å¹¶ä¸”ï¼ŒRedis è¿˜æ”¯æŒäº‹åŠ¡ ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å¤šç§å¼€ç®±å³ç”¨çš„é›†ç¾¤æ–¹æ¡ˆï¼ˆRedis Sentinelã€Redis Clusterï¼‰ã€‚

Redis æ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼ŒLinux å’Œ OS X æ˜¯ Redis å¼€å‘å’Œæµ‹è¯•æœ€å¤šçš„ä¸¤ä¸ªæ“ä½œç³»ç»Ÿï¼Œå®˜æ–¹æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Linux éƒ¨ç½² Redisã€‚

ä¸ªäººå­¦ä¹ çš„è¯ï¼Œä½ å¯ä»¥è‡ªå·±æœ¬æœºå®‰è£… Redis æˆ–è€…é€šè¿‡ Redis å®˜ç½‘æä¾›çš„[åœ¨çº¿ Redis ç¯å¢ƒ](https://try.redis.io/)æ¥å®é™…ä½“éªŒ Redisã€‚

![try-redis](https://oss.javaguide.cn/github/javaguide/database/redis/try.redis.io.png)

å…¨ä¸–ç•Œæœ‰éå¸¸å¤šçš„ç½‘ç«™ä½¿ç”¨åˆ°äº† Redis ï¼Œ[techstacks.io](https://techstacks.io/) ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª[ä½¿ç”¨ Redis çš„çƒ­é—¨ç«™ç‚¹åˆ—è¡¨](https://techstacks.io/tech/redis) ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹ã€‚

### Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ

Redis å†…éƒ¨åšäº†éå¸¸å¤šçš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸»è¦æœ‰ä¸‹é¢ 3 ç‚¹ï¼š

- Redis åŸºäºå†…å­˜ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦æ˜¯ç£ç›˜çš„ä¸Šåƒå€ï¼›
- Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹ï¼Œä¸»è¦æ˜¯å•çº¿ç¨‹äº‹ä»¶å¾ªç¯å’Œ IO å¤šè·¯å¤ç”¨ï¼ˆRedis çº¿ç¨‹æ¨¡å¼åé¢ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰ï¼›
- Redis å†…ç½®äº†å¤šç§ä¼˜åŒ–è¿‡åçš„æ•°æ®ç»“æ„å®ç°ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚

ä¸‹é¢è¿™å¼ å›¾ç‰‡æ€»ç»“çš„æŒºä¸é”™çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼Œå‡ºè‡ª [Why is Redis so fast?](https://twitter.com/alexxubyte/status/1498703822528544770) ã€‚

![why-redis-so-fast](./images/why-redis-so-fast.png)

### åˆ†å¸ƒå¼ç¼“å­˜å¸¸è§çš„æŠ€æœ¯é€‰å‹æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ

åˆ†å¸ƒå¼ç¼“å­˜çš„è¯ï¼Œæ¯”è¾ƒè€ç‰ŒåŒæ—¶ä¹Ÿæ˜¯ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„è¿˜æ˜¯ **Memcached** å’Œ **Redis**ã€‚ä¸è¿‡ï¼Œç°åœ¨åŸºæœ¬æ²¡æœ‰çœ‹è¿‡è¿˜æœ‰é¡¹ç›®ä½¿ç”¨ **Memcached** æ¥åšç¼“å­˜ï¼Œéƒ½æ˜¯ç›´æ¥ç”¨ **Redis**ã€‚

Memcached æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æœ€å¼€å§‹å…´èµ·çš„é‚£ä¼šï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ã€‚åæ¥ï¼Œéšç€ Redis çš„å‘å±•ï¼Œå¤§å®¶æ…¢æ…¢éƒ½è½¬è€Œä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ Redis äº†ã€‚

å¦å¤–ï¼Œè…¾è®¯ä¹Ÿå¼€æºäº†ä¸€æ¬¾ç±»ä¼¼äº Redis çš„åˆ†å¸ƒå¼é«˜æ€§èƒ½ KV å­˜å‚¨æ•°æ®åº“ï¼ŒåŸºäºçŸ¥åçš„å¼€æºé¡¹ç›® [RocksDB](https://github.com/facebook/rocksdb) ä½œä¸ºå­˜å‚¨å¼•æ“ ï¼Œ100% å…¼å®¹ Redis åè®®å’Œ Redis4.0 æ‰€æœ‰æ•°æ®æ¨¡å‹ï¼Œåä¸º [Tendis](https://github.com/Tencent/Tendis)ã€‚

å…³äº Redis å’Œ Tendis çš„å¯¹æ¯”ï¼Œè…¾è®¯å®˜æ–¹æ›¾ç»å‘è¿‡ä¸€ç¯‡æ–‡ç« ï¼š[Redis vs Tendisï¼šå†·çƒ­æ··åˆå­˜å‚¨ç‰ˆæ¶æ„æ­ç§˜](https://mp.weixin.qq.com/s/MeYkfOIdnU6LYlsGb24KjQ) ï¼Œå¯ä»¥ç®€å•å‚è€ƒä¸€ä¸‹ã€‚

ä»è¿™ä¸ªé¡¹ç›®çš„ Github æäº¤è®°å½•å¯ä»¥çœ‹å‡ºï¼ŒTendis å¼€æºç‰ˆå‡ ä¹å·²ç»æ²¡æœ‰è¢«ç»´æŠ¤æ›´æ–°äº†ï¼ŒåŠ ä¸Šå…¶å…³æ³¨åº¦å¹¶ä¸é«˜ï¼Œä½¿ç”¨çš„å…¬å¸ä¹Ÿæ¯”è¾ƒå°‘ã€‚å› æ­¤ï¼Œä¸å»ºè®®ä½ ä½¿ç”¨ Tendis æ¥å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€‚

### è¯´ä¸€ä¸‹ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹

ç°åœ¨å…¬å¸ä¸€èˆ¬éƒ½æ˜¯ç”¨ Redis æ¥å®ç°ç¼“å­˜ï¼Œè€Œä¸” Redis è‡ªèº«ä¹Ÿè¶Šæ¥è¶Šå¼ºå¤§äº†ï¼ä¸è¿‡ï¼Œäº†è§£ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨åšç›¸åº”çš„æŠ€æœ¯é€‰å‹çš„æ—¶å€™ï¼Œèƒ½å¤Ÿåšåˆ°æœ‰ç†æœ‰æ®ï¼

**å…±åŒç‚¹** ï¼š

1. éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“åšç¼“å­˜ä½¿ç”¨ã€‚
2. éƒ½æœ‰è¿‡æœŸç­–ç•¥ã€‚
3. ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚

**åŒºåˆ«** ï¼š

1. **Redis æ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼‰**ã€‚Redis ä¸ä»…ä»…æ”¯æŒç®€å•çš„ k/v ç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾› listï¼Œsetï¼Œzsetï¼Œhash ç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚Memcached åªæ”¯æŒæœ€ç®€å•çš„ k/v æ•°æ®ç±»å‹ã€‚
2. **Redis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨,è€Œ Memcached æŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ã€‚**
3. **Redis æœ‰ç¾éš¾æ¢å¤æœºåˆ¶ã€‚** å› ä¸ºå¯ä»¥æŠŠç¼“å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚
4. **Redis åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå¯ä»¥å°†ä¸ç”¨çš„æ•°æ®æ”¾åˆ°ç£ç›˜ä¸Šã€‚ä½†æ˜¯ï¼ŒMemcached åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå°±ä¼šç›´æ¥æŠ¥å¼‚å¸¸ã€‚**
5. **Memcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›ä½†æ˜¯ Redis ç›®å‰æ˜¯åŸç”Ÿæ”¯æŒ cluster æ¨¡å¼çš„ã€‚**
6. **Memcached æ˜¯å¤šçº¿ç¨‹ï¼Œéé˜»å¡ IO å¤ç”¨çš„ç½‘ç»œæ¨¡å‹ï¼›Redis ä½¿ç”¨å•çº¿ç¨‹çš„å¤šè·¯ IO å¤ç”¨æ¨¡å‹ã€‚** ï¼ˆRedis 6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ IO ï¼‰
7. **Redis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒã€‚å¹¶ä¸”ï¼ŒRedis æ”¯æŒæ›´å¤šçš„ç¼–ç¨‹è¯­è¨€ã€‚**
8. **Memcached è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥åªç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œè€Œ Redis åŒæ—¶ä½¿ç”¨äº†æƒ°æ€§åˆ é™¤ä¸å®šæœŸåˆ é™¤ã€‚**

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„å¯¹æ¯”ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰ä»€ä¹ˆç†ç”±å¯ä»¥é€‰æ‹©ä½¿ç”¨ Memcached æ¥ä½œä¸ºè‡ªå·±é¡¹ç›®çš„åˆ†å¸ƒå¼ç¼“å­˜äº†ã€‚

### ä¸ºä»€ä¹ˆè¦ç”¨ Redis/ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ

ä¸‹é¢æˆ‘ä»¬ä¸»è¦ä»â€œé«˜æ€§èƒ½â€å’Œâ€œé«˜å¹¶å‘â€è¿™ä¸¤ç‚¹æ¥å›ç­”è¿™ä¸ªé—®é¢˜ã€‚

**é«˜æ€§èƒ½**

å‡å¦‚ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ•°æ®åº“ä¸­çš„æŸäº›æ•°æ®çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ…¢ï¼Œæ¯•ç«Ÿæ˜¯ä»ç¡¬ç›˜ä¸­è¯»å–çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¯´ï¼Œç”¨æˆ·è®¿é—®çš„æ•°æ®å±äºé«˜é¢‘æ•°æ®å¹¶ä¸”ä¸ä¼šç»å¸¸æ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¾ˆæ”¾å¿ƒåœ°å°†è¯¥ç”¨æˆ·è®¿é—®çš„æ•°æ®å­˜åœ¨ç¼“å­˜ä¸­ã€‚

**è¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ** é‚£å°±æ˜¯ä¿è¯ç”¨æˆ·ä¸‹ä¸€æ¬¡å†è®¿é—®è¿™äº›æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–äº†ã€‚æ“ä½œç¼“å­˜å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“å¿«ã€‚

**é«˜å¹¶å‘**

ä¸€èˆ¬åƒ MySQL è¿™ç±»çš„æ•°æ®åº“çš„ QPS å¤§æ¦‚éƒ½åœ¨ 1w å·¦å³ï¼ˆ4 æ ¸ 8gï¼‰ ï¼Œä½†æ˜¯ä½¿ç”¨ Redis ç¼“å­˜ä¹‹åå¾ˆå®¹æ˜“è¾¾åˆ° 10w+ï¼Œç”šè‡³æœ€é«˜èƒ½è¾¾åˆ° 30w+ï¼ˆå°±å•æœº Redis çš„æƒ…å†µï¼ŒRedis é›†ç¾¤çš„è¯ä¼šæ›´é«˜ï¼‰ã€‚

> QPSï¼ˆQuery Per Secondï¼‰ï¼šæœåŠ¡å™¨æ¯ç§’å¯ä»¥æ‰§è¡Œçš„æŸ¥è¯¢æ¬¡æ•°ï¼›

ç”±æ­¤å¯è§ï¼Œç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„æ•°æ®åº“è¯·æ±‚æ•°é‡æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚è¿›è€Œï¼Œæˆ‘ä»¬ä¹Ÿå°±æé«˜äº†ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘ã€‚

### å¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å…³äºå¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[3 ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£](https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html) ã€‚

## Redis åº”ç”¨

### Redis é™¤äº†åšç¼“å­˜ï¼Œè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ

- **åˆ†å¸ƒå¼é”** ï¼š é€šè¿‡ Redis æ¥åšåˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŸºäº Redisson æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock.html) ã€‚
- **é™æµ** ï¼šä¸€èˆ¬æ˜¯é€šè¿‡ Redis + Lua è„šæœ¬çš„æ–¹å¼æ¥å®ç°é™æµã€‚ç›¸å…³é˜…è¯»ï¼š[ã€Šæˆ‘å¸ç”¨äº† 6 å¹´çš„ Redis åˆ†å¸ƒå¼é™æµå™¨ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸å‰å®³äº†ï¼ã€‹](https://mp.weixin.qq.com/s/kyFAWH3mVNJvurQDt4vchA)ã€‚
- **æ¶ˆæ¯é˜Ÿåˆ—** ï¼šRedis è‡ªå¸¦çš„ list æ•°æ®ç»“æ„å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ä½¿ç”¨ã€‚Redis 5.0 ä¸­å¢åŠ çš„ Stream ç±»å‹çš„æ•°æ®ç»“æ„æ›´åŠ é€‚åˆç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒæ¯”è¾ƒç±»ä¼¼äº Kafkaï¼Œæœ‰ä¸»é¢˜å’Œæ¶ˆè´¹ç»„çš„æ¦‚å¿µï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠ ACK æœºåˆ¶ã€‚
- **å¤æ‚ä¸šåŠ¡åœºæ™¯** ï¼šé€šè¿‡ Redis ä»¥åŠ Redis æ‰©å±•ï¼ˆæ¯”å¦‚ Redissonï¼‰æä¾›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå¾ˆå¤šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯æ¯”å¦‚é€šè¿‡ bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ã€é€šè¿‡ sorted set ç»´æŠ¤æ’è¡Œæ¦œã€‚
- ......

### å¦‚ä½•åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ

å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock.html) ã€‚

### Redis å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ä¹ˆï¼Ÿ

> å®é™…é¡¹ç›®ä¸­ä¹Ÿæ²¡è§è°ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¹äºè¿™éƒ¨åˆ†çŸ¥è¯†ç‚¹å¤§å®¶äº†è§£å°±å¥½äº†ã€‚

**Redis 2.0 ä¹‹å‰ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œåªèƒ½é€šè¿‡ List æ¥å®ç°ã€‚**

é€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP`å³å¯å®ç°ç®€æ˜“ç‰ˆæ¶ˆæ¯é˜Ÿåˆ— ï¼š

```bash
# ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯
> RPUSH myList msg1 msg2
(integer) 2
> RPUSH myList msg3
(integer) 3
# æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯
> LPOP myList
"msg1"
```

ä¸è¿‡ï¼Œé€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP`è¿™æ ·çš„æ–¹å¼å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­è½®è¯¢å»è°ƒç”¨ `RPOP` æˆ– `LPOP` æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚å½“ List ä¸ºç©ºæ—¶ï¼Œå¤§éƒ¨åˆ†çš„è½®è¯¢çš„è¯·æ±‚éƒ½æ˜¯æ— æ•ˆè¯·æ±‚ï¼Œè¿™ç§æ–¹å¼å¤§é‡æµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚

å› æ­¤ï¼ŒRedis è¿˜æä¾›äº† `BLPOP`ã€`BRPOP` è¿™ç§é˜»å¡å¼è¯»å–çš„å‘½ä»¤ï¼ˆå¸¦ B-Bloking çš„éƒ½æ˜¯é˜»å¡å¼ï¼‰ï¼Œå¹¶ä¸”è¿˜æ”¯æŒä¸€ä¸ªè¶…æ—¶å‚æ•°ã€‚å¦‚æœ List ä¸ºç©ºï¼ŒRedis æœåŠ¡ç«¯ä¸ä¼šç«‹åˆ»è¿”å›ç»“æœï¼Œå®ƒä¼šç­‰å¾… List ä¸­æœ‰æ–°æ•°æ®ååœ¨è¿”å›æˆ–è€…æ˜¯ç­‰å¾…æœ€å¤šä¸€ä¸ªè¶…æ—¶æ—¶é—´åè¿”å›ç©ºã€‚å¦‚æœå°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 0 æ—¶ï¼Œå³å¯æ— é™ç­‰å¾…ï¼Œç›´åˆ°å¼¹å‡ºæ¶ˆæ¯

```bash
# è¶…æ—¶æ—¶é—´ä¸º 10s
# å¦‚æœæœ‰æ•°æ®ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™æœ€å¤šç­‰å¾…10ç§’
> BRPOP myList 10
null
```

**List å®ç°æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½å¤ªç®€å•ï¼Œåƒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ç­‰åŠŸèƒ½è¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæœ€è¦å‘½çš„æ˜¯æ²¡æœ‰å¹¿æ’­æœºåˆ¶ï¼Œæ¶ˆæ¯ä¹Ÿåªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚**

**Redis 2.0 å¼•å…¥äº† å‘å¸ƒè®¢é˜… (pub/sub) è§£å†³äº† List å®ç°æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰å¹¿æ’­æœºåˆ¶çš„é—®é¢˜ã€‚**

pub/sub ä¸­å¼•å…¥äº†ä¸€ä¸ªæ¦‚å¿µå« channelï¼ˆé¢‘é“ï¼‰ï¼Œå‘å¸ƒè®¢é˜…æœºåˆ¶çš„å®ç°å°±æ˜¯åŸºäºè¿™ä¸ª channel æ¥åšçš„ã€‚

pub/sub æ¶‰åŠå‘å¸ƒè€…å’Œè®¢é˜…è€…ï¼ˆä¹Ÿå«æ¶ˆè´¹è€…ï¼‰ä¸¤ä¸ªè§’è‰²ï¼š

- å‘å¸ƒè€…é€šè¿‡ `PUBLISH` æŠ•é€’æ¶ˆæ¯ç»™æŒ‡å®š channelã€‚
- è®¢é˜…è€…é€šè¿‡`SUBSCRIBE`è®¢é˜…å®ƒå…³å¿ƒçš„ channelã€‚å¹¶ä¸”ï¼Œè®¢é˜…è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ª channelã€‚

æˆ‘ä»¬è¿™é‡Œå¯åŠ¨ 3 ä¸ª Redis å®¢æˆ·ç«¯æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼š

![pub/sub å®ç°æ¶ˆæ¯é˜Ÿåˆ—æ¼”ç¤º](https://oss.javaguide.cn/github/javaguide/database/redis/redis-pubsub-message-queue.png)

pub/sub æ—¢èƒ½å•æ’­åˆèƒ½å¹¿æ’­ï¼Œè¿˜æ”¯æŒ channel çš„ç®€å•æ­£åˆ™åŒ¹é…ã€‚ä¸è¿‡ï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼ˆå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æˆ–è€… Redis å®•æœºéƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼‰ã€æ¶ˆæ¯å †ç§¯ï¼ˆå‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™ä¸ä¼šç®¡æ¶ˆè´¹è€…çš„å…·ä½“æ¶ˆè´¹èƒ½åŠ›å¦‚ä½•ï¼‰ç­‰é—®é¢˜ä¾ç„¶æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³åŠæ³•ã€‚

ä¸ºæ­¤ï¼ŒRedis 5.0 æ–°å¢åŠ çš„ä¸€ä¸ªæ•°æ®ç»“æ„ `Stream` æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚`Stream` æ”¯æŒï¼š

- å‘å¸ƒ / è®¢é˜…æ¨¡å¼
- æŒ‰ç…§æ¶ˆè´¹è€…ç»„è¿›è¡Œæ¶ˆè´¹
- æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆ RDB å’Œ AOFï¼‰

`Stream` ä½¿ç”¨èµ·æ¥ç›¸å¯¹è¦éº»çƒ¦ä¸€äº›ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚è€Œä¸”ï¼Œ`Stream` åœ¨å®é™…ä½¿ç”¨ä¸­ä¾ç„¶ä¼šæœ‰ä¸€äº›å°é—®é¢˜ä¸å¤ªå¥½è§£å†³æ¯”å¦‚åœ¨ Redis å‘ç”Ÿæ•…éšœæ¢å¤åä¸èƒ½ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚

ç»¼ä¸Šï¼Œå’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œä½¿ç”¨ Redis æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹æ¯”å¦‚æ¶ˆæ¯ä¸¢å¤±å’Œå †ç§¯é—®é¢˜ä¸å¥½è§£å†³ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä¸è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½ å®Œå…¨å¯ä»¥é€‰æ‹©å¸‚é¢ä¸Šæ¯”è¾ƒæˆç†Ÿçš„ä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—æ¯”å¦‚ RocketMQã€Kafkaã€‚

ç›¸å…³é˜…è¯»ï¼š[Redis æ¶ˆæ¯é˜Ÿåˆ—å‘å±•å†ç¨‹ - é˜¿é‡Œå¼€å‘è€… - 2022](https://mp.weixin.qq.com/s/gCUT5TcCQRAxYkTJfTRjJw)ã€‚

## Redis æ•°æ®ç»“æ„

> å…³äº Redis 5 ç§åŸºç¡€æ•°æ®ç»“æ„å’Œ 3 ç§ç‰¹æ®Šæ•°æ®ç»“æ„çš„è¯¦ç»†ä»‹ç»è¯·çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ï¼š
>
> - [Redis 5 ç§åŸºæœ¬æ•°æ®ç»“æ„è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)
> - [Redis 3 ç§ç‰¹æ®Šæ•°æ®ç»“æ„è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-02.html)

### Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿ

- **5 ç§åŸºç¡€æ•°æ®ç»“æ„** ï¼šStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚
- **3 ç§ç‰¹æ®Šæ•°æ®ç»“æ„** ï¼šHyperLogLogsï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰ã€Bitmap ï¼ˆä½å­˜å‚¨ï¼‰ã€Geospatial (åœ°ç†ä½ç½®)ã€‚

### String çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

- å¸¸è§„æ•°æ®ï¼ˆæ¯”å¦‚ sessionã€tokenã€ã€åºåˆ—åŒ–åçš„å¯¹è±¡ï¼‰çš„ç¼“å­˜ï¼›
- è®¡æ•°æ¯”å¦‚ç”¨æˆ·å•ä½æ—¶é—´çš„è¯·æ±‚æ•°ï¼ˆç®€å•é™æµå¯ä»¥ç”¨åˆ°ï¼‰ã€é¡µé¢å•ä½æ—¶é—´çš„è®¿é—®æ•°ï¼›
- åˆ†å¸ƒå¼é”(åˆ©ç”¨ `SETNX key value` å‘½ä»¤å¯ä»¥å®ç°ä¸€ä¸ªæœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”)ï¼›
- ......

å…³äº String çš„è¯¦ç»†ä»‹ç»è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Redis 5 ç§åŸºæœ¬æ•°æ®ç»“æ„è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)ã€‚

### String è¿˜æ˜¯ Hash å­˜å‚¨å¯¹è±¡æ•°æ®æ›´å¥½å‘¢ï¼Ÿ

- String å­˜å‚¨çš„æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡æ•°æ®ï¼Œå­˜æ”¾çš„æ˜¯æ•´ä¸ªå¯¹è±¡ã€‚Hash æ˜¯å¯¹å¯¹è±¡çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ï¼Œå¯ä»¥è·å–éƒ¨åˆ†å­—æ®µçš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…æ·»åŠ éƒ¨åˆ†å­—æ®µï¼ŒèŠ‚çœç½‘ç»œæµé‡ã€‚å¦‚æœå¯¹è±¡ä¸­æŸäº›å­—æ®µéœ€è¦ç»å¸¸å˜åŠ¨æˆ–è€…ç»å¸¸éœ€è¦å•ç‹¬æŸ¥è¯¢å¯¹è±¡ä¸­çš„ä¸ªåˆ«å­—æ®µä¿¡æ¯ï¼ŒHash å°±éå¸¸é€‚åˆã€‚
- String å­˜å‚¨ç›¸å¯¹æ¥è¯´æ›´åŠ èŠ‚çœå†…å­˜ï¼Œç¼“å­˜ç›¸åŒæ•°é‡çš„å¯¹è±¡æ•°æ®ï¼ŒString æ¶ˆè€—çš„å†…å­˜çº¦æ˜¯ Hash çš„ä¸€åŠã€‚å¹¶ä¸”ï¼Œå­˜å‚¨å…·æœ‰å¤šå±‚åµŒå¥—çš„å¯¹è±¡æ—¶ä¹Ÿæ–¹ä¾¿å¾ˆå¤šã€‚å¦‚æœç³»ç»Ÿå¯¹æ€§èƒ½å’Œèµ„æºæ¶ˆè€—éå¸¸æ•æ„Ÿçš„è¯ï¼ŒString å°±éå¸¸é€‚åˆã€‚

åœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ String æ¥å­˜å‚¨å¯¹è±¡æ•°æ®å³å¯ï¼

### String çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ

Redis æ˜¯åŸºäº C è¯­è¨€ç¼–å†™çš„ï¼Œä½† Redis çš„ String ç±»å‹çš„åº•å±‚å®ç°å¹¶ä¸æ˜¯ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ç©ºå­—ç¬¦ `\0` ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œè€Œæ˜¯è‡ªå·±ç¼–å†™äº† [SDS](https://github.com/antirez/sds)ï¼ˆSimple Dynamic Stringï¼Œç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰ æ¥ä½œä¸ºåº•å±‚å®ç°ã€‚

SDS æœ€æ—©æ˜¯ Redis ä½œè€…ä¸ºæ—¥å¸¸ C è¯­è¨€å¼€å‘è€Œè®¾è®¡çš„ C å­—ç¬¦ä¸²ï¼Œåæ¥è¢«åº”ç”¨åˆ°äº† Redis ä¸Šï¼Œå¹¶ç»è¿‡äº†å¤§é‡çš„ä¿®æ”¹å®Œå–„ä»¥é€‚åˆé«˜æ€§èƒ½æ“ä½œã€‚

Redis7.0 çš„ SDS çš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼ˆhttps://github.com/redis/redis/blob/7.0/src/sds.hï¼‰ï¼š

```c
/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼ŒSDS å…±æœ‰äº”ç§å®ç°æ–¹å¼ SDS_TYPE_5ï¼ˆå¹¶æœªç”¨åˆ°ï¼‰ã€SDS_TYPE_8ã€SDS_TYPE_16ã€SDS_TYPE_32ã€SDS_TYPE_64ï¼Œå…¶ä¸­åªæœ‰åå››ç§å®é™…ç”¨åˆ°ã€‚Redis ä¼šæ ¹æ®åˆå§‹åŒ–çš„é•¿åº¦å†³å®šä½¿ç”¨å“ªç§ç±»å‹ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚

| ç±»å‹     | å­—èŠ‚ | ä½   |
| -------- | ---- | ---- |
| sdshdr5  | < 1  | <8   |
| sdshdr8  | 1    | 8    |
| sdshdr16 | 2    | 16   |
| sdshdr32 | 4    | 32   |
| sdshdr64 | 8    | 64   |

å¯¹äºåå››ç§å®ç°éƒ½åŒ…å«äº†ä¸‹é¢è¿™ 4 ä¸ªå±æ€§ï¼š

- `len` ï¼šå­—ç¬¦ä¸²çš„é•¿åº¦ä¹Ÿå°±æ˜¯å·²ç»ä½¿ç”¨çš„å­—èŠ‚æ•°
- `alloc`ï¼šæ€»å…±å¯ç”¨çš„å­—ç¬¦ç©ºé—´å¤§å°ï¼Œalloc-len å°±æ˜¯ SDS å‰©ä½™çš„ç©ºé—´å¤§å°
- `buf[]` ï¼šå®é™…å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°ç»„
- `flags` ï¼šä½ä¸‰ä½ä¿å­˜ç±»å‹æ ‡å¿—

SDS ç›¸æ¯”äº C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æœ‰å¦‚ä¸‹æå‡ï¼š

1. **å¯ä»¥é¿å…ç¼“å†²åŒºæº¢å‡º** ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²è¢«ä¿®æ”¹ï¼ˆæ¯”å¦‚æ‹¼æ¥ï¼‰æ—¶ï¼Œä¸€æ—¦æ²¡æœ‰åˆ†é…è¶³å¤Ÿé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚SDS è¢«ä¿®æ”¹æ—¶ï¼Œä¼šå…ˆæ ¹æ® len å±æ€§æ£€æŸ¥ç©ºé—´å¤§å°æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™å…ˆæ‰©å±•è‡³æ‰€éœ€å¤§å°å†è¿›è¡Œä¿®æ”¹æ“ä½œã€‚
2. **è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦è¾ƒä½** ï¼š C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²çš„é•¿åº¦é€šå¸¸æ˜¯ç»è¿‡éå†è®¡æ•°æ¥å®ç°çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚SDS çš„é•¿åº¦è·å–ç›´æ¥è¯»å– len å±æ€§å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
3. **å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°** ï¼š ä¸ºäº†é¿å…ä¿®æ”¹ï¼ˆå¢åŠ /å‡å°‘ï¼‰å­—ç¬¦ä¸²æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼ˆC è¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯è¿™æ ·çš„ï¼‰ï¼ŒSDS å®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ã€‚å½“ SDS éœ€è¦å¢åŠ å­—ç¬¦ä¸²æ—¶ï¼ŒRedis ä¼šä¸º SDS åˆ†é…å¥½å†…å­˜ï¼Œå¹¶ä¸”æ ¹æ®ç‰¹å®šçš„ç®—æ³•åˆ†é…å¤šä½™çš„å†…å­˜ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚å½“ SDS éœ€è¦å‡å°‘å­—ç¬¦ä¸²æ—¶ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸ä¼šç«‹å³è¢«å›æ”¶ï¼Œä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…åç»­ä½¿ç”¨ï¼ˆæ”¯æŒæ‰‹åŠ¨é‡Šæ”¾ï¼Œæœ‰å¯¹åº”çš„ APIï¼‰ã€‚
4. **äºŒè¿›åˆ¶å®‰å…¨** ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ `\0` ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸçš„æ ‡è¯†ï¼Œè¿™å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåƒä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ï¼‰å°±å¯èƒ½åŒ…æ‹¬ç©ºå­—ç¬¦ï¼ŒC å­—ç¬¦ä¸²æ— æ³•æ­£ç¡®ä¿å­˜ã€‚SDS ä½¿ç”¨ len å±æ€§åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚

ğŸ¤ å¤šæä¸€å˜´ï¼Œå¾ˆå¤šæ–‡ç« é‡Œ SDS çš„å®šä¹‰æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```c
struct sdshdr {
    unsigned int len;
    unsigned int free;
    char buf[];
};
```

è¿™ä¸ªä¹Ÿæ²¡é”™ï¼ŒRedis 3.2 ä¹‹å‰å°±æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚åæ¥ï¼Œç”±äºè¿™ç§æ–¹å¼çš„å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œ`len` å’Œ `free` çš„å®šä¹‰ç”¨äº† 4 ä¸ªå­—èŠ‚ï¼Œé€ æˆäº†æµªè´¹ã€‚Redis 3.2 ä¹‹åï¼ŒRedis æ”¹è¿›äº† SDS çš„å®šä¹‰ï¼Œå°†å…¶åˆ’åˆ†ä¸ºäº†ç°åœ¨çš„ 5 ç§ç±»å‹ã€‚

### è´­ç‰©è½¦ä¿¡æ¯ç”¨ String è¿˜æ˜¯ Hash å­˜å‚¨æ›´å¥½å‘¢?

ç”±äºè´­ç‰©è½¦ä¸­çš„å•†å“é¢‘ç¹ä¿®æ”¹å’Œå˜åŠ¨ï¼Œè´­ç‰©è½¦ä¿¡æ¯å»ºè®®ä½¿ç”¨ Hash å­˜å‚¨ï¼š

- ç”¨æˆ· id ä¸º key
- å•†å“ id ä¸º fieldï¼Œå•†å“æ•°é‡ä¸º value

![Hashç»´æŠ¤ç®€å•çš„è´­ç‰©è½¦ä¿¡æ¯](./images/hash-shopping-cart.png)

é‚£ç”¨æˆ·è´­ç‰©è½¦ä¿¡æ¯çš„ç»´æŠ¤å…·ä½“åº”è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

- ç”¨æˆ·æ·»åŠ å•†å“å°±æ˜¯å¾€ Hash é‡Œé¢å¢åŠ æ–°çš„ field ä¸ valueï¼›
- æŸ¥è¯¢è´­ç‰©è½¦ä¿¡æ¯å°±æ˜¯éå†å¯¹åº”çš„ Hashï¼›
- æ›´æ”¹å•†å“æ•°é‡ç›´æ¥ä¿®æ”¹å¯¹åº”çš„ value å€¼ï¼ˆç›´æ¥ set æˆ–è€…åšè¿ç®—çš†å¯ï¼‰ï¼›
- åˆ é™¤å•†å“å°±æ˜¯åˆ é™¤ Hash ä¸­å¯¹åº”çš„ fieldï¼›
- æ¸…ç©ºè´­ç‰©è½¦ç›´æ¥åˆ é™¤å¯¹åº”çš„ key å³å¯ã€‚

è¿™é‡Œåªæ˜¯ä»¥ä¸šåŠ¡æ¯”è¾ƒç®€å•çš„è´­ç‰©è½¦åœºæ™¯ä¸¾ä¾‹ï¼Œå®é™…ç”µå•†åœºæ™¯ä¸‹ï¼Œfield åªä¿å­˜ä¸€ä¸ªå•†å“ id æ˜¯æ²¡åŠæ³•æ»¡è¶³éœ€æ±‚çš„ã€‚

### ä½¿ç”¨ Redis å®ç°ä¸€ä¸ªæ’è¡Œæ¦œæ€ä¹ˆåšï¼Ÿ

Redis ä¸­æœ‰ä¸€ä¸ªå«åš `sorted set` çš„æ•°æ®ç»“æ„ç»å¸¸è¢«ç”¨åœ¨å„ç§æ’è¡Œæ¦œçš„åœºæ™¯ï¼Œæ¯”å¦‚ç›´æ’­é—´é€ç¤¼ç‰©çš„æ’è¡Œæ¦œã€æœ‹å‹åœˆçš„å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œã€ç‹è€…è£è€€ä¸­çš„æ®µä½æ’è¡Œæ¦œã€è¯é¢˜çƒ­åº¦æ’è¡Œæ¦œç­‰ç­‰ã€‚

ç›¸å…³çš„ä¸€äº› Redis å‘½ä»¤: `ZRANGE` (ä»å°åˆ°å¤§æ’åº) ã€ `ZREVRANGE` ï¼ˆä»å¤§åˆ°å°æ’åºï¼‰ã€`ZREVRANK` (æŒ‡å®šå…ƒç´ æ’å)ã€‚

![](https://oss.javaguide.cn/github/javaguide/database/redis/2021060714195385.png)

[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€å°±æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Sorted Set æ¥è®¾è®¡åˆ¶ä½œä¸€ä¸ªæ’è¡Œæ¦œã€‚

![](https://oss.javaguide.cn/github/javaguide/database/redis/image-20220719071115140.png)

### ä½¿ç”¨ Set å®ç°æŠ½å¥–ç³»ç»Ÿéœ€è¦ç”¨åˆ°ä»€ä¹ˆå‘½ä»¤ï¼Ÿ

- `SPOP key count` ï¼š éšæœºç§»é™¤å¹¶è·å–æŒ‡å®šé›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œé€‚åˆä¸å…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚
- `SRANDMEMBER key count` : éšæœºè·å–æŒ‡å®šé›†åˆä¸­æŒ‡å®šæ•°é‡çš„å…ƒç´ ï¼Œé€‚åˆå…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚

### ä½¿ç”¨ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·æ€ä¹ˆåšï¼Ÿ

ä½¿ç”¨æ—¥æœŸï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰ä½œä¸º keyï¼Œç„¶åç”¨æˆ· ID ä¸º offsetï¼Œå¦‚æœå½“æ—¥æ´»è·ƒè¿‡å°±è®¾ç½®ä¸º 1ã€‚

åˆå§‹åŒ–æ•°æ®ï¼š

```bash
> SETBIT 20210308 1 1
(integer) 0
> SETBIT 20210308 2 1
(integer) 0
> SETBIT 20210309 1 1
(integer) 0
```

ç»Ÿè®¡ 20210308~20210309 æ€»æ´»è·ƒç”¨æˆ·æ•°:

```bash
> BITOP and desk1 20210308 20210309
(integer) 1
> BITCOUNT desk1
(integer) 1
```

ç»Ÿè®¡ 20210308~20210309 åœ¨çº¿æ´»è·ƒç”¨æˆ·æ•°:

```bash
> BITOP or desk2 20210308 20210309
(integer) 1
> BITCOUNT desk2
(integer) 2
```

### ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UV æ€ä¹ˆåšï¼Ÿ

1ã€å°†è®¿é—®æŒ‡å®šé¡µé¢çš„æ¯ä¸ªç”¨æˆ· ID æ·»åŠ åˆ° `HyperLogLog` ä¸­ã€‚

```bash
PFADD PAGE_1:UV USER1 USER2 ...... USERn
```

2ã€ç»Ÿè®¡æŒ‡å®šé¡µé¢çš„ UVã€‚

```bash
PFCOUNT PAGE_1:UV
```

## Redis çº¿ç¨‹æ¨¡å‹

å¯¹äºè¯»å†™å‘½ä»¤æ¥è¯´ï¼ŒRedis ä¸€ç›´æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚ä¸è¿‡ï¼Œåœ¨ Redis 4.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥æ‰§è¡Œä¸€äº›å¤§é”®å€¼å¯¹çš„å¼‚æ­¥åˆ é™¤æ“ä½œï¼Œ Redis 6.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼ˆæé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼‰ã€‚

### Redis å•çº¿ç¨‹æ¨¡å‹äº†è§£å—ï¼Ÿ

**Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹** ï¼ˆNetty çš„çº¿ç¨‹æ¨¡å‹ä¹ŸåŸºäº Reactor æ¨¡å¼ï¼ŒReactor æ¨¡å¼ä¸æ„§æ˜¯é«˜æ€§èƒ½ IO çš„åŸºçŸ³ï¼‰ï¼Œè¿™å¥—äº‹ä»¶å¤„ç†æ¨¡å‹å¯¹åº”çš„æ˜¯ Redis ä¸­çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚

ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æœ‰ä¸€æ®µè¯æ˜¯å¦‚æ˜¯ä»‹ç»æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ï¼Œæˆ‘è§‰å¾—å†™å¾—æŒºä¸é”™ã€‚

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚
>
> - æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
> - å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> **è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—**ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

**æ—¢ç„¶æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ**

Redis é€šè¿‡ **IO å¤šè·¯å¤ç”¨ç¨‹åº** æ¥ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼ˆæˆ–è€…è¯´æ˜¯ç›‘å¬å¤šä¸ª socketï¼‰ï¼Œå®ƒä¼šå°†æ„Ÿå…´è¶£çš„äº‹ä»¶åŠç±»å‹ï¼ˆè¯»ã€å†™ï¼‰æ³¨å†Œåˆ°å†…æ ¸ä¸­å¹¶ç›‘å¬æ¯ä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚

è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š **I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä½¿ç”¨è®© Redis ä¸éœ€è¦é¢å¤–åˆ›å»ºå¤šä½™çš„çº¿ç¨‹æ¥ç›‘å¬å®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼Œé™ä½äº†èµ„æºçš„æ¶ˆè€—**ï¼ˆå’Œ NIO ä¸­çš„ `Selector` ç»„ä»¶å¾ˆåƒï¼‰ã€‚

æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- å¤šä¸ª socketï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰
- IO å¤šè·¯å¤ç”¨ç¨‹åºï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† socket å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰

![æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨](https://oss.javaguide.cn/github/javaguide/database/redis/redis-event-handler.png)

ç›¸å…³é˜…è¯»ï¼š[Redis äº‹ä»¶æœºåˆ¶è¯¦è§£](http://remcarpediem.net/article/1aa2da89/) ã€‚

### Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

è™½ç„¶è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œ**Redis åœ¨ 4.0 ä¹‹åçš„ç‰ˆæœ¬ä¸­å°±å·²ç»åŠ å…¥äº†å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒã€‚**

ä¸è¿‡ï¼ŒRedis 4.0 å¢åŠ çš„å¤šçº¿ç¨‹ä¸»è¦æ˜¯é’ˆå¯¹ä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œçš„å‘½ä»¤ï¼Œä½¿ç”¨è¿™äº›å‘½ä»¤å°±ä¼šä½¿ç”¨ä¸»çº¿ç¨‹ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹æ¥â€œå¼‚æ­¥å¤„ç†â€ã€‚

ä¸ºæ­¤ï¼ŒRedis 4.0 ä¹‹åæ–°å¢äº†`UNLINK`ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ `DEL` çš„å¼‚æ­¥ç‰ˆæœ¬ï¼‰ã€`FLUSHALL ASYNC`ï¼ˆæ¸…ç©ºæ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰ keyï¼Œä¸ä»…ä»…æ˜¯å½“å‰ `SELECT` çš„æ•°æ®åº“ï¼‰ã€`FLUSHDB ASYNC`ï¼ˆæ¸…ç©ºå½“å‰ `SELECT` æ•°æ®åº“ä¸­çš„æ‰€æœ‰ keyï¼‰ç­‰å¼‚æ­¥å‘½ä»¤ã€‚

![redis4.0 more thread](https://oss.javaguide.cn/github/javaguide/database/redis/redis4.0-more-thread.png)

å¤§ä½“ä¸Šæ¥è¯´ï¼ŒRedis 6.0 ä¹‹å‰ä¸»è¦è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ã€‚

**é‚£ Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ** æˆ‘è§‰å¾—ä¸»è¦åŸå› æœ‰ 3 ç‚¹ï¼š

- å•çº¿ç¨‹ç¼–ç¨‹å®¹æ˜“å¹¶ä¸”æ›´å®¹æ˜“ç»´æŠ¤ï¼›
- Redis çš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPU ï¼Œä¸»è¦åœ¨å†…å­˜å’Œç½‘ç»œï¼›
- å¤šçº¿ç¨‹å°±ä¼šå­˜åœ¨æ­»é”ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰é—®é¢˜ï¼Œç”šè‡³ä¼šå½±å“æ€§èƒ½ã€‚

ç›¸å…³é˜…è¯»ï¼š[ä¸ºä»€ä¹ˆ Redis é€‰æ‹©å•çº¿ç¨‹æ¨¡å‹](https://draveness.me/whys-the-design-redis-single-thread/) ã€‚

### Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ

**Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½**ï¼Œå› ä¸ºè¿™ä¸ªç®—æ˜¯ Redis ä¸­çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ã€‚

è™½ç„¶ï¼ŒRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ Redis çš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šä½¿ç”¨äº†ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚å› æ­¤ï¼Œä½ ä¹Ÿä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦è®¾ç½® IO çº¿ç¨‹æ•° > 1ï¼Œéœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` ï¼š

```bash
io-threads 4 #è®¾ç½®1çš„è¯åªä¼šå¼€å¯ä¸»çº¿ç¨‹ï¼Œå®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹
```

å¦å¤–ï¼š

- io-threads çš„ä¸ªæ•°ä¸€æ—¦è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡ config åŠ¨æ€è®¾ç½®ã€‚
- å½“è®¾ç½® ssl åï¼Œio-threads å°†ä¸å·¥ä½œã€‚

å¼€å¯å¤šçº¿ç¨‹åï¼Œé»˜è®¤åªä¼šä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œ IO å†™å…¥ writesï¼Œå³å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœéœ€è¦å¼€å¯å¤šçº¿ç¨‹ IO è¯»å– readsï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` :

```bash
io-threads-do-reads yes
```

ä½†æ˜¯å®˜ç½‘æè¿°å¼€å¯å¤šçº¿ç¨‹è¯»å¹¶ä¸èƒ½æœ‰å¤ªå¤§æå‡ï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹å¹¶ä¸å»ºè®®å¼€å¯

ç›¸å…³é˜…è¯»ï¼š

- [Redis 6.0 æ–°ç‰¹æ€§-å¤šçº¿ç¨‹è¿ç¯ 13 é—®ï¼](https://mp.weixin.qq.com/s/FZu3acwK6zrCBZQ_3HoUgw)
- [Redis å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å…¨é¢æ­ç§˜](https://segmentfault.com/a/1190000039223696)ï¼ˆæ¨èï¼‰

## Redis å†…å­˜ç®¡ç†

### Redis ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´æœ‰å•¥ç”¨ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®ä¿å­˜çš„ç¼“å­˜æ•°æ®çš„æ—¶å€™éƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸€ç›´ä¿å­˜çš„è¯ï¼Œåˆ†åˆ†é’Ÿç›´æ¥ Out of memoryã€‚

Redis è‡ªå¸¦äº†ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

```bash
127.0.0.1:6379> expire key 60 # æ•°æ®åœ¨ 60s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex key 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[set] + [ex]pire)
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56
```

æ³¨æ„ï¼š**Redis ä¸­é™¤äº†å­—ç¬¦ä¸²ç±»å‹æœ‰è‡ªå·±ç‹¬æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ `setex` å¤–ï¼Œå…¶ä»–æ–¹æ³•éƒ½éœ€è¦ä¾é  `expire` å‘½ä»¤æ¥è®¾ç½®è¿‡æœŸæ—¶é—´ ã€‚å¦å¤–ï¼Œ `persist` å‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´ã€‚**

**è¿‡æœŸæ—¶é—´é™¤äº†æœ‰åŠ©äºç¼“è§£å†…å­˜çš„æ¶ˆè€—ï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–ç”¨ä¹ˆï¼Ÿ**

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯éœ€è¦æŸä¸ªæ•°æ®åªåœ¨æŸä¸€æ—¶é—´æ®µå†…å­˜åœ¨ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„çŸ­ä¿¡éªŒè¯ç å¯èƒ½åªåœ¨ 1 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œç”¨æˆ·ç™»å½•çš„ token å¯èƒ½åªåœ¨ 1 å¤©å†…æœ‰æ•ˆã€‚

å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“æ¥å¤„ç†çš„è¯ï¼Œä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åˆ¤æ–­è¿‡æœŸï¼Œè¿™æ ·æ›´éº»çƒ¦å¹¶ä¸”æ€§èƒ½è¦å·®å¾ˆå¤šã€‚

### Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿ

Redis é€šè¿‡ä¸€ä¸ªå«åšè¿‡æœŸå­—å…¸ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ hash è¡¨ï¼‰æ¥ä¿å­˜æ•°æ®è¿‡æœŸçš„æ—¶é—´ã€‚è¿‡æœŸå­—å…¸çš„é”®æŒ‡å‘ Redis æ•°æ®åº“ä¸­çš„æŸä¸ª key(é”®)ï¼Œè¿‡æœŸå­—å…¸çš„å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼‰ã€‚

![redisè¿‡æœŸå­—å…¸](https://oss.javaguide.cn/github/javaguide/database/redis/redis-expired-dictionary.png)

è¿‡æœŸå­—å…¸æ˜¯å­˜å‚¨åœ¨ redisDb è¿™ä¸ªç»“æ„é‡Œçš„ï¼š

```c
typedef struct redisDb {
    ...

    dict *dict;     //æ•°æ®åº“é”®ç©ºé—´,ä¿å­˜ç€æ•°æ®åº“ä¸­æ‰€æœ‰é”®å€¼å¯¹
    dict *expires   // è¿‡æœŸå­—å…¸,ä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´
    ...
} redisDb;
```

### è¿‡æœŸçš„æ•°æ®çš„åˆ é™¤ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

å¦‚æœå‡è®¾ä½ è®¾ç½®äº†ä¸€æ‰¹ key åªèƒ½å­˜æ´» 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆ 1 åˆ†é’Ÿåï¼ŒRedis æ˜¯æ€ä¹ˆå¯¹è¿™æ‰¹ key è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿ

å¸¸ç”¨çš„è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥å°±ä¸¤ä¸ªï¼ˆé‡è¦ï¼è‡ªå·±é€ ç¼“å­˜è½®å­çš„æ—¶å€™éœ€è¦æ ¼å¤–è€ƒè™‘çš„ä¸œè¥¿ï¼‰ï¼š

1. **æƒ°æ€§åˆ é™¤** ï¼šåªä¼šåœ¨å–å‡º key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™æ ·å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚
2. **å®šæœŸåˆ é™¤** ï¼š æ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤è¿‡æœŸ key æ“ä½œã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚

å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œæ‰€ä»¥ Redis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ã€‚

ä½†æ˜¯ï¼Œä»…ä»…é€šè¿‡ç»™ key è®¾ç½®è¿‡æœŸæ—¶é—´è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚å› ä¸ºè¿˜æ˜¯å¯èƒ½å­˜åœ¨å®šæœŸåˆ é™¤å’Œæƒ°æ€§åˆ é™¤æ¼æ‰äº†å¾ˆå¤šè¿‡æœŸ key çš„æƒ…å†µã€‚è¿™æ ·å°±å¯¼è‡´å¤§é‡è¿‡æœŸ key å †ç§¯åœ¨å†…å­˜é‡Œï¼Œç„¶åå°± Out of memory äº†ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ï¼š**Redis å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚**

### Redis å†…å­˜æ·˜æ±°æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

> ç›¸å…³é—®é¢˜ï¼šMySQL é‡Œæœ‰ 2000w æ•°æ®ï¼ŒRedis ä¸­åªå­˜ 20w çš„æ•°æ®ï¼Œå¦‚ä½•ä¿è¯ Redis ä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®?

Redis æä¾› 6 ç§æ•°æ®æ·˜æ±°ç­–ç•¥ï¼š

1. **volatile-lruï¼ˆleast recently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **volatile-ttl**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°ã€‚
3. **volatile-random**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
4. **allkeys-lruï¼ˆleast recently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰ã€‚
5. **allkeys-random**ï¼šä»æ•°æ®é›†ï¼ˆ`server.db[i].dict`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
6. **no-eviction**ï¼šç¦æ­¢é©±é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚è¿™ä¸ªåº”è¯¥æ²¡äººä½¿ç”¨å§ï¼

4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š

7. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
8. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ keyã€‚

## Redis æŒä¹…åŒ–æœºåˆ¶

Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB æŒä¹…åŒ–ã€AOF æŒä¹…åŒ–ã€RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼‰ ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ Redis æŒä¹…åŒ–æœºåˆ¶ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š [Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£](./redis-persistence.md) ã€‚

## å‚è€ƒ

- ã€ŠRedis å¼€å‘ä¸è¿ç»´ã€‹
- ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹
- Redis å‘½ä»¤æ‰‹å†Œï¼šhttps://www.redis.com.cn/commands.html
- WHY Redis choose single thread (vs multi threads): [https://medium.com/@jychen7/sharing-redis-single-thread-vs-multi-threads-5870bd44d153](https://medium.com/@jychen7/sharing-redis-single-thread-vs-multi-threads-5870bd44d153)
- The difference between AOF and RDB persistenceï¼šhttps://www.sobyte.net/post/2022-04/redis-rdb-and-aof/
- Redis AOF æŒä¹…åŒ–è¯¦è§£ - ç¨‹åºå‘˜å†å°å†°ï¼šhttp://remcarpediem.net/article/376c55d8/
