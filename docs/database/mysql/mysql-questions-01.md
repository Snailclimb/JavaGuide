---
title: MySQLå¸¸è§é¢è¯•é¢˜æ€»ç»“
category: æ•°æ®åº“
tag:
  - MySQL
  - å¤§å‚é¢è¯•
head:
  - - meta
    - name: keywords
      content: MySQLåŸºç¡€,MySQLåŸºç¡€æ¶æ„,MySQLå­˜å‚¨å¼•æ“,MySQLæŸ¥è¯¢ç¼“å­˜,MySQLäº‹åŠ¡,MySQLé”ç­‰å†…å®¹ã€‚
  - - meta
    - name: description
      content: ä¸€ç¯‡æ–‡ç« æ€»ç»“MySQLå¸¸è§çš„çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜ï¼Œæ¶µç›–MySQLåŸºç¡€ã€MySQLåŸºç¡€æ¶æ„ã€MySQLå­˜å‚¨å¼•æ“ã€MySQLæŸ¥è¯¢ç¼“å­˜ã€MySQLäº‹åŠ¡ã€MySQLé”ç­‰å†…å®¹ã€‚
---

## MySQL åŸºç¡€

### ä»€ä¹ˆæ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Ÿ

é¡¾åæ€ä¹‰ï¼Œå…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼ŒRelational Database Management Systemï¼‰å°±æ˜¯ä¸€ç§å»ºç«‹åœ¨å…³ç³»æ¨¡å‹çš„åŸºç¡€ä¸Šçš„æ•°æ®åº“ã€‚å…³ç³»æ¨¡å‹è¡¨æ˜äº†æ•°æ®åº“ä¸­æ‰€å­˜å‚¨çš„æ•°æ®ä¹‹é—´çš„è”ç³»ï¼ˆä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šï¼‰ã€‚

å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®éƒ½è¢«å­˜æ”¾åœ¨äº†å„ç§è¡¨ä¸­ï¼ˆæ¯”å¦‚ç”¨æˆ·è¡¨ï¼‰ï¼Œè¡¨ä¸­çš„æ¯ä¸€è¡Œå°±å­˜æ”¾ç€ä¸€æ¡æ•°æ®ï¼ˆæ¯”å¦‚ä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼‰ã€‚

![å…³ç³»å‹æ•°æ®åº“è¡¨å…³ç³»](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/java-guide-blog/5e3c1a71724a38245aa43b02_99bf70d46cc247be878de9d3a88f0c44.png)

å¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“éƒ½ä½¿ç”¨ SQL æ¥æ“ä½œæ•°æ®åº“ä¸­çš„æ•°æ®ã€‚å¹¶ä¸”ï¼Œå¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“éƒ½æ”¯æŒäº‹åŠ¡çš„å››å¤§ç‰¹æ€§(ACID)ã€‚

**æœ‰å“ªäº›å¸¸è§çš„å…³ç³»å‹æ•°æ®åº“å‘¢ï¼Ÿ**

MySQLã€PostgreSQLã€Oracleã€SQL Serverã€SQLiteï¼ˆå¾®ä¿¡æœ¬åœ°çš„èŠå¤©è®°å½•çš„å­˜å‚¨å°±æ˜¯ç”¨çš„ SQLiteï¼‰ ......ã€‚

### ä»€ä¹ˆæ˜¯ SQLï¼Ÿ

SQL æ˜¯ä¸€ç§ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€(Structured Query Language)ï¼Œä¸“é—¨ç”¨æ¥ä¸æ•°æ®åº“æ‰“äº¤é“ï¼Œç›®çš„æ˜¯æä¾›ä¸€ç§ä»æ•°æ®åº“ä¸­è¯»å†™æ•°æ®çš„ç®€å•æœ‰æ•ˆçš„æ–¹æ³•ã€‚

å‡ ä¹æ‰€æœ‰çš„ä¸»æµå…³ç³»æ•°æ®åº“éƒ½æ”¯æŒ SQL ï¼Œé€‚ç”¨æ€§éå¸¸å¼ºã€‚å¹¶ä¸”ï¼Œä¸€äº›éå…³ç³»å‹æ•°æ®åº“ä¹Ÿå…¼å®¹ SQL æˆ–è€…ä½¿ç”¨çš„æ˜¯ç±»ä¼¼äº SQL çš„æŸ¥è¯¢è¯­è¨€ã€‚

SQL å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š

- æ–°å»ºæ•°æ®åº“ã€æ•°æ®è¡¨ã€å­—æ®µï¼›
- åœ¨æ•°æ®åº“ä¸­å¢åŠ ï¼Œåˆ é™¤ï¼Œä¿®æ”¹ï¼ŒæŸ¥è¯¢æ•°æ®ï¼›
- æ–°å»ºè§†å›¾ã€å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼›
- å¯¹æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œç®€å•çš„æ•°æ®åˆ†æï¼›
- æ­é… Hiveï¼ŒSpark SQL åšå¤§æ•°æ®ï¼›
- æ­é… SQLFlow åšæœºå™¨å­¦ä¹ ï¼›
- ......

### ä»€ä¹ˆæ˜¯ MySQLï¼Ÿ

![](https://img-blog.csdnimg.cn/20210327143351823.png)

**MySQL æ˜¯ä¸€ç§å…³ç³»å‹æ•°æ®åº“ï¼Œä¸»è¦ç”¨äºæŒä¹…åŒ–å­˜å‚¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­çš„ä¸€äº›æ•°æ®æ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ã€‚**

ç”±äº MySQL æ˜¯å¼€æºå…è´¹å¹¶ä¸”æ¯”è¾ƒæˆç†Ÿçš„æ•°æ®åº“ï¼Œå› æ­¤ï¼ŒMySQL è¢«å¤§é‡ä½¿ç”¨åœ¨å„ç§ç³»ç»Ÿä¸­ã€‚ä»»ä½•äººéƒ½å¯ä»¥åœ¨ GPL(General Public License) çš„è®¸å¯ä¸‹ä¸‹è½½å¹¶æ ¹æ®ä¸ªæ€§åŒ–çš„éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚MySQL çš„é»˜è®¤ç«¯å£å·æ˜¯**3306**ã€‚

### MySQL æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ

è¿™ä¸ªé—®é¢˜æœ¬è´¨ä¸Šæ˜¯åœ¨é—® MySQL å¦‚æ­¤æµè¡Œçš„åŸå› ã€‚

MySQL ä¸»è¦å…·æœ‰ä¸‹é¢è¿™äº›ä¼˜ç‚¹ï¼š

1. æˆç†Ÿç¨³å®šï¼ŒåŠŸèƒ½å®Œå–„ã€‚
2. å¼€æºå…è´¹ã€‚
3. æ–‡æ¡£ä¸°å¯Œï¼Œæ—¢æœ‰è¯¦ç»†çš„å®˜æ–¹æ–‡æ¡£ï¼Œåˆæœ‰éå¸¸å¤šä¼˜è´¨æ–‡ç« å¯ä¾›å‚è€ƒå­¦ä¹ ã€‚
4. å¼€ç®±å³ç”¨ï¼Œæ“ä½œç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½ã€‚
5. å…¼å®¹æ€§å¥½ï¼Œæ”¯æŒå¸¸è§çš„æ“ä½œç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å¼€å‘è¯­è¨€ã€‚
6. ç¤¾åŒºæ´»è·ƒï¼Œç”Ÿæ€å®Œå–„ã€‚
7. äº‹åŠ¡æ”¯æŒä¼˜ç§€ï¼Œ InnoDB å­˜å‚¨å¼•æ“é»˜è®¤ä½¿ç”¨ REPEATABLE-READ å¹¶ä¸ä¼šæœ‰ä»»ä½•æ€§èƒ½æŸå¤±ï¼Œå¹¶ä¸”ï¼ŒInnoDB å®ç°çš„ REPEATABLE-READ éš”ç¦»çº§åˆ«å…¶å®æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å‘ç”Ÿçš„ã€‚
8. æ”¯æŒåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€é«˜å¯ç”¨ã€‚

## MySQL åŸºç¡€æ¶æ„

> å»ºè®®é…åˆ [SQL è¯­å¥åœ¨ MySQL ä¸­çš„æ‰§è¡Œè¿‡ç¨‹](./how-sql-executed-in-mysql.md) è¿™ç¯‡æ–‡ç« æ¥ç†è§£ MySQL åŸºç¡€æ¶æ„ã€‚å¦å¤–ï¼Œâ€œä¸€ä¸ª SQL è¯­å¥åœ¨ MySQL ä¸­çš„æ‰§è¡Œæµç¨‹â€ä¹Ÿæ˜¯é¢è¯•ä¸­æ¯”è¾ƒå¸¸é—®çš„ä¸€ä¸ªé—®é¢˜ã€‚

ä¸‹å›¾æ˜¯ MySQL çš„ä¸€ä¸ªç®€è¦æ¶æ„å›¾ï¼Œä»ä¸‹å›¾ä½ å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°å®¢æˆ·ç«¯çš„ä¸€æ¡ SQL è¯­å¥åœ¨ MySQL å†…éƒ¨æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javaguide/13526879-3037b144ed09eb88.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œ MySQL ä¸»è¦ç”±ä¸‹é¢å‡ éƒ¨åˆ†æ„æˆï¼š

- **è¿æ¥å™¨ï¼š** èº«ä»½è®¤è¯å’Œæƒé™ç›¸å…³(ç™»å½• MySQL çš„æ—¶å€™)ã€‚
- **æŸ¥è¯¢ç¼“å­˜ï¼š** æ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„æ—¶å€™ï¼Œä¼šå…ˆæŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 8.0 ç‰ˆæœ¬åç§»é™¤ï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½ä¸å¤ªå®ç”¨ï¼‰ã€‚
- **åˆ†æå™¨ï¼š** æ²¡æœ‰å‘½ä¸­ç¼“å­˜çš„è¯ï¼ŒSQL è¯­å¥å°±ä¼šç»è¿‡åˆ†æå™¨ï¼Œåˆ†æå™¨è¯´ç™½äº†å°±æ˜¯è¦å…ˆçœ‹ä½ çš„ SQL è¯­å¥è¦å¹²å˜›ï¼Œå†æ£€æŸ¥ä½ çš„ SQL è¯­å¥è¯­æ³•æ˜¯å¦æ­£ç¡®ã€‚
- **ä¼˜åŒ–å™¨ï¼š** æŒ‰ç…§ MySQL è®¤ä¸ºæœ€ä¼˜çš„æ–¹æ¡ˆå»æ‰§è¡Œã€‚
- **æ‰§è¡Œå™¨ï¼š** æ‰§è¡Œè¯­å¥ï¼Œç„¶åä»å­˜å‚¨å¼•æ“è¿”å›æ•°æ®ã€‚ æ‰§è¡Œè¯­å¥ä¹‹å‰ä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™çš„è¯ï¼Œå°±ä¼šæŠ¥é”™ã€‚
- **æ’ä»¶å¼å­˜å‚¨å¼•æ“** ï¼š ä¸»è¦è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ï¼Œé‡‡ç”¨çš„æ˜¯æ’ä»¶å¼æ¶æ„ï¼Œæ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šç§å­˜å‚¨å¼•æ“ã€‚

## MySQL å­˜å‚¨å¼•æ“

MySQL æ ¸å¿ƒåœ¨äºå­˜å‚¨å¼•æ“ï¼Œæƒ³è¦æ·±å…¥å­¦ä¹  MySQLï¼Œå¿…å®šè¦æ·±å…¥ç ”ç©¶ MySQL å­˜å‚¨å¼•æ“ã€‚

### MySQL æ”¯æŒå“ªäº›å­˜å‚¨å¼•æ“ï¼Ÿé»˜è®¤ä½¿ç”¨å“ªä¸ªï¼Ÿ

MySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œä½ å¯ä»¥é€šè¿‡ `show engines` å‘½ä»¤æ¥æŸ¥çœ‹ MySQL æ”¯æŒçš„æ‰€æœ‰å­˜å‚¨å¼•æ“ã€‚

![æŸ¥çœ‹ MySQL æä¾›çš„æ‰€æœ‰å­˜å‚¨å¼•æ“](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220510105408703.png)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å‡ºï¼Œ MySQL å½“å‰é»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯ InnoDBã€‚å¹¶ä¸”ï¼Œæ‰€æœ‰çš„å­˜å‚¨å¼•æ“ä¸­åªæœ‰ InnoDB æ˜¯äº‹åŠ¡æ€§å­˜å‚¨å¼•æ“ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ InnoDB æ”¯æŒäº‹åŠ¡ã€‚

æˆ‘è¿™é‡Œä½¿ç”¨çš„ MySQL ç‰ˆæœ¬æ˜¯ 8.xï¼Œä¸åŒçš„ MySQL ç‰ˆæœ¬ä¹‹é—´å¯èƒ½ä¼šæœ‰å·®åˆ«ã€‚

MySQL 5.5.5 ä¹‹å‰ï¼ŒMyISAM æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚5.5.5 ç‰ˆæœ¬ä¹‹åï¼ŒInnoDB æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚

ä½ å¯ä»¥é€šè¿‡ `select version()` å‘½ä»¤æŸ¥çœ‹ä½ çš„ MySQL ç‰ˆæœ¬ã€‚

```bash
 mysql> select version();
+-----------+
| version() |
+-----------+
| 8.0.27    |
+-----------+
1 row in set (0.00 sec)
```

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `show variables like '%storage_engine%'` å‘½ä»¤ç›´æ¥æŸ¥çœ‹ MySQL å½“å‰é»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚

![æŸ¥çœ‹ MySQL å½“å‰é»˜è®¤çš„å­˜å‚¨å¼•æ“](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220510105837786.png)

å¦‚æœä½ åªæƒ³æŸ¥çœ‹æ•°æ®åº“ä¸­æŸä¸ªè¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `show table status from db_name where name='table_name'`å‘½ä»¤ã€‚

![æŸ¥çœ‹è¡¨çš„å­˜å‚¨å¼•æ“](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220510110549140.png)

å¦‚æœä½ æƒ³è¦æ·±å…¥äº†è§£æ¯ä¸ªå­˜å‚¨å¼•æ“ä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ï¼Œæ¨èä½ å»é˜…è¯»ä»¥ä¸‹ MySQL å®˜æ–¹æ–‡æ¡£å¯¹åº”çš„ä»‹ç»(é¢è¯•ä¸ä¼šé—®è¿™ä¹ˆç»†ï¼Œäº†è§£å³å¯)ï¼š

- InnoDB å­˜å‚¨å¼•æ“è¯¦ç»†ä»‹ç»ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html ã€‚
- å…¶ä»–å­˜å‚¨å¼•æ“è¯¦ç»†ä»‹ç»ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/storage-engines.html ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220510155143458.png)

### MySQL å­˜å‚¨å¼•æ“æ¶æ„äº†è§£å—ï¼Ÿ

MySQL å­˜å‚¨å¼•æ“é‡‡ç”¨çš„æ˜¯ **æ’ä»¶å¼æ¶æ„** ï¼Œæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä¸ºä¸åŒçš„æ•°æ®åº“è¡¨è®¾ç½®ä¸åŒçš„å­˜å‚¨å¼•æ“ä»¥é€‚åº”ä¸åŒåœºæ™¯çš„éœ€è¦ã€‚**å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ã€‚**

å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥æ ¹æ® MySQL å®šä¹‰çš„å­˜å‚¨å¼•æ“å®ç°æ ‡å‡†æ¥å£æ¥ç¼–å†™ä¸€ä¸ªå±äºè‡ªå·±çš„å­˜å‚¨å¼•æ“ã€‚è¿™äº›éå®˜æ–¹æä¾›çš„å­˜å‚¨å¼•æ“å¯ä»¥ç§°ä¸ºç¬¬ä¸‰æ–¹å­˜å‚¨å¼•æ“ï¼ŒåŒºåˆ«äºå®˜æ–¹å­˜å‚¨å¼•æ“ã€‚åƒç›®å‰æœ€å¸¸ç”¨çš„ InnoDB å…¶å®åˆšå¼€å§‹å°±æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å­˜å‚¨å¼•æ“ï¼Œåé¢ç”±äºè¿‡äºä¼˜ç§€ï¼Œå…¶è¢« Oracle ç›´æ¥æ”¶è´­äº†ã€‚

MySQL å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰ä»‹ç»åˆ°å¦‚ä½•ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰å­˜å‚¨å¼•æ“ï¼Œåœ°å€ï¼šhttps://dev.mysql.com/doc/internals/en/custom-engine.html ã€‚

### MyISAM å’Œ InnoDB æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

![](https://img-blog.csdnimg.cn/20210327145248960.png)

MySQL 5.5 ä¹‹å‰ï¼ŒMyISAM å¼•æ“æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œå¯è°“æ˜¯é£å…‰ä¸€æ—¶ã€‚

è™½ç„¶ï¼ŒMyISAM çš„æ€§èƒ½è¿˜è¡Œï¼Œå„ç§ç‰¹æ€§ä¹Ÿè¿˜ä¸é”™ï¼ˆæ¯”å¦‚å…¨æ–‡ç´¢å¼•ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°ç­‰ï¼‰ã€‚ä½†æ˜¯ï¼ŒMyISAM ä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œè€Œä¸”æœ€å¤§çš„ç¼ºé™·å°±æ˜¯å´©æºƒåæ— æ³•å®‰å…¨æ¢å¤ã€‚

MySQL 5.5 ç‰ˆæœ¬ä¹‹åï¼ŒInnoDB æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚

è¨€å½’æ­£ä¼ ï¼å’±ä»¬ä¸‹é¢è¿˜æ˜¯æ¥ç®€å•å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…ï¼š

**1.æ˜¯å¦æ”¯æŒè¡Œçº§é”**

MyISAM åªæœ‰è¡¨çº§é”(table-level locking)ï¼Œè€Œ InnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”,é»˜è®¤ä¸ºè¡Œçº§é”ã€‚

ä¹Ÿå°±è¯´ï¼ŒMyISAM ä¸€é”å°±æ˜¯é”ä½äº†æ•´å¼ è¡¨ï¼Œè¿™åœ¨å¹¶å‘å†™çš„æƒ…å†µä¸‹æ˜¯å¤šä¹ˆæ»´æ†¨æ†¨å•Šï¼è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ InnoDB åœ¨å¹¶å‘å†™çš„æ—¶å€™ï¼Œæ€§èƒ½æ›´ç‰›çš®äº†ï¼

**2.æ˜¯å¦æ”¯æŒäº‹åŠ¡**

MyISAM ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚

InnoDB æä¾›äº‹åŠ¡æ”¯æŒï¼Œå®ç°äº† SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼Œå…·æœ‰æäº¤(commit)å’Œå›æ»š(rollback)äº‹åŠ¡çš„èƒ½åŠ›ã€‚å¹¶ä¸”ï¼ŒInnoDB é»˜è®¤ä½¿ç”¨çš„ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰éš”ç¦»çº§åˆ«æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å‘ç”Ÿçš„ï¼ˆåŸºäº MVCC å’Œ Next-Key Lockï¼‰ã€‚

å…³äº MySQL äº‹åŠ¡çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£](https://javaguide.cn/database/mysql/transaction-isolation-level.html)ã€‚

**3.æ˜¯å¦æ”¯æŒå¤–é”®**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

å¤–é”®å¯¹äºç»´æŠ¤æ•°æ®ä¸€è‡´æ€§éå¸¸æœ‰å¸®åŠ©ï¼Œä½†æ˜¯å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„æŸè€—ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯ä¸å»ºè®®åœ¨å®é™…ç”Ÿäº§é¡¹ç›®ä¸­ä½¿ç”¨å¤–é”®çš„ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­è¿›è¡Œçº¦æŸå³å¯ï¼

é˜¿é‡Œçš„ã€ŠJava å¼€å‘æ‰‹å†Œã€‹ä¹Ÿæ˜¯æ˜ç¡®è§„å®šç¦æ­¢ä½¿ç”¨å¤–é”®çš„ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220510090309427.png)

ä¸è¿‡ï¼Œåœ¨ä»£ç ä¸­è¿›è¡Œçº¦æŸçš„è¯ï¼Œå¯¹ç¨‹åºå‘˜çš„èƒ½åŠ›è¦æ±‚æ›´é«˜ï¼Œå…·ä½“æ˜¯å¦è¦é‡‡ç”¨å¤–é”®è¿˜æ˜¯è¦æ ¹æ®ä½ çš„é¡¹ç›®å®é™…æƒ…å†µè€Œå®šã€‚

æ€»ç»“ï¼šä¸€èˆ¬æˆ‘ä»¬ä¹Ÿæ˜¯ä¸å»ºè®®åœ¨æ•°æ®åº“å±‚é¢ä½¿ç”¨å¤–é”®çš„ï¼Œåº”ç”¨å±‚é¢å¯ä»¥è§£å†³ã€‚ä¸è¿‡ï¼Œè¿™æ ·ä¼šå¯¹æ•°æ®çš„ä¸€è‡´æ€§é€ æˆå¨èƒã€‚å…·ä½“è¦ä¸è¦ä½¿ç”¨å¤–é”®è¿˜æ˜¯è¦æ ¹æ®ä½ çš„é¡¹ç›®æ¥å†³å®šã€‚

**4.æ˜¯å¦æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„å®‰å…¨æ¢å¤**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

ä½¿ç”¨ InnoDB çš„æ•°æ®åº“åœ¨å¼‚å¸¸å´©æºƒåï¼Œæ•°æ®åº“é‡æ–°å¯åŠ¨çš„æ—¶å€™ä¼šä¿è¯æ•°æ®åº“æ¢å¤åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ä¾èµ–äº `redo log` ã€‚

**5.æ˜¯å¦æ”¯æŒ MVCC**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

è®²çœŸï¼Œè¿™ä¸ªå¯¹æ¯”æœ‰ç‚¹åºŸè¯ï¼Œæ¯•ç«Ÿ MyISAM è¿è¡Œçº§é”éƒ½ä¸æ”¯æŒã€‚MVCC å¯ä»¥çœ‹ä½œæ˜¯è¡Œçº§é”çš„ä¸€ä¸ªå‡çº§ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘åŠ é”æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚

**6.ç´¢å¼•å®ç°ä¸ä¸€æ ·ã€‚**

è™½ç„¶ MyISAM å¼•æ“å’Œ InnoDB å¼•æ“éƒ½æ˜¯ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†æ˜¯ä¸¤è€…çš„å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚

InnoDB å¼•æ“ä¸­ï¼Œå…¶æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚ç›¸æ¯” MyISAMï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå…¶è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œæ ‘çš„å¶èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚

è¯¦ç»†åŒºåˆ«ï¼Œæ¨èä½ çœ‹çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[MySQL ç´¢å¼•è¯¦è§£](https://javaguide.cn/database/mysql/mysql-index.html)ã€‚

**7.æ€§èƒ½æœ‰å·®åˆ«ã€‚**

InnoDB çš„æ€§èƒ½æ¯” MyISAM æ›´å¼ºå¤§ï¼Œä¸ç®¡æ˜¯åœ¨è¯»å†™æ··åˆæ¨¡å¼ä¸‹è¿˜æ˜¯åªè¯»æ¨¡å¼ä¸‹ï¼Œéšç€ CPU æ ¸æ•°çš„å¢åŠ ï¼ŒInnoDB çš„è¯»å†™èƒ½åŠ›å‘ˆçº¿æ€§å¢é•¿ã€‚MyISAM å› ä¸ºè¯»å†™ä¸èƒ½å¹¶å‘ï¼Œå®ƒçš„å¤„ç†èƒ½åŠ›è·Ÿæ ¸æ•°æ²¡å…³ç³»ã€‚

![InnoDB å’Œ MyISAM æ€§èƒ½å¯¹æ¯”](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/innodb-myisam-performance-comparison.png)

**æ€»ç»“** ï¼š

- InnoDB æ”¯æŒè¡Œçº§åˆ«çš„é”ç²’åº¦ï¼ŒMyISAM ä¸æ”¯æŒï¼Œåªæ”¯æŒè¡¨çº§åˆ«çš„é”ç²’åº¦ã€‚
- MyISAM ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚InnoDB æä¾›äº‹åŠ¡æ”¯æŒï¼Œå®ç°äº† SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ã€‚
- MyISAM ä¸æ”¯æŒå¤–é”®ï¼Œè€Œ InnoDB æ”¯æŒã€‚
- MyISAM ä¸æ”¯æŒ MVCCï¼Œè€Œ InnoDB æ”¯æŒã€‚
- è™½ç„¶ MyISAM å¼•æ“å’Œ InnoDB å¼•æ“éƒ½æ˜¯ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†æ˜¯ä¸¤è€…çš„å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚
- MyISAM ä¸æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„å®‰å…¨æ¢å¤ï¼Œè€Œ InnoDB æ”¯æŒã€‚
- InnoDB çš„æ€§èƒ½æ¯” MyISAM æ›´å¼ºå¤§ã€‚

æœ€åï¼Œå†åˆ†äº«ä¸€å¼ å›¾ç‰‡ç»™ä½ ï¼Œè¿™å¼ å›¾ç‰‡è¯¦ç»†å¯¹æ¯”äº†å¸¸è§çš„å‡ ç§ MySQL å­˜å‚¨å¼•æ“ã€‚

![å¸¸è§çš„å‡ ç§ MySQL å­˜å‚¨å¼•æ“å¯¹æ¯”](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/comparison-of-common-mysql-storage-engines.png)

### MyISAM å’Œ InnoDB å¦‚ä½•é€‰æ‹©ï¼Ÿ

å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ InnoDB å­˜å‚¨å¼•æ“ï¼Œåœ¨æŸäº›è¯»å¯†é›†çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ MyISAM ä¹Ÿæ˜¯åˆé€‚çš„ã€‚ä¸è¿‡ï¼Œå‰ææ˜¯ä½ çš„é¡¹ç›®ä¸ä»‹æ„ MyISAM ä¸æ”¯æŒäº‹åŠ¡ã€å´©æºƒæ¢å¤ç­‰ç¼ºç‚¹ï¼ˆå¯æ˜¯~æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä»‹æ„å•Šï¼ï¼‰ã€‚

ã€ŠMySQL é«˜æ€§èƒ½ã€‹ä¸Šé¢æœ‰ä¸€å¥è¯è¿™æ ·å†™åˆ°:

> ä¸è¦è½»æ˜“ç›¸ä¿¡â€œMyISAM æ¯” InnoDB å¿«â€ä¹‹ç±»çš„ç»éªŒä¹‹è°ˆï¼Œè¿™ä¸ªç»“è®ºå¾€å¾€ä¸æ˜¯ç»å¯¹çš„ã€‚åœ¨å¾ˆå¤šæˆ‘ä»¬å·²çŸ¥åœºæ™¯ä¸­ï¼ŒInnoDB çš„é€Ÿåº¦éƒ½å¯ä»¥è®© MyISAM æœ›å°˜è«åŠï¼Œå°¤å…¶æ˜¯ç”¨åˆ°äº†èšç°‡ç´¢å¼•ï¼Œæˆ–è€…éœ€è¦è®¿é—®çš„æ•°æ®éƒ½å¯ä»¥æ”¾å…¥å†…å­˜çš„åº”ç”¨ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬é€‰æ‹© InnoDB éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ä½ å¹¶ä¸åœ¨ä¹å¯æ‰©å±•èƒ½åŠ›å’Œå¹¶å‘èƒ½åŠ›ï¼Œä¹Ÿä¸éœ€è¦äº‹åŠ¡æ”¯æŒï¼Œä¹Ÿä¸åœ¨ä¹å´©æºƒåçš„å®‰å…¨æ¢å¤é—®é¢˜çš„è¯ï¼Œé€‰æ‹© MyISAM ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯éœ€è¦è€ƒè™‘åˆ°è¿™äº›é—®é¢˜çš„ã€‚

å› æ­¤ï¼Œå¯¹äºå’±ä»¬æ—¥å¸¸å¼€å‘çš„ä¸šåŠ¡ç³»ç»Ÿæ¥è¯´ï¼Œä½ å‡ ä¹æ‰¾ä¸åˆ°ä»€ä¹ˆç†ç”±å†ä½¿ç”¨ MyISAM ä½œä¸ºè‡ªå·±çš„ MySQL æ•°æ®åº“çš„å­˜å‚¨å¼•æ“ã€‚

## MySQL ç´¢å¼•

MySQL ç´¢å¼•ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œå¯¹äºé¢è¯•å’Œå·¥ä½œéƒ½æ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯ï¼Œæˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« ä¸“é—¨æ¥æ€»ç»“ MySQL ç´¢å¼•ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š [MySQL ç´¢å¼•è¯¦è§£](./mysql-index.md) ã€‚

## MySQL æŸ¥è¯¢ç¼“å­˜

æ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„æ—¶å€™ï¼Œä¼šå…ˆæŸ¥è¯¢ç¼“å­˜ã€‚ä¸è¿‡ï¼ŒMySQL 8.0 ç‰ˆæœ¬åç§»é™¤ï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½ä¸å¤ªå®ç”¨

`my.cnf` åŠ å…¥ä»¥ä¸‹é…ç½®ï¼Œé‡å¯ MySQL å¼€å¯æŸ¥è¯¢ç¼“å­˜

```properties
query_cache_type=1
query_cache_size=600000
```

MySQL æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¹Ÿå¯ä»¥å¼€å¯æŸ¥è¯¢ç¼“å­˜

```properties
set global  query_cache_type=1;
set global  query_cache_size=600000;
```

å¦‚ä¸Šï¼Œ**å¼€å¯æŸ¥è¯¢ç¼“å­˜ååœ¨åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ä»¥åŠæ•°æ®æƒ…å†µä¸‹ï¼Œä¼šç›´æ¥åœ¨ç¼“å­˜ä¸­è¿”å›ç»“æœ**ã€‚è¿™é‡Œçš„æŸ¥è¯¢æ¡ä»¶åŒ…æ‹¬æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯ã€‚

**æŸ¥è¯¢ç¼“å­˜ä¸å‘½ä¸­çš„æƒ…å†µï¼š**

1. ä»»ä½•ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸å‘½ä¸­ã€‚
2. å¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€MySQL åº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœä¹Ÿä¸ä¼šè¢«ç¼“å­˜ã€‚
3. ç¼“å­˜å»ºç«‹ä¹‹åï¼ŒMySQL çš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯å¼ è¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚

**ç¼“å­˜è™½ç„¶èƒ½å¤Ÿæå‡æ•°æ®åº“çš„æŸ¥è¯¢æ€§èƒ½ï¼Œä½†æ˜¯ç¼“å­˜åŒæ—¶ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„å¼€é”€ï¼Œæ¯æ¬¡æŸ¥è¯¢åéƒ½è¦åšä¸€æ¬¡ç¼“å­˜æ“ä½œï¼Œå¤±æ•ˆåè¿˜è¦é”€æ¯ã€‚** å› æ­¤ï¼Œå¼€å¯æŸ¥è¯¢ç¼“å­˜è¦è°¨æ…ï¼Œå°¤å…¶å¯¹äºå†™å¯†é›†çš„åº”ç”¨æ¥è¯´æ›´æ˜¯å¦‚æ­¤ã€‚å¦‚æœå¼€å¯ï¼Œè¦æ³¨æ„åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ å MB æ¯”è¾ƒåˆé€‚ã€‚æ­¤å¤–ï¼Œ**è¿˜å¯ä»¥é€šè¿‡ `sql_cache` å’Œ `sql_no_cache` æ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦ç¼“å­˜ï¼š**

```sql
select sql_no_cache count(*) from usr;
```

## MySQL æ—¥å¿—

- MySQL ä¸­å¸¸è§çš„æ—¥å¿—æœ‰å“ªäº›ï¼Ÿ
- æ…¢æŸ¥è¯¢æ—¥å¿—æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
- binlog ä¸»è¦è®°å½•äº†ä»€ä¹ˆï¼Ÿ
- redo log å¦‚ä½•ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Ÿ
- é¡µä¿®æ”¹ä¹‹åä¸ºä»€ä¹ˆä¸ç›´æ¥åˆ·ç›˜å‘¢ï¼Ÿ
- binlog å’Œ redolog æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- undo log å¦‚ä½•ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Ÿ
- ......

ä¸Šè¯‰é—®é¢˜çš„ç­”æ¡ˆå¯ä»¥åœ¨[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹(ä»˜è´¹)](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ **ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€** ä¸­æ‰¾åˆ°ã€‚

![ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹æŠ€æœ¯é¢è¯•é¢˜ç¯‡](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javamianshizhibei/technical-interview-questions.png)

## MySQL äº‹åŠ¡

### ä½•è°“äº‹åŠ¡ï¼Ÿ

æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯ä¸­æˆ‘ä»¬éœ€è¦æ’å…¥å¤šæ¡ç›¸å…³è”çš„æ•°æ®åˆ°æ•°æ®åº“ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

- æ•°æ®åº“ä¸­é€”çªç„¶å› ä¸ºæŸäº›åŸå› æŒ‚æ‰äº†ã€‚
- å®¢æˆ·ç«¯çªç„¶å› ä¸ºç½‘ç»œåŸå› è¿æ¥ä¸ä¸Šæ•°æ®åº“äº†ã€‚
- å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥æ•°æ®åº“ï¼Œè¦†ç›–äº†å½¼æ­¤çš„æ›´æ”¹ã€‚
- ......

ä¸Šé¢çš„ä»»ä½•ä¸€ä¸ªé—®é¢˜éƒ½å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿå¤„ç†è¿™äº›é—®é¢˜ã€‚äº‹åŠ¡å°±æ˜¯æˆ‘ä»¬æŠ½è±¡å‡ºæ¥ç®€åŒ–è¿™äº›é—®é¢˜çš„é¦–é€‰æœºåˆ¶ã€‚äº‹åŠ¡çš„æ¦‚å¿µèµ·æºäºæ•°æ®åº“ï¼Œç›®å‰ï¼Œå·²ç»æˆä¸ºä¸€ä¸ªæ¯”è¾ƒå¹¿æ³›çš„æ¦‚å¿µã€‚

**ä½•ä¸ºäº‹åŠ¡ï¼Ÿ** ä¸€è¨€è”½ä¹‹ï¼Œ**äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚**

äº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚å‡å¦‚å°æ˜è¦ç»™å°çº¢è½¬è´¦ 1000 å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»éƒ½æˆåŠŸæˆ–è€…éƒ½å¤±è´¥ã€‚

1. å°†å°æ˜çš„ä½™é¢å‡å°‘ 1000 å…ƒ
2. å°†å°çº¢çš„ä½™é¢å¢åŠ  1000 å…ƒã€‚

äº‹åŠ¡ä¼šæŠŠè¿™ä¸¤ä¸ªæ“ä½œå°±å¯ä»¥çœ‹æˆé€»è¾‘ä¸Šçš„ä¸€ä¸ªæ•´ä½“ï¼Œè¿™ä¸ªæ•´ä½“åŒ…å«çš„æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚è¿™æ ·å°±ä¸ä¼šå‡ºç°å°æ˜ä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢å´å¹¶æ²¡æœ‰å¢åŠ çš„æƒ…å†µã€‚

![äº‹åŠ¡ç¤ºæ„å›¾](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/%E4%BA%8B%E5%8A%A1%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

### ä½•è°“æ•°æ®åº“äº‹åŠ¡ï¼Ÿ

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºäº‹åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æŒ‡**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå¾€å¾€æŒ‡çš„å°±æ˜¯**æ•°æ®åº“äº‹åŠ¡**ã€‚

æ•°æ®åº“äº‹åŠ¡åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æ¥è§¦çš„æœ€å¤šäº†ã€‚å¦‚æœä½ çš„é¡¹ç›®å±äºå•ä½“æ¶æ„çš„è¯ï¼Œä½ æ¥è§¦åˆ°çš„å¾€å¾€å°±æ˜¯æ•°æ®åº“äº‹åŠ¡äº†ã€‚

**é‚£æ•°æ®åº“äº‹åŠ¡æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œæ•°æ®åº“äº‹åŠ¡å¯ä»¥ä¿è¯å¤šä¸ªå¯¹æ•°æ®åº“çš„æ“ä½œï¼ˆä¹Ÿå°±æ˜¯ SQL è¯­å¥ï¼‰æ„æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“ã€‚æ„æˆè¿™ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“çš„è¿™äº›æ•°æ®åº“æ“ä½œéµå¾ªï¼š**è¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸ,è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ** ã€‚

```sql
# å¼€å¯ä¸€ä¸ªäº‹åŠ¡
START TRANSACTION;
# å¤šæ¡ SQL è¯­å¥
SQL1,SQL2...
## æäº¤äº‹åŠ¡
COMMIT;
```

![æ•°æ®åº“äº‹åŠ¡ç¤ºæ„å›¾](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

å¦å¤–ï¼Œå…³ç³»å‹æ•°æ®åº“ï¼ˆä¾‹å¦‚ï¼š`MySQL`ã€`SQL Server`ã€`Oracle` ç­‰ï¼‰äº‹åŠ¡éƒ½æœ‰ **ACID** ç‰¹æ€§ï¼š

![ACID](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/ACID.png)

1. **åŸå­æ€§**ï¼ˆ`Atomicity`ï¼‰ ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **ä¸€è‡´æ€§**ï¼ˆ`Consistency`ï¼‰ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œä¾‹å¦‚è½¬è´¦ä¸šåŠ¡ä¸­ï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œè½¬è´¦è€…å’Œæ”¶æ¬¾äººçš„æ€»é¢åº”è¯¥æ˜¯ä¸å˜çš„ï¼›
3. **éš”ç¦»æ€§**ï¼ˆ`Isolation`ï¼‰ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
4. **æŒä¹…æ€§**ï¼ˆ`Durability`ï¼‰ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚

ğŸŒˆ è¿™é‡Œè¦é¢å¤–è¡¥å……ä¸€ç‚¹ï¼š**åªæœ‰ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚ä¹Ÿå°±æ˜¯è¯´ Aã€Iã€D æ˜¯æ‰‹æ®µï¼ŒC æ˜¯ç›®çš„ï¼** æƒ³å¿…å¤§å®¶ä¹Ÿå’Œæˆ‘ä¸€æ ·ï¼Œè¢« ACID è¿™ä¸ªæ¦‚å¿µè¢«è¯¯å¯¼äº†å¾ˆä¹…! æˆ‘ä¹Ÿæ˜¯çœ‹å‘¨å¿—æ˜è€å¸ˆçš„å…¬å¼€è¯¾[ã€Šå‘¨å¿—æ˜çš„è½¯ä»¶æ¶æ„è¯¾ã€‹](https://time.geekbang.org/opencourse/intro/100064201)æ‰ææ¸…æ¥šçš„ï¼ˆå¤šçœ‹å¥½ä¹¦ï¼ï¼ï¼ï¼‰ã€‚

![AID->C](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/AID-%3EC.png)

å¦å¤–ï¼ŒDDIA ä¹Ÿå°±æ˜¯ [ã€ŠDesigning Data-Intensive Applicationï¼ˆæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ï¼‰ã€‹](https://book.douban.com/subject/30329536/) çš„ä½œè€…åœ¨ä»–çš„è¿™æœ¬ä¹¦ä¸­å¦‚æ˜¯è¯´ï¼š

> Atomicity, isolation, and durability are properties of the database, whereas consisâ€
> tency (in the ACID sense) is a property of the application. The application may rely
> on the databaseâ€™s atomicity and isolation properties in order to achieve consistency,
> but itâ€™s not up to the database alone.
>
> ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ï¼šåŸå­æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§æ˜¯æ•°æ®åº“çš„å±æ€§ï¼Œè€Œä¸€è‡´æ€§ï¼ˆåœ¨ ACID æ„ä¹‰ä¸Šï¼‰æ˜¯åº”ç”¨ç¨‹åºçš„å±æ€§ã€‚åº”ç”¨å¯èƒ½ä¾èµ–æ•°æ®åº“çš„åŸå­æ€§å’Œéš”ç¦»å±æ€§æ¥å®ç°ä¸€è‡´æ€§ï¼Œä½†è¿™å¹¶ä¸ä»…å–å†³äºæ•°æ®åº“ã€‚å› æ­¤ï¼Œå­—æ¯ C ä¸å±äº ACID ã€‚

ã€ŠDesigning Data-Intensive Applicationï¼ˆæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ï¼‰ã€‹è¿™æœ¬ä¹¦å¼ºæ¨ä¸€æ³¢ï¼Œå€¼å¾—è¯»å¾ˆå¤šéï¼è±†ç“£æœ‰æ¥è¿‘ 90% çš„äººçœ‹äº†è¿™æœ¬ä¹¦ä¹‹åç»™äº†äº”æ˜Ÿå¥½è¯„ã€‚å¦å¤–ï¼Œä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬å·²ç»åœ¨ Github å¼€æºï¼Œåœ°å€ï¼š[https://github.com/Vonng/ddia](https://github.com/Vonng/ddia) ã€‚

![](https://img-blog.csdnimg.cn/20210526162552353.png)

### å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜?

åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿è¡Œï¼Œç»å¸¸ä¼šæ“ä½œç›¸åŒçš„æ•°æ®æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼ˆå¤šä¸ªç”¨æˆ·å¯¹åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼‰ã€‚å¹¶å‘è™½ç„¶æ˜¯å¿…é¡»çš„ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹çš„é—®é¢˜ã€‚

#### è„è¯»ï¼ˆDirty readï¼‰

ä¸€ä¸ªäº‹åŠ¡è¯»å–æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™ä¸ªä¿®æ”¹å¯¹å…¶ä»–äº‹åŠ¡æ¥è¯´æ˜¯å¯è§çš„ï¼Œå³ä½¿å½“å‰äº‹åŠ¡æ²¡æœ‰æäº¤ã€‚è¿™æ—¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†è¿™ä¸ªè¿˜æœªæäº¤çš„æ•°æ®ï¼Œä½†ç¬¬ä¸€ä¸ªäº‹åŠ¡çªç„¶å›æ»šï¼Œå¯¼è‡´æ•°æ®å¹¶æ²¡æœ‰è¢«æäº¤åˆ°æ•°æ®åº“ï¼Œé‚£ç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–åˆ°çš„å°±æ˜¯è„æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯è„è¯»çš„ç”±æ¥ã€‚

ä¾‹å¦‚ï¼šäº‹åŠ¡ 1 è¯»å–æŸè¡¨ä¸­çš„æ•°æ® A=20ï¼Œäº‹åŠ¡ 1 ä¿®æ”¹ A=A-1ï¼Œäº‹åŠ¡ 2 è¯»å–åˆ° A = 19,äº‹åŠ¡ 1 å›æ»šå¯¼è‡´å¯¹ A çš„ä¿®æ”¹å¹¶ä¸ºæäº¤åˆ°æ•°æ®åº“ï¼Œ A çš„å€¼è¿˜æ˜¯ 20ã€‚

![è„è¯»](./images/concurrency-consistency-issues-dirty-reading.png)

#### ä¸¢å¤±ä¿®æ”¹ï¼ˆLost to modifyï¼‰

åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®åï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ã€‚è¿™æ ·ç¬¬ä¸€ä¸ªäº‹åŠ¡å†…çš„ä¿®æ”¹ç»“æœå°±è¢«ä¸¢å¤±ï¼Œå› æ­¤ç§°ä¸ºä¸¢å¤±ä¿®æ”¹ã€‚

ä¾‹å¦‚ï¼šäº‹åŠ¡ 1 è¯»å–æŸè¡¨ä¸­çš„æ•°æ® A=20ï¼Œäº‹åŠ¡ 2 ä¹Ÿè¯»å– A=20ï¼Œäº‹åŠ¡ 1 å…ˆä¿®æ”¹ A=A-1ï¼Œäº‹åŠ¡ 2 åæ¥ä¹Ÿä¿®æ”¹ A=A-1ï¼Œæœ€ç»ˆç»“æœ A=19ï¼Œäº‹åŠ¡ 1 çš„ä¿®æ”¹è¢«ä¸¢å¤±ã€‚

![ä¸¢å¤±ä¿®æ”¹](./images/concurrency-consistency-issues-missing-modifications.png)

#### ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatable readï¼‰

æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚è¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚

ä¾‹å¦‚ï¼šäº‹åŠ¡ 1 è¯»å–æŸè¡¨ä¸­çš„æ•°æ® A=20ï¼Œäº‹åŠ¡ 2 ä¹Ÿè¯»å– A=20ï¼Œäº‹åŠ¡ 1 ä¿®æ”¹ A=A-1ï¼Œäº‹åŠ¡ 2 å†æ¬¡è¯»å– A =19ï¼Œæ­¤æ—¶è¯»å–çš„ç»“æœå’Œç¬¬ä¸€æ¬¡è¯»å–çš„ç»“æœä¸åŒã€‚

![ä¸å¯é‡å¤è¯»](./images/concurrency-consistency-issues-unrepeatable-read.png)

#### å¹»è¯»ï¼ˆPhantom readï¼‰

å¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡æ’å…¥äº†ä¸€äº›æ•°æ®æ—¶ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸ºå¹»è¯»ã€‚

ä¾‹å¦‚ï¼šäº‹åŠ¡ 2 è¯»å–æŸä¸ªèŒƒå›´çš„æ•°æ®ï¼Œäº‹åŠ¡ 1 åœ¨è¿™ä¸ªèŒƒå›´æ’å…¥äº†æ–°çš„æ•°æ®ï¼Œäº‹åŠ¡ 2 å†æ¬¡è¯»å–è¿™ä¸ªèŒƒå›´çš„æ•°æ®å‘ç°ç›¸æ¯”äºç¬¬ä¸€æ¬¡è¯»å–çš„ç»“æœå¤šäº†æ–°çš„æ•°æ®ã€‚

![å¹»è¯»](./images/concurrency-consistency-issues-phantom-read.png)

### ä¸å¯é‡å¤è¯»å’Œå¹»è¯»æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯å†…å®¹ä¿®æ”¹æˆ–è€…è®°å½•å‡å°‘æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°å…¶ä¸­æŸäº›è®°å½•çš„å€¼è¢«ä¿®æ”¹ï¼›
- å¹»è¯»çš„é‡ç‚¹åœ¨äºè®°å½•æ–°å¢æ¯”å¦‚å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼ˆDQLï¼‰æ—¶ï¼Œå‘ç°æŸ¥åˆ°çš„è®°å½•å¢åŠ äº†ã€‚

å¹»è¯»å…¶å®å¯ä»¥çœ‹ä½œæ˜¯ä¸å¯é‡å¤è¯»çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå•ç‹¬æŠŠåŒºåˆ†å¹»è¯»çš„åŸå› ä¸»è¦æ˜¯è§£å†³å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„æ–¹æ¡ˆä¸ä¸€æ ·ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæ‰§è¡Œ `delete` å’Œ `update` æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å¯¹è®°å½•åŠ é”ï¼Œä¿è¯äº‹åŠ¡å®‰å…¨ã€‚è€Œæ‰§è¡Œ `insert` æ“ä½œçš„æ—¶å€™ï¼Œç”±äºè®°å½•é”ï¼ˆRecord Lockï¼‰åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è®°å½•ï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è®°å½•ï¼Œéœ€è¦ä¾èµ–é—´éš™é”ï¼ˆGap Lockï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œ `insert` æ“ä½œçš„æ—¶å€™éœ€è¦ä¾èµ– Next-Key Lockï¼ˆRecord Lock+Gap Lockï¼‰ è¿›è¡ŒåŠ é”æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚

### å¹¶å‘äº‹åŠ¡çš„æ§åˆ¶æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

MySQL ä¸­å¹¶å‘äº‹åŠ¡çš„æ§åˆ¶æ–¹å¼æ— éå°±ä¸¤ç§ï¼š**é”** å’Œ **MVCC**ã€‚é”å¯ä»¥çœ‹ä½œæ˜¯æ‚²è§‚æ§åˆ¶çš„æ¨¡å¼ï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiversion concurrency controlï¼‰å¯ä»¥çœ‹ä½œæ˜¯ä¹è§‚æ§åˆ¶çš„æ¨¡å¼ã€‚

**é”** æ§åˆ¶æ–¹å¼ä¸‹ä¼šé€šè¿‡é”æ¥æ˜¾ç¤ºæ§åˆ¶å…±äº«èµ„æºè€Œä¸æ˜¯é€šè¿‡è°ƒåº¦æ‰‹æ®µï¼ŒMySQL ä¸­ä¸»è¦æ˜¯é€šè¿‡ **è¯»å†™é”** æ¥å®ç°å¹¶å‘æ§åˆ¶ã€‚

- **å…±äº«é”ï¼ˆS é”ï¼‰** ï¼šåˆç§°è¯»é”ï¼Œäº‹åŠ¡åœ¨è¯»å–è®°å½•çš„æ—¶å€™è·å–å…±äº«é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ï¼ˆé”å…¼å®¹ï¼‰ã€‚
- **æ’ä»–é”ï¼ˆX é”ï¼‰** ï¼šåˆç§°å†™é”/ç‹¬å é”ï¼Œäº‹åŠ¡åœ¨ä¿®æ”¹è®°å½•çš„æ—¶å€™è·å–æ’ä»–é”ï¼Œä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ã€‚å¦‚æœä¸€ä¸ªè®°å½•å·²ç»è¢«åŠ äº†æ’ä»–é”ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¸èƒ½å†å¯¹è¿™æ¡è®°å½•åŠ ä»»ä½•ç±»å‹çš„é”ï¼ˆé”ä¸å…¼å®¹ï¼‰ã€‚

è¯»å†™é”å¯ä»¥åšåˆ°è¯»è¯»å¹¶è¡Œï¼Œä½†æ˜¯æ— æ³•åšåˆ°å†™è¯»ã€å†™å†™å¹¶è¡Œã€‚å¦å¤–ï¼Œæ ¹æ®æ ¹æ®é”ç²’åº¦çš„ä¸åŒï¼Œåˆè¢«åˆ†ä¸º **è¡¨çº§é”(table-level locking)** å’Œ **è¡Œçº§é”(row-level locking)** ã€‚InnoDB ä¸å…‰æ”¯æŒè¡¨çº§é”ï¼Œè¿˜æ”¯æŒè¡Œçº§é”ï¼Œé»˜è®¤ä¸ºè¡Œçº§é”ã€‚è¡Œçº§é”çš„ç²’åº¦æ›´å°ï¼Œä»…å¯¹ç›¸å…³çš„è®°å½•ä¸Šé”å³å¯ï¼ˆå¯¹ä¸€è¡Œæˆ–è€…å¤šè¡Œè®°å½•åŠ é”ï¼‰ï¼Œæ‰€ä»¥å¯¹äºå¹¶å‘å†™å…¥æ“ä½œæ¥è¯´ï¼Œ InnoDB çš„æ€§èƒ½æ›´é«˜ã€‚ä¸è®ºæ˜¯è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é”ï¼Œéƒ½å­˜åœ¨å…±äº«é”ï¼ˆShare Lockï¼ŒS é”ï¼‰å’Œæ’ä»–é”ï¼ˆExclusive Lockï¼ŒX é”ï¼‰è¿™ä¸¤ç±»ã€‚

**MVCC** æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œå³å¯¹ä¸€ä»½æ•°æ®ä¼šå­˜å‚¨å¤šä¸ªç‰ˆæœ¬ï¼Œé€šè¿‡äº‹åŠ¡çš„å¯è§æ€§æ¥ä¿è¯äº‹åŠ¡èƒ½çœ‹åˆ°è‡ªå·±åº”è¯¥çœ‹åˆ°çš„ç‰ˆæœ¬ã€‚é€šå¸¸ä¼šæœ‰ä¸€ä¸ªå…¨å±€çš„ç‰ˆæœ¬åˆ†é…å™¨æ¥ä¸ºæ¯ä¸€è¡Œæ•°æ®è®¾ç½®ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·æ˜¯å”¯ä¸€çš„ã€‚

MVCC åœ¨ MySQL ä¸­å®ç°æ‰€ä¾èµ–çš„æ‰‹æ®µä¸»è¦æ˜¯: **éšè—å­—æ®µã€read viewã€undo log**ã€‚

- undo log : undo log ç”¨äºè®°å½•æŸè¡Œæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®ã€‚
- read view å’Œ éšè—å­—æ®µ : ç”¨æ¥åˆ¤æ–­å½“å‰ç‰ˆæœ¬æ•°æ®çš„å¯è§æ€§ã€‚

å…³äº InnoDB å¯¹ MVCC çš„å…·ä½“å®ç°å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[InnoDB å­˜å‚¨å¼•æ“å¯¹ MVCC çš„å®ç°](https://javaguide.cn/database/mysql/innodb-implementation-of-mvcc.html) ã€‚

### SQL æ ‡å‡†å®šä¹‰äº†å“ªäº›äº‹åŠ¡éš”ç¦»çº§åˆ«?

SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š

- **READ-UNCOMMITTED(è¯»å–æœªæäº¤)** ï¼š æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚
- **READ-COMMITTED(è¯»å–å·²æäº¤)** ï¼š å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚
- **REPEATABLE-READ(å¯é‡å¤è¯»)** ï¼š å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚
- **SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)** ï¼š æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚

---

|     éš”ç¦»çº§åˆ«     | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| :--------------: | :--: | :--------: | :--: |
| READ-UNCOMMITTED |  âˆš   |     âˆš      |  âˆš   |
|  READ-COMMITTED  |  Ã—   |     âˆš      |  âˆš   |
| REPEATABLE-READ  |  Ã—   |     Ã—      |  âˆš   |
|   SERIALIZABLE   |  Ã—   |     Ã—      |  Ã—   |

### MySQL çš„éš”ç¦»çº§åˆ«æ˜¯åŸºäºé”å®ç°çš„å—ï¼Ÿ

MySQL çš„éš”ç¦»çº§åˆ«åŸºäºé”å’Œ MVCC æœºåˆ¶å…±åŒå®ç°çš„ã€‚

SERIALIZABLE éš”ç¦»çº§åˆ«æ˜¯é€šè¿‡é”æ¥å®ç°çš„ï¼ŒREAD-COMMITTED å’Œ REPEATABLE-READ éš”ç¦»çº§åˆ«æ˜¯åŸºäº MVCC å®ç°çš„ã€‚ä¸è¿‡ï¼Œ SERIALIZABLE ä¹‹å¤–çš„å…¶ä»–éš”ç¦»çº§åˆ«å¯èƒ½ä¹Ÿéœ€è¦ç”¨åˆ°é”æœºåˆ¶ï¼Œå°±æ¯”å¦‚ REPEATABLE-READ åœ¨å½“å‰è¯»æƒ…å†µä¸‹éœ€è¦ä½¿ç”¨åŠ é”è¯»æ¥ä¿è¯ä¸ä¼šå‡ºç°å¹»è¯»ã€‚

### MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ?

MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰**ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`SELECT @@tx_isolation;`å‘½ä»¤æ¥æŸ¥çœ‹ï¼ŒMySQL 8.0 è¯¥å‘½ä»¤æ”¹ä¸º`SELECT @@transaction_isolation;`

```sql
mysql> SELECT @@tx_isolation;
+-----------------+
| @@tx_isolation  |
+-----------------+
| REPEATABLE-READ |
+-----------------+
```

å…³äº MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£](https://javaguide.cn/database/mysql/transaction-isolation-level.html)ã€‚

## MySQL é”

é”æ˜¯ä¸€ç§å¸¸è§çš„å¹¶å‘äº‹åŠ¡çš„æ§åˆ¶æ–¹å¼ã€‚

### è¡¨çº§é”å’Œè¡Œçº§é”äº†è§£å—ï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

MyISAM ä»…ä»…æ”¯æŒè¡¨çº§é”(table-level locking)ï¼Œä¸€é”å°±é”æ•´å¼ è¡¨ï¼Œè¿™åœ¨å¹¶å‘å†™çš„æƒ…å†µä¸‹æ€§éå¸¸å·®ã€‚InnoDB ä¸å…‰æ”¯æŒè¡¨çº§é”(table-level locking)ï¼Œè¿˜æ”¯æŒè¡Œçº§é”(row-level locking)ï¼Œé»˜è®¤ä¸ºè¡Œçº§é”ã€‚

è¡Œçº§é”çš„ç²’åº¦æ›´å°ï¼Œä»…å¯¹ç›¸å…³çš„è®°å½•ä¸Šé”å³å¯ï¼ˆå¯¹ä¸€è¡Œæˆ–è€…å¤šè¡Œè®°å½•åŠ é”ï¼‰ï¼Œæ‰€ä»¥å¯¹äºå¹¶å‘å†™å…¥æ“ä½œæ¥è¯´ï¼Œ InnoDB çš„æ€§èƒ½æ›´é«˜ã€‚

**è¡¨çº§é”å’Œè¡Œçº§é”å¯¹æ¯”** ï¼š

- **è¡¨çº§é”ï¼š** MySQL ä¸­é”å®šç²’åº¦æœ€å¤§çš„ä¸€ç§é”ï¼ˆå…¨å±€é”é™¤å¤–ï¼‰ï¼Œæ˜¯é’ˆå¯¹éç´¢å¼•å­—æ®µåŠ çš„é”ï¼Œå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—ä¹Ÿæ¯”è¾ƒå°‘ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šå‡ºç°æ­»é”ã€‚ä¸è¿‡ï¼Œè§¦å‘é”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œé«˜å¹¶å‘ä¸‹æ•ˆç‡æä½ã€‚è¡¨çº§é”å’Œå­˜å‚¨å¼•æ“æ— å…³ï¼ŒMyISAM å’Œ InnoDB å¼•æ“éƒ½æ”¯æŒè¡¨çº§é”ã€‚
- **è¡Œçº§é”ï¼š** MySQL ä¸­é”å®šç²’åº¦æœ€å°çš„ä¸€ç§é”ï¼Œæ˜¯ **é’ˆå¯¹ç´¢å¼•å­—æ®µåŠ çš„é”** ï¼Œåªé’ˆå¯¹å½“å‰æ“ä½œçš„è¡Œè®°å½•è¿›è¡ŒåŠ é”ã€‚ è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œå¹¶å‘åº¦é«˜ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‡ºç°æ­»é”ã€‚è¡Œçº§é”å’Œå­˜å‚¨å¼•æ“æœ‰å…³ï¼Œæ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚é¢å®ç°çš„ã€‚

### è¡Œçº§é”çš„ä½¿ç”¨æœ‰ä»€ä¹ˆæ³¨æ„äº‹é¡¹ï¼Ÿ

InnoDB çš„è¡Œé”æ˜¯é’ˆå¯¹ç´¢å¼•å­—æ®µåŠ çš„é”ï¼Œè¡¨çº§é”æ˜¯é’ˆå¯¹éç´¢å¼•å­—æ®µåŠ çš„é”ã€‚å½“æˆ‘ä»¬æ‰§è¡Œ `UPDATE`ã€`DELETE` è¯­å¥æ—¶ï¼Œå¦‚æœ `WHERE`æ¡ä»¶ä¸­å­—æ®µæ²¡æœ‰å‘½ä¸­å”¯ä¸€ç´¢å¼•æˆ–è€…ç´¢å¼•å¤±æ•ˆçš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ‰«æå…¨è¡¨å¯¹è¡¨ä¸­çš„æ‰€æœ‰è¡Œè®°å½•è¿›è¡ŒåŠ é”ã€‚è¿™ä¸ªåœ¨æˆ‘ä»¬æ—¥å¸¸å·¥ä½œå¼€å‘ä¸­ç»å¸¸ä¼šé‡åˆ°ï¼Œä¸€å®šè¦å¤šå¤šæ³¨æ„ï¼ï¼ï¼

ä¸è¿‡ï¼Œå¾ˆå¤šæ—¶å€™å³ä½¿ç”¨äº†ç´¢å¼•ä¹Ÿæœ‰å¯èƒ½ä¼šèµ°å…¨è¡¨æ‰«æï¼Œè¿™æ˜¯å› ä¸º MySQL ä¼˜åŒ–å™¨çš„åŸå› ã€‚

### InnoDB æœ‰å“ªå‡ ç±»è¡Œé”ï¼Ÿ

InnoDB è¡Œé”æ˜¯é€šè¿‡å¯¹ç´¢å¼•æ•°æ®é¡µä¸Šçš„è®°å½•åŠ é”å®ç°çš„ï¼ŒMySQL InnoDB æ”¯æŒä¸‰ç§è¡Œé”å®šæ–¹å¼ï¼š

- **è®°å½•é”ï¼ˆRecord Lockï¼‰** ï¼šä¹Ÿè¢«ç§°ä¸ºè®°å½•é”ï¼Œå±äºå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”ã€‚
- **é—´éš™é”ï¼ˆGap Lockï¼‰** ï¼šé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸åŒ…æ‹¬è®°å½•æœ¬èº«ã€‚
- **ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰** ï¼šRecord Lock+Gap Lockï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº«ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ˆMySQL äº‹åŠ¡éƒ¨åˆ†æåˆ°è¿‡ï¼‰ã€‚è®°å½•é”åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è®°å½•ï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è®°å½•ï¼Œéœ€è¦ä¾èµ–é—´éš™é”ã€‚

**åœ¨ InnoDB é»˜è®¤çš„éš”ç¦»çº§åˆ« REPEATABLE-READ ä¸‹ï¼Œè¡Œé”é»˜è®¤ä½¿ç”¨çš„æ˜¯ Next-Key Lockã€‚ä½†æ˜¯ï¼Œå¦‚æœæ“ä½œçš„ç´¢å¼•æ˜¯å”¯ä¸€ç´¢å¼•æˆ–ä¸»é”®ï¼ŒInnoDB ä¼šå¯¹ Next-Key Lock è¿›è¡Œä¼˜åŒ–ï¼Œå°†å…¶é™çº§ä¸º Record Lockï¼Œå³ä»…é”ä½ç´¢å¼•æœ¬èº«ï¼Œè€Œä¸æ˜¯èŒƒå›´ã€‚**

ä¸€äº›å¤§å‚é¢è¯•ä¸­å¯èƒ½ä¼šé—®åˆ° Next-Key Lock çš„åŠ é”èŒƒå›´ï¼Œè¿™é‡Œæ¨èä¸€ç¯‡æ–‡ç« ï¼š[MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ - ç¨‹åºå‘˜å°èˆª - 2021](https://segmentfault.com/a/1190000040129107) ã€‚

### å…±äº«é”å’Œæ’ä»–é”å‘¢ï¼Ÿ

ä¸è®ºæ˜¯è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é”ï¼Œéƒ½å­˜åœ¨å…±äº«é”ï¼ˆShare Lockï¼ŒS é”ï¼‰å’Œæ’ä»–é”ï¼ˆExclusive Lockï¼ŒX é”ï¼‰è¿™ä¸¤ç±»ï¼š

- **å…±äº«é”ï¼ˆS é”ï¼‰** ï¼šåˆç§°è¯»é”ï¼Œäº‹åŠ¡åœ¨è¯»å–è®°å½•çš„æ—¶å€™è·å–å…±äº«é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ï¼ˆé”å…¼å®¹ï¼‰ã€‚
- **æ’ä»–é”ï¼ˆX é”ï¼‰** ï¼šåˆç§°å†™é”/ç‹¬å é”ï¼Œäº‹åŠ¡åœ¨ä¿®æ”¹è®°å½•çš„æ—¶å€™è·å–æ’ä»–é”ï¼Œä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ã€‚å¦‚æœä¸€ä¸ªè®°å½•å·²ç»è¢«åŠ äº†æ’ä»–é”ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¸èƒ½å†å¯¹è¿™æ¡äº‹åŠ¡åŠ ä»»ä½•ç±»å‹çš„é”ï¼ˆé”ä¸å…¼å®¹ï¼‰ã€‚

æ’ä»–é”ä¸ä»»ä½•çš„é”éƒ½ä¸å…¼å®¹ï¼Œå…±äº«é”ä»…å’Œå…±äº«é”å…¼å®¹ã€‚

|      | S é”   | X é” |
| :--- | :----- | :--- |
| S é” | ä¸å†²çª | å†²çª |
| X é” | å†²çª   | å†²çª |

ç”±äº MVCC çš„å­˜åœ¨ï¼Œå¯¹äºä¸€èˆ¬çš„ `SELECT` è¯­å¥ï¼ŒInnoDB ä¸ä¼šåŠ ä»»ä½•é”ã€‚ä¸è¿‡ï¼Œ ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æ˜¾å¼åŠ å…±äº«é”æˆ–æ’ä»–é”ã€‚

```sql
# å…±äº«é”
SELECT ... LOCK IN SHARE MODE;
# æ’ä»–é”
SELECT ... FOR UPDATE;
```

### æ„å‘é”æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

å¦‚æœéœ€è¦ç”¨åˆ°è¡¨é”çš„è¯ï¼Œå¦‚ä½•åˆ¤æ–­è¡¨ä¸­çš„è®°å½•æ²¡æœ‰è¡Œé”å‘¢ï¼Œä¸€è¡Œä¸€è¡Œéå†è‚¯å®šæ˜¯ä¸è¡Œï¼Œæ€§èƒ½å¤ªå·®ã€‚æˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªå«åšæ„å‘é”çš„ä¸œä¸œæ¥å¿«é€Ÿåˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹æŸä¸ªè¡¨ä½¿ç”¨è¡¨é”ã€‚

æ„å‘é”æ˜¯è¡¨çº§é”ï¼Œå…±æœ‰ä¸¤ç§ï¼š

- **æ„å‘å…±äº«é”ï¼ˆIntention Shared Lockï¼ŒIS é”ï¼‰**ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è®°å½•åŠ å…±äº«é”ï¼ˆS é”ï¼‰ï¼ŒåŠ å…±äº«é”å‰å¿…é¡»å…ˆå–å¾—è¯¥è¡¨çš„ IS é”ã€‚
- **æ„å‘æ’ä»–é”ï¼ˆIntention Exclusive Lockï¼ŒIX é”ï¼‰**ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è®°å½•åŠ æ’ä»–é”ï¼ˆX é”ï¼‰ï¼ŒåŠ æ’ä»–é”ä¹‹å‰å¿…é¡»å…ˆå–å¾—è¯¥è¡¨çš„ IX é”ã€‚

**æ„å‘é”æ˜¯æœ‰æ•°æ®å¼•æ“è‡ªå·±ç»´æŠ¤çš„ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œæ„å‘é”ï¼Œåœ¨ä¸ºæ•°æ®è¡ŒåŠ å…±äº«/æ’ä»–é”ä¹‹å‰ï¼ŒInooDB ä¼šå…ˆè·å–è¯¥æ•°æ®è¡Œæ‰€åœ¨åœ¨æ•°æ®è¡¨çš„å¯¹åº”æ„å‘é”ã€‚**

æ„å‘é”ä¹‹é—´æ˜¯äº’ç›¸å…¼å®¹çš„ã€‚

|       | IS é” | IX é” |
| ----- | ----- | ----- |
| IS é” | å…¼å®¹  | å…¼å®¹  |
| IX é” | å…¼å®¹  | å…¼å®¹  |

æ„å‘é”å’Œå…±äº«é”å’Œæ’å®ƒé”äº’æ–¥ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯è¡¨çº§åˆ«çš„å…±äº«é”å’Œæ’ä»–é”ï¼Œæ„å‘é”ä¸ä¼šä¸è¡Œçº§çš„å…±äº«é”å’Œæ’ä»–é”äº’æ–¥ï¼‰ã€‚

|      | IS é” | IX é” |
| ---- | ----- | ----- |
| S é” | å…¼å®¹  | äº’æ–¥  |
| X é” | äº’æ–¥  | äº’æ–¥  |

ã€ŠMySQL æŠ€æœ¯å†…å¹• InnoDB å­˜å‚¨å¼•æ“ã€‹è¿™æœ¬ä¹¦å¯¹åº”çš„æè¿°åº”è¯¥æ˜¯ç¬”è¯¯äº†ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/image-20220511171419081.png)

### å½“å‰è¯»å’Œå¿«ç…§è¯»æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å¿«ç…§è¯»**ï¼ˆä¸€è‡´æ€§éé”å®šè¯»ï¼‰å°±æ˜¯å•çº¯çš„ `SELECT` è¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬ä¸‹é¢è¿™ä¸¤ç±» `SELECT` è¯­å¥ï¼š

```sql
SELECT ... FOR UPDATE
SELECT ... LOCK IN SHARE MODE
```

å¿«ç…§å³è®°å½•çš„å†å²ç‰ˆæœ¬ï¼Œæ¯è¡Œè®°å½•å¯èƒ½å­˜åœ¨å¤šä¸ªå†å²ç‰ˆæœ¬ï¼ˆå¤šç‰ˆæœ¬æŠ€æœ¯ï¼‰ã€‚

å¿«ç…§è¯»çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¯»å–çš„è®°å½•æ­£åœ¨æ‰§è¡Œ UPDATE/DELETE æ“ä½œï¼Œè¯»å–æ“ä½œä¸ä¼šå› æ­¤å»ç­‰å¾…è®°å½•ä¸Š X é”çš„é‡Šæ”¾ï¼Œè€Œæ˜¯ä¼šå»è¯»å–è¡Œçš„ä¸€ä¸ªå¿«ç…§ã€‚

åªæœ‰åœ¨äº‹åŠ¡éš”ç¦»çº§åˆ« RC(è¯»å–å·²æäº¤) å’Œ RRï¼ˆå¯é‡è¯»ï¼‰ä¸‹ï¼ŒInnoDB æ‰ä¼šä½¿ç”¨ä¸€è‡´æ€§éé”å®šè¯»ï¼š

- åœ¨ RC çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œä¸€è‡´æ€§éé”å®šè¯»æ€»æ˜¯è¯»å–è¢«é”å®šè¡Œçš„æœ€æ–°ä¸€ä»½å¿«ç…§æ•°æ®ã€‚
- åœ¨ RR çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œä¸€è‡´æ€§éé”å®šè¯»æ€»æ˜¯è¯»å–æœ¬äº‹åŠ¡å¼€å§‹æ—¶çš„è¡Œæ•°æ®ç‰ˆæœ¬ã€‚

å¿«ç…§è¯»æ¯”è¾ƒé€‚åˆå¯¹äºæ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ä¸”è¿½æ±‚æè‡´æ€§èƒ½çš„ä¸šåŠ¡åœºæ™¯ã€‚

**å½“å‰è¯»** ï¼ˆä¸€è‡´æ€§é”å®šè¯»ï¼‰å°±æ˜¯ç»™è¡Œè®°å½•åŠ  X é”æˆ– S é”ã€‚

å½“å‰è¯»çš„ä¸€äº›å¸¸è§ SQL è¯­å¥ç±»å‹å¦‚ä¸‹ï¼š

```sql
# å¯¹è¯»çš„è®°å½•åŠ ä¸€ä¸ªXé”
SELECT...FOR UPDATE
# å¯¹è¯»çš„è®°å½•åŠ ä¸€ä¸ªSé”
SELECT...LOCK IN SHARE MODE
# å¯¹ä¿®æ”¹çš„è®°å½•åŠ ä¸€ä¸ªXé”
INSERT...
UPDATE...
DELETE...
```

### è‡ªå¢é”æœ‰äº†è§£å—ï¼Ÿ

> ä¸å¤ªé‡è¦çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œç®€å•äº†è§£å³å¯ã€‚

å…³ç³»å‹æ•°æ®åº“è®¾è®¡è¡¨çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šæœ‰ä¸€åˆ—ä½œä¸ºè‡ªå¢ä¸»é”®ã€‚InnoDB ä¸­çš„è‡ªå¢ä¸»é”®ä¼šæ¶‰åŠä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„è¡¨çº§é”â€” **è‡ªå¢é”ï¼ˆAUTO-INC Locksï¼‰** ã€‚

```sql
CREATE TABLE `sequence_id` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `stub` char(10) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  UNIQUE KEY `stub` (`stub`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

æ›´å‡†ç¡®ç‚¹æ¥è¯´ï¼Œä¸ä»…ä»…æ˜¯è‡ªå¢ä¸»é”®ï¼Œ`AUTO_INCREMENT`çš„åˆ—éƒ½ä¼šæ¶‰åŠåˆ°è‡ªå¢é”ï¼Œæ¯•ç«Ÿéä¸»é”®ä¹Ÿå¯ä»¥è®¾ç½®è‡ªå¢é•¿ã€‚

å¦‚æœä¸€ä¸ªäº‹åŠ¡æ­£åœ¨æ’å…¥æ•°æ®åˆ°æœ‰è‡ªå¢åˆ—çš„è¡¨æ—¶ï¼Œä¼šå…ˆè·å–è‡ªå¢é”ï¼Œæ‹¿ä¸åˆ°å°±å¯èƒ½ä¼šè¢«é˜»å¡ä½ã€‚è¿™é‡Œçš„é˜»å¡è¡Œä¸ºåªæ˜¯è‡ªå¢é”è¡Œä¸ºçš„å…¶ä¸­ä¸€ç§ï¼Œå¯ä»¥ç†è§£ä¸ºè‡ªå¢é”å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å…·ä½“çš„å®ç°æœ‰å¤šç§ã€‚å…·ä½“çš„é…ç½®é¡¹ä¸º `innodb_autoinc_lock_mode` ï¼ˆMySQL 5.1.22 å¼•å…¥ï¼‰ï¼Œå¯ä»¥é€‰æ‹©çš„å€¼å¦‚ä¸‹ï¼š

| innodb_autoinc_lock_mode | ä»‹ç»                           |
| :----------------------- | :----------------------------- |
| 0                        | ä¼ ç»Ÿæ¨¡å¼                       |
| 1                        | è¿ç»­æ¨¡å¼ï¼ˆMySQL 8.0 ä¹‹å‰é»˜è®¤ï¼‰ |
| 2                        | äº¤é”™æ¨¡å¼(MySQL 8.0 ä¹‹åé»˜è®¤)   |

äº¤é”™æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„â€œINSERT-LIKEâ€è¯­å¥ï¼ˆæ‰€æœ‰çš„æ’å…¥è¯­å¥ï¼ŒåŒ…æ‹¬ï¼š `INSERT`ã€`REPLACE`ã€`INSERTâ€¦SELECT`ã€`REPLACEâ€¦SELECT`ã€`LOAD DATA`ç­‰ï¼‰éƒ½ä¸ä½¿ç”¨è¡¨çº§é”ï¼Œä½¿ç”¨çš„æ˜¯è½»é‡çº§äº’æ–¥é”å®ç°ï¼Œå¤šæ¡æ’å…¥è¯­å¥å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæ‰©å±•æ€§ä¹Ÿæ›´å¥½ã€‚

ä¸è¿‡ï¼Œå¦‚æœä½ çš„ MySQL æ•°æ®åº“æœ‰ä¸»ä»åŒæ­¥éœ€æ±‚å¹¶ä¸” Binlog å­˜å‚¨æ ¼å¼ä¸º Statement çš„è¯ï¼Œä¸è¦å°† InnoDB è‡ªå¢é”æ¨¡å¼è®¾ç½®ä¸ºäº¤å‰æ¨¡å¼ï¼Œä¸ç„¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™æ˜¯å› ä¸ºå¹¶å‘æƒ…å†µä¸‹æ’å…¥è¯­å¥çš„æ‰§è¡Œé¡ºåºå°±æ— æ³•å¾—åˆ°ä¿éšœã€‚

> å¦‚æœ MySQL é‡‡ç”¨çš„æ ¼å¼ä¸º Statement ï¼Œé‚£ä¹ˆ MySQL çš„ä¸»ä»åŒæ­¥å®é™…ä¸ŠåŒæ­¥çš„å°±æ˜¯ä¸€æ¡ä¸€æ¡çš„ SQL è¯­å¥ã€‚

æœ€åï¼Œå†æ¨èä¸€ç¯‡æ–‡ç« ï¼š [ä¸ºä»€ä¹ˆ MySQL çš„è‡ªå¢ä¸»é”®ä¸å•è°ƒä¹Ÿä¸è¿ç»­](https://draveness.me/whys-the-design-mysql-auto-increment/) ã€‚

## MySQL æ€§èƒ½ä¼˜åŒ–

å…³äº MySQL æ€§èƒ½ä¼˜åŒ–çš„å»ºè®®æ€»ç»“ï¼Œè¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[MySQL é«˜æ€§èƒ½ä¼˜åŒ–è§„èŒƒå»ºè®®æ€»ç»“](./mysql-high-performance-optimization-specification-recommendations.md) ã€‚

### èƒ½ç”¨ MySQL ç›´æ¥å­˜å‚¨æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ï¼‰å—ï¼Ÿ

å¯ä»¥æ˜¯å¯ä»¥ï¼Œç›´æ¥å­˜å‚¨æ–‡ä»¶å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®å³å¯ã€‚ä¸è¿‡ï¼Œè¿˜æ˜¯å»ºè®®ä¸è¦åœ¨æ•°æ®åº“ä¸­å­˜å‚¨æ–‡ä»¶ï¼Œä¼šä¸¥é‡å½±å“æ•°æ®åº“æ€§èƒ½ï¼Œæ¶ˆè€—è¿‡å¤šå­˜å‚¨ç©ºé—´ã€‚

å¯ä»¥é€‰æ‹©ä½¿ç”¨äº‘æœåŠ¡å‚å•†æä¾›çš„å¼€ç®±å³ç”¨çš„æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼Œæˆç†Ÿç¨³å®šï¼Œä»·æ ¼ä¹Ÿæ¯”è¾ƒä½ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/mysql/oss-search.png)

ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå»ºæ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼Œå®ç°èµ·æ¥ä¹Ÿä¸éš¾ï¼ŒåŸºäº FastDFSã€MinIOï¼ˆæ¨èï¼‰ ç­‰å¼€æºé¡¹ç›®å°±å¯ä»¥å®ç°åˆ†å¸ƒå¼æ–‡ä»¶æœåŠ¡ã€‚

**æ•°æ®åº“åªå­˜å‚¨æ–‡ä»¶åœ°å€ä¿¡æ¯ï¼Œæ–‡ä»¶ç”±æ–‡ä»¶å­˜å‚¨æœåŠ¡è´Ÿè´£å­˜å‚¨ã€‚**

ç›¸å…³é˜…è¯»ï¼š[Spring Boot æ•´åˆ MinIO å®ç°åˆ†å¸ƒå¼æ–‡ä»¶æœåŠ¡](https://www.51cto.com/article/716978.html) ã€‚

### MySQL å¦‚ä½•å­˜å‚¨ IP åœ°å€ï¼Ÿ

å¯ä»¥å°† IP åœ°å€è½¬æ¢æˆæ•´å½¢æ•°æ®å­˜å‚¨ï¼Œæ€§èƒ½æ›´å¥½ï¼Œå ç”¨ç©ºé—´ä¹Ÿæ›´å°ã€‚

MySQL æä¾›äº†ä¸¤ä¸ªæ–¹æ³•æ¥å¤„ç† ip åœ°å€

- `INET_ATON()` ï¼š æŠŠ ip è½¬ä¸ºæ— ç¬¦å·æ•´å‹ (4-8 ä½)
- `INET_NTOA()` :æŠŠæ•´å‹çš„ ip è½¬ä¸ºåœ°å€

æ’å…¥æ•°æ®å‰ï¼Œå…ˆç”¨ `INET_ATON()` æŠŠ ip åœ°å€è½¬ä¸ºæ•´å‹ï¼Œæ˜¾ç¤ºæ•°æ®æ—¶ï¼Œä½¿ç”¨ `INET_NTOA()` æŠŠæ•´å‹çš„ ip åœ°å€è½¬ä¸ºåœ°å€æ˜¾ç¤ºå³å¯ã€‚

### æœ‰å“ªäº›å¸¸è§çš„ SQL ä¼˜åŒ–æ‰‹æ®µï¼Ÿ

[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹(ä»˜è´¹)](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ **ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€** æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†å¸¸è§çš„ SQL ä¼˜åŒ–æ‰‹æ®µï¼Œéå¸¸å…¨é¢ï¼Œæ¸…æ™°æ˜“æ‡‚ï¼

![å¸¸è§çš„ SQL ä¼˜åŒ–æ‰‹æ®µ](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javamianshizhibei/javamianshizhibei-sql-optimization.png)

### å¦‚ä½•åˆ†æ SQL çš„æ€§èƒ½ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `EXPLAIN` å‘½ä»¤æ¥åˆ†æ SQL çš„ **æ‰§è¡Œè®¡åˆ’** ã€‚æ‰§è¡Œè®¡åˆ’æ˜¯æŒ‡ä¸€æ¡ SQL è¯­å¥åœ¨ç»è¿‡ MySQL æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä¼˜åŒ–ä¼šåï¼Œå…·ä½“çš„æ‰§è¡Œæ–¹å¼ã€‚

`EXPLAIN` å¹¶ä¸ä¼šçœŸçš„å»æ‰§è¡Œç›¸å…³çš„è¯­å¥ï¼Œè€Œæ˜¯é€šè¿‡ **æŸ¥è¯¢ä¼˜åŒ–å™¨** å¯¹è¯­å¥è¿›è¡Œåˆ†æï¼Œæ‰¾å‡ºæœ€ä¼˜çš„æŸ¥è¯¢æ–¹æ¡ˆï¼Œå¹¶æ˜¾ç¤ºå¯¹åº”çš„ä¿¡æ¯ã€‚

`EXPLAIN` é€‚ç”¨äº `SELECT`, `DELETE`, `INSERT`, `REPLACE`, å’Œ `UPDATE`è¯­å¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬åˆ†æ `SELECT` æŸ¥è¯¢è¾ƒå¤šã€‚

æˆ‘ä»¬è¿™é‡Œç®€å•æ¥æ¼”ç¤ºä¸€ä¸‹ `EXPLAIN` çš„ä½¿ç”¨ã€‚

`EXPLAIN` çš„è¾“å‡ºæ ¼å¼å¦‚ä¸‹ï¼š

```sql
mysql> EXPLAIN SELECT `score`,`name` FROM `cus_order` ORDER BY `score` DESC;
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+----------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra          |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+----------------+
|  1 | SIMPLE      | cus_order | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 997572 |   100.00 | Using filesort |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+----------------+
1 row in set, 1 warning (0.00 sec)
```

å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š

| **åˆ—å**      | **å«ä¹‰**                                     |
| ------------- | -------------------------------------------- |
| id            | SELECT æŸ¥è¯¢çš„åºåˆ—æ ‡è¯†ç¬¦                      |
| select_type   | SELECT å…³é”®å­—å¯¹åº”çš„æŸ¥è¯¢ç±»å‹                  |
| table         | ç”¨åˆ°çš„è¡¨å                                   |
| partitions    | åŒ¹é…çš„åˆ†åŒºï¼Œå¯¹äºæœªåˆ†åŒºçš„è¡¨ï¼Œå€¼ä¸º NULL        |
| type          | è¡¨çš„è®¿é—®æ–¹æ³•                                 |
| possible_keys | å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•                               |
| key           | å®é™…ç”¨åˆ°çš„ç´¢å¼•                               |
| key_len       | æ‰€é€‰ç´¢å¼•çš„é•¿åº¦                               |
| ref           | å½“ä½¿ç”¨ç´¢å¼•ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¸ç´¢å¼•ä½œæ¯”è¾ƒçš„åˆ—æˆ–å¸¸é‡ |
| rows          | é¢„è®¡è¦è¯»å–çš„è¡Œæ•°                             |
| filtered      | æŒ‰è¡¨æ¡ä»¶è¿‡æ»¤åï¼Œç•™å­˜çš„è®°å½•æ•°çš„ç™¾åˆ†æ¯”         |
| Extra         | é™„åŠ ä¿¡æ¯                                     |

ç¯‡å¹…é—®é¢˜ï¼Œæˆ‘è¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»äº†ä¸€ä¸‹ MySQL æ‰§è¡Œè®¡åˆ’ï¼Œè¯¦ç»†ä»‹ç»è¯·çœ‹ï¼š[SQL çš„æ‰§è¡Œè®¡åˆ’](https://javaguide.cn/database/mysql/mysql-query-execution-plan.html)è¿™ç¯‡æ–‡ç« ã€‚

### è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨äº†è§£å—ï¼Ÿ

è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œäºæ˜¯ï¼Œæˆ‘å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»ï¼š [è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨è¯¦è§£](https://javaguide.cn/high-performance/read-and-write-separation-and-library-subtable.html)ã€‚

## MySQL å­¦ä¹ èµ„æ–™æ¨è

**ä¹¦ç±æ¨è** ï¼šå‚è§ï¼š[https://javaguide.cn/books/database.html#mysql](https://javaguide.cn/books/database.html#mysql) ã€‚

**æ–‡ç« æ¨è** :

- [ä¸€æ ‘ä¸€æºªçš„ MySQL ç³»åˆ—æ•™ç¨‹](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3NTc3NjM4Nw==&action=getalbum&album_id=2372043523518300162&scene=173&from_msgid=2247484308&from_itemidx=1&count=3&nolastread=1#wechat_redirect)
- [Yes çš„ MySQL ç³»åˆ—æ•™ç¨‹](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzkxNTE3NjQ3MA==&action=getalbum&album_id=1903249596194095112&scene=173&from_msgid=2247490365&from_itemidx=1&count=3&nolastread=1#wechat_redirect)
- [å†™å®Œè¿™ç¯‡ æˆ‘çš„SQLä¼˜åŒ–èƒ½åŠ›ç›´æ¥è¿›å…¥æ–°å±‚æ¬¡ - å˜æˆæ´¾å¤§æ˜Ÿ - 2022](https://juejin.cn/post/7161964571853815822)
- [ä¸¤ä¸‡å­—è¯¦è§£ï¼InnoDB é”ä¸“é¢˜ï¼ - æ¡ç”°èºçš„å°ç”·å­© - 2022](https://juejin.cn/post/7094049650428084232)
- [MySQL çš„è‡ªå¢ä¸»é”®ä¸€å®šæ˜¯è¿ç»­çš„å—ï¼Ÿ - é£å¤©å°ç‰›è‚‰ - 2022](https://mp.weixin.qq.com/s/qci10h9rJx_COZbHV3aygQ)
- [æ·±å…¥ç†è§£ MySQL ç´¢å¼•åº•å±‚åŸç† - è…¾è®¯æŠ€æœ¯å·¥ç¨‹ - 2020](https://zhuanlan.zhihu.com/p/113917726)

## å‚è€ƒ

- ã€Šé«˜æ€§èƒ½ MySQLã€‹ç¬¬ 7 ç«  MySQL é«˜çº§ç‰¹æ€§
- ã€ŠMySQL æŠ€æœ¯å†…å¹• InnoDB å­˜å‚¨å¼•æ“ã€‹ç¬¬ 6 ç«  é”
- Relational Databaseï¼šhttps://www.omnisci.com/technical-glossary/relational-database
- æŠ€æœ¯åˆ†äº« | éš”ç¦»çº§åˆ«ï¼šæ­£ç¡®ç†è§£å¹»è¯»ï¼šhttps://opensource.actionsky.com/20210818-mysql/
- MySQL Server Logs - MySQL 5.7 Reference Manualï¼šhttps://dev.mysql.com/doc/refman/5.7/en/server-logs.html
- Redo Log - MySQL 5.7 Reference Manualï¼šhttps://dev.mysql.com/doc/refman/5.7/en/innodb-redo-log.html
- Locking Reads - MySQL 5.7 Reference Manualï¼šhttps://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html
- æ·±å…¥ç†è§£æ•°æ®åº“è¡Œé”ä¸è¡¨é” https://zhuanlan.zhihu.com/p/52678870
- è¯¦è§£ MySQL InnoDB ä¸­æ„å‘é”çš„ä½œç”¨ï¼šhttps://juejin.cn/post/6844903666332368909
- æ·±å…¥å‰–æ MySQL è‡ªå¢é”ï¼šhttps://juejin.cn/post/6968420054287253540
- åœ¨æ•°æ®åº“ä¸­ä¸å¯é‡å¤è¯»å’Œå¹»è¯»åˆ°åº•åº”è¯¥æ€ä¹ˆåˆ†ï¼Ÿï¼šhttps://www.zhihu.com/question/392569386
