---
title: Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰
description: Javaå¹¶å‘è¿›é˜¶é¢è¯•é¢˜ï¼šæ·±å…¥è§£æsynchronizedä¸ReentrantLockåŒºåˆ«ã€volatileå¯è§æ€§ä¿è¯ã€JMMå†…å­˜æ¨¡å‹ã€happens-beforeåŸåˆ™ç­‰å¹¶å‘ç¼–ç¨‹æ ¸å¿ƒæœºåˆ¶ã€‚
category: Java
tag:
  - Javaå¹¶å‘
head:
  - - meta
    - name: keywords
      content: synchronized,ReentrantLock,volatile,JMM,happens-before,å¯è§æ€§,åŸå­æ€§,æœ‰åºæ€§,å¹¶å‘é¢è¯•é¢˜
---

<!-- @include: @article-header.snippet.md -->

## â­ï¸JMM(Java å†…å­˜æ¨¡å‹)

JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ JMM ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š[JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£](https://javaguide.cn/java/concurrent/jmm.html) ã€‚

## â­ï¸volatile å…³é”®å­—

### å¦‚ä½•ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Ÿ

åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œå¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

![JMM(Java å†…å­˜æ¨¡å‹)](https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm.png)

![JMM(Java å†…å­˜æ¨¡å‹)å¼ºåˆ¶åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å–](https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm2.png)

`volatile` å…³é”®å­—å…¶å®å¹¶éæ˜¯ Java è¯­è¨€ç‰¹æœ‰çš„ï¼Œåœ¨ C è¯­è¨€é‡Œä¹Ÿæœ‰ï¼Œå®ƒæœ€åŸå§‹çš„æ„ä¹‰å°±æ˜¯ç¦ç”¨ CPU ç¼“å­˜ã€‚å¦‚æœæˆ‘ä»¬å°†ä¸€ä¸ªå˜é‡ä½¿ç”¨ `volatile` ä¿®é¥°ï¼Œè¿™å°±æŒ‡ç¤º ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

`volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚

### å¦‚ä½•ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ

**åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—é™¤äº†å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯é˜²æ­¢ JVM çš„æŒ‡ä»¤é‡æ’åºã€‚** å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œåœ¨å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ’å…¥ç‰¹å®šçš„ **å†…å­˜å±éšœ** çš„æ–¹å¼æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚

åœ¨ Java ä¸­ï¼Œ`Unsafe` ç±»æä¾›äº†ä¸‰ä¸ªå¼€ç®±å³ç”¨çš„å†…å­˜å±éšœç›¸å…³çš„æ–¹æ³•ï¼Œå±è”½äº†æ“ä½œç³»ç»Ÿåº•å±‚çš„å·®å¼‚ï¼š

```java
public native void loadFence();
public native void storeFence();
public native void fullFence();
```

ç†è®ºä¸Šæ¥è¯´ï¼Œä½ é€šè¿‡è¿™ä¸ªä¸‰ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥å®ç°å’Œ`volatile`ç¦æ­¢é‡æ’åºä¸€æ ·çš„æ•ˆæœï¼Œåªæ˜¯ä¼šéº»çƒ¦ä¸€äº›ã€‚

ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ `volatile` å…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„æ•ˆæœã€‚

é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€

**åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**ï¼š

```java
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

`uniqueInstance` é‡‡ç”¨ `volatile` å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ `uniqueInstance = new Singleton();` è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š

1. ä¸º `uniqueInstance` åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ– `uniqueInstance`
3. å°† `uniqueInstance` æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1->3->2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ `getUniqueInstance`() åå‘ç° `uniqueInstance` ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› `uniqueInstance`ï¼Œä½†æ­¤æ—¶ `uniqueInstance` è¿˜æœªè¢«åˆå§‹åŒ–ã€‚

### volatile å¯ä»¥ä¿è¯åŸå­æ€§ä¹ˆï¼Ÿ

**`volatile` å…³é”®å­—èƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å¯¹å˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚**

æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä»£ç å³å¯è¯æ˜ï¼š

```java
/**
 * å¾®ä¿¡æœ JavaGuide å›å¤"é¢è¯•çªå‡»"å³å¯å…è´¹é¢†å–ä¸ªäººåŸåˆ›çš„ Java é¢è¯•æ‰‹å†Œ
 *
 * @author Guideå“¥
 * @date 2022/08/03 13:40
 **/
public class VolatileAtomicityDemo {
    public volatile static int inc = 0;

    public void increase() {
        inc++;
    }

    public static void main(String[] args) throws InterruptedException {
        ExecutorService threadPool = Executors.newFixedThreadPool(5);
        VolatileAtomicityDemo volatileAtomicityDemo = new VolatileAtomicityDemo();
        for (int i = 0; i < 5; i++) {
            threadPool.execute(() -> {
                for (int j = 0; j < 500; j++) {
                    volatileAtomicityDemo.increase();
                }
            });
        }
        // ç­‰å¾…1.5ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ
        Thread.sleep(1500);
        System.out.println(inc);
        threadPool.shutdown();
    }
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œä¸Šé¢çš„ä»£ç ç†åº”è¾“å‡º `2500`ã€‚ä½†ä½ çœŸæ­£è¿è¡Œäº†ä¸Šé¢çš„ä»£ç ä¹‹åï¼Œä½ ä¼šå‘ç°æ¯æ¬¡è¾“å‡ºç»“æœéƒ½å°äº `2500`ã€‚

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿä¸æ˜¯è¯´å¥½äº†ï¼Œ`volatile` å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§å˜›ï¼

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ `volatile` èƒ½ä¿è¯ `inc++` æ“ä½œçš„åŸå­æ€§çš„è¯ã€‚æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹ `inc` å˜é‡è‡ªå¢å®Œä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚5 ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº† 500 æ¬¡æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆ inc çš„å€¼åº”è¯¥æ˜¯ 5\*500=2500ã€‚

å¾ˆå¤šäººä¼šè¯¯è®¤ä¸ºè‡ªå¢æ“ä½œ `inc++` æ˜¯åŸå­æ€§çš„ï¼Œå®é™…ä¸Šï¼Œ`inc++` å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥ï¼š

1. è¯»å– inc çš„å€¼ã€‚
2. å¯¹ inc åŠ  1ã€‚
3. å°† inc çš„å€¼å†™å›å†…å­˜ã€‚

`volatile` æ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢è¿™ç§æƒ…å†µå‡ºç°ï¼š

1. çº¿ç¨‹ 1 å¯¹ `inc` è¿›è¡Œè¯»å–æ“ä½œä¹‹åï¼Œè¿˜æœªå¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚çº¿ç¨‹ 2 åˆè¯»å–äº† `inc`çš„å€¼å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚
2. çº¿ç¨‹ 2 æ“ä½œå®Œæ¯•åï¼Œçº¿ç¨‹ 1 å¯¹ `inc`çš„å€¼è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚

è¿™ä¹Ÿå°±å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹ `inc` è¿›è¡Œäº†ä¸€æ¬¡è‡ªå¢æ“ä½œåï¼Œ`inc` å®é™…ä¸Šåªå¢åŠ äº† 1ã€‚

å…¶å®ï¼Œå¦‚æœæƒ³è¦ä¿è¯ä¸Šé¢çš„ä»£ç è¿è¡Œæ­£ç¡®ä¹Ÿéå¸¸ç®€å•ï¼Œåˆ©ç”¨ `synchronized`ã€`Lock`æˆ–è€…`AtomicInteger`éƒ½å¯ä»¥ã€‚

ä½¿ç”¨ `synchronized` æ”¹è¿›ï¼š

```java
public synchronized void increase() {
    inc++;
}
```

ä½¿ç”¨ `AtomicInteger` æ”¹è¿›ï¼š

```java
public AtomicInteger inc = new AtomicInteger();

public void increase() {
    inc.getAndIncrement();
}
```

ä½¿ç”¨ `ReentrantLock` æ”¹è¿›ï¼š

```java
Lock lock = new ReentrantLock();
public void increase() {
    lock.lock();
    try {
        inc++;
    } finally {
        lock.unlock();
    }
}
```

## â­ï¸ä¹è§‚é”å’Œæ‚²è§‚é”

### ä»€ä¹ˆæ˜¯æ‚²è§‚é”ï¼Ÿ

æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜(æ¯”å¦‚å…±äº«æ•°æ®è¢«ä¿®æ”¹)ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è·å–èµ„æºæ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æƒ³æ‹¿åˆ°è¿™ä¸ªèµ„æºå°±ä¼šé˜»å¡ç›´åˆ°é”è¢«ä¸Šä¸€ä¸ªæŒæœ‰è€…é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹**ã€‚

åƒ Java ä¸­`synchronized`å’Œ`ReentrantLock`ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚

```java
public void performSynchronisedTask() {
    synchronized (this) {
        // éœ€è¦åŒæ­¥çš„æ“ä½œ
    }
}

private Lock lock = new ReentrantLock();
lock.lock();
try {
   // éœ€è¦åŒæ­¥çš„æ“ä½œ
} finally {
    lock.unlock();
}
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ¿€çƒˆçš„é”ç«äº‰ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œå¤§é‡é˜»å¡çº¿ç¨‹ä¼šå¯¼è‡´ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ã€‚å¹¶ä¸”ï¼Œæ‚²è§‚é”è¿˜å¯èƒ½ä¼šå­˜åœ¨æ­»é”é—®é¢˜ï¼Œå½±å“ä»£ç çš„æ­£å¸¸è¿è¡Œã€‚

### ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œçº¿ç¨‹å¯ä»¥ä¸åœåœ°æ‰§è¡Œï¼Œæ— éœ€åŠ é”ä¹Ÿæ— éœ€ç­‰å¾…ï¼Œåªæ˜¯åœ¨æäº¤ä¿®æ”¹çš„æ—¶å€™å»éªŒè¯å¯¹åº”çš„èµ„æºï¼ˆä¹Ÿå°±æ˜¯æ•°æ®ï¼‰æ˜¯å¦è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹äº†ï¼ˆå…·ä½“æ–¹æ³•å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•ï¼‰ã€‚

åœ¨ Java ä¸­`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼ˆæ¯”å¦‚`AtomicInteger`ã€`LongAdder`ï¼‰å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ **CAS** å®ç°çš„ã€‚
![JUCåŸå­ç±»æ¦‚è§ˆ](https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88-20230814005211968.png)

```java
// LongAdder åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šæ¯” AtomicInteger å’Œ AtomicLong çš„æ€§èƒ½æ›´å¥½
// ä»£ä»·å°±æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
LongAdder sum = new LongAdder();
sum.increment();
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚é”ç›¸æ¯”æ‚²è§‚é”æ¥è¯´ï¼Œä¸å­˜åœ¨é”ç«äº‰é€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¹Ÿä¸ä¼šæœ‰æ­»é”çš„é—®é¢˜ï¼Œåœ¨æ€§èƒ½ä¸Šå¾€å¾€ä¼šæ›´èƒœä¸€ç­¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœå†²çªé¢‘ç¹å‘ç”Ÿï¼ˆå†™å æ¯”éå¸¸å¤šçš„æƒ…å†µï¼‰ï¼Œä¼šé¢‘ç¹å¤±è´¥å’Œé‡è¯•ï¼Œè¿™æ ·åŒæ ·ä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œå¯¼è‡´ CPU é£™å‡ã€‚

ä¸è¿‡ï¼Œå¤§é‡å¤±è´¥é‡è¯•çš„é—®é¢˜ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„ï¼Œåƒæˆ‘ä»¬å‰é¢æåˆ°çš„ `LongAdder`ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

ç†è®ºä¸Šæ¥è¯´ï¼š

- æ‚²è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå¤šçš„æƒ…å†µï¼ˆå¤šå†™åœºæ™¯ï¼Œç«äº‰æ¿€çƒˆï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹å¤±è´¥å’Œé‡è¯•å½±å“æ€§èƒ½ï¼Œæ‚²è§‚é”çš„å¼€é”€æ˜¯å›ºå®šçš„ã€‚ä¸è¿‡ï¼Œå¦‚æœä¹è§‚é”è§£å†³äº†é¢‘ç¹å¤±è´¥å’Œé‡è¯•è¿™ä¸ªé—®é¢˜çš„è¯ï¼ˆæ¯”å¦‚`LongAdder`ï¼‰ï¼Œä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¹è§‚é”çš„ï¼Œè¦è§†å®é™…æƒ…å†µè€Œå®šã€‚
- ä¹è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µï¼ˆå¤šè¯»åœºæ™¯ï¼Œç«äº‰è¾ƒå°‘ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åŠ é”å½±å“æ€§èƒ½ã€‚ä¸è¿‡ï¼Œä¹è§‚é”ä¸»è¦é’ˆå¯¹çš„å¯¹è±¡æ˜¯å•ä¸ªå…±äº«å˜é‡ï¼ˆå‚è€ƒ`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼‰ã€‚

### å¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•å®ç°ï¼ŒCAS ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¤šä¸€äº›ï¼Œè¿™é‡Œéœ€è¦æ ¼å¤–æ³¨æ„ã€‚

#### ç‰ˆæœ¬å·æœºåˆ¶

ä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­åŠ ä¸Šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å· `version` å­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œ`version` å€¼ä¼šåŠ ä¸€ã€‚å½“çº¿ç¨‹ A è¦æ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å– `version` å€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°çš„ version å€¼ä¸ºå½“å‰æ•°æ®åº“ä¸­çš„ `version` å€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šå‡è®¾æ•°æ®åº“ä¸­å¸æˆ·ä¿¡æ¯è¡¨ä¸­æœ‰ä¸€ä¸ª version å­—æ®µï¼Œå½“å‰å€¼ä¸º 1 ï¼›è€Œå½“å‰å¸æˆ·ä½™é¢å­—æ®µï¼ˆ `balance` ï¼‰ä¸º \$100 ã€‚

1. æ“ä½œå‘˜ A æ­¤æ—¶å°†å…¶è¯»å‡ºï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $50ï¼ˆ $100-\$50 ï¼‰ã€‚
2. åœ¨æ“ä½œå‘˜ A æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæ“ä½œå‘˜ B ä¹Ÿè¯»å…¥æ­¤ç”¨æˆ·ä¿¡æ¯ï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $20 ï¼ˆ $100-\$20 ï¼‰ã€‚
3. æ“ä½œå‘˜ A å®Œæˆäº†ä¿®æ”¹å·¥ä½œï¼Œå°†æ•°æ®ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰ï¼Œè¿åŒå¸æˆ·æ‰£é™¤åä½™é¢ï¼ˆ `balance`=\$50 ï¼‰ï¼Œæäº¤è‡³æ•°æ®åº“æ›´æ–°ï¼Œæ­¤æ—¶ç”±äºæäº¤æ•°æ®ç‰ˆæœ¬ç­‰äºæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ï¼Œæ•°æ®è¢«æ›´æ–°ï¼Œæ•°æ®åº“è®°å½• `version` æ›´æ–°ä¸º 2 ã€‚
4. æ“ä½œå‘˜ B å®Œæˆäº†æ“ä½œï¼Œä¹Ÿå°†ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰è¯•å›¾å‘æ•°æ®åº“æäº¤æ•°æ®ï¼ˆ `balance`=\$80 ï¼‰ï¼Œä½†æ­¤æ—¶æ¯”å¯¹æ•°æ®åº“è®°å½•ç‰ˆæœ¬æ—¶å‘ç°ï¼Œæ“ä½œå‘˜ B æäº¤çš„æ•°æ®ç‰ˆæœ¬å·ä¸º 1 ï¼Œæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ä¹Ÿä¸º 2 ï¼Œä¸æ»¡è¶³ â€œ æäº¤ç‰ˆæœ¬å¿…é¡»ç­‰äºå½“å‰ç‰ˆæœ¬æ‰èƒ½æ‰§è¡Œæ›´æ–° â€œ çš„ä¹è§‚é”ç­–ç•¥ï¼Œå› æ­¤ï¼Œæ“ä½œå‘˜ B çš„æäº¤è¢«é©³å›ã€‚

è¿™æ ·å°±é¿å…äº†æ“ä½œå‘˜ B ç”¨åŸºäº `version`=1 çš„æ—§æ•°æ®ä¿®æ”¹çš„ç»“æœè¦†ç›–æ“ä½œå‘˜ A çš„æ“ä½œç»“æœçš„å¯èƒ½ã€‚

#### CAS ç®—æ³•

CAS çš„å…¨ç§°æ˜¯ **Compare And Swapï¼ˆæ¯”è¾ƒä¸äº¤æ¢ï¼‰** ï¼Œç”¨äºå®ç°ä¹è§‚é”ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„å¤§æ¡†æ¶ä¸­ã€‚CAS çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªé¢„æœŸå€¼å’Œè¦æ›´æ–°çš„å˜é‡å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸¤å€¼ç›¸ç­‰æ‰ä¼šè¿›è¡Œæ›´æ–°ã€‚

CAS æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œåº•å±‚ä¾èµ–äºä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ã€‚

> **åŸå­æ“ä½œ** å³æœ€å°ä¸å¯æ‹†åˆ†çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸èƒ½è¢«æ‰“æ–­ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚

CAS æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œæ•°ï¼š

- **V**ï¼šè¦æ›´æ–°çš„å˜é‡å€¼(Var)
- **E**ï¼šé¢„æœŸå€¼(Expected)
- **N**ï¼šæ‹Ÿå†™å…¥çš„æ–°å€¼(New)

å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº E æ—¶ï¼ŒCAS é€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼ N æ¥æ›´æ–° V çš„å€¼ã€‚å¦‚æœä¸ç­‰ï¼Œè¯´æ˜å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº† Vï¼Œåˆ™å½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šçº¿ç¨‹ A è¦ä¿®æ”¹å˜é‡ i çš„å€¼ä¸º 6ï¼Œi åŸå€¼ä¸º 1ï¼ˆV = 1ï¼ŒE=1ï¼ŒN=6ï¼Œå‡è®¾ä¸å­˜åœ¨ ABA é—®é¢˜ï¼‰ã€‚

1. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œ åˆ™è¯´æ˜æ²¡è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå¯ä»¥è¢«è®¾ç½®ä¸º 6 ã€‚
2. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ï¼ŒCAS æ“ä½œå¤±è´¥ã€‚

å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨ CAS æ“ä½œä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰ä¸€ä¸ªä¼šèƒœå‡ºï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œå…¶ä½™å‡ä¼šå¤±è´¥ï¼Œä½†å¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œä»…æ˜¯è¢«å‘ŠçŸ¥å¤±è´¥ï¼Œå¹¶ä¸”å…è®¸å†æ¬¡å°è¯•ï¼Œå½“ç„¶ä¹Ÿå…è®¸å¤±è´¥çš„çº¿ç¨‹æ”¾å¼ƒæ“ä½œã€‚

Java è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥å®ç° CASï¼ŒCAS ç›¸å…³çš„å®ç°æ˜¯é€šè¿‡ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼ˆJNI è°ƒç”¨ï¼‰ã€‚å› æ­¤ï¼Œ CAS çš„å…·ä½“å®ç°å’Œæ“ä½œç³»ç»Ÿä»¥åŠ CPU éƒ½æœ‰å…³ç³»ã€‚

`sun.misc`åŒ…ä¸‹çš„`Unsafe`ç±»æä¾›äº†`compareAndSwapObject`ã€`compareAndSwapInt`ã€`compareAndSwapLong`æ–¹æ³•æ¥å®ç°çš„å¯¹`Object`ã€`int`ã€`long`ç±»å‹çš„ CAS æ“ä½œ

```java
/**
  *  CAS
  * @param o         åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡
  * @param offset    å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡
  * @param expected  æœŸæœ›å€¼
  * @param update    æ›´æ–°å€¼
  * @return          true | false
  */
public final native boolean compareAndSwapObject(Object o, long offset,  Object expected, Object update);

public final native boolean compareAndSwapInt(Object o, long offset, int expected,int update);

public final native boolean compareAndSwapLong(Object o, long offset, long expected, long update);
```

å…³äº `Unsafe` ç±»çš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Java é­”æ³•ç±» Unsafe è¯¦è§£ - JavaGuide - 2022](https://javaguide.cn/java/basis/unsafe.html) ã€‚

### Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯`Unsafe`ã€‚

`Unsafe`ç±»ä½äº`sun.misc`åŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„ç±»ã€‚ç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåœ¨çš„å±é™©æ€§ï¼Œå®ƒé€šå¸¸ç”¨äº JVM å†…éƒ¨æˆ–ä¸€äº›éœ€è¦æé«˜æ€§èƒ½å’Œåº•å±‚è®¿é—®çš„åº“ä¸­ï¼Œè€Œä¸æ¨èæ™®é€šå¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å…³äº `Unsafe`ç±»çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼šğŸ“Œ[Java é­”æ³•ç±» Unsafe è¯¦è§£](https://javaguide.cn/java/basis/unsafe.html)ã€‚

`sun.misc`åŒ…ä¸‹çš„`Unsafe`ç±»æä¾›äº†`compareAndSwapObject`ã€`compareAndSwapInt`ã€`compareAndSwapLong`æ–¹æ³•æ¥å®ç°çš„å¯¹`Object`ã€`int`ã€`long`ç±»å‹çš„ CAS æ“ä½œï¼š

```java
/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–°å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 *
 * @param o        è¦æ“ä½œçš„å¯¹è±¡
 * @param offset   å¯¹è±¡å­—æ®µçš„å†…å­˜åç§»é‡
 * @param expected æœŸæœ›çš„æ—§å€¼
 * @param x        è¦è®¾ç½®çš„æ–°å€¼
 * @return å¦‚æœå€¼è¢«æˆåŠŸæ›´æ–°ï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false
 */
boolean compareAndSwapObject(Object o, long offset, Object expected, Object x);

/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° int ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */
boolean compareAndSwapInt(Object o, long offset, int expected, int x);

/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° long ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */
boolean compareAndSwapLong(Object o, long offset, long expected, long x);
```

`Unsafe`ç±»ä¸­çš„ CAS æ–¹æ³•æ˜¯`native`æ–¹æ³•ã€‚`native`å…³é”®å­—è¡¨æ˜è¿™äº›æ–¹æ³•æ˜¯ç”¨æœ¬åœ°ä»£ç ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰å®ç°çš„ï¼Œè€Œä¸æ˜¯ç”¨ Java å®ç°çš„ã€‚è¿™äº›æ–¹æ³•ç›´æ¥è°ƒç”¨åº•å±‚çš„ç¡¬ä»¶æŒ‡ä»¤æ¥å®ç°åŸå­æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJava è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥ç”¨ Java å®ç° CASï¼Œè€Œæ˜¯é€šè¿‡ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼ˆé€šè¿‡ JNI è°ƒç”¨ï¼‰ã€‚å› æ­¤ï¼ŒCAS çš„å…·ä½“å®ç°ä¸æ“ä½œç³»ç»Ÿä»¥åŠ CPU å¯†åˆ‡ç›¸å…³ã€‚

`java.util.concurrent.atomic` åŒ…æä¾›äº†ä¸€äº›ç”¨äºåŸå­æ“ä½œçš„ç±»ã€‚è¿™äº›ç±»åˆ©ç”¨åº•å±‚çš„åŸå­æŒ‡ä»¤ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

![JUCåŸå­ç±»æ¦‚è§ˆ](https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png)

å…³äºè¿™äº› Atomic åŸå­ç±»çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š[Atomic åŸå­ç±»æ€»ç»“](https://javaguide.cn/java/concurrent/atomic-classes.html)ã€‚

`AtomicInteger`æ˜¯ Java çš„åŸå­ç±»ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºå¯¹ `int` ç±»å‹çš„å˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼Œå®ƒåˆ©ç”¨`Unsafe`ç±»æä¾›çš„ä½çº§åˆ«åŸå­æ“ä½œæ–¹æ³•å®ç°æ— é”çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡è§£è¯»`AtomicInteger`çš„æ ¸å¿ƒæºç ï¼ˆJDK1.8ï¼‰ï¼Œæ¥è¯´æ˜ Java å¦‚ä½•ä½¿ç”¨`Unsafe`ç±»çš„æ–¹æ³•æ¥å®ç°åŸå­æ“ä½œã€‚

`AtomicInteger`æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š

```java
// è·å– Unsafe å®ä¾‹
private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long valueOffset;

static {
    try {
        // è·å–â€œvalueâ€å­—æ®µåœ¨AtomicIntegerç±»ä¸­çš„å†…å­˜åç§»é‡
        valueOffset = unsafe.objectFieldOffset
            (AtomicInteger.class.getDeclaredField("value"));
    } catch (Exception ex) { throw new Error(ex); }
}
// ç¡®ä¿â€œvalueâ€å­—æ®µçš„å¯è§æ€§
private volatile int value;

// å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™åŸå­åœ°å°†å€¼è®¾ç½®ä¸ºnewValue
// ä½¿ç”¨ Unsafe#compareAndSwapInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œ
public final boolean compareAndSet(int expect, int update) {
    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
}

// åŸå­åœ°å°†å½“å‰å€¼åŠ  delta å¹¶è¿”å›æ—§å€¼
public final int getAndAdd(int delta) {
    return unsafe.getAndAddInt(this, valueOffset, delta);
}

// åŸå­åœ°å°†å½“å‰å€¼åŠ  1 å¹¶è¿”å›åŠ ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰
// ä½¿ç”¨ Unsafe#getAndAddInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œã€‚
public final int getAndIncrement() {
    return unsafe.getAndAddInt(this, valueOffset, 1);
}

// åŸå­åœ°å°†å½“å‰å€¼å‡ 1 å¹¶è¿”å›å‡ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰
public final int getAndDecrement() {
    return unsafe.getAndAddInt(this, valueOffset, -1);
}
```

`Unsafe#getAndAddInt`æºç ï¼š

```java
// åŸå­åœ°è·å–å¹¶å¢åŠ æ•´æ•°å€¼
public final int getAndAddInt(Object o, long offset, int delta) {
    int v;
    do {
        // ä»¥ volatile æ–¹å¼è·å–å¯¹è±¡ o åœ¨å†…å­˜åç§»é‡ offset å¤„çš„æ•´æ•°å€¼
        v = getIntVolatile(o, offset);
    } while (!compareAndSwapInt(o, offset, v, v + delta));
    // è¿”å›æ—§å€¼
    return v;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`getAndAddInt` ä½¿ç”¨äº† `do-while` å¾ªç¯ï¼šåœ¨`compareAndSwapInt`æ“ä½œå¤±è´¥æ—¶ï¼Œä¼šä¸æ–­é‡è¯•ç›´åˆ°æˆåŠŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`getAndAddInt`æ–¹æ³•ä¼šé€šè¿‡ `compareAndSwapInt` æ–¹æ³•æ¥å°è¯•æ›´æ–° `value` çš„å€¼ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼ˆå½“å‰å€¼åœ¨æ­¤æœŸé—´è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ï¼Œå®ƒä¼šé‡æ–°è·å–å½“å‰å€¼å¹¶å†æ¬¡å°è¯•æ›´æ–°ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚

ç”±äº CAS æ“ä½œå¯èƒ½ä¼šå› ä¸ºå¹¶å‘å†²çªè€Œå¤±è´¥ï¼Œå› æ­¤é€šå¸¸ä¼šä¸`while`å¾ªç¯æ­é…ä½¿ç”¨ï¼Œåœ¨å¤±è´¥åä¸æ–­é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚è¿™å°±æ˜¯ **è‡ªæ—‹é”æœºåˆ¶** ã€‚

### CAS ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ

ABA é—®é¢˜æ˜¯ CAS ç®—æ³•æœ€å¸¸è§çš„é—®é¢˜ã€‚

#### ABA é—®é¢˜

å¦‚æœä¸€ä¸ªå˜é‡ V åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡èµ‹å€¼çš„æ—¶å€™æ£€æŸ¥åˆ°å®ƒä»ç„¶æ˜¯ A å€¼ï¼Œé‚£æˆ‘ä»¬å°±èƒ½è¯´æ˜å®ƒçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡äº†å—ï¼Ÿå¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½çš„ï¼Œå› ä¸ºåœ¨è¿™æ®µæ—¶é—´å®ƒçš„å€¼å¯èƒ½è¢«æ”¹ä¸ºå…¶ä»–å€¼ï¼Œç„¶ååˆæ”¹å› Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸º CAS æ“ä½œçš„ **"ABA"é—®é¢˜ã€‚**

ABA é—®é¢˜çš„è§£å†³æ€è·¯æ˜¯åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Š**ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³**ã€‚JDK 1.5 ä»¥åçš„ `AtomicStampedReference` ç±»å°±æ˜¯ç”¨æ¥è§£å†³ ABA é—®é¢˜çš„ï¼Œå…¶ä¸­çš„ `compareAndSet()` æ–¹æ³•å°±æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚

```java
public boolean compareAndSet(V   expectedReference,
                             V   newReference,
                             int expectedStamp,
                             int newStamp) {
    Pair<V> current = pair;
    return
        expectedReference == current.reference &&
        expectedStamp == current.stamp &&
        ((newReference == current.reference &&
          newStamp == current.stamp) ||
         casPair(current, Pair.of(newReference, newStamp)));
}
```

#### å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§

CAS ç»å¸¸ä¼šç”¨åˆ°è‡ªæ—‹æ“ä½œæ¥è¿›è¡Œé‡è¯•ï¼Œä¹Ÿå°±æ˜¯ä¸æˆåŠŸå°±ä¸€ç›´å¾ªç¯æ‰§è¡Œç›´åˆ°æˆåŠŸã€‚å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚

å¦‚æœ JVM èƒ½å¤Ÿæ”¯æŒå¤„ç†å™¨æä¾›çš„`pause`æŒ‡ä»¤ï¼Œé‚£ä¹ˆè‡ªæ—‹æ“ä½œçš„æ•ˆç‡å°†æœ‰æ‰€æå‡ã€‚`pause`æŒ‡ä»¤æœ‰ä¸¤ä¸ªé‡è¦ä½œç”¨ï¼š

1. **å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤**ï¼š`pause`æŒ‡ä»¤å¯ä»¥å»¶è¿ŸæŒ‡ä»¤çš„æ‰§è¡Œï¼Œä»è€Œå‡å°‘ CPU çš„èµ„æºæ¶ˆè€—ã€‚å…·ä½“çš„å»¶è¿Ÿæ—¶é—´å–å†³äºå¤„ç†å™¨çš„å®ç°ç‰ˆæœ¬ï¼Œåœ¨æŸäº›å¤„ç†å™¨ä¸Šï¼Œå»¶è¿Ÿæ—¶é—´å¯èƒ½ä¸ºé›¶ã€‚
2. **é¿å…å†…å­˜é¡ºåºå†²çª**ï¼šåœ¨é€€å‡ºå¾ªç¯æ—¶ï¼Œ`pause`æŒ‡ä»¤å¯ä»¥é¿å…ç”±äºå†…å­˜é¡ºåºå†²çªè€Œå¯¼è‡´çš„ CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚

#### åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ

CAS æ“ä½œä»…èƒ½å¯¹å•ä¸ªå…±äº«å˜é‡æœ‰æ•ˆã€‚å½“éœ€è¦æ“ä½œå¤šä¸ªå…±äº«å˜é‡æ—¶ï¼ŒCAS å°±æ˜¾å¾—æ— èƒ½ä¸ºåŠ›ã€‚ä¸è¿‡ï¼Œä» JDK 1.5 å¼€å§‹ï¼ŒJava æä¾›äº†`AtomicReference`ç±»ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ã€‚é€šè¿‡å°†å¤šä¸ªå˜é‡å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`AtomicReference`æ¥æ‰§è¡Œ CAS æ“ä½œã€‚

é™¤äº† `AtomicReference` è¿™ç§æ–¹å¼ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨åŠ é”æ¥ä¿è¯ã€‚

### æ€»ç»“

| **å¯¹æ¯”ç»´åº¦**    | **ä¹è§‚é” (Optimistic Locking)**             | **æ‚²è§‚é” (Pessimistic Locking)**             |
| --------------- | ------------------------------------------- | -------------------------------------------- |
| **æ ¸å¿ƒå‡è®¾**    | å‡è®¾å†²çªå¾ˆå°‘å‘ç”Ÿï¼Œæäº¤æ—¶æ‰éªŒè¯ã€‚            | å‡è®¾å†²çªå¿…ç„¶å‘ç”Ÿï¼Œè¯»å–æ—¶å°±åŠ é”ã€‚             |
| **åº•å±‚åŸç†**    | **CAS (Compare And Swap)** æˆ–ç‰ˆæœ¬å·æœºåˆ¶ã€‚   | **æ“ä½œç³»ç»Ÿäº’æ–¥é”**ï¼Œæ¶‰åŠå†…æ ¸æ€åˆ‡æ¢ã€‚         |
| **é˜»å¡æƒ…å†µ**    | **éé˜»å¡**ã€‚å¤±è´¥åç”±ä¸šåŠ¡é€»è¾‘å†³å®šæ˜¯å¦é‡è¯•ã€‚  | **é˜»å¡**ã€‚å…¶ä»–çº¿ç¨‹å¿…é¡»æ’é˜Ÿç­‰å¾…é”é‡Šæ”¾ã€‚       |
| **å¹¶å‘å¼€é”€**    | **CPU æ¶ˆè€—**ï¼ˆé«˜å¹¶å‘å†™æ—¶é¢‘ç¹è‡ªæ—‹é‡è¯•ï¼‰ã€‚    | **ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€**ï¼ˆçº¿ç¨‹æŒ‚èµ·ä¸å”¤é†’ï¼‰ã€‚       |
| **æ­»é”é£é™©**    | **æ— æ­»é”**ï¼ˆå› ä¸ºä¸æ¶‰åŠæŒæœ‰é”çš„ç­‰å¾…ï¼‰ã€‚      | **æœ‰æ­»é”é£é™©**ï¼ˆå¤šä¸ªé”ç›¸äº’ç­‰å¾…ï¼‰ã€‚           |
| **æ•°æ®åº“å®ç°**  | `UPDATE ... SET version = version + 1`      | `SELECT ... FOR UPDATE`                      |
| **Java ä»£è¡¨ç±»** | `AtomicInteger`ã€`LongAdder`ã€`StampedLock` | `synchronized`ã€`ReentrantLock`              |
| **é€‚ç”¨åœºæ™¯**    | **å¤šè¯»å°‘å†™**ã€å¹¶å‘å†²çªæ¦‚ç‡ä½çš„ä¸šåŠ¡ã€‚        | **å¤šå†™å°‘è¯»**ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„æ ¸å¿ƒä¸šåŠ¡ã€‚ |

## synchronized å…³é”®å­—

### synchronized æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` æ˜¯ Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç¿»è¯‘æˆä¸­æ–‡æ˜¯åŒæ­¥çš„æ„æ€ï¼Œä¸»è¦è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œå¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

åœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚è¿™æ˜¯å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

ä¸è¿‡ï¼Œåœ¨ Java 6 ä¹‹åï¼Œ `synchronized` å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© `synchronized` é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šã€‚å› æ­¤ï¼Œ `synchronized` è¿˜æ˜¯å¯ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼Œåƒ JDK æºç ã€å¾ˆå¤šå¼€æºæ¡†æ¶éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` ã€‚

å…³äºåå‘é”å¤šè¡¥å……ä¸€ç‚¹ï¼šç”±äºåå‘é”å¢åŠ äº† JVM çš„å¤æ‚æ€§ï¼ŒåŒæ—¶ä¹Ÿå¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰åº”ç”¨éƒ½å¸¦æ¥æ€§èƒ½æå‡ã€‚å› æ­¤ï¼Œåœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ `-XX:+UseBiasedLocking` å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚

### å¦‚ä½•ä½¿ç”¨ synchronizedï¼Ÿ

`synchronized` å…³é”®å­—çš„ä½¿ç”¨æ–¹å¼ä¸»è¦æœ‰ä¸‹é¢ 3 ç§ï¼š

1. ä¿®é¥°å®ä¾‹æ–¹æ³•
2. ä¿®é¥°é™æ€æ–¹æ³•
3. ä¿®é¥°ä»£ç å—

**1ã€ä¿®é¥°å®ä¾‹æ–¹æ³•** ï¼ˆé”å½“å‰å¯¹è±¡å®ä¾‹ï¼‰

ç»™å½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰å¯¹è±¡å®ä¾‹çš„é”** ã€‚

```java
synchronized void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**2ã€ä¿®é¥°é™æ€æ–¹æ³•** ï¼ˆé”å½“å‰ç±»ï¼‰

ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**ã€‚

è¿™æ˜¯å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå½’æ•´ä¸ªç±»æ‰€æœ‰ï¼Œä¸ä¾èµ–äºç±»çš„ç‰¹å®šå®ä¾‹ï¼Œè¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ã€‚

```java
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

é™æ€ `synchronized` æ–¹æ³•å’Œéé™æ€ `synchronized` æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨äº’æ–¥ä¹ˆï¼Ÿä¸äº’æ–¥ï¼å¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ `synchronized` æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ `synchronized` æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚

**3ã€ä¿®é¥°ä»£ç å—** ï¼ˆé”æŒ‡å®šå¯¹è±¡/ç±»ï¼‰

å¯¹æ‹¬å·é‡ŒæŒ‡å®šçš„å¯¹è±¡/ç±»åŠ é”ï¼š

- `synchronized(object)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å—å‰è¦è·å¾— **ç»™å®šå¯¹è±¡çš„é”**ã€‚
- `synchronized(ç±».class)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å—å‰è¦è·å¾— **ç»™å®š Class çš„é”**

```java
synchronized(this) {
    //ä¸šåŠ¡ä»£ç 
}
```

**æ€»ç»“ï¼š**

- `synchronized` å…³é”®å­—åŠ åˆ° `static` é™æ€æ–¹æ³•å’Œ `synchronized(class)` ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ï¼›
- `synchronized` å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ï¼›
- å°½é‡ä¸è¦ä½¿ç”¨ `synchronized(String a)` å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ã€‚

### æ„é€ æ–¹æ³•å¯ä»¥ç”¨ synchronized ä¿®é¥°ä¹ˆï¼Ÿ

æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚ä¸è¿‡ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•å†…éƒ¨ä½¿ç”¨ synchronized ä»£ç å—ã€‚

å¦å¤–ï¼Œæ„é€ æ–¹æ³•æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­æ¶‰åŠåˆ°å…±äº«èµ„æºçš„æ“ä½œï¼Œå°±éœ€è¦é‡‡å–é€‚å½“çš„åŒæ­¥æªæ–½æ¥ä¿è¯æ•´ä¸ªæ„é€ è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨ã€‚

### â­ï¸synchronized åº•å±‚åŸç†äº†è§£å—ï¼Ÿ

synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢çš„ä¸œè¥¿ã€‚

#### synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}
```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ`javap -c -s -v -l SynchronizedDemo.class`ã€‚

![synchronizedå…³é”®å­—åŸç†](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-principle.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

ä¸Šé¢çš„å­—èŠ‚ç ä¸­åŒ…å«ä¸€ä¸ª `monitorenter` æŒ‡ä»¤ä»¥åŠä¸¤ä¸ª `monitorexit` æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯é”åœ¨åŒæ­¥ä»£ç å—ä»£ç æ­£å¸¸æ‰§è¡Œä»¥åŠå‡ºç°å¼‚å¸¸çš„è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitor](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
>
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº`monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨`wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º`java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![æ‰§è¡Œ monitorenter è·å–é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-get-lock-code-block.png)

å¯¹è±¡é”çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![æ‰§è¡Œ monitorexit é‡Šæ”¾é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-release-lock-block.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

#### synchronized ä¿®é¥°æ–¹æ³•çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}

```

![synchronizedå…³é”®å­—åŸç†](https://oss.javaguide.cn/github/javaguide/synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%8E%9F%E7%90%862.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

#### æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ï¼Œä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

ç›¸å…³æ¨èï¼š[Java é”ä¸çº¿ç¨‹çš„é‚£äº›äº‹ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ](https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/) ã€‚

ğŸ§—ğŸ» è¿›é˜¶ä¸€ä¸‹ï¼šå­¦æœ‰ä½™åŠ›çš„å°ä¼™ä¼´å¯ä»¥æŠ½æ—¶é—´è¯¦ç»†ç ”ç©¶ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ `monitor`ã€‚

### JDK1.6 ä¹‹åçš„ synchronized åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿé”å‡çº§åŸç†äº†è§£å—ï¼Ÿ

åœ¨ Java 6 ä¹‹åï¼Œ `synchronized` å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© `synchronized` é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šï¼ˆJDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼Œå‰é¢å·²ç»æåˆ°è¿‡äº†ï¼‰ã€‚

é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚

`synchronized` é”å‡çº§æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œé¢è¯•ä¹Ÿå¾ˆå°‘é—®åˆ°ï¼Œå¦‚æœä½ æƒ³è¦è¯¦ç»†äº†è§£çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š[æµ…æ synchronized é”å‡çº§çš„åŸç†ä¸å®ç°](https://www.cnblogs.com/star95/p/17542850.html)ã€‚

### synchronized çš„åå‘é”ä¸ºä»€ä¹ˆè¢«åºŸå¼ƒäº†ï¼Ÿ

Open JDK å®˜æ–¹å£°æ˜ï¼š[JEP 374: Deprecate and Disable Biased Locking](https://openjdk.org/jeps/374)

åœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ `-XX:+UseBiasedLocking` å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚

åœ¨å®˜æ–¹å£°æ˜ä¸­ï¼Œä¸»è¦åŸå› æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š

- **æ€§èƒ½æ”¶ç›Šä¸æ˜æ˜¾ï¼š**

åå‘é”æ˜¯ HotSpot è™šæ‹Ÿæœºçš„ä¸€é¡¹ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥æå‡å•çº¿ç¨‹å¯¹åŒæ­¥ä»£ç å—çš„è®¿é—®æ€§èƒ½ã€‚

å—ç›Šäºåå‘é”çš„åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨äº†æ—©æœŸçš„ Java é›†åˆ APIï¼Œä¾‹å¦‚ HashTableã€Vectorï¼Œåœ¨è¿™äº›é›†åˆç±»ä¸­é€šè¿‡ synchronized æ¥æ§åˆ¶åŒæ­¥ï¼Œè¿™æ ·åœ¨å•çº¿ç¨‹é¢‘ç¹è®¿é—®æ—¶ï¼Œé€šè¿‡åå‘é”ä¼šå‡å°‘åŒæ­¥å¼€é”€ã€‚

éšç€ JDK çš„å‘å±•ï¼Œå‡ºç°äº† ConcurrentHashMap é«˜æ€§èƒ½çš„é›†åˆç±»ï¼Œåœ¨é›†åˆç±»å†…éƒ¨è¿›è¡Œäº†è®¸å¤šæ€§èƒ½ä¼˜åŒ–ï¼Œæ­¤æ—¶åå‘é”å¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šå°±ä¸æ˜æ˜¾äº†ã€‚

åå‘é”ä»…ä»…åœ¨å•çº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—çš„åœºæ™¯ä¸­å¯ä»¥è·å¾—æ€§èƒ½æ”¶ç›Šã€‚

å¦‚æœå­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œå°±éœ€è¦ **æ’¤é”€åå‘é”** ï¼Œè¿™ä¸ªæ“ä½œçš„æ€§èƒ½å¼€é”€æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ã€‚åå‘é”çš„æ’¤é”€éœ€è¦ç­‰å¾…è¿›å…¥åˆ°å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafe pointï¼‰ï¼Œè¯¥çŠ¶æ€ä¸‹æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯æš‚åœçš„ï¼Œæ­¤æ—¶å»æ£€æŸ¥çº¿ç¨‹çŠ¶æ€å¹¶è¿›è¡Œåå‘é”çš„æ’¤é”€ã€‚

- **JVM å†…éƒ¨ä»£ç ç»´æŠ¤æˆæœ¬å¤ªé«˜ï¼š**

åå‘é”å°†è®¸å¤šå¤æ‚ä»£ç å¼•å…¥åˆ°åŒæ­¥å­ç³»ç»Ÿï¼Œå¹¶ä¸”å¯¹å…¶ä»–çš„ HotSpot ç»„ä»¶ä¹Ÿå…·æœ‰ä¾µå…¥æ€§ã€‚è¿™ç§å¤æ‚æ€§ä¸ºç†è§£ä»£ç ã€ç³»ç»Ÿé‡æ„å¸¦æ¥äº†å›°éš¾ï¼Œå› æ­¤ï¼Œ OpenJDK å®˜æ–¹å¸Œæœ›ç¦ç”¨ã€åºŸå¼ƒå¹¶åˆ é™¤åå‘é”ã€‚

### â­ï¸synchronized å’Œ volatile æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

`synchronized` å…³é”®å­—å’Œ `volatile` å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼

- `volatile` å…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥ `volatile`æ€§èƒ½è‚¯å®šæ¯”`synchronized`å…³é”®å­—è¦å¥½ ã€‚ä½†æ˜¯ `volatile` å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ `synchronized` å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å— ã€‚
- `volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚
- `volatile`å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ `synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚

## ReentrantLock

### ReentrantLock æ˜¯ä»€ä¹ˆï¼Ÿ

`ReentrantLock` å®ç°äº† `Lock` æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼çš„é”ï¼Œå’Œ `synchronized` å…³é”®å­—ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œ`ReentrantLock` æ›´çµæ´»ã€æ›´å¼ºå¤§ï¼Œå¢åŠ äº†è½®è¯¢ã€è¶…æ—¶ã€ä¸­æ–­ã€å…¬å¹³é”å’Œéå…¬å¹³é”ç­‰é«˜çº§åŠŸèƒ½ã€‚

```java
public class ReentrantLock implements Lock, java.io.Serializable {}
```

`ReentrantLock` é‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» `Sync`ï¼Œ`Sync` ç»§æ‰¿ AQSï¼ˆ`AbstractQueuedSynchronizer`ï¼‰ï¼Œæ·»åŠ é”å’Œé‡Šæ”¾é”çš„å¤§éƒ¨åˆ†æ“ä½œå®é™…ä¸Šéƒ½æ˜¯åœ¨ `Sync` ä¸­å®ç°çš„ã€‚`Sync` æœ‰å…¬å¹³é” `FairSync` å’Œéå…¬å¹³é” `NonfairSync` ä¸¤ä¸ªå­ç±»ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/reentrantlock-class-diagram.png)

`ReentrantLock` é»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å™¨æ¥æ˜¾å¼çš„æŒ‡å®šä½¿ç”¨å…¬å¹³é”ã€‚

```java
// ä¼ å…¥ä¸€ä¸ª boolean å€¼ï¼Œtrue æ—¶ä¸ºå…¬å¹³é”ï¼Œfalse æ—¶ä¸ºéå…¬å¹³é”
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

ä»ä¸Šé¢çš„å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œ `ReentrantLock` çš„åº•å±‚å°±æ˜¯ç”± AQS æ¥å®ç°çš„ã€‚å…³äº AQS çš„ç›¸å…³å†…å®¹æ¨èé˜…è¯» [AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html) è¿™ç¯‡æ–‡ç« ã€‚

### å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å…¬å¹³é”** : é”è¢«é‡Šæ”¾ä¹‹åï¼Œå…ˆç”³è¯·çš„çº¿ç¨‹å…ˆå¾—åˆ°é”ã€‚æ€§èƒ½è¾ƒå·®ä¸€äº›ï¼Œå› ä¸ºå…¬å¹³é”ä¸ºäº†ä¿è¯æ—¶é—´ä¸Šçš„ç»å¯¹é¡ºåºï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æ›´é¢‘ç¹ã€‚
- **éå…¬å¹³é”**ï¼šé”è¢«é‡Šæ”¾ä¹‹åï¼Œåç”³è¯·çš„çº¿ç¨‹å¯èƒ½ä¼šå…ˆè·å–åˆ°é”ï¼Œæ˜¯éšæœºæˆ–è€…æŒ‰ç…§å…¶ä»–ä¼˜å…ˆçº§æ’åºçš„ã€‚æ€§èƒ½æ›´å¥½ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´æŸäº›çº¿ç¨‹æ°¸è¿œæ— æ³•è·å–åˆ°é”ã€‚

### â­ï¸synchronized å’Œ ReentrantLock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

#### ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**å¯é‡å…¥é”** ä¹Ÿå«é€’å½’é”ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚

JDK æä¾›çš„æ‰€æœ‰ç°æˆçš„ `Lock` å®ç°ç±»ï¼ŒåŒ…æ‹¬ `synchronized` å…³é”®å­—é”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ`method1()` å’Œ `method2()`éƒ½è¢« `synchronized` å…³é”®å­—ä¿®é¥°ï¼Œ`method1()`è°ƒç”¨äº†`method2()`ã€‚

```java
public class SynchronizedDemo {
    public synchronized void method1() {
        System.out.println("æ–¹æ³•1");
        method2();
    }

    public synchronized void method2() {
        System.out.println("æ–¹æ³•2");
    }
}
```

ç”±äº `synchronized`é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨`method1()` æ—¶å¯ä»¥ç›´æ¥è·å¾—å½“å‰å¯¹è±¡çš„é”ï¼Œæ‰§è¡Œ `method2()` çš„æ—¶å€™å¯ä»¥å†æ¬¡è·å–è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚å‡å¦‚`synchronized`æ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œç”±äºè¯¥å¯¹è±¡çš„é”å·²è¢«å½“å‰çº¿ç¨‹æ‰€æŒæœ‰ä¸”æ— æ³•é‡Šæ”¾ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹åœ¨æ‰§è¡Œ `method2()`æ—¶è·å–é”å¤±è´¥ï¼Œä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚

#### synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API

`synchronized` æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚

`ReentrantLock` æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ `lock()` å’Œ `unlock()` æ–¹æ³•é…åˆ `try/finally` è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

#### ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯”`synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€Œ `interrupt()` ã€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•æ‰è¯¥å¼‚å¸¸è¿›è¡Œç›¸åº”å¤„ç†ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥æŒ‡å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **é€šçŸ¥æœºåˆ¶æ›´å¼ºå¤§**ï¼š`ReentrantLock` é€šè¿‡ç»‘å®šå¤šä¸ª `Condition` å¯¹è±¡ï¼Œå¯ä»¥å®ç°åˆ†ç»„å”¤é†’å’Œé€‰æ‹©æ€§é€šçŸ¥ã€‚è¿™è§£å†³äº† `synchronized` åªèƒ½éšæœºå”¤é†’æˆ–å…¨éƒ¨å”¤é†’çš„æ•ˆç‡é—®é¢˜ï¼Œä¸ºå¤æ‚çš„çº¿ç¨‹åä½œåœºæ™¯æä¾›äº†å¼ºå¤§çš„æ”¯æŒã€‚
- **æ”¯æŒè¶…æ—¶** ï¼š`ReentrantLock` æä¾›äº† `tryLock(timeout)` çš„æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šç­‰å¾…è·å–é”çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†ç­‰å¾…æ—¶é—´ï¼Œå°±ä¼šè·å–é”å¤±è´¥ï¼Œä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚

å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© `ReentrantLock` æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å…³äº `Condition`æ¥å£çš„è¡¥å……ï¼š

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª`Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª`Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„`Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨`notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨`ReentrantLock`ç±»ç»“åˆ`Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ `Condition` æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ`synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª `Lock` å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª`Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ`notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ã€‚è€Œ`Condition`å®ä¾‹çš„`signalAll()`æ–¹æ³•ï¼Œåªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥`Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

å…³äº **ç­‰å¾…å¯ä¸­æ–­** çš„è¡¥å……ï¼š

> `lockInterruptibly()` ä¼šè®©è·å–é”çš„çº¿ç¨‹åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­å¯ä»¥å“åº”ä¸­æ–­ï¼Œå³å½“å‰çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™ï¼Œå‘ç°é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œå°±ä¼šé˜»å¡ç­‰å¾…ã€‚
>
> åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ `interrupt()` ï¼Œå°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•è·è¯¥å¼‚å¸¸ï¼Œåšä¸€äº›å¤„ç†æ“ä½œã€‚
>
> ä¸ºäº†æ›´å¥½ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œå€Ÿç”¨ Stack Overflow ä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£ `lockInterruptibly()` å¯ä»¥å“åº”ä¸­æ–­ï¼š
>
> ```JAVA
> public class MyRentrantlock {
>     Thread t = new Thread() {
>         @Override
>         public void run() {
>             ReentrantLock r = new ReentrantLock();
>             // 1.1ã€ç¬¬ä¸€æ¬¡å°è¯•è·å–é”ï¼Œå¯ä»¥è·å–æˆåŠŸ
>             r.lock();
>
>             // 1.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 1
>             System.out.println("lock() : lock count :" + r.getHoldCount());
>
>             // 2ã€ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡ Thread.currentThread().isInterrupted() å¯ä»¥çœ‹åˆ°å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º true
>             interrupt();
>             System.out.println("Current thread is intrupted");
>
>             // 3.1ã€å°è¯•è·å–é”ï¼Œå¯ä»¥æˆåŠŸè·å–
>             r.tryLock();
>             // 3.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 2
>             System.out.println("tryLock() on intrupted thread lock count :" + r.getHoldCount());
>             try {
>                 // 4ã€æ‰“å°çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º trueï¼Œé‚£ä¹ˆè°ƒç”¨ lockInterruptibly() æ–¹æ³•å°±ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸
>                 System.out.println("Current Thread isInterrupted:" + Thread.currentThread().isInterrupted());
>                 r.lockInterruptibly();
>                 System.out.println("lockInterruptibly() --NOt executable statement" + r.getHoldCount());
>             } catch (InterruptedException e) {
>                 r.lock();
>                 System.out.println("Error");
>             } finally {
>                 r.unlock();
>             }
>
>             // 5ã€æ‰“å°é”çš„é‡å…¥æ¬¡æ•°ï¼Œå¯ä»¥å‘ç° lockInterruptibly() æ–¹æ³•å¹¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”
>             System.out.println("lockInterruptibly() not able to Acqurie lock: lock count :" + r.getHoldCount());
>
>             r.unlock();
>             System.out.println("lock count :" + r.getHoldCount());
>             r.unlock();
>             System.out.println("lock count :" + r.getHoldCount());
>         }
>     };
>     public static void main(String str[]) {
>         MyRentrantlock m = new MyRentrantlock();
>         m.t.start();
>     }
> }
> ```
>
> è¾“å‡ºï¼š
>
> ```BASH
> lock() : lock count :1
> Current thread is intrupted
> tryLock() on intrupted thread lock count :2
> Current Thread isInterrupted:true
> Error
> lockInterruptibly() not able to Acqurie lock: lock count :2
> lock count :1
> lock count :0
> ```

å…³äº **æ”¯æŒè¶…æ—¶** çš„è¡¥å……ï¼š

> **ä¸ºä»€ä¹ˆéœ€è¦ `tryLock(timeout)` è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ**
>
> `tryLock(timeout)` æ–¹æ³•å°è¯•åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…è·å–é”ã€‚å¦‚æœæˆåŠŸè·å–é”ï¼Œåˆ™è¿”å› `true`ï¼›å¦‚æœåœ¨é”å¯ç”¨ä¹‹å‰è¶…æ—¶ï¼Œåˆ™è¿”å› `false`ã€‚æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹å‡ ç§åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼š
>
> - **é˜²æ­¢æ­»é”ï¼š** åœ¨å¤æ‚çš„é”åœºæ™¯ä¸­ï¼Œ`tryLock(timeout)` å¯ä»¥é€šè¿‡å…è®¸çº¿ç¨‹åœ¨åˆç†çš„æ—¶é—´å†…æ”¾å¼ƒå¹¶é‡è¯•æ¥å¸®åŠ©é˜²æ­¢æ­»é”ã€‚
> - **æé«˜å“åº”é€Ÿåº¦ï¼š** é˜²æ­¢çº¿ç¨‹æ— é™æœŸé˜»å¡ã€‚
> - **å¤„ç†æ—¶é—´æ•æ„Ÿçš„æ“ä½œï¼š** å¯¹äºå…·æœ‰ä¸¥æ ¼æ—¶é—´é™åˆ¶çš„æ“ä½œï¼Œ`tryLock(timeout)` å…è®¸çº¿ç¨‹åœ¨æ— æ³•åŠæ—¶è·å–é”æ—¶ç»§ç»­æ‰§è¡Œæ›¿ä»£æ“ä½œã€‚

### å¯ä¸­æ–­é”å’Œä¸å¯ä¸­æ–­é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼š**çº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­è¢«é˜»å¡æ—¶ï¼Œæ˜¯å¦èƒ½å¤Ÿå› ä¸ºä¸­æ–­è€Œæå‰æ”¾å¼ƒç­‰å¾…ã€‚**

- **ä¸å¯ä¸­æ–­é”**ï¼šçº¿ç¨‹åœ¨ç­‰å¾…é”æœŸé—´å³ä½¿æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œä¹Ÿä¸ä¼šé€€å‡ºé˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ä¸€ç›´ç­‰å¾…ç›´åˆ°è·å¾—é”ã€‚ä¸­æ–­çŠ¶æ€ä¼šè¢«ä¿ç•™ï¼Œä½†ä¸ä¼šå½±å“é”çš„è·å–è¿‡ç¨‹ã€‚
  - `synchronized` å±äºå…¸å‹çš„ä¸å¯ä¸­æ–­é”ã€‚
  - `ReentrantLock#lock()` ä¹Ÿæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚
- **å¯ä¸­æ–­é”**ï¼šçº¿ç¨‹åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­å¦‚æœæ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œä¼šç«‹å³åœæ­¢ç­‰å¾…å¹¶æŠ›å‡º `InterruptedException`ï¼Œä»è€Œæœ‰æœºä¼šè¿›è¡Œå–æ¶ˆæˆ–é”™è¯¯å¤„ç†ã€‚
  - `ReentrantLock#lockInterruptibly()` å®ç°äº†å¯ä¸­æ–­é”ã€‚
  - `ReentrantLock#tryLock(long time, TimeUnit unit)` ï¼ˆå¸¦è¶…æ—¶çš„å°è¯•è·å–ï¼‰ä¹Ÿæ˜¯å¯ä¸­æ–­çš„ã€‚

## ReentrantReadWriteLock

`ReentrantReadWriteLock` åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„å¹¶ä¸å¤šï¼Œé¢è¯•ä¸­ä¹Ÿé—®çš„æ¯”è¾ƒå°‘ï¼Œç®€å•äº†è§£å³å¯ã€‚JDK 1.8 å¼•å…¥äº†æ€§èƒ½æ›´å¥½çš„è¯»å†™é” `StampedLock` ã€‚

### ReentrantReadWriteLock æ˜¯ä»€ä¹ˆï¼Ÿ

`ReentrantReadWriteLock` å®ç°äº† `ReadWriteLock` ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„è¯»å†™é”ï¼Œæ—¢å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ•ˆç‡ï¼ŒåŒæ—¶åˆå¯ä»¥ä¿è¯æœ‰å†™å…¥æ“ä½œæ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚

```java
public class ReentrantReadWriteLock
        implements ReadWriteLock, java.io.Serializable{
}
public interface ReadWriteLock {
    Lock readLock();
    Lock writeLock();
}
```

- ä¸€èˆ¬é”è¿›è¡Œå¹¶å‘æ§åˆ¶çš„è§„åˆ™ï¼šè¯»è¯»äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ã€‚
- è¯»å†™é”è¿›è¡Œå¹¶å‘æ§åˆ¶çš„è§„åˆ™ï¼šè¯»è¯»ä¸äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ï¼ˆåªæœ‰è¯»è¯»ä¸äº’æ–¥ï¼‰ã€‚

`ReentrantReadWriteLock` å…¶å®æ˜¯ä¸¤æŠŠé”ï¼Œä¸€æŠŠæ˜¯ `WriteLock` (å†™é”)ï¼Œä¸€æŠŠæ˜¯ `ReadLock`ï¼ˆè¯»é”ï¼‰ ã€‚è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”ã€‚è¯»é”å¯ä»¥è¢«åŒæ—¶è¯»ï¼Œå¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ï¼Œè€Œå†™é”æœ€å¤šåªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚

å’Œ `ReentrantLock` ä¸€æ ·ï¼Œ`ReentrantReadWriteLock` åº•å±‚ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/reentrantreadwritelock-class-diagram.png)

`ReentrantReadWriteLock` ä¹Ÿæ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œé»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œå¯ä»¥é€šè¿‡æ„é€ å™¨æ¥æ˜¾å¼åœ°æŒ‡å®šã€‚

```java
// ä¼ å…¥ä¸€ä¸ª boolean å€¼ï¼Œtrue æ—¶ä¸ºå…¬å¹³é”ï¼Œfalse æ—¶ä¸ºéå…¬å¹³é”
public ReentrantReadWriteLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
    readerLock = new ReadLock(this);
    writerLock = new WriteLock(this);
}
```

### ReentrantReadWriteLock é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ

ç”±äº `ReentrantReadWriteLock` æ—¢å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ•ˆç‡ï¼ŒåŒæ—¶åˆå¯ä»¥ä¿è¯æœ‰å†™å…¥æ“ä½œæ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚å› æ­¤ï¼Œåœ¨è¯»å¤šå†™å°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `ReentrantReadWriteLock` èƒ½å¤Ÿæ˜æ˜¾æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

### å…±äº«é”å’Œç‹¬å é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å…±äº«é”**ï¼šä¸€æŠŠé”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å¾—ã€‚
- **ç‹¬å é”**ï¼šä¸€æŠŠé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å¾—ã€‚

### çº¿ç¨‹æŒæœ‰è¯»é”è¿˜èƒ½è·å–å†™é”å—ï¼Ÿ

- åœ¨çº¿ç¨‹æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹ä¸èƒ½å–å¾—å†™é”(å› ä¸ºè·å–å†™é”çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å½“å‰çš„è¯»é”è¢«å ç”¨ï¼Œå°±é©¬ä¸Šè·å–å¤±è´¥ï¼Œä¸ç®¡è¯»é”æ˜¯ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹æŒæœ‰)ã€‚
- åœ¨çº¿ç¨‹æŒæœ‰å†™é”çš„æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­è·å–è¯»é”ï¼ˆè·å–è¯»é”æ—¶å¦‚æœå‘ç°å†™é”è¢«å ç”¨ï¼Œåªæœ‰å†™é”æ²¡æœ‰è¢«å½“å‰çº¿ç¨‹å ç”¨çš„æƒ…å†µæ‰ä¼šè·å–å¤±è´¥ï¼‰ã€‚

è¯»å†™é”çš„æºç åˆ†æï¼Œæ¨èé˜…è¯» [èŠèŠ Java çš„å‡ æŠŠ JVM çº§é” - é˜¿é‡Œå·´å·´ä¸­é—´ä»¶](https://mp.weixin.qq.com/s/h3VIUyH9L0v14MrQJiiDbw) è¿™ç¯‡æ–‡ç« ï¼Œå†™çš„å¾ˆä¸é”™ã€‚

### è¯»é”ä¸ºä»€ä¹ˆä¸èƒ½å‡çº§ä¸ºå†™é”ï¼Ÿ

å†™é”å¯ä»¥é™çº§ä¸ºè¯»é”ï¼Œä½†æ˜¯è¯»é”å´ä¸èƒ½å‡çº§ä¸ºå†™é”ã€‚è¿™æ˜¯å› ä¸ºè¯»é”å‡çº§ä¸ºå†™é”ä¼šå¼•èµ·çº¿ç¨‹çš„äº‰å¤ºï¼Œæ¯•ç«Ÿå†™é”å±äºæ˜¯ç‹¬å é”ï¼Œè¿™æ ·çš„è¯ï¼Œä¼šå½±å“æ€§èƒ½ã€‚

å¦å¤–ï¼Œè¿˜å¯èƒ½ä¼šæœ‰æ­»é”é—®é¢˜å‘ç”Ÿã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾ä¸¤ä¸ªçº¿ç¨‹çš„è¯»é”éƒ½æƒ³å‡çº§å†™é”ï¼Œåˆ™éœ€è¦å¯¹æ–¹éƒ½é‡Šæ”¾è‡ªå·±é”ï¼Œè€ŒåŒæ–¹éƒ½ä¸é‡Šæ”¾ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚

## StampedLock

```mermaid
flowchart TB
    subgraph StampedLock["StampedLock(JDK1.8+)"]
        style StampedLock fill:#F0F2F5,stroke:#E0E6ED,rx:10,ry:10
        subgraph Modes["æ¨¡å¼åˆ†ç±»"]
            style Modes fill:#F5F7FA,stroke:#E0E6ED,rx:10,ry:10
            Write(["å†™é”ï¼ˆç‹¬å ï¼‰ï¼šå•çº¿ç¨‹æŒæœ‰ï¼Œé˜»å¡å…¶ä»–è¯»å†™"]):::write
            Read(["è¯»é”ï¼ˆæ‚²è§‚è¯»ï¼‰ï¼šæ— å†™é”æ—¶å¤šçº¿ç¨‹å…±äº«"]):::read
            Optimistic(["ä¹è§‚è¯»ï¼šæ— å†™é”æ—¶ç›´æ¥è®¿é—®ï¼Œæäº¤æ—¶éªŒè¯"]):::optimistic
        end
        subgraph Features["æ ¸å¿ƒç‰¹ç‚¹"]
            style Features fill:#F5F7FA,stroke:#E0E6ED,rx:10,ry:10
            F1(["ä¸å¯é‡å…¥ï¼Œä¸æ”¯æŒCondition"]):::feature
            F2(["æ€§èƒ½ä¼˜ç§€ï¼ˆä¹è§‚è¯»å‡å°‘é˜»å¡ï¼‰"]):::feature
            F3(["é€‚ç”¨åœºæ™¯ï¼šè¯»å¤šå†™å°‘ï¼Œæ— é‡å…¥éœ€æ±‚"]):::feature
        end
    end

    classDef write fill:#C44545,color:#fff,rx:10,ry:10
    classDef read fill:#00838F,color:#fff,rx:10,ry:10
    classDef optimistic fill:#4CA497,color:#fff,rx:10,ry:10
    classDef feature fill:#E99151,color:#333,rx:10,ry:10

    linkStyle default stroke-width:1.5px,opacity:0.8
```

`StampedLock` é¢è¯•ä¸­é—®çš„æ¯”è¾ƒå°‘ï¼Œä¸æ˜¯å¾ˆé‡è¦ï¼Œç®€å•äº†è§£å³å¯ã€‚

### StampedLock æ˜¯ä»€ä¹ˆï¼Ÿ

`StampedLock` æ˜¯ JDK 1.8 å¼•å…¥çš„æ€§èƒ½æ›´å¥½çš„è¯»å†™é”ï¼Œä¸å¯é‡å…¥ä¸”ä¸æ”¯æŒæ¡ä»¶å˜é‡ `Condition`ã€‚

ä¸åŒäºä¸€èˆ¬çš„ `Lock` ç±»ï¼Œ`StampedLock` å¹¶ä¸æ˜¯ç›´æ¥å®ç° `Lock`æˆ– `ReadWriteLock`æ¥å£ï¼Œè€Œæ˜¯åŸºäº **CLH é”** ç‹¬ç«‹å®ç°çš„ï¼ˆAQS ä¹Ÿæ˜¯åŸºäºè¿™ç©æ„ï¼‰ã€‚

```java
public class StampedLock implements java.io.Serializable {
}
```

`StampedLock` æä¾›äº†ä¸‰ç§æ¨¡å¼çš„è¯»å†™æ§åˆ¶æ¨¡å¼ï¼šè¯»é”ã€å†™é”å’Œä¹è§‚è¯»ã€‚

- **å†™é”**ï¼šç‹¬å é”ï¼Œä¸€æŠŠé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å¾—ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”åï¼Œå…¶ä»–è¯·æ±‚è¯»é”å’Œå†™é”çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚ç±»ä¼¼äº `ReentrantReadWriteLock` çš„å†™é”ï¼Œä¸è¿‡è¿™é‡Œçš„å†™é”æ˜¯ä¸å¯é‡å…¥çš„ã€‚
- **è¯»é”** ï¼ˆæ‚²è§‚è¯»ï¼‰ï¼šå…±äº«é”ï¼Œæ²¡æœ‰çº¿ç¨‹è·å–å†™é”çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ã€‚å¦‚æœå·±ç»æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹è¯·æ±‚è·å–è¯¥è¯»é”ä¼šè¢«é˜»å¡ã€‚ç±»ä¼¼äº `ReentrantReadWriteLock` çš„è¯»é”ï¼Œä¸è¿‡è¿™é‡Œçš„è¯»é”æ˜¯ä¸å¯é‡å…¥çš„ã€‚
- **ä¹è§‚è¯»**ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹è·å–ä¹è§‚è¯»ä»¥åŠè¯»é”ã€‚åŒæ—¶å…è®¸ä¸€ä¸ªå†™çº¿ç¨‹è·å–å†™é”ã€‚

å¦å¤–ï¼Œ`StampedLock` è¿˜æ”¯æŒè¿™ä¸‰ç§é”åœ¨ä¸€å®šæ¡ä»¶ä¸‹è¿›è¡Œç›¸äº’è½¬æ¢ ã€‚

```java
long tryConvertToWriteLock(long stamp){}
long tryConvertToReadLock(long stamp){}
long tryConvertToOptimisticRead(long stamp){}
```

`StampedLock` åœ¨è·å–é”çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ª long å‹çš„æ•°æ®æˆ³ï¼Œè¯¥æ•°æ®æˆ³ç”¨äºç¨åçš„é”é‡Šæ”¾å‚æ•°ï¼Œå¦‚æœè¿”å›çš„æ•°æ®æˆ³ä¸º 0 åˆ™è¡¨ç¤ºé”è·å–å¤±è´¥ã€‚å½“å‰çº¿ç¨‹æŒæœ‰äº†é”å†æ¬¡è·å–é”è¿˜æ˜¯ä¼šè¿”å›ä¸€ä¸ªæ–°çš„æ•°æ®æˆ³ï¼Œè¿™ä¹Ÿæ˜¯`StampedLock`ä¸å¯é‡å…¥çš„åŸå› ã€‚

```java
// å†™é”
public long writeLock() {
    long s, next;  // bypass acquireWrite in fully unlocked case only
    return ((((s = state) & ABITS) == 0L &&
             U.compareAndSwapLong(this, STATE, s, next = s + WBIT)) ?
            next : acquireWrite(false, 0L));
}
// è¯»é”
public long readLock() {
    long s = state, next;  // bypass acquireRead on common uncontended case
    return ((whead == wtail && (s & ABITS) < RFULL &&
             U.compareAndSwapLong(this, STATE, s, next = s + RUNIT)) ?
            next : acquireRead(false, 0L));
}
// ä¹è§‚è¯»
public long tryOptimisticRead() {
    long s;
    return (((s = state) & WBIT) == 0L) ? (s & SBITS) : 0L;
}
```

### StampedLock çš„æ€§èƒ½ä¸ºä»€ä¹ˆæ›´å¥½ï¼Ÿ

ç›¸æ¯”äºä¼ ç»Ÿè¯»å†™é”å¤šå‡ºæ¥çš„ä¹è§‚è¯»æ˜¯`StampedLock`æ¯” `ReadWriteLock` æ€§èƒ½æ›´å¥½çš„å…³é”®åŸå› ã€‚`StampedLock` çš„ä¹è§‚è¯»å…è®¸ä¸€ä¸ªå†™çº¿ç¨‹è·å–å†™é”ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´æ‰€æœ‰å†™çº¿ç¨‹é˜»å¡ï¼Œä¹Ÿå°±æ˜¯å½“è¯»å¤šå†™å°‘çš„æ—¶å€™ï¼Œå†™çº¿ç¨‹æœ‰æœºä¼šè·å–å†™é”ï¼Œå‡å°‘äº†çº¿ç¨‹é¥¥é¥¿çš„é—®é¢˜ï¼Œååé‡å¤§å¤§æé«˜ã€‚

### StampedLock é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ

å’Œ `ReentrantReadWriteLock` ä¸€æ ·ï¼Œ`StampedLock` åŒæ ·é€‚åˆè¯»å¤šå†™å°‘çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥ä½œä¸º `ReentrantReadWriteLock`çš„æ›¿ä»£å“ï¼Œæ€§èƒ½æ›´å¥½ã€‚

ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯`StampedLock`ä¸å¯é‡å…¥ï¼Œä¸æ”¯æŒæ¡ä»¶å˜é‡ `Condition`ï¼Œå¯¹ä¸­æ–­æ“ä½œæ”¯æŒä¹Ÿä¸å‹å¥½ï¼ˆä½¿ç”¨ä¸å½“å®¹æ˜“å¯¼è‡´ CPU é£™å‡ï¼‰ã€‚å¦‚æœä½ éœ€è¦ç”¨åˆ° `ReentrantLock` çš„ä¸€äº›é«˜çº§æ€§èƒ½ï¼Œå°±ä¸å¤ªå»ºè®®ä½¿ç”¨ `StampedLock` äº†ã€‚

å¦å¤–ï¼Œ`StampedLock` æ€§èƒ½è™½å¥½ï¼Œä½†ä½¿ç”¨èµ·æ¥ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œä¸€æ—¦ä½¿ç”¨ä¸å½“ï¼Œå°±ä¼šå‡ºç°ç”Ÿäº§é—®é¢˜ã€‚å¼ºçƒˆå»ºè®®ä½ åœ¨ä½¿ç”¨`StampedLock` ä¹‹å‰ï¼Œçœ‹çœ‹ [StampedLock å®˜æ–¹æ–‡æ¡£ä¸­çš„æ¡ˆä¾‹](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/StampedLock.html)ã€‚

### StampedLock çš„åº•å±‚åŸç†äº†è§£å—ï¼Ÿ

`StampedLock` ä¸æ˜¯ç›´æ¥å®ç° `Lock`æˆ– `ReadWriteLock`æ¥å£ï¼Œè€Œæ˜¯åŸºäº **CLH é”** å®ç°çš„ï¼ˆAQS ä¹Ÿæ˜¯åŸºäºè¿™ç©æ„ï¼‰ï¼ŒCLH é”æ˜¯å¯¹è‡ªæ—‹é”çš„ä¸€ç§æ”¹è‰¯ï¼Œæ˜¯ä¸€ç§éšå¼çš„é“¾è¡¨é˜Ÿåˆ—ã€‚`StampedLock` é€šè¿‡ CLH é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹çš„ç®¡ç†ï¼Œé€šè¿‡åŒæ­¥çŠ¶æ€å€¼ `state` æ¥è¡¨ç¤ºé”çš„çŠ¶æ€å’Œç±»å‹ã€‚

`StampedLock` çš„åŸç†å’Œ AQS åŸç†æ¯”è¾ƒç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ï¼š

- [AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html)
- [StampedLock åº•å±‚åŸç†åˆ†æ](https://segmentfault.com/a/1190000015808032)

å¦‚æœä½ åªæ˜¯å‡†å¤‡é¢è¯•çš„è¯ï¼Œå»ºè®®å¤šèŠ±ç‚¹ç²¾åŠ›ææ‡‚ AQS åŸç†å³å¯ï¼Œ`StampedLock` åº•å±‚åŸç†åœ¨é¢è¯•ä¸­é‡åˆ°çš„æ¦‚ç‡éå¸¸å°ã€‚

## Atomic åŸå­ç±»

Atomic åŸå­ç±»éƒ¨åˆ†çš„å†…å®¹æˆ‘å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ï¼š[Atomic åŸå­ç±»æ€»ç»“](./atomic-classes.md) ã€‚

## å‚è€ƒ

- ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹
- ã€Šå®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡ã€‹
- Guide to the Volatile Keyword in Java - Baeldungï¼š<https://www.baeldung.com/java-volatile>
- ä¸å¯ä¸è¯´çš„ Javaâ€œé”â€äº‹ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿï¼š<https://tech.meituan.com/2018/11/15/java-lock.html>
- åœ¨ ReadWriteLock ç±»ä¸­è¯»é”ä¸ºä»€ä¹ˆä¸èƒ½å‡çº§ä¸ºå†™é”ï¼Ÿï¼š<https://cloud.tencent.com/developer/article/1176230>
- é«˜æ€§èƒ½è§£å†³çº¿ç¨‹é¥¥é¥¿çš„åˆ©å™¨ StampedLockï¼š<https://mp.weixin.qq.com/s/2Acujjr4BHIhlFsCLGwYSg>
- ç†è§£ Java ä¸­çš„ ThreadLocal - æŠ€æœ¯å°é»‘å±‹ï¼š<https://droidyue.com/blog/2016/03/13/learning-threadlocal-in-java/>
- ThreadLocal (Java Platform SE 8 ) - Oracle Help Centerï¼š<https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadLocal.html>

<!-- @include: @article-footer.snippet.md -->
