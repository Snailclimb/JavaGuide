---
title: Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰
category: Java
tag:
  - Javaå¹¶å‘
head:
  - - meta
    - name: keywords
      content: å¤šçº¿ç¨‹,æ­»é”,çº¿ç¨‹æ± ,CAS,AQS
  - - meta
    - name: description
      content: Javaå¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜æ€»ç»“ï¼ˆå«è¯¦ç»†è§£ç­”ï¼‰ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ï¼
---

<!-- @include: @article-header.snippet.md -->

## ThreadLocal

### ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ã€‚è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰å’Œçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é‚£ä¹ˆï¼Œ**å¦‚æœæƒ³è®©æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡ï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ**

JDK ä¸­æä¾›çš„ `ThreadLocal` ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**`ThreadLocal` ç±»å…è®¸æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼**ï¼Œå¯ä»¥å°†å…¶å½¢è±¡åœ°æ¯”å–»ä¸ºä¸€ä¸ªâ€œå­˜æ”¾æ•°æ®çš„ç›’å­â€ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç›’å­ï¼Œç”¨äºå­˜å‚¨ç§æœ‰æ•°æ®ï¼Œç¡®ä¿ä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº’ä¸å¹²æ‰°ã€‚

å½“ä½ åˆ›å»ºä¸€ä¸ª `ThreadLocal` å˜é‡æ—¶ï¼Œæ¯ä¸ªè®¿é—®è¯¥å˜é‡çš„çº¿ç¨‹éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å‰¯æœ¬ã€‚è¿™ä¹Ÿæ˜¯ `ThreadLocal` åç§°çš„ç”±æ¥ã€‚çº¿ç¨‹å¯ä»¥é€šè¿‡ `get()` æ–¹æ³•è·å–è‡ªå·±çº¿ç¨‹çš„æœ¬åœ°å‰¯æœ¬ï¼Œæˆ–é€šè¿‡ `set()` æ–¹æ³•ä¿®æ”¹è¯¥å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šå‡è®¾æœ‰ä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ã€‚å¦‚æœä»–ä»¬å…±ç”¨ä¸€ä¸ªè¢‹å­ï¼Œå¿…ç„¶ä¼šäº§ç”Ÿäº‰æ‰§ï¼›ä½†å¦‚æœæ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¢‹å­ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœå°†è¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹ï¼Œé‚£ä¹ˆ `ThreadLocal` å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ªèµ„æºçš„æ–¹æ³•ã€‚

```java
public class ThreadLocalExample {
    private static ThreadLocal<Integer> threadLocal = ThreadLocal.withInitial(() -> 0);

    public static void main(String[] args) {
        Runnable task = () -> {
            int value = threadLocal.get();
            value += 1;
            threadLocal.set(value);
            System.out.println(Thread.currentThread().getName() + " Value: " + threadLocal.get());
        };

        Thread thread1 = new Thread(task, "Thread-1");
        Thread thread2 = new Thread(task, "Thread-2");

        thread1.start(); // è¾“å‡º: Thread-1 Value: 1
        thread2.start(); // è¾“å‡º: Thread-2 Value: 1
    }
}
```

### â­ï¸ThreadLocal åŸç†äº†è§£å—ï¼Ÿ

ä» `Thread`ç±»æºä»£ç å…¥æ‰‹ã€‚

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}
```

ä»ä¸Šé¢`Thread`ç±» æºä»£ç å¯ä»¥çœ‹å‡º`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ã€‚

`ThreadLocal`ç±»çš„`set()`æ–¹æ³•

```java
public void set(T value) {
    //è·å–å½“å‰è¯·æ±‚çš„çº¿ç¨‹
    Thread t = Thread.currentThread();
    //å–å‡º Thread ç±»å†…éƒ¨çš„ threadLocals å˜é‡(å“ˆå¸Œè¡¨ç»“æ„)
    ThreadLocalMap map = getMap(t);
    if (map != null)
        // å°†éœ€è¦å­˜å‚¨çš„å€¼æ”¾å…¥åˆ°è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­
        map.set(this, value);
    else
        createMap(t, value);
}
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š**æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯`ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡`Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡`getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„`ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª`Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª`ThreadLocalMap`ï¼Œè€Œ`ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥`ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

```java
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
    //......
}
```

æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª `ThreadLocal` å¯¹è±¡çš„è¯ï¼Œ `Thread`å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª`ThreadLocalMap` å­˜æ”¾æ•°æ®çš„ï¼Œ`ThreadLocalMap`çš„ key å°±æ˜¯ `ThreadLocal`å¯¹è±¡ï¼Œvalue å°±æ˜¯ `ThreadLocal` å¯¹è±¡è°ƒç”¨`set`æ–¹æ³•è®¾ç½®çš„å€¼ã€‚

`ThreadLocal` æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ThreadLocal æ•°æ®ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadlocal-data-structure.png)

`ThreadLocalMap`æ˜¯`ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

![ThreadLocalå†…éƒ¨ç±»](https://oss.javaguide.cn/github/javaguide/java/concurrent/thread-local-inner-class.png)

### â­ï¸ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„ï¼Ÿ

`ThreadLocal` å†…å­˜æ³„æ¼çš„æ ¹æœ¬åŸå› åœ¨äºå…¶å†…éƒ¨å®ç°æœºåˆ¶ã€‚

é€šè¿‡ä¸Šé¢çš„å†…å®¹æˆ‘ä»¬å·²ç»çŸ¥é“ï¼šæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªåä¸º `ThreadLocalMap` çš„ mapã€‚ å½“ä½ ä½¿ç”¨ `ThreadLocal` å­˜å‚¨å€¼æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å€¼å­˜å‚¨åœ¨å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå…¶ä¸­ `ThreadLocal` å®ä¾‹æœ¬èº«ä½œä¸º keyï¼Œè€Œä½ è¦å­˜å‚¨çš„å€¼ä½œä¸º valueã€‚

`ThreadLocal` çš„ `set()` æ–¹æ³•æºç å¦‚ä¸‹ï¼š

```java
public void set(T value) {
    Thread t = Thread.currentThread(); // è·å–å½“å‰çº¿ç¨‹
    ThreadLocalMap map = getMap(t);   // è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap
    if (map != null) {
        map.set(this, value);         // è®¾ç½®å€¼
    } else {
        createMap(t, value);          // åˆ›å»ºæ–°çš„ ThreadLocalMap
    }
}
```

`ThreadLocalMap` çš„ `set()` å’Œ `createMap()` æ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ `ThreadLocal` å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯ä½¿ç”¨ `ThreadLocal` çš„å“ˆå¸Œå€¼è®¡ç®—æ•°ç»„ç´¢å¼•ï¼Œæœ€ç»ˆå­˜å‚¨äºç±»å‹ä¸º`static class Entry extends WeakReference<ThreadLocal<?>>`çš„æ•°ç»„ä¸­ã€‚

```java
int i = key.threadLocalHashCode & (len-1);
```

`ThreadLocalMap` çš„ `Entry` å®šä¹‰å¦‚ä¸‹ï¼š

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

`ThreadLocalMap` çš„ `key` å’Œ `value` å¼•ç”¨æœºåˆ¶ï¼š

- **key æ˜¯å¼±å¼•ç”¨**ï¼š`ThreadLocalMap` ä¸­çš„ key æ˜¯ `ThreadLocal` çš„å¼±å¼•ç”¨ (`WeakReference<ThreadLocal<?>>`)ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœ `ThreadLocal` å®ä¾‹ä¸å†è¢«ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šåœ¨ä¸‹æ¬¡ GC æ—¶å›æ”¶è¯¥å®ä¾‹ï¼Œå¯¼è‡´ `ThreadLocalMap` ä¸­å¯¹åº”çš„ key å˜ä¸º `null`ã€‚
- **value æ˜¯å¼ºå¼•ç”¨**ï¼šå³ä½¿ `key` è¢« GC å›æ”¶ï¼Œ`value` ä»ç„¶è¢« `ThreadLocalMap.Entry` å¼ºå¼•ç”¨å­˜åœ¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚

å½“ `ThreadLocal` å®ä¾‹å¤±å»å¼ºå¼•ç”¨åï¼Œå…¶å¯¹åº”çš„ value ä»ç„¶å­˜åœ¨äº `ThreadLocalMap` ä¸­ï¼Œå› ä¸º `Entry` å¯¹è±¡å¼ºå¼•ç”¨äº†å®ƒã€‚å¦‚æœçº¿ç¨‹æŒç»­å­˜æ´»ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œ`ThreadLocalMap` ä¹Ÿä¼šä¸€ç›´å­˜åœ¨ï¼Œå¯¼è‡´ key ä¸º `null` çš„ entry æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œå³ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜æ³„æ¼çš„å‘ç”Ÿéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

1. `ThreadLocal` å®ä¾‹ä¸å†è¢«å¼ºå¼•ç”¨ï¼›
2. çº¿ç¨‹æŒç»­å­˜æ´»ï¼Œå¯¼è‡´ `ThreadLocalMap` é•¿æœŸå­˜åœ¨ã€‚

è™½ç„¶ `ThreadLocalMap` åœ¨ `get()`, `set()` å’Œ `remove()` æ“ä½œæ—¶ä¼šå°è¯•æ¸…ç† key ä¸º null çš„ entryï¼Œä½†è¿™ç§æ¸…ç†æœºåˆ¶æ˜¯è¢«åŠ¨çš„ï¼Œå¹¶ä¸å®Œå…¨å¯é ã€‚

**å¦‚ä½•é¿å…å†…å­˜æ³„æ¼çš„å‘ç”Ÿï¼Ÿ**

1. åœ¨ä½¿ç”¨å®Œ `ThreadLocal` åï¼ŒåŠ¡å¿…è°ƒç”¨ `remove()` æ–¹æ³•ã€‚ è¿™æ˜¯æœ€å®‰å…¨å’Œæœ€æ¨èçš„åšæ³•ã€‚ `remove()` æ–¹æ³•ä¼šä» `ThreadLocalMap` ä¸­æ˜¾å¼åœ°ç§»é™¤å¯¹åº”çš„ entryï¼Œå½»åº•è§£å†³å†…å­˜æ³„æ¼çš„é£é™©ã€‚ å³ä½¿å°† `ThreadLocal` å®šä¹‰ä¸º `static final`ï¼Œä¹Ÿå¼ºçƒˆå»ºè®®åœ¨æ¯æ¬¡ä½¿ç”¨åè°ƒç”¨ `remove()`ã€‚
2. åœ¨çº¿ç¨‹æ± ç­‰çº¿ç¨‹å¤ç”¨çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ `try-finally` å—å¯ä»¥ç¡®ä¿å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œ`remove()` æ–¹æ³•ä¹Ÿä¸€å®šä¼šè¢«æ‰§è¡Œã€‚

### â­ï¸å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼ï¼Ÿ

ç”±äº `ThreadLocal` çš„å˜é‡å€¼å­˜æ”¾åœ¨ `Thread` é‡Œï¼Œè€Œçˆ¶å­çº¿ç¨‹å±äºä¸åŒçš„ `Thread` çš„ã€‚å› æ­¤åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ï¼Œçˆ¶å­çº¿ç¨‹çš„ `ThreadLocal` å€¼æ— æ³•è¿›è¡Œä¼ é€’ã€‚

å¦‚æœæƒ³è¦åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼ é€’ `ThreadLocal` å€¼ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

- `InheritableThreadLocal` ï¼š`InheritableThreadLocal` æ˜¯ JDK1.2 æä¾›çš„å·¥å…·ï¼Œç»§æ‰¿è‡ª `ThreadLocal` ã€‚ä½¿ç”¨ `InheritableThreadLocal` æ—¶ï¼Œä¼šåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä»¤å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹ä¸­çš„ `ThreadLocal` å€¼ï¼Œä½†æ˜¯æ— æ³•æ”¯æŒçº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ `ThreadLocal` å€¼ä¼ é€’ã€‚
- `TransmittableThreadLocal` ï¼š `TransmittableThreadLocal` ï¼ˆç®€ç§° TTLï¼‰ æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„å·¥å…·ç±»ï¼Œç»§æ‰¿å¹¶åŠ å¼ºäº†`InheritableThreadLocal`ç±»ï¼Œå¯ä»¥åœ¨çº¿ç¨‹æ± çš„åœºæ™¯ä¸‹æ”¯æŒ `ThreadLocal` å€¼ä¼ é€’ã€‚é¡¹ç›®åœ°å€ï¼š<https://github.com/alibaba/transmittable-thread-local>ã€‚

#### InheritableThreadLocal åŸç†

`InheritableThreadLocal` å®ç°äº†åˆ›å»ºå¼‚æ­¥çº¿ç¨‹æ—¶ï¼Œç»§æ‰¿çˆ¶çº¿ç¨‹ `ThreadLocal` å€¼çš„åŠŸèƒ½ã€‚è¯¥ç±»æ˜¯ JDK å›¢é˜Ÿæä¾›çš„ï¼Œé€šè¿‡æ”¹é€  JDK æºç åŒ…ä¸­çš„ `Thread` ç±»æ¥å®ç°åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œ`ThreadLocal` å€¼çš„ä¼ é€’ã€‚

**`InheritableThreadLocal` çš„å€¼å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ**

åœ¨ `Thread` ç±»ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ `ThreadLocalMap` ï¼Œå‘½åä¸º `inheritableThreadLocals` ï¼Œè¯¥å˜é‡ç”¨äºå­˜å‚¨éœ€è¦è·¨çº¿ç¨‹ä¼ é€’çš„ `ThreadLocal` å€¼ã€‚å¦‚ä¸‹ï¼š

```JAVA
class Thread implements Runnable {
    ThreadLocal.ThreadLocalMap threadLocals = null;
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}
```

**å¦‚ä½•å®Œæˆ `ThreadLocal` å€¼çš„ä¼ é€’ï¼Ÿ**

é€šè¿‡æ”¹é€  `Thread` ç±»çš„æ„é€ æ–¹æ³•æ¥å®ç°ï¼Œåœ¨åˆ›å»º `Thread` çº¿ç¨‹æ—¶ï¼Œæ‹¿åˆ°çˆ¶çº¿ç¨‹çš„ `inheritableThreadLocals` å˜é‡èµ‹å€¼ç»™å­çº¿ç¨‹å³å¯ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```JAVA
// Thread çš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨ init() æ–¹æ³•
private void init(/* ... */) {
	// 1ã€è·å–çˆ¶çº¿ç¨‹
    Thread parent = currentThread();
    // 2ã€å°†çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals èµ‹å€¼ç»™å­çº¿ç¨‹
    if (inheritThreadLocals && parent.inheritableThreadLocals != null)
        this.inheritableThreadLocals =
        	ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
}
```

#### TransmittableThreadLocal åŸç†

JDK é»˜è®¤æ²¡æœ‰æ”¯æŒçº¿ç¨‹æ± åœºæ™¯ä¸‹ `ThreadLocal` å€¼ä¼ é€’çš„åŠŸèƒ½ï¼Œå› æ­¤é˜¿é‡Œå·´å·´å¼€æºäº†ä¸€å¥—å·¥å…· `TransmittableThreadLocal` æ¥å®ç°è¯¥åŠŸèƒ½ã€‚

é˜¿é‡Œå·´å·´æ— æ³•æ”¹åŠ¨ JDK çš„æºç ï¼Œå› æ­¤ä»–å†…éƒ¨é€šè¿‡ **è£…é¥°å™¨æ¨¡å¼** åœ¨åŸæœ‰çš„åŠŸèƒ½ä¸Šåšå¢å¼ºï¼Œä»¥æ­¤æ¥å®ç°çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ `ThreadLocal` å€¼ä¼ é€’ã€‚

TTL æ”¹é€ çš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼š

- å®ç°è‡ªå®šä¹‰çš„ `Thread` ï¼Œåœ¨ `run()` æ–¹æ³•å†…éƒ¨åš `ThreadLocal` å˜é‡çš„èµ‹å€¼æ“ä½œã€‚

- åŸºäº **çº¿ç¨‹æ± ** è¿›è¡Œè£…é¥°ï¼Œåœ¨ `execute()` æ–¹æ³•ä¸­ï¼Œä¸æäº¤ JDK å†…éƒ¨çš„ `Thread` ï¼Œè€Œæ˜¯æäº¤è‡ªå®šä¹‰çš„ `Thread` ã€‚

å¦‚æœæƒ³è¦æŸ¥çœ‹ç›¸å…³æºç ï¼Œå¯ä»¥å¼•å…¥ Maven ä¾èµ–è¿›è¡Œä¸‹è½½ã€‚

```XML
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.12.0</version>
</dependency>
```

#### åº”ç”¨åœºæ™¯

1. **å‹æµ‹æµé‡æ ‡è®°**ï¼š åœ¨å‹æµ‹åœºæ™¯ä¸­ï¼Œä½¿ç”¨ `ThreadLocal` å­˜å‚¨å‹æµ‹æ ‡è®°ï¼Œç”¨äºåŒºåˆ†å‹æµ‹æµé‡å’ŒçœŸå®æµé‡ã€‚å¦‚æœæ ‡è®°ä¸¢å¤±ï¼Œå¯èƒ½å¯¼è‡´å‹æµ‹æµé‡è¢«é”™è¯¯åœ°å½“æˆçº¿ä¸Šæµé‡å¤„ç†ã€‚
2. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¼ é€’é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼ˆå¦‚ Trace IDï¼‰æˆ–ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

## çº¿ç¨‹æ± 

### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ?

é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ã€‚å½“æœ‰ä»»åŠ¡è¦å¤„ç†æ—¶ï¼Œç›´æ¥ä»çº¿ç¨‹æ± ä¸­è·å–çº¿ç¨‹æ¥å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åçº¿ç¨‹å¹¶ä¸ä¼šç«‹å³è¢«é”€æ¯ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

### â­ï¸ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ

æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€HTTP è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚

çº¿ç¨‹æ± æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚ä½¿ç”¨çº¿ç¨‹æ± ä¸»è¦å¸¦æ¥ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š

1. **é™ä½èµ„æºæ¶ˆè€—**ï¼šçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„ã€‚ä¸€æ—¦çº¿ç¨‹å®Œæˆäº†æŸä¸ªä»»åŠ¡ï¼Œå®ƒä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯å›åˆ°æ± å­é‡Œç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚è¿™å°±é¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„å¼€é”€ã€‚
2. **æé«˜å“åº”é€Ÿåº¦**ï¼šå› ä¸ºçº¿ç¨‹æ± é‡Œé€šå¸¸ä¼šç»´æŠ¤ä¸€å®šæ•°é‡çš„æ ¸å¿ƒçº¿ç¨‹ï¼ˆæˆ–è€…è¯´â€œå¸¸é©»å·¥äººâ€ï¼‰ï¼Œä»»åŠ¡æ¥äº†ä¹‹åï¼Œå¯ä»¥ç›´æ¥äº¤ç»™è¿™äº›å·²ç»å­˜åœ¨çš„ã€ç©ºé—²çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œçœå»äº†åˆ›å»ºçº¿ç¨‹çš„æ—¶é—´ï¼Œä»»åŠ¡èƒ½å¤Ÿæ›´å¿«åœ°å¾—åˆ°å¤„ç†ã€‚
3. **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ï¼šçº¿ç¨‹æ± å…è®¸æˆ‘ä»¬ç»Ÿä¸€ç®¡ç†æ± ä¸­çš„çº¿ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥é…ç½®çº¿ç¨‹æ± çš„å¤§å°ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ï¼‰ã€ä»»åŠ¡é˜Ÿåˆ—çš„ç±»å‹å’Œå¤§å°ã€æ‹’ç»ç­–ç•¥ç­‰ã€‚è¿™æ ·å°±èƒ½æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ€»é‡ï¼Œé˜²æ­¢èµ„æºè€—å°½ï¼Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚åŒæ—¶ï¼Œçº¿ç¨‹æ± é€šå¸¸ä¹Ÿæä¾›äº†ç›‘æ§æ¥å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬äº†è§£çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ¯”å¦‚æœ‰å¤šå°‘æ´»è·ƒçº¿ç¨‹ã€å¤šå°‘ä»»åŠ¡åœ¨æ’é˜Ÿç­‰ï¼‰ï¼Œä¾¿äºè°ƒä¼˜ã€‚

### å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

åœ¨ Java ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹æ± ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ä¸€ï¼šé€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°ç›´æ¥åˆ›å»º (æ¨è)**

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-construtors.png)

è¿™æ˜¯æœ€æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå®ƒå…è®¸å¼€å‘è€…æ˜ç¡®æŒ‡å®šçº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ï¼Œå¯¹çº¿ç¨‹æ± çš„è¿è¡Œè¡Œä¸ºæœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œä»è€Œé¿å…èµ„æºè€—å°½çš„é£é™©ã€‚

**æ–¹å¼äºŒï¼šé€šè¿‡ `Executors` å·¥å…·ç±»åˆ›å»º (ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ)**

`Executors`å·¥å…·ç±»æä¾›çš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/executors-new-thread-pool-methods.png)

å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡`Executors`å·¥å…·ç±»å¯ä»¥åˆ›å»ºå¤šç§ç±»å‹çš„çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬ï¼š

- `FixedThreadPool`ï¼šå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- `SingleThreadExecutor`ï¼š åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- `CachedThreadPool`ï¼š å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚
- `ScheduledThreadPool`ï¼šç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚

### â­ï¸ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨å†…ç½®çº¿ç¨‹æ± ï¼Ÿ

åœ¨ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹â€œå¹¶å‘å¤„ç†â€è¿™ä¸€ç« èŠ‚ï¼Œæ˜ç¡®æŒ‡å‡ºçº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

> ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºå¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚

å¦å¤–ï¼Œã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ `Executors` å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

`Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹(åæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°)ï¼š

- `FixedThreadPool` å’Œ `SingleThreadExecutor`:ä½¿ç”¨çš„æ˜¯é˜»å¡é˜Ÿåˆ— `LinkedBlockingQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`ï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `CachedThreadPool`:ä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— `SynchronousQueue`, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¿‡å¤šä¸”æ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`:ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—`DelayedWorkQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
    // LinkedBlockingQueue çš„é»˜è®¤é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„
    return new ThreadPoolExecutor(nThreads, nThreads,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>());

}

public static ExecutorService newSingleThreadExecutor() {
    // LinkedBlockingQueue çš„é»˜è®¤é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„
    return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>()));

}

// åŒæ­¥é˜Ÿåˆ— SynchronousQueueï¼Œæ²¡æœ‰å®¹é‡ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUE`
public static ExecutorService newCachedThreadPool() {

    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,60L, TimeUnit.SECONDS,new SynchronousQueue<Runnable>());

}

// DelayedWorkQueueï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
    return new ScheduledThreadPoolExecutor(corePoolSize);
}
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
          new DelayedWorkQueue());
}
```

### â­ï¸çº¿ç¨‹æ± å¸¸è§å‚æ•°æœ‰å“ªäº›ï¼Ÿå¦‚ä½•è§£é‡Šï¼Ÿ

```java
    /**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                              TimeUnit unit,//æ—¶é—´å•ä½
                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                               ) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š

- `corePoolSize` : ä»»åŠ¡é˜Ÿåˆ—æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- `maximumPoolSize` : ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- `workQueue`: æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

- `keepAliveTime`:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` ï¼Œå³æœ‰éæ ¸å¿ƒçº¿ç¨‹ï¼ˆçº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹ä»¥å¤–çš„çº¿ç¨‹ï¼‰æ—¶ï¼Œè¿™äº›éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²åä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ã€‚
- `unit` : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
- `threadFactory` :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
- `handler` :æ‹’ç»ç­–ç•¥ï¼ˆåé¢ä¼šå•ç‹¬è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼‰ã€‚

ä¸‹é¢è¿™å¼ å›¾å¯ä»¥åŠ æ·±ä½ å¯¹çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»çš„ç†è§£ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](https://oss.javaguide.cn/github/javaguide/java/concurrent/relationship-between-thread-pool-parameters.png)

### çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹ä¼šè¢«å›æ”¶å—ï¼Ÿ

`ThreadPoolExecutor` é»˜è®¤ä¸ä¼šå›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼Œå³ä½¿å®ƒä»¬å·²ç»ç©ºé—²äº†ã€‚è¿™æ˜¯ä¸ºäº†å‡å°‘åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ï¼Œå› ä¸ºæ ¸å¿ƒçº¿ç¨‹é€šå¸¸æ˜¯è¦é•¿æœŸä¿æŒæ´»è·ƒçš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœçº¿ç¨‹æ± æ˜¯è¢«ç”¨äºå‘¨æœŸæ€§ä½¿ç”¨çš„åœºæ™¯ï¼Œä¸”é¢‘ç‡ä¸é«˜ï¼ˆå‘¨æœŸä¹‹é—´æœ‰æ˜æ˜¾çš„ç©ºé—²æ—¶é—´ï¼‰ï¼Œå¯ä»¥è€ƒè™‘å°† `allowCoreThreadTimeOut(boolean value)` æ–¹æ³•çš„å‚æ•°è®¾ç½®ä¸º `true`ï¼Œè¿™æ ·å°±ä¼šå›æ”¶ç©ºé—²ï¼ˆæ—¶é—´é—´éš”ç”± `keepAliveTime` æŒ‡å®šï¼‰çš„æ ¸å¿ƒçº¿ç¨‹äº†ã€‚

```java
public void allowCoreThreadTimeOut(boolean value) {
    // æ ¸å¿ƒçº¿ç¨‹çš„ keepAliveTime å¿…é¡»å¤§äº 0 æ‰èƒ½å¯ç”¨è¶…æ—¶æœºåˆ¶
    if (value && keepAliveTime <= 0) {
        throw new IllegalArgumentException("Core threads must have nonzero keep alive times");
    }
    // è®¾ç½® allowCoreThreadTimeOut çš„å€¼
    if (value != allowCoreThreadTimeOut) {
        allowCoreThreadTimeOut = value;
        // å¦‚æœå¯ç”¨äº†è¶…æ—¶æœºåˆ¶ï¼Œæ¸…ç†æ‰€æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼ŒåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹
        if (value) {
            interruptIdleWorkers();
        }
    }
}
```

### æ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿ

æ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶ï¼Œå…¶çŠ¶æ€åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

- **è®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´** ï¼šæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²æ—¶ï¼Œä¼šå¤„äº `WAITING` çŠ¶æ€ï¼Œç­‰å¾…è·å–ä»»åŠ¡ã€‚å¦‚æœé˜»å¡ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šé€€å‡ºå·¥ä½œï¼Œå°†è¯¥çº¿ç¨‹ä»çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹é›†åˆä¸­ç§»é™¤ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸º `TERMINATED` çŠ¶æ€ã€‚
- **æ²¡æœ‰è®¾ç½®æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´** ï¼šæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²æ—¶ï¼Œä¼šä¸€ç›´å¤„äº `WAITING` çŠ¶æ€ï¼Œç­‰å¾…è·å–ä»»åŠ¡ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»åœ¨çº¿ç¨‹æ± ä¸­ã€‚

å½“é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨ä»»åŠ¡æ—¶ï¼Œä¼šå”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œçº¿ç¨‹çš„çŠ¶æ€ä¼šç”± `WAITING` çŠ¶æ€å˜ä¸º `RUNNABLE` çŠ¶æ€ï¼Œä¹‹åå»æ‰§è¡Œå¯¹åº”ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥é€šè¿‡ç›¸å…³æºç ï¼Œäº†è§£ä¸€ä¸‹çº¿ç¨‹æ± å†…éƒ¨æ˜¯å¦‚ä½•åšçš„ã€‚

çº¿ç¨‹åœ¨çº¿ç¨‹æ± å†…éƒ¨è¢«æŠ½è±¡ä¸ºäº† `Worker` ï¼Œå½“ `Worker` è¢«å¯åŠ¨ä¹‹åï¼Œä¼šä¸æ–­å»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚

åœ¨è·å–ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šæ ¹æ® `timed` å€¼æ¥å†³å®šä»ä»»åŠ¡é˜Ÿåˆ—ï¼ˆ `BlockingQueue` ï¼‰è·å–ä»»åŠ¡çš„è¡Œä¸ºã€‚

å¦‚æœã€Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ã€æˆ–è€…ã€Œçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€ï¼Œåˆ™å°† `timed` æ ‡è®°ä¸º `true` ï¼Œè¡¨æ˜è·å–ä»»åŠ¡æ—¶éœ€è¦ä½¿ç”¨ `poll()` æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚

- `timed == true` ï¼šä½¿ç”¨ `poll(timeout, unit)` æ¥è·å–ä»»åŠ¡ã€‚ä½¿ç”¨ `poll(timeout, unit)` æ–¹æ³•è·å–ä»»åŠ¡è¶…æ—¶çš„è¯ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé€€å‡ºæ‰§è¡Œï¼ˆ `TERMINATED` ï¼‰ï¼Œè¯¥çº¿ç¨‹ä»çº¿ç¨‹æ± ä¸­è¢«ç§»é™¤ã€‚
- `timed == false` ï¼šä½¿ç”¨ `take()` æ¥è·å–ä»»åŠ¡ã€‚ä½¿ç”¨ `take()` æ–¹æ³•è·å–ä»»åŠ¡ä¼šè®©å½“å‰çº¿ç¨‹ä¸€ç›´é˜»å¡ç­‰å¾…ï¼ˆ`WAITING`ï¼‰ã€‚

æºç å¦‚ä¸‹ï¼š

```JAVA
// ThreadPoolExecutor
private Runnable getTask() {
    boolean timedOut = false;
    for (;;) {
        // ...

        // 1ã€å¦‚æœã€Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ã€æˆ–è€…æ˜¯ã€Œçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€ï¼Œåˆ™ timed ä¸º trueã€‚
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
        // 2ã€æ‰£å‡çº¿ç¨‹æ•°é‡ã€‚
        // wc > maximuimPoolSizeï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚å…¶ä¸­ wc ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚
        // timed && timeOutï¼štimeOut è¡¨ç¤ºè·å–ä»»åŠ¡è¶…æ—¶ã€‚
        // åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šæ ¸å¿ƒçº¿ç¨‹è®¾ç½®äº†å­˜æ´»æ—¶é—´ && è·å–ä»»åŠ¡è¶…æ—¶ï¼Œåˆ™æ‰£å‡çº¿ç¨‹æ•°é‡ï¼›çº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ && è·å–ä»»åŠ¡è¶…æ—¶ï¼Œåˆ™æ‰£å‡çº¿ç¨‹æ•°é‡ã€‚
        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }
        try {
            // 3ã€å¦‚æœ timed ä¸º trueï¼Œåˆ™ä½¿ç”¨ poll() è·å–ä»»åŠ¡ï¼›å¦åˆ™ï¼Œä½¿ç”¨ take() è·å–ä»»åŠ¡ã€‚
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            // 4ã€è·å–ä»»åŠ¡ä¹‹åè¿”å›ã€‚
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

### â­ï¸çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- `ThreadPoolExecutor.AbortPolicy`ï¼šæŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- `ThreadPoolExecutor.CallerRunsPolicy`ï¼šè°ƒç”¨æ‰§è¡Œè€…è‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- `ThreadPoolExecutor.DiscardPolicy`ï¼šä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- `ThreadPoolExecutor.DiscardOldestPolicy`ï¼šæ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šSpring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` æ‹’ç»ç­–ç•¥æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ `AbortPolicy`ã€‚åœ¨è¿™ç§æ‹’ç»ç­–ç•¥ä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` å¼‚å¸¸æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚å¦‚æœä¸æƒ³ä¸¢å¼ƒä»»åŠ¡çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`CallerRunsPolicy`ã€‚`CallerRunsPolicy` å’Œå…¶ä»–çš„å‡ ä¸ªç­–ç•¥ä¸åŒï¼Œå®ƒæ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†ä»»åŠ¡å›é€€ç»™è°ƒç”¨è€…ï¼Œä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {

        public CallerRunsPolicy() { }

        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                // ç›´æ¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ
                r.run();
            }
        }
    }
```

### å¦‚æœä¸å…è®¸ä¸¢å¼ƒä»»åŠ¡ï¼Œåº”è¯¥é€‰æ‹©å“ªä¸ªæ‹’ç»ç­–ç•¥ï¼Ÿ

æ ¹æ®ä¸Šé¢å¯¹çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥çš„ä»‹ç»ï¼Œç›¸ä¿¡å¤§å®¶å¾ˆå®¹æ˜“èƒ½å¤Ÿå¾—å‡ºç­”æ¡ˆæ˜¯ï¼š`CallerRunsPolicy` ã€‚

è¿™é‡Œæˆ‘ä»¬å†æ¥ç»“åˆ`CallerRunsPolicy` çš„æºç æ¥çœ‹çœ‹ï¼š

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {

        public CallerRunsPolicy() { }


        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            //åªè¦å½“å‰ç¨‹åºæ²¡æœ‰å…³é—­ï¼Œå°±ç”¨æ‰§è¡Œexecuteæ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡
            if (!e.isShutdown()) {

                r.run();
            }
        }
    }
```

ä»æºç å¯ä»¥çœ‹å‡ºï¼Œåªè¦å½“å‰ç¨‹åºä¸å…³é—­å°±ä¼šä½¿ç”¨æ‰§è¡Œ`execute`æ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

### CallerRunsPolicy æ‹’ç»ç­–ç•¥æœ‰ä»€ä¹ˆé£é™©ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼šå¦‚æœæƒ³è¦ä¿è¯ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œé‚£é€‰æ‹© `CallerRunsPolicy` æ‹’ç»ç­–ç•¥æ›´åˆé€‚ä¸€äº›ã€‚

ä¸è¿‡ï¼Œå¦‚æœèµ°åˆ°`CallerRunsPolicy`çš„ä»»åŠ¡æ˜¯ä¸ªéå¸¸è€—æ—¶çš„ä»»åŠ¡ï¼Œä¸”å¤„ç†æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œå½±å“ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚

è¿™é‡Œç®€å•ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œè¯¥çº¿ç¨‹æ± é™å®šäº†æœ€å¤§çº¿ç¨‹æ•°ä¸º 2ï¼Œé˜»å¡é˜Ÿåˆ—å¤§å°ä¸º 1(è¿™æ„å‘³ç€ç¬¬ 4 ä¸ªä»»åŠ¡å°±ä¼šèµ°åˆ°æ‹’ç»ç­–ç•¥)ï¼Œ`ThreadUtil`ä¸º Hutool æä¾›çš„å·¥å…·ç±»ï¼š

```java
public class ThreadPoolTest {

    private static final Logger log = LoggerFactory.getLogger(ThreadPoolTest.class);

    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º1ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º2
        // å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´ä¸º60ç§’ï¼Œ
        // ä»»åŠ¡é˜Ÿåˆ—ä¸ºå®¹é‡ä¸º1çš„ArrayBlockingQueueï¼Œé¥±å’Œç­–ç•¥ä¸ºCallerRunsPolicyã€‚
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(1,
                2,
                60,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(1),
                new ThreadPoolExecutor.CallerRunsPolicy());

        // æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œç”±æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ
        threadPoolExecutor.execute(() -> {
            log.info("æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹è¢«å ç”¨ï¼Œä»»åŠ¡å°†è¿›å…¥é˜Ÿåˆ—ç­‰å¾…
        threadPoolExecutor.execute(() -> {
            log.info("éæ ¸å¿ƒçº¿ç¨‹å¤„ç†å…¥é˜Ÿçš„ç¬¬äºŒä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹è¢«å ç”¨ä¸”é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤„ç†
        threadPoolExecutor.execute(() -> {
            log.info("éæ ¸å¿ƒçº¿ç¨‹å¤„ç†ç¬¬ä¸‰ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬å››ä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹éƒ½è¢«å ç”¨ï¼Œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ ¹æ®CallerRunsPolicyç­–ç•¥ï¼Œä»»åŠ¡å°†ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆå³ä¸»çº¿ç¨‹ï¼‰æ¥æ‰§è¡Œ
        threadPoolExecutor.execute(() -> {
            log.info("ä¸»çº¿ç¨‹å¤„ç†ç¬¬å››ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(2, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬äº”ä¸ªä»»åŠ¡ï¼Œä¸»çº¿ç¨‹è¢«ç¬¬å››ä¸ªä»»åŠ¡å¡ä½ï¼Œè¯¥ä»»åŠ¡å¿…é¡»ç­‰åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ‰èƒ½æäº¤
        threadPoolExecutor.execute(() -> {
            log.info("æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬äº”ä¸ªä»»åŠ¡");
        });

        // å…³é—­çº¿ç¨‹æ± 
        threadPoolExecutor.shutdown();
    }
}

```

è¾“å‡ºï¼š

```bash
18:19:48.203 INFO  [pool-1-thread-1] c.j.concurrent.ThreadPoolTest - æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
18:19:48.203 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - éæ ¸å¿ƒçº¿ç¨‹å¤„ç†ç¬¬ä¸‰ä¸ªä»»åŠ¡
18:19:48.203 INFO  [main] c.j.concurrent.ThreadPoolTest - ä¸»çº¿ç¨‹å¤„ç†ç¬¬å››ä¸ªä»»åŠ¡
18:20:48.212 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - éæ ¸å¿ƒçº¿ç¨‹å¤„ç†å…¥é˜Ÿçš„ç¬¬äºŒä¸ªä»»åŠ¡
18:21:48.219 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬äº”ä¸ªä»»åŠ¡
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œå› ä¸º`CallerRunsPolicy`è¿™ä¸ªæ‹’ç»ç­–ç•¥ï¼Œå¯¼è‡´è€—æ—¶çš„ä»»åŠ¡ç”¨äº†ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¯¼è‡´çº¿ç¨‹æ± é˜»å¡ï¼Œè¿›è€Œå¯¼è‡´åç»­ä»»åŠ¡æ— æ³•åŠæ—¶æ‰§è¡Œï¼Œä¸¥é‡çš„æƒ…å†µä¸‹å¾ˆå¯èƒ½å¯¼è‡´ OOMã€‚

æˆ‘ä»¬ä»é—®é¢˜çš„æœ¬è´¨å…¥æ‰‹ï¼Œè°ƒç”¨è€…é‡‡ç”¨`CallerRunsPolicy`æ˜¯å¸Œæœ›æ‰€æœ‰çš„ä»»åŠ¡éƒ½èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œæš‚æ—¶æ— æ³•å¤„ç†çš„ä»»åŠ¡åˆè¢«ä¿å­˜åœ¨é˜»å¡é˜Ÿåˆ—`BlockingQueue`ä¸­ã€‚è¿™æ ·çš„è¯ï¼Œåœ¨å†…å­˜å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ é˜»å¡é˜Ÿåˆ—`BlockingQueue`çš„å¤§å°å¹¶è°ƒæ•´å †å†…å­˜ä»¥å®¹çº³æ›´å¤šçš„ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡èƒ½å¤Ÿè¢«å‡†ç¡®æ‰§è¡Œã€‚

ä¸ºäº†å……åˆ†åˆ©ç”¨ CPUï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è°ƒæ•´çº¿ç¨‹æ± çš„`maximumPoolSize` ï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰å‚æ•°ï¼Œè¿™æ ·å¯ä»¥æé«˜ä»»åŠ¡å¤„ç†é€Ÿåº¦ï¼Œé¿å…ç´¯è®¡åœ¨ `BlockingQueue`çš„ä»»åŠ¡è¿‡å¤šå¯¼è‡´å†…å­˜ç”¨å®Œã€‚

![è°ƒæ•´é˜»å¡é˜Ÿåˆ—å¤§å°å’Œæœ€å¤§çº¿ç¨‹æ•°](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpool-reject-2-threadpool-reject-01.png)

å¦‚æœæœåŠ¡å™¨èµ„æºä»¥è¾¾åˆ°å¯åˆ©ç”¨çš„æé™ï¼Œè¿™å°±æ„å‘³æˆ‘ä»¬è¦åœ¨è®¾è®¡ç­–ç•¥ä¸Šæ”¹å˜çº¿ç¨‹æ± çš„è°ƒåº¦äº†ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹å¡æ­»çš„æœ¬è´¨å°±æ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¢«ä¸¢å¼ƒã€‚æ¢ä¸ªæ€è·¯ï¼Œæœ‰æ²¡æœ‰åŠæ³•æ—¢èƒ½ä¿è¯ä»»åŠ¡ä¸è¢«ä¸¢å¼ƒä¸”åœ¨æœåŠ¡å™¨æœ‰ä½™åŠ›æ—¶åŠæ—¶å¤„ç†å‘¢ï¼Ÿ

è¿™é‡Œæä¾›çš„ä¸€ç§**ä»»åŠ¡æŒä¹…åŒ–**çš„æ€è·¯ï¼Œè¿™é‡Œæ‰€è°“çš„ä»»åŠ¡æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº:

1. è®¾è®¡ä¸€å¼ ä»»åŠ¡è¡¨å°†ä»»åŠ¡å­˜å‚¨åˆ° MySQL æ•°æ®åº“ä¸­ã€‚
2. Redis ç¼“å­˜ä»»åŠ¡ã€‚
3. å°†ä»»åŠ¡æäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚

è¿™é‡Œä»¥æ–¹æ¡ˆä¸€ä¸ºä¾‹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å®ç°é€»è¾‘ï¼š

1. å®ç°`RejectedExecutionHandler`æ¥å£è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼Œè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥è´Ÿè´£å°†çº¿ç¨‹æ± æš‚æ—¶æ— æ³•å¤„ç†ï¼ˆæ­¤æ—¶é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼‰çš„ä»»åŠ¡å…¥åº“ï¼ˆä¿å­˜åˆ° MySQL ä¸­ï¼‰ã€‚æ³¨æ„ï¼šçº¿ç¨‹æ± æš‚æ—¶æ— æ³•å¤„ç†çš„ä»»åŠ¡ä¼šå…ˆè¢«æ”¾åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œé˜»å¡é˜Ÿåˆ—æ»¡äº†æ‰ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚
2. ç»§æ‰¿`BlockingQueue`å®ç°ä¸€ä¸ªæ··åˆå¼é˜»å¡é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—åŒ…å« JDK è‡ªå¸¦çš„`ArrayBlockingQueue`ã€‚å¦å¤–ï¼Œè¯¥æ··åˆå¼é˜»å¡é˜Ÿåˆ—éœ€è¦ä¿®æ”¹å–ä»»åŠ¡å¤„ç†çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯é‡å†™`take()`æ–¹æ³•ï¼Œå–ä»»åŠ¡æ—¶ä¼˜å…ˆä»æ•°æ®åº“ä¸­è¯»å–æœ€æ—©çš„ä»»åŠ¡ï¼Œæ•°æ®åº“ä¸­æ— ä»»åŠ¡æ—¶å†ä» `ArrayBlockingQueue`ä¸­å»å–ä»»åŠ¡ã€‚

![å°†ä¸€éƒ¨åˆ†ä»»åŠ¡ä¿å­˜åˆ°MySQLä¸­](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpool-reject-2-threadpool-reject-02.png)

æ•´ä¸ªå®ç°é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ ¸å¿ƒåœ¨äºè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥å’Œé˜»å¡é˜Ÿåˆ—ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¸€æ—¦æˆ‘ä»¬çš„çº¿ç¨‹æ± ä¸­çº¿ç¨‹è¾¾åˆ°æ»¡è½½æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‹’ç»ç­–ç•¥å°†æœ€æ–°ä»»åŠ¡æŒä¹…åŒ–åˆ° MySQL æ•°æ®åº“ä¸­ï¼Œç­‰åˆ°çº¿ç¨‹æ± æœ‰äº†æœ‰ä½™åŠ›å¤„ç†æ‰€æœ‰ä»»åŠ¡æ—¶ï¼Œè®©å…¶ä¼˜å…ˆå¤„ç†æ•°æ®åº“ä¸­çš„ä»»åŠ¡ä»¥é¿å…"é¥¥é¥¿"é—®é¢˜ã€‚

å½“ç„¶ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‚è€ƒå…¶ä»–ä¸»æµæ¡†æ¶çš„åšæ³•ï¼Œä»¥ Netty ä¸ºä¾‹ï¼Œå®ƒçš„æ‹’ç»ç­–ç•¥åˆ™æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ä»¥å¤–çš„çº¿ç¨‹å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œä¸ºäº†ä¿è¯ä»»åŠ¡çš„å®æ—¶å¤„ç†ï¼Œè¿™ç§åšæ³•å¯èƒ½éœ€è¦è‰¯å¥½çš„ç¡¬ä»¶è®¾å¤‡ä¸”ä¸´æ—¶åˆ›å»ºçš„çº¿ç¨‹æ— æ³•åšåˆ°å‡†ç¡®çš„ç›‘æ§ï¼š

```java
private static final class NewThreadRunsPolicy implements RejectedExecutionHandler {
    NewThreadRunsPolicy() {
        super();
    }
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        try {
            //åˆ›å»ºä¸€ä¸ªä¸´æ—¶çº¿ç¨‹å¤„ç†ä»»åŠ¡
            final Thread t = new Thread(r, "Temporary task executor");
            t.start();
        } catch (Throwable e) {
            throw new RejectedExecutionException(
                    "Failed to start a new thread", e);
        }
    }
}
```

ActiveMQ åˆ™æ˜¯å°è¯•åœ¨æŒ‡å®šçš„æ—¶æ•ˆå†…å°½å¯èƒ½çš„äº‰å–å°†ä»»åŠ¡å…¥é˜Ÿï¼Œä»¥ä¿è¯æœ€å¤§äº¤ä»˜ï¼š

```java
new RejectedExecutionHandler() {
                @Override
                public void rejectedExecution(final Runnable r, final ThreadPoolExecutor executor) {
                    try {
                        //é™æ—¶é˜»å¡ç­‰å¾…ï¼Œå®ç°å°½å¯èƒ½äº¤ä»˜
                        executor.getQueue().offer(r, 60, TimeUnit.SECONDS);
                    } catch (InterruptedException e) {
                        throw new RejectedExecutionException("Interrupted waiting for BrokerService.worker");
                    }
                    throw new RejectedExecutionException("Timed Out while attempting to enqueue Task.");
                }
            });
```

### çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ

æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

ä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå†…ç½®çº¿ç¨‹æ± æ¥åˆ†æã€‚

- å®¹é‡ä¸º `Integer.MAX_VALUE` çš„ `LinkedBlockingQueue`ï¼ˆæ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼‰ï¼š`FixedThreadPool` å’Œ `SingleThreadExecutor` ã€‚`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ç›¸ç­‰ï¼‰ï¼Œ`SingleThreadExecutor`åªèƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ 1ï¼‰ï¼ŒäºŒè€…çš„ä»»åŠ¡é˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ã€‚
- `SynchronousQueue`ï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰ï¼š`CachedThreadPool` ã€‚`SynchronousQueue` æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿è¯å¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`CachedThreadPool` çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE` ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°æ˜¯å¯ä»¥æ— é™æ‰©å±•çš„ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `DelayedWorkQueue`ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰ï¼š`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor` ã€‚`DelayedWorkQueue` çš„å†…éƒ¨å…ƒç´ å¹¶ä¸æ˜¯æŒ‰ç…§æ”¾å…¥çš„æ—¶é—´æ’åºï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åºï¼Œå†…éƒ¨é‡‡ç”¨çš„æ˜¯â€œå †â€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ã€‚`DelayedWorkQueue` æ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚å…¶åº•å±‚è™½ç„¶æ˜¯æ•°ç»„ï¼Œä½†å½“æ•°ç»„å®¹é‡ä¸è¶³æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤é˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«å¡«æ»¡ã€‚å½“ä»»åŠ¡ä¸æ–­æäº¤æ—¶ï¼Œå®ƒä»¬ä¼šå…¨éƒ¨è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™æ„å‘³ç€çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡æ°¸è¿œä¸ä¼šè¶…è¿‡å…¶æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°å‚æ•°å¯¹äºä½¿ç”¨è¯¥é˜Ÿåˆ—çš„çº¿ç¨‹æ± æ¥è¯´æ˜¯æ— æ•ˆçš„ã€‚
- `ArrayBlockingQueue`ï¼ˆæœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼‰ï¼šåº•å±‚ç”±æ•°ç»„å®ç°ï¼Œå®¹é‡ä¸€æ—¦åˆ›å»ºï¼Œå°±ä¸èƒ½ä¿®æ”¹ã€‚

### â­ï¸çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æµç¨‹äº†è§£å—ï¼Ÿ

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](https://oss.javaguide.cn/github/javaguide/java/concurrent/thread-pool-principle.png)

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
2. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äºæˆ–å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥ä»»åŠ¡æ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚
3. å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œä½†æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°çš„ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
4. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å·²ç»ç­‰åŒäºæœ€å¤§çº¿ç¨‹æ•°äº†ï¼Œæ–°å»ºçº¿ç¨‹å°†ä¼šä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå½“å‰ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œæ‹’ç»ç­–ç•¥ä¼šè°ƒç”¨`RejectedExecutionHandler.rejectedExecution()`æ–¹æ³•ã€‚

å†æä¸€ä¸ªæœ‰æ„æ€çš„å°é—®é¢˜ï¼š**çº¿ç¨‹æ± åœ¨æäº¤ä»»åŠ¡å‰ï¼Œå¯ä»¥æå‰åˆ›å»ºçº¿ç¨‹å—ï¼Ÿ**

ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼`ThreadPoolExecutor` æä¾›äº†ä¸¤ä¸ªæ–¹æ³•å¸®åŠ©æˆ‘ä»¬åœ¨æäº¤ä»»åŠ¡ä¹‹å‰ï¼Œå®Œæˆæ ¸å¿ƒçº¿ç¨‹çš„åˆ›å»ºï¼Œä»è€Œå®ç°çº¿ç¨‹æ± é¢„çƒ­çš„æ•ˆæœï¼š

- `prestartCoreThread()`:å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡ï¼Œå¦‚æœå·²è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› falseï¼Œå¦åˆ™è¿”å› trueï¼›
- `prestartAllCoreThreads()`:å¯åŠ¨æ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œå¹¶è¿”å›å¯åŠ¨æˆåŠŸçš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚

### â­ï¸çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼Œé”€æ¯è¿˜æ˜¯å¤ç”¨ï¼Ÿ

ç›´æ¥è¯´ç»“è®ºï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µï¼š

- **ä½¿ç”¨`execute()`æäº¤ä»»åŠ¡**ï¼šå½“ä»»åŠ¡é€šè¿‡`execute()`æäº¤åˆ°çº¿ç¨‹æ± å¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¦‚æœè¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨ä»»åŠ¡å†…è¢«æ•è·ï¼Œé‚£ä¹ˆè¯¥å¼‚å¸¸ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ç»ˆæ­¢ï¼Œå¹¶ä¸”å¼‚å¸¸ä¼šè¢«æ‰“å°åˆ°æ§åˆ¶å°æˆ–æ—¥å¿—æ–‡ä»¶ä¸­ã€‚çº¿ç¨‹æ± ä¼šæ£€æµ‹åˆ°è¿™ç§çº¿ç¨‹ç»ˆæ­¢ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ›¿æ¢å®ƒï¼Œä»è€Œä¿æŒé…ç½®çš„çº¿ç¨‹æ•°ä¸å˜ã€‚
- **ä½¿ç”¨`submit()`æäº¤ä»»åŠ¡**ï¼šå¯¹äºé€šè¿‡`submit()`æäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœåœ¨ä»»åŠ¡æ‰§è¡Œä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¸ä¼šç›´æ¥æ‰“å°å‡ºæ¥ã€‚ç›¸åï¼Œå¼‚å¸¸ä¼šè¢«å°è£…åœ¨ç”±`submit()`è¿”å›çš„`Future`å¯¹è±¡ä¸­ã€‚å½“è°ƒç”¨`Future.get()`æ–¹æ³•æ—¶ï¼Œå¯ä»¥æ•è·åˆ°ä¸€ä¸ª`ExecutionException`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¸ä¼šå› ä¸ºå¼‚å¸¸è€Œç»ˆæ­¢ï¼Œå®ƒä¼šç»§ç»­å­˜åœ¨äºçº¿ç¨‹æ± ä¸­ï¼Œå‡†å¤‡æ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚

ç®€å•æ¥è¯´ï¼šä½¿ç”¨`execute()`æ—¶ï¼Œæœªæ•è·å¼‚å¸¸å¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ï¼Œçº¿ç¨‹æ± åˆ›å»ºæ–°çº¿ç¨‹æ›¿ä»£ï¼›ä½¿ç”¨`submit()`æ—¶ï¼Œå¼‚å¸¸è¢«å°è£…åœ¨`Future`ä¸­ï¼Œçº¿ç¨‹ç»§ç»­å¤ç”¨ã€‚

è¿™ç§è®¾è®¡å…è®¸`submit()`æä¾›æ›´çµæ´»çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºå®ƒå…è®¸è°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Œè€Œ`execute()`åˆ™é€‚ç”¨äºé‚£äº›ä¸éœ€è¦å…³æ³¨æ‰§è¡Œç»“æœçš„åœºæ™¯ã€‚

å…·ä½“çš„æºç åˆ†æå¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š[çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼šé”€æ¯è¿˜æ˜¯å¤ç”¨ï¼Ÿ - äº¬ä¸œæŠ€æœ¯](https://mp.weixin.qq.com/s/9ODjdUU-EwQFF5PrnzOGfw)ã€‚

### â­ï¸å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ

åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºå‘½åï¼ˆè®¾ç½®çº¿ç¨‹æ± åç§°å‰ç¼€ï¼‰ï¼Œæœ‰åˆ©äºå®šä½é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹åå­—ç±»ä¼¼ `pool-1-thread-n` è¿™æ ·çš„ï¼Œæ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å‘½åé€šå¸¸æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

**1ã€åˆ©ç”¨ guava çš„ `ThreadFactoryBuilder`**

```java
ThreadFactory threadFactory = new ThreadFactoryBuilder()
                        .setNameFormat(threadNamePrefix + "-%d")
                        .setDaemon(true).build();
ExecutorService threadPool = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
```

**2ã€è‡ªå·±å®ç° `ThreadFactory`ã€‚**

```java
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * çº¿ç¨‹å·¥å‚ï¼Œå®ƒè®¾ç½®çº¿ç¨‹åç§°ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚
 */
public final class NamingThreadFactory implements ThreadFactory {

    private final AtomicInteger threadNum = new AtomicInteger();
    private final String name;

    /**
     * åˆ›å»ºä¸€ä¸ªå¸¦åå­—çš„çº¿ç¨‹æ± ç”Ÿäº§å·¥å‚
     */
    public NamingThreadFactory(String name) {
        this.name = name;
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = new Thread(r);
        t.setName(name + " [#" + threadNum.incrementAndGet() + "]");
        return t;
    }
}
```

### å¦‚ä½•è®¾å®šçº¿ç¨‹æ± çš„å¤§å°ï¼Ÿ

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

ç±»æ¯”äºç°å®ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚

- å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ŒCPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚
- å¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

**å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼ˆå‚è§ï¼š[issue#1737](https://github.com/Snailclimb/JavaGuide/issues/1737)ï¼‰ï¼š
>
> çº¿ç¨‹æ•°æ›´ä¸¥è°¨çš„è®¡ç®—çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š`æœ€ä½³çº¿ç¨‹æ•° = Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰/STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰ï¼‰`ï¼Œå…¶ä¸­ `WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰=çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ - STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰`ã€‚
>
> çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ã€‚çº¿ç¨‹è®¡ç®—æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚
>
> æˆ‘ä»¬å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„å·¥å…· VisualVM æ¥æŸ¥çœ‹ `WT/ST` æ¯”ä¾‹ã€‚
>
> CPU å¯†é›†å‹ä»»åŠ¡çš„ `WT/ST` æ¥è¿‘æˆ–è€…ç­‰äº 0ï¼Œå› æ­¤ï¼Œ çº¿ç¨‹æ•°å¯ä»¥è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+0ï¼‰= Nï¼Œå’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1 å·®ä¸å¤šã€‚
>
> IO å¯†é›†å‹ä»»åŠ¡ä¸‹ï¼Œå‡ ä¹å…¨æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œä½ å°±å¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º 2Nï¼ˆæŒ‰é“ç†æ¥è¯´ï¼ŒWT/ST çš„ç»“æœåº”è¯¥æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œé€‰æ‹© 2N çš„åŸå› åº”è¯¥æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçº¿ç¨‹å§ï¼‰ã€‚

å…¬å¼ä¹Ÿåªæ˜¯å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®å®é™…çº¿ä¸Šè¿è¡Œæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚æˆ‘åœ¨åé¢ä»‹ç»çš„ç¾å›¢çš„çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®è¿™ç§æ–¹æ¡ˆå°±éå¸¸ä¸é”™ï¼Œå¾ˆå®ç”¨ï¼

### â­ï¸å¦‚ä½•åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„å‚æ•°ï¼Ÿ

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨[ã€ŠJava çº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µã€‹](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»åˆ°å¯¹çº¿ç¨‹æ± å‚æ•°å®ç°å¯è‡ªå®šä¹‰é…ç½®çš„æ€è·¯å’Œæ–¹æ³•ã€‚

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ€è·¯æ˜¯ä¸»è¦å¯¹çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å®ç°è‡ªå®šä¹‰å¯é…ç½®ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯ï¼š

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

**ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ**

æˆ‘åœ¨[Java çº¿ç¨‹æ± è¯¦è§£](https://javaguide.cn/java/concurrent/java-thread-pool-summary.html) è¿™ç¯‡æ–‡ç« ä¸­å°±è¯´è¿‡è¿™ä¸‰ä¸ªå‚æ•°æ˜¯ `ThreadPoolExecutor` æœ€é‡è¦çš„å‚æ•°ï¼Œå®ƒä»¬åŸºæœ¬å†³å®šäº†çº¿ç¨‹æ± å¯¹äºä»»åŠ¡çš„å¤„ç†ç­–ç•¥ã€‚

**å¦‚ä½•æ”¯æŒå‚æ•°åŠ¨æ€é…ç½®ï¼Ÿ** ä¸”çœ‹ `ThreadPoolExecutor` æä¾›çš„ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-methods.png)

æ ¼å¤–éœ€è¦æ³¨æ„çš„æ˜¯`corePoolSize`ï¼Œ ç¨‹åºè¿è¡ŒæœŸé—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨ `setCorePoolSize()`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹æ± ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å¤§äº`corePoolSize`ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šå›æ”¶å·¥ä½œçº¿ç¨‹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å¹¶æ²¡æœ‰åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ï¼Œç¾å›¢çš„æ–¹å¼æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå«åš `ResizableCapacityLinkedBlockIngQueue` çš„é˜Ÿåˆ—ï¼ˆä¸»è¦å°±æ˜¯æŠŠ`LinkedBlockingQueue`çš„ capacity å­—æ®µçš„ final å…³é”®å­—ä¿®é¥°ç»™å»æ‰äº†ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„ï¼‰ã€‚

æœ€ç»ˆå®ç°çš„å¯åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°æ•ˆæœå¦‚ä¸‹ã€‚ğŸ‘ğŸ‘ğŸ‘

![åŠ¨æ€é…ç½®çº¿ç¨‹æ± å‚æ•°æœ€ç»ˆæ•ˆæœ](https://oss.javaguide.cn/github/javaguide/java/concurrent/meituan-dynamically-configuring-thread-pool-parameters.png)

è¿˜æ²¡çœ‹å¤Ÿï¼Ÿæˆ‘åœ¨[ã€Šåç«¯é¢è¯•é«˜é¢‘ç³»ç»Ÿè®¾è®¡&åœºæ™¯é¢˜ã€‹](https://javaguide.cn/zhuanlan/back-end-interview-high-frequency-system-design-and-scenario-questions.html)ä¸­è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è®¾è®¡ä¸€ä¸ªåŠ¨æ€çº¿ç¨‹æ± ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•ä¸­å¸¸é—®çš„ä¸€é“ç³»ç»Ÿè®¾è®¡é¢˜ã€‚

![ã€Šåç«¯é¢è¯•é«˜é¢‘ç³»ç»Ÿè®¾è®¡&åœºæ™¯é¢˜ã€‹](https://oss.javaguide.cn/xingqiu/back-end-interview-high-frequency-system-design-and-scenario-questions-fengmian.png)

å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿæƒ³è¦å®ç°è¿™ç§æ•ˆæœçš„è¯ï¼Œå¯ä»¥å€ŸåŠ©ç°æˆçš„å¼€æºé¡¹ç›®ï¼š

- **[Hippo4j](https://github.com/opengoofy/hippo4j)**ï¼šå¼‚æ­¥çº¿ç¨‹æ± æ¡†æ¶ï¼Œæ”¯æŒçº¿ç¨‹æ± åŠ¨æ€å˜æ›´&ç›‘æ§&æŠ¥è­¦ï¼Œæ— éœ€ä¿®æ”¹ä»£ç è½»æ¾å¼•å…¥ã€‚æ”¯æŒå¤šç§ä½¿ç”¨æ¨¡å¼ï¼Œè½»æ¾å¼•å…¥ï¼Œè‡´åŠ›äºæé«˜ç³»ç»Ÿè¿è¡Œä¿éšœèƒ½åŠ›ã€‚
- **[Dynamic TP](https://github.com/dromara/dynamic-tp)**ï¼šè½»é‡çº§åŠ¨æ€çº¿ç¨‹æ± ï¼Œå†…ç½®ç›‘æ§å‘Šè­¦åŠŸèƒ½ï¼Œé›†æˆä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± ç®¡ç†ï¼ŒåŸºäºä¸»æµé…ç½®ä¸­å¿ƒï¼ˆå·²æ”¯æŒ Nacosã€Apolloï¼ŒZookeeperã€Consulã€Etcdï¼Œå¯é€šè¿‡ SPI è‡ªå®šä¹‰å®ç°ï¼‰ã€‚

### â­ï¸å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæ ¹æ®ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¥æ‰§è¡Œçš„çº¿ç¨‹æ± ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é¢è¯•é—®é¢˜ï¼Œæœ¬è´¨å…¶å®è¿˜æ˜¯åœ¨è€ƒå¯Ÿæ±‚èŒè€…å¯¹äºçº¿ç¨‹æ± ä»¥åŠé˜»å¡é˜Ÿåˆ—çš„æŒæ¡ã€‚

æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼Œä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯”å¦‚`FixedThreadPool` ä½¿ç”¨çš„æ˜¯`LinkedBlockingQueue`ï¼ˆæœ‰ç•Œé˜Ÿåˆ—ï¼‰ï¼Œé»˜è®¤æ„é€ å™¨åˆå§‹çš„é˜Ÿåˆ—é•¿åº¦ä¸º `Integer.MAX_VALUE` ï¼Œç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚

å‡å¦‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªä¼˜å…ˆçº§ä»»åŠ¡çº¿ç¨‹æ± çš„è¯ï¼Œé‚£å¯ä»¥è€ƒè™‘ä½¿ç”¨ `PriorityBlockingQueue` ï¼ˆä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—ï¼‰ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼ˆ`ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æœ‰ä¸€ä¸ª `workQueue` å‚æ•°å¯ä»¥ä¼ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼‰ã€‚

![ThreadPoolExecutoræ„é€ å‡½æ•°](https://oss.javaguide.cn/github/javaguide/java/concurrent/common-parameters-of-threadpool-workqueue.jpg)

`PriorityBlockingQueue` æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ `PriorityQueue`ï¼Œä¸¤è€…åº•å±‚éƒ½æ˜¯ä½¿ç”¨å°é¡¶å †å½¢å¼çš„äºŒå‰å †ï¼Œå³å€¼æœ€å°çš„å…ƒç´ ä¼˜å…ˆå‡ºé˜Ÿã€‚ä¸è¿‡ï¼Œ`PriorityQueue` ä¸æ”¯æŒé˜»å¡æ“ä½œã€‚

è¦æƒ³è®© `PriorityBlockingQueue` å®ç°å¯¹ä»»åŠ¡çš„æ’åºï¼Œä¼ å…¥å…¶ä¸­çš„ä»»åŠ¡å¿…é¡»æ˜¯å…·å¤‡æ’åºèƒ½åŠ›çš„ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼š

1. æäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡å®ç° `Comparable` æ¥å£ï¼Œå¹¶é‡å†™ `compareTo` æ–¹æ³•æ¥æŒ‡å®šä»»åŠ¡ä¹‹é—´çš„ä¼˜å…ˆçº§æ¯”è¾ƒè§„åˆ™ã€‚
2. åˆ›å»º `PriorityBlockingQueue` æ—¶ä¼ å…¥ä¸€ä¸ª `Comparator` å¯¹è±¡æ¥æŒ‡å®šä»»åŠ¡ä¹‹é—´çš„æ’åºè§„åˆ™(æ¨è)ã€‚

ä¸è¿‡ï¼Œè¿™å­˜åœ¨ä¸€äº›é£é™©å’Œé—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- `PriorityBlockingQueue` æ˜¯æ— ç•Œçš„ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- å¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿é—®é¢˜ï¼Œå³ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é•¿æ—¶é—´å¾—ä¸åˆ°æ‰§è¡Œã€‚
- ç”±äºéœ€è¦å¯¹é˜Ÿåˆ—ä¸­çš„å…ƒç´ è¿›è¡Œæ’åºæ“ä½œä»¥åŠä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆå¹¶å‘æ§åˆ¶é‡‡ç”¨çš„æ˜¯å¯é‡å…¥é” `ReentrantLock`ï¼‰ï¼Œå› æ­¤ä¼šé™ä½æ€§èƒ½ã€‚

å¯¹äº OOM è¿™ä¸ªé—®é¢˜çš„è§£å†³æ¯”è¾ƒç®€å•ç²—æš´ï¼Œå°±æ˜¯ç»§æ‰¿`PriorityBlockingQueue` å¹¶é‡å†™ä¸€ä¸‹ `offer` æ–¹æ³•(å…¥é˜Ÿ)çš„é€»è¾‘ï¼Œå½“æ’å…¥çš„å…ƒç´ æ•°é‡è¶…è¿‡æŒ‡å®šå€¼å°±è¿”å› false ã€‚

é¥¥é¥¿é—®é¢˜è¿™ä¸ªå¯ä»¥é€šè¿‡ä¼˜åŒ–è®¾è®¡æ¥è§£å†³ï¼ˆæ¯”è¾ƒéº»çƒ¦ï¼‰ï¼Œæ¯”å¦‚ç­‰å¾…æ—¶é—´è¿‡é•¿çš„ä»»åŠ¡ä¼šè¢«ç§»é™¤å¹¶é‡æ–°æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ä¼˜å…ˆçº§ä¼šè¢«æå‡ã€‚

å¯¹äºæ€§èƒ½æ–¹é¢çš„å½±å“ï¼Œæ˜¯æ²¡åŠæ³•é¿å…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å¯¹ä»»åŠ¡è¿›è¡Œæ’åºæ“ä½œã€‚å¹¶ä¸”ï¼Œå¯¹äºå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯æ¥è¯´ï¼Œè¿™ç‚¹æ€§èƒ½å½±å“æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## Future

é‡ç‚¹æ˜¯è¦æŒæ¡ `CompletableFuture` çš„ä½¿ç”¨ä»¥åŠå¸¸è§é¢è¯•é¢˜ã€‚

é™¤äº†ä¸‹é¢çš„é¢è¯•é¢˜ä¹‹å¤–ï¼Œè¿˜æ¨èä½ çœ‹çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š [CompletableFuture è¯¦è§£](https://javaguide.cn/java/concurrent/completablefuture-intro.html)ã€‚

### Future ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` ç±»æ˜¯å¼‚æ­¥æ€æƒ³çš„å…¸å‹è¿ç”¨ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›éœ€è¦æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œé¿å…ç¨‹åºä¸€ç›´åŸåœ°ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œæ•ˆç‡å¤ªä½ã€‚å…·ä½“æ¥è¯´æ˜¯è¿™æ ·çš„ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸€è€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥å°†è¿™ä¸ªè€—æ—¶ä»»åŠ¡äº¤ç»™ä¸€ä¸ªå­çº¿ç¨‹å»å¼‚æ­¥æ‰§è¡Œï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¹²ç‚¹å…¶ä»–äº‹æƒ…ï¼Œä¸ç”¨å‚»å‚»ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ç­‰æˆ‘ä»¬çš„äº‹æƒ…å¹²å®Œåï¼Œæˆ‘ä»¬å†é€šè¿‡ `Future` ç±»è·å–åˆ°è€—æ—¶ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å°±æ˜æ˜¾æé«˜äº†ã€‚

è¿™å…¶å®å°±æ˜¯å¤šçº¿ç¨‹ä¸­ç»å…¸çš„ **Future æ¨¡å¼**ï¼Œä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä¸»è¦ç”¨åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼Œå¹¶é Java è¯­è¨€ç‹¬æœ‰ã€‚

åœ¨ Java ä¸­ï¼Œ`Future` ç±»åªæ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä½äº `java.util.concurrent` åŒ…ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™ 4 ä¸ªåŠŸèƒ½ï¼š

- å–æ¶ˆä»»åŠ¡ï¼›
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ;
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ;
- è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

```java
// V ä»£è¡¨äº†Futureæ‰§è¡Œçš„ä»»åŠ¡è¿”å›å€¼çš„ç±»å‹
public interface Future<V> {
    // å–æ¶ˆä»»åŠ¡æ‰§è¡Œ
    // æˆåŠŸå–æ¶ˆè¿”å› trueï¼Œå¦åˆ™è¿”å› false
    boolean cancel(boolean mayInterruptIfRunning);
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    boolean isCancelled();
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
    boolean isDone();
    // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
    V get() throws InterruptedException, ExecutionException;
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¿”å›è®¡ç®—ç»“æœå°±æŠ›å‡º TimeOutException å¼‚å¸¸
    V get(long timeout, TimeUnit unit)

        throws InterruptedException, ExecutionException, TimeoutExceptio

}
```

ç®€å•ç†è§£å°±æ˜¯ï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº† `Future` æ¥å¤„ç†ã€‚ä»»åŠ¡æ‰§è¡ŒæœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™æœŸé—´æˆ‘è¿˜å¯ä»¥å–æ¶ˆä»»åŠ¡ä»¥åŠè·å–ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ `Future` é‚£é‡Œç›´æ¥å–å‡ºä»»åŠ¡æ‰§è¡Œç»“æœã€‚

### Callable å’Œ Future æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `FutureTask` æ¥ç†è§£ `Callable` å’Œ `Future` ä¹‹é—´çš„å…³ç³»ã€‚

`FutureTask` æä¾›äº† `Future` æ¥å£çš„åŸºæœ¬å®ç°ï¼Œå¸¸ç”¨æ¥å°è£… `Callable` å’Œ `Runnable`ï¼Œå…·æœ‰å–æ¶ˆä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆä»¥åŠè·å–ä»»åŠ¡æ‰§è¡Œç»“æœçš„æ–¹æ³•ã€‚`ExecutorService.submit()` æ–¹æ³•è¿”å›çš„å…¶å®å°±æ˜¯ `Future` çš„å®ç°ç±» `FutureTask` ã€‚

```java
<T> Future<T> submit(Callable<T> task);
Future<?> submit(Runnable task);
```

`FutureTask` ä¸å…‰å®ç°äº† `Future`æ¥å£ï¼Œè¿˜å®ç°äº†`Runnable` æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºä»»åŠ¡ç›´æ¥è¢«çº¿ç¨‹æ‰§è¡Œã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`FutureTask` æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä¼ å…¥ `Callable` æˆ–è€… `Runnable` å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œä¼ å…¥ `Runnable` å¯¹è±¡ä¹Ÿä¼šåœ¨æ–¹æ³•å†…éƒ¨è½¬æ¢ä¸º`Callable` å¯¹è±¡ã€‚

```java
public FutureTask(Callable<V> callable) {
    if (callable == null)
        throw new NullPointerException();
    this.callable = callable;
    this.state = NEW;
}
public FutureTask(Runnable runnable, V result) {
    // é€šè¿‡é€‚é…å™¨RunnableAdapteræ¥å°†Runnableå¯¹è±¡runnableè½¬æ¢æˆCallableå¯¹è±¡
    this.callable = Executors.callable(runnable, result);
    this.state = NEW;
}
```

`FutureTask`ç›¸å½“äºå¯¹`Callable` è¿›è¡Œäº†å°è£…ï¼Œç®¡ç†ç€ä»»åŠ¡æ‰§è¡Œçš„æƒ…å†µï¼Œå­˜å‚¨äº† `Callable` çš„ `call` æ–¹æ³•çš„ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

å…³äºæ›´å¤š `Future` çš„æºç ç»†èŠ‚ï¼Œå¯ä»¥è‚è¿™ç¯‡ä¸‡å­—è§£æï¼Œå†™çš„å¾ˆæ¸…æ¥šï¼š[Java æ˜¯å¦‚ä½•å®ç° Future æ¨¡å¼çš„ï¼Ÿä¸‡å­—è¯¦è§£ï¼](https://juejin.cn/post/6844904199625375757)ã€‚

### CompletableFuture ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ç»„åˆã€è·å–è®¡ç®—ç»“æœçš„ `get()` æ–¹æ³•ä¸ºé˜»å¡è°ƒç”¨ã€‚

Java 8 æ‰è¢«å¼•å…¥`CompletableFuture` ç±»å¯ä»¥è§£å†³`Future` çš„è¿™äº›ç¼ºé™·ã€‚`CompletableFuture` é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ `Future` ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ç¼–æ’ç»„åˆï¼ˆå¯ä»¥å°†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„é“¾å¼è°ƒç”¨ï¼‰ç­‰èƒ½åŠ›ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹ `CompletableFuture` ç±»çš„å®šä¹‰ã€‚

```java
public class CompletableFuture<T> implements Future<T>, CompletionStage<T> {
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`CompletableFuture` åŒæ—¶å®ç°äº† `Future` å’Œ `CompletionStage` æ¥å£ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`CompletionStage` æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¾ˆå¤šè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚

`CompletionStage` æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ`CompletableFuture` çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°ä½ å°±å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚

![](https://oss.javaguide.cn/javaguide/image-20210902093026059.png)

### â­ï¸ä¸€ä¸ªä»»åŠ¡éœ€è¦ä¾èµ–å¦å¤–ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œå®Œä¹‹åå†æ‰§è¡Œï¼Œæ€ä¹ˆè®¾è®¡ï¼Ÿ

è¿™ç§ä»»åŠ¡ç¼–æ’åœºæ™¯éå¸¸é€‚åˆé€šè¿‡`CompletableFuture`å®ç°ã€‚è¿™é‡Œå‡è®¾è¦å®ç° T3 åœ¨ T2 å’Œ T1 æ‰§è¡Œå®Œåæ‰§è¡Œã€‚

ä»£ç å¦‚ä¸‹ï¼ˆè¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œç”¨åˆ°äº† Hutool çš„çº¿ç¨‹å·¥å…·ç±» `ThreadUtil` å’Œæ—¥æœŸæ—¶é—´å·¥å…·ç±» `DateUtil`ï¼‰ï¼š

```java
// T1
CompletableFuture<Void> futureT1 = CompletableFuture.runAsync(() -> {
    System.out.println("T1 is executing. Current timeï¼š" + DateUtil.now());
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    ThreadUtil.sleep(1000);
});
// T2
CompletableFuture<Void> futureT2 = CompletableFuture.runAsync(() -> {
    System.out.println("T2 is executing. Current timeï¼š" + DateUtil.now());
    ThreadUtil.sleep(1000);
});

// ä½¿ç”¨allOf()æ–¹æ³•åˆå¹¶T1å’ŒT2çš„CompletableFutureï¼Œç­‰å¾…å®ƒä»¬éƒ½å®Œæˆ
CompletableFuture<Void> bothCompleted = CompletableFuture.allOf(futureT1, futureT2);
// å½“T1å’ŒT2éƒ½å®Œæˆåï¼Œæ‰§è¡ŒT3
bothCompleted.thenRunAsync(() -> System.out.println("T3 is executing after T1 and T2 have completed.Current timeï¼š" + DateUtil.now()));
// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ŒéªŒè¯æ•ˆæœ
ThreadUtil.sleep(3000);
```

é€šè¿‡ `CompletableFuture` çš„ `allOf()` è¿™ä¸ªé™æ€æ–¹æ³•æ¥å¹¶è¡Œè¿è¡Œ T1 å’Œ T2ï¼Œå½“ T1 å’Œ T2 éƒ½å®Œæˆåï¼Œå†æ‰§è¡Œ T3ã€‚

### â­ï¸ä½¿ç”¨ CompletableFutureï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Ÿ

ä½¿ç”¨ `CompletableFuture`çš„æ—¶å€™ä¸€å®šè¦ä»¥æ­£ç¡®çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé¿å…å¼‚å¸¸ä¸¢å¤±æˆ–è€…å‡ºç°ä¸å¯æ§é—®é¢˜ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å»ºè®®ï¼š

- ä½¿ç”¨ `whenComplete` æ–¹æ³•å¯ä»¥åœ¨ä»»åŠ¡å®Œæˆæ—¶è§¦å‘å›è°ƒå‡½æ•°ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«åå™¬æˆ–ä¸¢å¤±ã€‚
- ä½¿ç”¨ `exceptionally` æ–¹æ³•å¯ä»¥å¤„ç†å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡ºï¼Œä»¥ä¾¿å¼‚å¸¸èƒ½å¤Ÿä¼ æ’­åˆ°åç»­é˜¶æ®µï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«å¿½ç•¥æˆ–ç»ˆæ­¢ã€‚
- ä½¿ç”¨ `handle` æ–¹æ³•å¯ä»¥å¤„ç†æ­£å¸¸çš„è¿”å›ç»“æœå’Œå¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»“æœï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ã€‚
- ä½¿ç”¨ `CompletableFuture.allOf` æ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ª `CompletableFuture`ï¼Œå¹¶ç»Ÿä¸€å¤„ç†æ‰€æœ‰ä»»åŠ¡çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å¤„ç†è¿‡äºå†—é•¿æˆ–é‡å¤ã€‚
- â€¦â€¦

### â­ï¸åœ¨ä½¿ç”¨ CompletableFuture çš„æ—¶å€™ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Ÿ

`CompletableFuture` é»˜è®¤ä½¿ç”¨å…¨å±€å…±äº«çš„ `ForkJoinPool.commonPool()` ä½œä¸ºæ‰§è¡Œå™¨ï¼Œæ‰€æœ‰æœªæŒ‡å®šæ‰§è¡Œå™¨çš„å¼‚æ­¥ä»»åŠ¡éƒ½ä¼šä½¿ç”¨è¯¥çº¿ç¨‹æ± ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºã€å¤šä¸ªåº“æˆ–æ¡†æ¶ï¼ˆå¦‚ Springã€ç¬¬ä¸‰æ–¹åº“ï¼‰è‹¥éƒ½ä¾èµ– `CompletableFuture`ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒä»¬éƒ½ä¼šå…±äº«åŒä¸€ä¸ªçº¿ç¨‹æ± ã€‚

è™½ç„¶ `ForkJoinPool` æ•ˆç‡å¾ˆé«˜ï¼Œä½†å½“åŒæ—¶æäº¤å¤§é‡ä»»åŠ¡æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºç«äº‰å’Œçº¿ç¨‹é¥¥é¥¿ï¼Œè¿›è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

ä¸ºé¿å…è¿™äº›é—®é¢˜ï¼Œå»ºè®®ä¸º `CompletableFuture` æä¾›è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- éš”ç¦»æ€§ï¼šä¸ºä¸åŒä»»åŠ¡åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œé¿å…å…¨å±€çº¿ç¨‹æ± èµ„æºäº‰å¤ºã€‚
- èµ„æºæ§åˆ¶ï¼šæ ¹æ®ä»»åŠ¡ç‰¹æ€§è°ƒæ•´çº¿ç¨‹æ± å¤§å°å’Œé˜Ÿåˆ—ç±»å‹ï¼Œä¼˜åŒ–æ€§èƒ½è¡¨ç°ã€‚
- å¼‚å¸¸å¤„ç†ï¼šé€šè¿‡è‡ªå®šä¹‰ `ThreadFactory` æ›´å¥½åœ°å¤„ç†çº¿ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µã€‚

```java
private ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 10,
        0L, TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<Runnable>());

CompletableFuture.runAsync(() -> {
     //...
}, executor);
```

## AQS

å…³äº AQS æºç çš„è¯¦ç»†åˆ†æï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸€ç¯‡æ–‡ç« ï¼š[AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html)ã€‚

### AQS æ˜¯ä»€ä¹ˆï¼Ÿ

AQS ï¼ˆ`AbstractQueuedSynchronizer` ï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼‰æ˜¯ä» JDK1.5 å¼€å§‹æä¾›çš„ Java å¹¶å‘æ ¸å¿ƒç»„ä»¶ã€‚

AQS è§£å†³äº†å¼€å‘è€…åœ¨å®ç°åŒæ­¥å™¨æ—¶çš„å¤æ‚æ€§é—®é¢˜ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œç”¨äºå®ç°å„ç§åŒæ­¥å™¨ï¼Œä¾‹å¦‚ **å¯é‡å…¥é”**ï¼ˆ`ReentrantLock`ï¼‰ã€**ä¿¡å·é‡**ï¼ˆ`Semaphore`ï¼‰å’Œ **å€’è®¡æ—¶å™¨**ï¼ˆ`CountDownLatch`ï¼‰ã€‚é€šè¿‡å°è£…åº•å±‚çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼ŒAQS å°†å¤æ‚çš„çº¿ç¨‹ç®¡ç†é€»è¾‘éšè—èµ·æ¥ï¼Œä½¿å¼€å‘è€…åªéœ€ä¸“æ³¨äºå…·ä½“çš„åŒæ­¥é€»è¾‘ã€‚

ç®€å•æ¥è¯´ï¼ŒAQS æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸ºåŒæ­¥å™¨æä¾›äº†é€šç”¨çš„ **æ‰§è¡Œæ¡†æ¶**ã€‚å®ƒå®šä¹‰äº† **èµ„æºè·å–å’Œé‡Šæ”¾çš„é€šç”¨æµç¨‹**ï¼Œè€Œå…·ä½“çš„èµ„æºè·å–é€»è¾‘åˆ™ç”±å…·ä½“åŒæ­¥å™¨é€šè¿‡é‡å†™æ¨¡æ¿æ–¹æ³•æ¥å®ç°ã€‚ å› æ­¤ï¼Œå¯ä»¥å°† AQS çœ‹ä½œæ˜¯åŒæ­¥å™¨çš„ **åŸºç¡€â€œåº•åº§â€**ï¼Œè€ŒåŒæ­¥å™¨åˆ™æ˜¯åŸºäº AQS å®ç°çš„ **å…·ä½“â€œåº”ç”¨â€**ã€‚

### â­ï¸AQS çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯åŸºäº **CLH é”** ï¼ˆCraig, Landin, and Hagersten locksï¼‰ è¿›ä¸€æ­¥ä¼˜åŒ–å®ç°çš„ã€‚

**CLH é”** å¯¹è‡ªæ—‹é”è¿›è¡Œäº†æ”¹è¿›ï¼Œæ˜¯åŸºäºå•é“¾è¡¨çš„è‡ªæ—‹é”ã€‚åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä¼šå°†è¯·æ±‚è·å–é”çš„çº¿ç¨‹ç»„ç»‡æˆä¸€ä¸ªå•å‘é˜Ÿåˆ—ï¼Œæ¯ä¸ªç­‰å¾…çš„çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹è®¿é—®å‰ä¸€ä¸ªçº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”ä¹‹åï¼Œå½“å‰èŠ‚ç‚¹æ‰å¯ä»¥è·å–é”ã€‚**CLH é”** çš„é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![CLH é”çš„é˜Ÿåˆ—ç»“æ„](https://oss.javaguide.cn/github/javaguide/open-source-project/clh-lock-queue-structure.png)

AQS ä¸­ä½¿ç”¨çš„ **ç­‰å¾…é˜Ÿåˆ—** æ˜¯ CLH é”é˜Ÿåˆ—çš„å˜ä½“ï¼ˆæ¥ä¸‹æ¥ç®€ç§°ä¸º CLH å˜ä½“é˜Ÿåˆ—ï¼‰ã€‚

AQS çš„ CLH å˜ä½“é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼Œä¼šæš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹å°†è¢«åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ï¼ŒCLH å˜ä½“é˜Ÿåˆ—å’ŒåŸæœ¬çš„ CLH é”é˜Ÿåˆ—çš„åŒºåˆ«ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

- ç”± **è‡ªæ—‹** ä¼˜åŒ–ä¸º **è‡ªæ—‹ + é˜»å¡** ï¼šè‡ªæ—‹æ“ä½œçš„æ€§èƒ½å¾ˆé«˜ï¼Œä½†å¤§é‡çš„è‡ªæ—‹æ“ä½œæ¯”è¾ƒå ç”¨ CPU èµ„æºï¼Œå› æ­¤åœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ä¼šå…ˆé€šè¿‡è‡ªæ—‹å°è¯•è·å–é”ï¼Œå¦‚æœå¤±è´¥å†è¿›è¡Œé˜»å¡ç­‰å¾…ã€‚
- ç”± **å•å‘é˜Ÿåˆ—** ä¼˜åŒ–ä¸º **åŒå‘é˜Ÿåˆ—** ï¼šåœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ï¼Œä¼šå¯¹ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œé˜»å¡æ“ä½œï¼Œå½“é˜Ÿåˆ—å‰è¾¹çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œéœ€è¦å¯¹åè¾¹çš„çº¿ç¨‹è¿›è¡Œå”¤é†’ï¼Œå› æ­¤å¢åŠ äº† `next` æŒ‡é’ˆï¼Œæˆä¸ºäº†åŒå‘é˜Ÿåˆ—ã€‚

AQS å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH å˜ä½“é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚åœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ã€‚

AQS ä¸­çš„ CLH å˜ä½“é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![CLH å˜ä½“é˜Ÿåˆ—ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/concurrent/clh-queue-structure-bianti.png)

AQS(`AbstractQueuedSynchronizer`)çš„æ ¸å¿ƒåŸç†å›¾ï¼š

![CLH å˜ä½“é˜Ÿåˆ—](https://oss.javaguide.cn/github/javaguide/java/concurrent/clh-queue-state.png)

AQS ä½¿ç”¨ **int æˆå‘˜å˜é‡ `state` è¡¨ç¤ºåŒæ­¥çŠ¶æ€**ï¼Œé€šè¿‡å†…ç½®çš„ **çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—** æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚

`state` å˜é‡ç”± `volatile` ä¿®é¥°ï¼Œç”¨äºå±•ç¤ºå½“å‰ä¸´ç•Œèµ„æºçš„è·é”æƒ…å†µã€‚

```java
// å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
private volatile int state;
```

å¦å¤–ï¼ŒçŠ¶æ€ä¿¡æ¯ `state` å¯ä»¥é€šè¿‡ `protected` ç±»å‹çš„`getState()`ã€`setState()`å’Œ`compareAndSetState()` è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”ï¼Œè¿™å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯ `final` ä¿®é¥°çš„ï¼Œåœ¨å­ç±»ä¸­æ— æ³•è¢«é‡å†™ã€‚

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {
     return state;
}
 // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) {
     state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
      return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

ä»¥ `ReentrantLock` ä¸ºä¾‹ï¼Œ`state` åˆå§‹å€¼ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ `lock()` æ—¶ï¼Œä¼šè°ƒç”¨ `tryAcquire()` ç‹¬å è¯¥é”å¹¶å°† `state+1` ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† `tryAcquire()` æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ `unlock()` åˆ° `state=`0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆ`state` ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚

å†ä»¥ `CountDownLatch` ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œ`state` ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå`countDown()` ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ `state=0` )ï¼Œä¼š `unpark()` ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» `await()` å‡½æ•°è¿”å›ï¼Œç»§ç»­åç»­åŠ¨ä½œã€‚

### Semaphore æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` å’Œ `ReentrantLock` éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œè€Œ`Semaphore`(ä¿¡å·é‡)å¯ä»¥ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚

Semaphore çš„ä½¿ç”¨ç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾æœ‰ N(N>5) ä¸ªçº¿ç¨‹æ¥è·å– `Semaphore` ä¸­çš„å…±äº«èµ„æºï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºåŒä¸€æ—¶åˆ» N ä¸ªçº¿ç¨‹ä¸­åªæœ‰ 5 ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°å…±äº«èµ„æºï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œåªæœ‰è·å–åˆ°å…±äº«èµ„æºçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚ç­‰åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾äº†å…±äº«èµ„æºï¼Œå…¶ä»–é˜»å¡çš„çº¿ç¨‹æ‰èƒ½è·å–åˆ°ã€‚

```java
// åˆå§‹å…±äº«èµ„æºæ•°é‡
final Semaphore semaphore = new Semaphore(5);
// è·å–1ä¸ªè®¸å¯
semaphore.acquire();
// é‡Šæ”¾1ä¸ªè®¸å¯
semaphore.release();
```

å½“åˆå§‹çš„èµ„æºä¸ªæ•°ä¸º 1 çš„æ—¶å€™ï¼Œ`Semaphore` é€€åŒ–ä¸ºæ’ä»–é”ã€‚

`Semaphore` æœ‰ä¸¤ç§æ¨¡å¼ï¼šã€‚

- **å…¬å¹³æ¨¡å¼ï¼š** è°ƒç”¨ `acquire()` æ–¹æ³•çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯è¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›
- **éå…¬å¹³æ¨¡å¼ï¼š** æŠ¢å å¼çš„ã€‚

`Semaphore` å¯¹åº”çš„ä¸¤ä¸ªæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public Semaphore(int permits) {
    sync = new NonfairSync(permits);
}

public Semaphore(int permits, boolean fair) {
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```

**è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤éå…¬å¹³æ¨¡å¼ã€‚**

`Semaphore` é€šå¸¸ç”¨äºé‚£äº›èµ„æºæœ‰æ˜ç¡®è®¿é—®æ•°é‡é™åˆ¶çš„åœºæ™¯æ¯”å¦‚é™æµï¼ˆä»…é™äºå•æœºæ¨¡å¼ï¼Œå®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨ Redis +Lua æ¥åšé™æµï¼‰ã€‚

### Semaphore çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`Semaphore` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `permits`ï¼Œä½ å¯ä»¥å°† `permits` çš„å€¼ç†è§£ä¸ºè®¸å¯è¯çš„æ•°é‡ï¼Œåªæœ‰æ‹¿åˆ°è®¸å¯è¯çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚

è°ƒç”¨`semaphore.acquire()` ï¼Œçº¿ç¨‹å°è¯•è·å–è®¸å¯è¯ï¼Œå¦‚æœ `state >= 0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–æˆåŠŸçš„è¯ï¼Œä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state-1`ã€‚å¦‚æœ `state<0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºè®¸å¯è¯æ•°é‡ä¸è¶³ã€‚æ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚

```java
/**
 *  è·å–1ä¸ªè®¸å¯è¯
 */
public void acquire() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
/**
 * å…±äº«æ¨¡å¼ä¸‹è·å–è®¸å¯è¯ï¼Œè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¤±è´¥åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹
 */
public final void acquireSharedInterruptibly(int arg)
    throws InterruptedException {
    if (Thread.interrupted())
      throw new InterruptedException();
        // å°è¯•è·å–è®¸å¯è¯ï¼Œargä¸ºè·å–è®¸å¯è¯ä¸ªæ•°ï¼Œå½“å¯ç”¨è®¸å¯è¯æ•°å‡å½“å‰è·å–çš„è®¸å¯è¯æ•°ç»“æœå°äº0,åˆ™åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚
    if (tryAcquireShared(arg) < 0)
      doAcquireSharedInterruptibly(arg);
}
```

è°ƒç”¨`semaphore.release();` ï¼Œçº¿ç¨‹å°è¯•é‡Šæ”¾è®¸å¯è¯ï¼Œå¹¶ä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state+1`ã€‚é‡Šæ”¾è®¸å¯è¯æˆåŠŸä¹‹åï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°å°è¯•å»ä¿®æ”¹ `state` çš„å€¼ `state=state-1` ï¼Œå¦‚æœ `state>=0` åˆ™è·å–ä»¤ç‰ŒæˆåŠŸï¼Œå¦åˆ™é‡æ–°è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚

```java
// é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯
public void release() {
    sync.releaseShared(1);
}

// é‡Šæ”¾å…±äº«é”ï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚
public final boolean releaseShared(int arg) {
    //é‡Šæ”¾å…±äº«é”
    if (tryReleaseShared(arg)) {
      //å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
      doReleaseShared();
      return true;
    }
    return false;
}
```

### CountDownLatch æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CountDownLatch` å…è®¸ `count` ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

`CountDownLatch` æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨çš„å€¼åªèƒ½åœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åæ²¡æœ‰ä»»ä½•æœºåˆ¶å†æ¬¡å¯¹å…¶è®¾ç½®å€¼ï¼Œå½“ `CountDownLatch` ä½¿ç”¨å®Œæ¯•åï¼Œå®ƒä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚

### CountDownLatch çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CountDownLatch` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°,å®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `count`ã€‚å½“çº¿ç¨‹ä½¿ç”¨ `countDown()` æ–¹æ³•æ—¶,å…¶å®ä½¿ç”¨äº†`tryReleaseShared`æ–¹æ³•ä»¥ CAS çš„æ“ä½œæ¥å‡å°‘ `state`,ç›´è‡³ `state` ä¸º 0 ã€‚å½“è°ƒç”¨ `await()` æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ `state` ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ`await()` æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ `await()` æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç›´åˆ°`count` ä¸ªçº¿ç¨‹è°ƒç”¨äº†`countDown()`ä½¿ state å€¼è¢«å‡ä¸º 0ï¼Œæˆ–è€…è°ƒç”¨`await()`çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šä»é˜»å¡ä¸­è¢«å”¤é†’ï¼Œ`await()` æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œã€‚

### ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ

`CountDownLatch` çš„ä½œç”¨å°±æ˜¯ å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚ä¹‹å‰åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨å¤šçº¿ç¨‹è¯»å–å¤šä¸ªæ–‡ä»¶å¤„ç†çš„åœºæ™¯ï¼Œæˆ‘ç”¨åˆ°äº† `CountDownLatch` ã€‚å…·ä½“åœºæ™¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚

ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± å’Œ count ä¸º 6 çš„`CountDownLatch`å¯¹è±¡ ã€‚ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† count-1ï¼Œè°ƒç”¨`CountDownLatch`å¯¹è±¡çš„ `await()`æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚

ä¼ªä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
public class CountDownLatchExample1 {
    // å¤„ç†æ–‡ä»¶çš„æ•°é‡
    private static final int threadCount = 6;

    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(10);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);
        for (int i = 0; i < threadCount; i++) {
            final int threadnum = i;
            threadPool.execute(() -> {
                try {
                    //å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ
                    //......
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    //è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ
                    countDownLatch.countDown();
                }

            });
        }
        countDownLatch.await();
        threadPool.shutdown();
        System.out.println("finish");
    }
}
```

**æœ‰æ²¡æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å‘¢ï¼Ÿ**

å¯ä»¥ä½¿ç”¨ `CompletableFuture` ç±»æ¥æ”¹è¿›ï¼Java8 çš„ `CompletableFuture` æä¾›äº†å¾ˆå¤šå¯¹å¤šçº¿ç¨‹å‹å¥½çš„æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæˆ‘ä»¬ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºï¼Œä»€ä¹ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œæˆ–è€…ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä»€ä¹ˆçš„éƒ½éå¸¸æ–¹ä¾¿ã€‚

```java
CompletableFuture<Void> task1 =
    CompletableFuture.supplyAsync(()->{
        //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> task6 =
    CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> headerFuture=CompletableFuture.allOf(task1,.....,task6);

try {
    headerFuture.join();
} catch (Exception ex) {
    //......
}
System.out.println("all done. ");
```

ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸€ä¸ª task éƒ½åˆ—å‡ºæ¥ä¸å¤ªç°å®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¾ªç¯æ¥æ·»åŠ ä»»åŠ¡ã€‚

```java
//æ–‡ä»¶å¤¹ä½ç½®
List<String> filePaths = Arrays.asList(...)
// å¼‚æ­¥å¤„ç†æ‰€æœ‰æ–‡ä»¶
List<CompletableFuture<String>> fileFutures = filePaths.stream()
    .map(filePath -> doSomeThing(filePath))
    .collect(Collectors.toList());
// å°†ä»–ä»¬åˆå¹¶èµ·æ¥
CompletableFuture<Void> allFutures = CompletableFuture.allOf(
    fileFutures.toArray(new CompletableFuture[fileFutures.size()])
);
```

### CyclicBarrier æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CyclicBarrier` å’Œ `CountDownLatch` éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” `CountDownLatch` æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ `CountDownLatch` ç±»ä¼¼ã€‚

> `CountDownLatch` çš„å®ç°æ˜¯åŸºäº AQS çš„ï¼Œè€Œ `CyclicBarrier` æ˜¯åŸºäº `ReentrantLock`(`ReentrantLock` ä¹Ÿå±äº AQS åŒæ­¥å™¨)å’Œ `Condition` çš„ã€‚

`CyclicBarrier` çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼šè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚

### CyclicBarrier çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CyclicBarrier` å†…éƒ¨é€šè¿‡ä¸€ä¸ª `count` å˜é‡ä½œä¸ºè®¡æ•°å™¨ï¼Œ`count` çš„åˆå§‹å€¼ä¸º `parties` å±æ€§çš„åˆå§‹åŒ–å€¼ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹åˆ°äº†æ …æ è¿™é‡Œäº†ï¼Œé‚£ä¹ˆå°±å°†è®¡æ•°å™¨å‡ 1ã€‚å¦‚æœ count å€¼ä¸º 0 äº†ï¼Œè¡¨ç¤ºè¿™æ˜¯è¿™ä¸€ä»£æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ …æ ï¼Œå°±å°è¯•æ‰§è¡Œæˆ‘ä»¬æ„é€ æ–¹æ³•ä¸­è¾“å…¥çš„ä»»åŠ¡ã€‚

```java
//æ¯æ¬¡æ‹¦æˆªçš„çº¿ç¨‹æ•°
private final int parties;
//è®¡æ•°å™¨
private int count;
```

ä¸‹é¢æˆ‘ä»¬ç»“åˆæºç æ¥ç®€å•çœ‹çœ‹ã€‚

1ã€`CyclicBarrier` é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ `CyclicBarrier(int parties)`ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•å‘Šè¯‰ `CyclicBarrier` æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚

```java
public CyclicBarrier(int parties) {
    this(parties, null);
}

public CyclicBarrier(int parties, Runnable barrierAction) {
    if (parties <= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
}
```

å…¶ä¸­ï¼Œ`parties` å°±ä»£è¡¨äº†æœ‰æ‹¦æˆªçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå½“æ‹¦æˆªçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™å°±æ‰“å¼€æ …æ ï¼Œè®©æ‰€æœ‰çº¿ç¨‹é€šè¿‡ã€‚

2ã€å½“è°ƒç”¨ `CyclicBarrier` å¯¹è±¡è°ƒç”¨ `await()` æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ `dowait(false, 0L)`æ–¹æ³•ã€‚ `await()` æ–¹æ³•å°±åƒæ ‘ç«‹èµ·ä¸€ä¸ªæ …æ çš„è¡Œä¸ºä¸€æ ·ï¼Œå°†çº¿ç¨‹æŒ¡ä½äº†ï¼Œå½“æ‹¦ä½çš„çº¿ç¨‹æ•°é‡è¾¾åˆ° `parties` çš„å€¼æ—¶ï¼Œæ …æ æ‰ä¼šæ‰“å¼€ï¼Œçº¿ç¨‹æ‰å¾—ä»¥é€šè¿‡æ‰§è¡Œã€‚

```java
public int await() throws InterruptedException, BrokenBarrierException {
  try {
      return dowait(false, 0L);
  } catch (TimeoutException toe) {
      throw new Error(toe); // cannot happen
  }
}
```

`dowait(false, 0L)`æ–¹æ³•æºç åˆ†æå¦‚ä¸‹ï¼š

```java
    // å½“çº¿ç¨‹æ•°é‡æˆ–è€…è¯·æ±‚æ•°é‡è¾¾åˆ° count æ—¶ await ä¹‹åçš„æ–¹æ³•æ‰ä¼šè¢«æ‰§è¡Œã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­ count çš„å€¼å°±ä¸º 5ã€‚
    private int count;
    /**
     * Main barrier code, covering the various policies.
     */
    private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException,
               TimeoutException {
        final ReentrantLock lock = this.lock;
        // é”ä½
        lock.lock();
        try {
            final Generation g = generation;

            if (g.broken)
                throw new BrokenBarrierException();

            // å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸
            if (Thread.interrupted()) {
                breakBarrier();
                throw new InterruptedException();
            }
            // coutå‡1
            int index = --count;
            // å½“ count æ•°é‡å‡ä¸º 0 ä¹‹åè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ°è¾¾æ …æ äº†ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†å¯ä»¥æ‰§è¡Œawait æ–¹æ³•ä¹‹åçš„æ¡ä»¶
            if (index == 0) {  // tripped
                boolean ranAction = false;
                try {
                    final Runnable command = barrierCommand;
                    if (command != null)
                        command.run();
                    ranAction = true;
                    // å°† count é‡ç½®ä¸º parties å±æ€§çš„åˆå§‹åŒ–å€¼
                    // å”¤é†’ä¹‹å‰ç­‰å¾…çš„çº¿ç¨‹
                    // ä¸‹ä¸€æ³¢æ‰§è¡Œå¼€å§‹
                    nextGeneration();
                    return 0;
                } finally {
                    if (!ranAction)
                        breakBarrier();
                }
            }

            // loop until tripped, broken, interrupted, or timed out
            for (;;) {
                try {
                    if (!timed)
                        trip.await();
                    else if (nanos > 0L)
                        nanos = trip.awaitNanos(nanos);
                } catch (InterruptedException ie) {
                    if (g == generation && ! g.broken) {
                        breakBarrier();
                        throw ie;
                    } else {
                        // We're about to finish waiting even if we had not
                        // been interrupted, so this interrupt is deemed to
                        // "belong" to subsequent execution.
                        Thread.currentThread().interrupt();
                    }
                }

                if (g.broken)
                    throw new BrokenBarrierException();

                if (g != generation)
                    return index;

                if (timed && nanos <= 0L) {
                    breakBarrier();
                    throw new TimeoutException();
                }
            }
        } finally {
            lock.unlock();
        }
    }
```

## è™šæ‹Ÿçº¿ç¨‹

è™šæ‹Ÿçº¿ç¨‹åœ¨ Java 21 æ­£å¼å‘å¸ƒï¼Œè¿™æ˜¯ä¸€é¡¹é‡é‡çº§çš„æ›´æ–°ã€‚è™½ç„¶ç›®å‰é¢è¯•ä¸­é—®çš„ä¸å¤šï¼Œä½†è¿˜æ˜¯å»ºè®®å¤§å®¶å»ç®€å•äº†è§£ä¸€ä¸‹ã€‚æˆ‘å†™äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“è™šæ‹Ÿçº¿ç¨‹å¸¸è§çš„é—®é¢˜ï¼š[è™šæ‹Ÿçº¿ç¨‹å¸¸è§é—®é¢˜æ€»ç»“](https://javaguide.cn/java/concurrent/virtual-thread.html)ï¼ŒåŒ…å«ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

1. ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ
2. è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ
3. è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ
4. å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ
5. è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

## å‚è€ƒ

- ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹
- ã€Šå®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡ã€‹
- Java çº¿ç¨‹æ± çš„å®ç°åŸç†åŠå…¶åœ¨ä¸šåŠ¡ä¸­çš„æœ€ä½³å®è·µ:é˜¿é‡Œäº‘å¼€å‘è€…ï¼š<https://mp.weixin.qq.com/s/icrrxEsbABBvEU0Gym7D5Q>
- å¸¦ä½ äº†è§£ä¸‹ SynchronousQueueï¼ˆå¹¶å‘é˜Ÿåˆ—ä¸“é¢˜ï¼‰ï¼š<https://juejin.cn/post/7031196740128768037>
- é˜»å¡é˜Ÿåˆ— â€” DelayedWorkQueue æºç åˆ†æï¼š<https://zhuanlan.zhihu.com/p/310621485>
- Java å¤šçº¿ç¨‹ï¼ˆä¸‰ï¼‰â€”â€”FutureTask/CompletableFutureï¼š<https://www.cnblogs.com/iwehdio/p/14285282.html>
- Java å¹¶å‘ä¹‹ AQS è¯¦è§£ï¼š<https://www.cnblogs.com/waterystone/p/4920797.html>
- Java å¹¶å‘åŒ…åŸºçŸ³-AQS è¯¦è§£ï¼š<https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html>

<!-- @include: @article-footer.snippet.md -->
