---
title: Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰
category: Java
tag:
  - Javaå¹¶å‘
head:
  - - meta
    - name: keywords
      content: å¤šçº¿ç¨‹,æ­»é”,çº¿ç¨‹æ± ,CAS,AQS
  - - meta
    - name: description
      content: Javaå¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜æ€»ç»“ï¼ˆå«è¯¦ç»†è§£ç­”ï¼‰ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ï¼
---

## ThreadLocal

### ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚**å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ**

JDK ä¸­è‡ªå¸¦çš„`ThreadLocal`ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ **`ThreadLocal`ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†`ThreadLocal`ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚**

å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª`ThreadLocal`å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯`ThreadLocal`å˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ `get()` å’Œ `set()` æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

å†ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ï¼Œè¿™ä¸¤ä¸ªå…±ç”¨ä¸€ä¸ªè¢‹å­çš„è¯è‚¯å®šä¼šäº§ç”Ÿäº‰æ‰§ï¼Œä½†æ˜¯ç»™ä»–ä»¬ä¸¤ä¸ªäººæ¯ä¸ªäººåˆ†é…ä¸€ä¸ªè¢‹å­çš„è¯å°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœæŠŠè¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆ ThreadLocal å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰çš„ã€‚

### å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ `ThreadLocal` ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ `ThreadLocal` ã€‚

```java
import java.text.SimpleDateFormat;
import java.util.Random;

public class ThreadLocalExample implements Runnable{

     // SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬
    private static final ThreadLocal<SimpleDateFormat> formatter = ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyyMMdd HHmm"));

    public static void main(String[] args) throws InterruptedException {
        ThreadLocalExample obj = new ThreadLocalExample();
        for(int i=0 ; i<10; i++){
            Thread t = new Thread(obj, ""+i);
            Thread.sleep(new Random().nextInt(1000));
            t.start();
        }
    }

    @Override
    public void run() {
        System.out.println("Thread Name= "+Thread.currentThread().getName()+" default Formatter = "+formatter.get().toPattern());
        try {
            Thread.sleep(new Random().nextInt(1000));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        //formatter pattern is changed here by thread, but it won't reflect to other threads
        formatter.set(new SimpleDateFormat());

        System.out.println("Thread Name= "+Thread.currentThread().getName()+" formatter = "+formatter.get().toPattern());
    }

}

```

è¾“å‡ºç»“æœ :

```
Thread Name= 0 default Formatter = yyyyMMdd HHmm
Thread Name= 0 formatter = yy-M-d ah:mm
Thread Name= 1 default Formatter = yyyyMMdd HHmm
Thread Name= 2 default Formatter = yyyyMMdd HHmm
Thread Name= 1 formatter = yy-M-d ah:mm
Thread Name= 3 default Formatter = yyyyMMdd HHmm
Thread Name= 2 formatter = yy-M-d ah:mm
Thread Name= 4 default Formatter = yyyyMMdd HHmm
Thread Name= 3 formatter = yy-M-d ah:mm
Thread Name= 4 formatter = yy-M-d ah:mm
Thread Name= 5 default Formatter = yyyyMMdd HHmm
Thread Name= 5 formatter = yy-M-d ah:mm
Thread Name= 6 default Formatter = yyyyMMdd HHmm
Thread Name= 6 formatter = yy-M-d ah:mm
Thread Name= 7 default Formatter = yyyyMMdd HHmm
Thread Name= 7 formatter = yy-M-d ah:mm
Thread Name= 8 default Formatter = yyyyMMdd HHmm
Thread Name= 9 default Formatter = yyyyMMdd HHmm
Thread Name= 8 formatter = yy-M-d ah:mm
Thread Name= 9 formatter = yy-M-d ah:mm
```

ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ `Thread-0` å·²ç»æ”¹å˜äº† `formatter` çš„å€¼ï¼Œä½† `Thread-1` é»˜è®¤æ ¼å¼åŒ–å€¼ä¸åˆå§‹åŒ–å€¼ç›¸åŒï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸€æ ·ã€‚

ä¸Šé¢æœ‰ä¸€æ®µä»£ç ç”¨åˆ°äº†åˆ›å»º `ThreadLocal` å˜é‡çš„é‚£æ®µä»£ç ç”¨åˆ°äº† Java8 çš„çŸ¥è¯†ï¼Œå®ƒç­‰äºä¸‹é¢è¿™æ®µä»£ç ï¼Œå¦‚æœä½ å†™äº†ä¸‹é¢è¿™æ®µä»£ç çš„è¯ï¼ŒIDEA ä¼šæç¤ºä½ è½¬æ¢ä¸º Java8 çš„æ ¼å¼(IDEA çœŸçš„ä¸é”™ï¼)ã€‚å› ä¸º ThreadLocal ç±»åœ¨ Java 8 ä¸­æ‰©å±•ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„æ–¹æ³•`withInitial()`ï¼Œå°† Supplier åŠŸèƒ½æ¥å£ä½œä¸ºå‚æ•°ã€‚

```java
private static final ThreadLocal<SimpleDateFormat> formatter = new ThreadLocal<SimpleDateFormat>(){
    @Override
    protected SimpleDateFormat initialValue(){
        return new SimpleDateFormat("yyyyMMdd HHmm");
    }
};
```

### ThreadLocal åŸç†äº†è§£å—ï¼Ÿ

ä» `Thread`ç±»æºä»£ç å…¥æ‰‹ã€‚

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}
```

ä»ä¸Šé¢`Thread`ç±» æºä»£ç å¯ä»¥çœ‹å‡º`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ã€‚

`ThreadLocal`ç±»çš„`set()`æ–¹æ³•

```java
public void set(T value) {
    //è·å–å½“å‰è¯·æ±‚çš„çº¿ç¨‹
    Thread t = Thread.currentThread();
    //å–å‡º Thread ç±»å†…éƒ¨çš„ threadLocals å˜é‡(å“ˆå¸Œè¡¨ç»“æ„)
    ThreadLocalMap map = getMap(t);
    if (map != null)
        // å°†éœ€è¦å­˜å‚¨çš„å€¼æ”¾å…¥åˆ°è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­
        map.set(this, value);
    else
        createMap(t, value);
}
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š**æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯`ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡`Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡`getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„`ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª`Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª`ThreadLocalMap`ï¼Œè€Œ`ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥`ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

```java
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
    //......
}
```

æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª `ThreadLocal` å¯¹è±¡çš„è¯ï¼Œ `Thread`å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª`ThreadLocalMap` å­˜æ”¾æ•°æ®çš„ï¼Œ`ThreadLocalMap`çš„ key å°±æ˜¯ `ThreadLocal`å¯¹è±¡ï¼Œvalue å°±æ˜¯ `ThreadLocal` å¯¹è±¡è°ƒç”¨`set`æ–¹æ³•è®¾ç½®çš„å€¼ã€‚

`ThreadLocal` æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ThreadLocal æ•°æ®ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadlocal-data-structure.png)

`ThreadLocalMap`æ˜¯`ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

![ThreadLocalå†…éƒ¨ç±»](https://oss.javaguide.cn/github/javaguide/java/concurrent/thread-local-inner-class.png)

### ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„ï¼Ÿ

`ThreadLocalMap` ä¸­ä½¿ç”¨çš„ key ä¸º `ThreadLocal` çš„å¼±å¼•ç”¨ï¼Œè€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚

è¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚`ThreadLocalMap` å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ `ThreadLocal`æ–¹æ³•åæœ€å¥½æ‰‹åŠ¨è°ƒç”¨`remove()`æ–¹æ³•

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

**å¼±å¼•ç”¨ä»‹ç»ï¼š**

> å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“**ã€‚å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒ æ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚
>
> å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚

## çº¿ç¨‹æ± 

### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ?

é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ã€‚å½“æœ‰ä»»åŠ¡è¦å¤„ç†æ—¶ï¼Œç›´æ¥ä»çº¿ç¨‹æ± ä¸­è·å–çº¿ç¨‹æ¥å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åçº¿ç¨‹å¹¶ä¸ä¼šç«‹å³è¢«é”€æ¯ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

### ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ

æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚

**çº¿ç¨‹æ± **æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ª**çº¿ç¨‹æ± **è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹**ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„**ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

### å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

**æ–¹å¼ä¸€ï¼šé€šè¿‡`ThreadPoolExecutor`æ„é€ å‡½æ•°æ¥åˆ›å»ºï¼ˆæ¨èï¼‰ã€‚**

![é€šè¿‡æ„é€ æ–¹æ³•å®ç°](./images/java-thread-pool-summary/threadpoolexecutoræ„é€ å‡½æ•°.png)

**æ–¹å¼äºŒï¼šé€šè¿‡ `Executor` æ¡†æ¶çš„å·¥å…·ç±» `Executors` æ¥åˆ›å»ºã€‚**

æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šç§ç±»å‹çš„ `ThreadPoolExecutor`ï¼š

- **`FixedThreadPool`**ï¼šè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **`SingleThreadExecutor`ï¼š** è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **`CachedThreadPool`ï¼š** è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚
- **`ScheduledThreadPool`**ï¼šè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚

å¯¹åº” `Executors` å·¥å…·ç±»ä¸­çš„æ–¹æ³•å¦‚å›¾æ‰€ç¤ºï¼š

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/executors-inner-threadpool.png)

### ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨å†…ç½®çº¿ç¨‹æ± ï¼Ÿ

åœ¨ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹â€œå¹¶å‘å¤„ç†â€è¿™ä¸€ç« èŠ‚ï¼Œæ˜ç¡®æŒ‡å‡ºçº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

> ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºå¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚

å¦å¤–ï¼Œã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ `Executors` å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

`Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹(åæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°)ï¼š

- **`FixedThreadPool` å’Œ `SingleThreadExecutor`**ï¼šä½¿ç”¨çš„æ˜¯æ— ç•Œçš„ `LinkedBlockingQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- **`CachedThreadPool`**ï¼šä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— `SynchronousQueue`, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- **`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`** : ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—`DelayedWorkQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

```java
// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue
public static ExecutorService newFixedThreadPool(int nThreads) {

    return new ThreadPoolExecutor(nThreads, nThreads,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>());

}

// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue
public static ExecutorService newSingleThreadExecutor() {

    return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>()));

}

// åŒæ­¥é˜Ÿåˆ— SynchronousQueueï¼Œæ²¡æœ‰å®¹é‡ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUE`
public static ExecutorService newCachedThreadPool() {

    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,60L, TimeUnit.SECONDS,new SynchronousQueue<Runnable>());

}

// DelayedWorkQueueï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
    return new ScheduledThreadPoolExecutor(corePoolSize);
}
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
          new DelayedWorkQueue());
}
```

### çº¿ç¨‹æ± å¸¸è§å‚æ•°æœ‰å“ªäº›ï¼Ÿå¦‚ä½•è§£é‡Šï¼Ÿ

```java
    /**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                              TimeUnit unit,//æ—¶é—´å•ä½
                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                               ) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

**`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

- **`corePoolSize` :** ä»»åŠ¡é˜Ÿåˆ—æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

- **`keepAliveTime`**:çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›
- **`unit`** : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
- **`threadFactory`** :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
- **`handler`** :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚

ä¸‹é¢è¿™å¼ å›¾å¯ä»¥åŠ æ·±ä½ å¯¹çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»çš„ç†è§£ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](./images/java-thread-pool-summary/çº¿ç¨‹æ± å„ä¸ªå‚æ•°ä¹‹é—´çš„å…³ç³».png)

### çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- **`ThreadPoolExecutor.AbortPolicy`ï¼š** æŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- **`ThreadPoolExecutor.CallerRunsPolicy`ï¼š** è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- **`ThreadPoolExecutor.DiscardPolicy`ï¼š** ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- **`ThreadPoolExecutor.DiscardOldestPolicy`ï¼š** æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šSpring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ `AbortPolicy`ã€‚åœ¨è¿™ç§é¥±å’Œç­–ç•¥ä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` å¼‚å¸¸æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚å¦‚æœä¸æƒ³ä¸¢å¼ƒä»»åŠ¡çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`CallerRunsPolicy`ã€‚`CallerRunsPolicy` å’Œå…¶ä»–çš„å‡ ä¸ªç­–ç•¥ä¸åŒï¼Œå®ƒæ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†ä»»åŠ¡å›é€€ç»™è°ƒç”¨è€…ï¼Œä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {

        public CallerRunsPolicy() { }

        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                // ç›´æ¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ
                r.run();
            }
        }
    }
```

### çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ

æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

ä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå†…ç½®çº¿ç¨‹æ± æ¥åˆ†æã€‚

- å®¹é‡ä¸º `Integer.MAX_VALUE` çš„ `LinkedBlockingQueue`ï¼ˆæ— ç•Œé˜Ÿåˆ—ï¼‰ï¼š`FixedThreadPool` å’Œ `SingleThreadExector` ã€‚ç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚
- `SynchronousQueue`ï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰ï¼š`CachedThreadPool` ã€‚`SynchronousQueue` æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿è¯å¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`CachedThreadPool` çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE` ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°æ˜¯å¯ä»¥æ— é™æ‰©å±•çš„ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `DelayedWorkQueue`ï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰ï¼š`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor` ã€‚`DelayedWorkQueue` çš„å†…éƒ¨å…ƒç´ å¹¶ä¸æ˜¯æŒ‰ç…§æ”¾å…¥çš„æ—¶é—´æ’åºï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åºï¼Œå†…éƒ¨é‡‡ç”¨çš„æ˜¯â€œå †â€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ã€‚`DelayedWorkQueue` æ·»åŠ å…ƒç´ æ»¡äº†ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹åŸæ¥å®¹é‡çš„ 1/2ï¼Œå³æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œæœ€å¤§æ‰©å®¹å¯è¾¾ `Integer.MAX_VALUE`ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚

### çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æµç¨‹äº†è§£å—ï¼Ÿ

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](https://oss.javaguide.cn/javaguide/%E5%9B%BE%E8%A7%A3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.png)

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
2. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äºæˆ–å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥ä»»åŠ¡æ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚
3. å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œä½†æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°çš„ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
4. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å·²ç»ç­‰åŒäºæœ€å¤§çº¿ç¨‹æ•°äº†ï¼Œæ–°å»ºçº¿ç¨‹å°†ä¼šä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå½“å‰ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œé¥±å’Œç­–ç•¥ä¼šè°ƒç”¨`RejectedExecutionHandler.rejectedExecution()`æ–¹æ³•ã€‚

### å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ

åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºå‘½åï¼ˆè®¾ç½®çº¿ç¨‹æ± åç§°å‰ç¼€ï¼‰ï¼Œæœ‰åˆ©äºå®šä½é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹åå­—ç±»ä¼¼ `pool-1-thread-n` è¿™æ ·çš„ï¼Œæ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å‘½åé€šå¸¸æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

**1ã€åˆ©ç”¨ guava çš„ `ThreadFactoryBuilder`**

```java
ThreadFactory threadFactory = new ThreadFactoryBuilder()
                        .setNameFormat(threadNamePrefix + "-%d")
                        .setDaemon(true).build();
ExecutorService threadPool = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
```

**2ã€è‡ªå·±å®ç° `ThreadFactory`ã€‚**

```java
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;
/**
 * çº¿ç¨‹å·¥å‚ï¼Œå®ƒè®¾ç½®çº¿ç¨‹åç§°ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚
 */
public final class NamingThreadFactory implements ThreadFactory {

    private final AtomicInteger threadNum = new AtomicInteger();
    private final ThreadFactory delegate;
    private final String name;

    /**
     * åˆ›å»ºä¸€ä¸ªå¸¦åå­—çš„çº¿ç¨‹æ± ç”Ÿäº§å·¥å‚
     */
    public NamingThreadFactory(ThreadFactory delegate, String name) {
        this.delegate = delegate;
        this.name = name; // TODO consider uniquifying this
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = delegate.newThread(r);
        t.setName(name + " [#" + threadNum.incrementAndGet() + "]");
        return t;
    }

}
```

### å¦‚ä½•è®¾å®šçº¿ç¨‹æ± çš„å¤§å°ï¼Ÿ

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

ç±»æ¯”äºå®ç°ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚

- å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ŒCPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚
- å¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

**å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼ˆå‚è§ï¼š[issue#1737](https://github.com/Snailclimb/JavaGuide/issues/1737)ï¼‰ï¼š
>
> çº¿ç¨‹æ•°æ›´ä¸¥è°¨çš„è®¡ç®—çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š`æœ€ä½³çº¿ç¨‹æ•° = Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰/STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰ï¼‰`ï¼Œå…¶ä¸­ `WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰=çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ - STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰`ã€‚
>
> çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ã€‚çº¿ç¨‹è®¡ç®—æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚
>
> æˆ‘ä»¬å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„å·¥å…· VisualVM æ¥æŸ¥çœ‹ `WT/ST` æ¯”ä¾‹ã€‚
>
> CPU å¯†é›†å‹ä»»åŠ¡çš„ `WT/ST` æ¥è¿‘æˆ–è€…ç­‰äº 0ï¼Œå› æ­¤ï¼Œ çº¿ç¨‹æ•°å¯ä»¥è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+0ï¼‰= Nï¼Œå’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1 å·®ä¸å¤šã€‚
>
> IO å¯†é›†å‹ä»»åŠ¡ä¸‹ï¼Œå‡ ä¹å…¨æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œä½ å°±å¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º 2Nï¼ˆæŒ‰é“ç†æ¥è¯´ï¼ŒWT/ST çš„ç»“æœåº”è¯¥æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œé€‰æ‹© 2N çš„åŸå› åº”è¯¥æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçº¿ç¨‹å§ï¼‰ã€‚

å…¬ç¤ºä¹Ÿåªæ˜¯å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®å®é™…çº¿ä¸Šè¿è¡Œæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚æˆ‘åœ¨åé¢ä»‹ç»çš„ç¾å›¢çš„çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®è¿™ç§æ–¹æ¡ˆå°±éå¸¸ä¸é”™ï¼Œå¾ˆå®ç”¨ï¼

### å¦‚ä½•åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„å‚æ•°ï¼Ÿ

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨[ã€ŠJava çº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µã€‹](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»åˆ°å¯¹çº¿ç¨‹æ± å‚æ•°å®ç°å¯è‡ªå®šä¹‰é…ç½®çš„æ€è·¯å’Œæ–¹æ³•ã€‚

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ€è·¯æ˜¯ä¸»è¦å¯¹çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å®ç°è‡ªå®šä¹‰å¯é…ç½®ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯ï¼š

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

**ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ**

æˆ‘åœ¨[Java çº¿ç¨‹æ± è¯¦è§£](https://javaguide.cn/java/concurrent/java-thread-pool-summary.html) è¿™ç¯‡æ–‡ç« ä¸­å°±è¯´è¿‡è¿™ä¸‰ä¸ªå‚æ•°æ˜¯ `ThreadPoolExecutor` æœ€é‡è¦çš„å‚æ•°ï¼Œå®ƒä»¬åŸºæœ¬å†³å®šäº†çº¿ç¨‹æ± å¯¹äºä»»åŠ¡çš„å¤„ç†ç­–ç•¥ã€‚

**å¦‚ä½•æ”¯æŒå‚æ•°åŠ¨æ€é…ç½®ï¼Ÿ** ä¸”çœ‹ `ThreadPoolExecutor` æä¾›çš„ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-methods.png)

æ ¼å¤–éœ€è¦æ³¨æ„çš„æ˜¯`corePoolSize`ï¼Œ ç¨‹åºè¿è¡ŒæœŸé—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨ `setCorePoolSizeï¼ˆï¼‰`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹æ± ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å¤§äº`corePoolSize`ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šå›æ”¶å·¥ä½œçº¿ç¨‹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å¹¶æ²¡æœ‰åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ï¼Œç¾å›¢çš„æ–¹å¼æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå«åš `ResizableCapacityLinkedBlockIngQueue` çš„é˜Ÿåˆ—ï¼ˆä¸»è¦å°±æ˜¯æŠŠ`LinkedBlockingQueue`çš„ capacity å­—æ®µçš„ final å…³é”®å­—ä¿®é¥°ç»™å»æ‰äº†ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„ï¼‰ã€‚

æœ€ç»ˆå®ç°çš„å¯åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°æ•ˆæœå¦‚ä¸‹ã€‚ğŸ‘ğŸ‘ğŸ‘

![åŠ¨æ€é…ç½®çº¿ç¨‹æ± å‚æ•°æœ€ç»ˆæ•ˆæœ](https://oss.javaguide.cn/github/javaguide/java/concurrent/meituan-dynamically-configuring-thread-pool-parameters.png)

è¿˜æ²¡çœ‹å¤Ÿï¼Ÿæ¨è why ç¥çš„[å¦‚ä½•è®¾ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿç¾å›¢ç»™å‡ºäº†ä¸€ä¸ªè®©é¢è¯•å®˜è™èº¯ä¸€éœ‡çš„å›ç­”ã€‚](https://mp.weixin.qq.com/s/9HLuPcoWmTqAeFKa1kj-_A)è¿™ç¯‡æ–‡ç« ï¼Œæ·±åº¦å‰–æï¼Œå¾ˆä¸é”™å“¦ï¼

å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿæƒ³è¦å®ç°è¿™ç§æ•ˆæœçš„è¯ï¼Œå¯ä»¥å€ŸåŠ©ç°æˆçš„å¼€æºé¡¹ç›®ï¼š

- **[Hippo4j](https://github.com/opengoofy/hippo4j)**ï¼šå¼‚æ­¥çº¿ç¨‹æ± æ¡†æ¶ï¼Œæ”¯æŒçº¿ç¨‹æ± åŠ¨æ€å˜æ›´&ç›‘æ§&æŠ¥è­¦ï¼Œæ— éœ€ä¿®æ”¹ä»£ç è½»æ¾å¼•å…¥ã€‚æ”¯æŒå¤šç§ä½¿ç”¨æ¨¡å¼ï¼Œè½»æ¾å¼•å…¥ï¼Œè‡´åŠ›äºæé«˜ç³»ç»Ÿè¿è¡Œä¿éšœèƒ½åŠ›ã€‚
- **[Dynamic TP](https://github.com/dromara/dynamic-tp)**ï¼šè½»é‡çº§åŠ¨æ€çº¿ç¨‹æ± ï¼Œå†…ç½®ç›‘æ§å‘Šè­¦åŠŸèƒ½ï¼Œé›†æˆä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± ç®¡ç†ï¼ŒåŸºäºä¸»æµé…ç½®ä¸­å¿ƒï¼ˆå·²æ”¯æŒ Nacosã€Apolloï¼ŒZookeeperã€Consulã€Etcdï¼Œå¯é€šè¿‡ SPI è‡ªå®šä¹‰å®ç°ï¼‰ã€‚

## Future

### Future ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` ç±»æ˜¯å¼‚æ­¥æ€æƒ³çš„å…¸å‹è¿ç”¨ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›éœ€è¦æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œé¿å…ç¨‹åºä¸€ç›´åŸåœ°ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œæ•ˆç‡å¤ªä½ã€‚å…·ä½“æ¥è¯´æ˜¯è¿™æ ·çš„ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸€è€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥å°†è¿™ä¸ªè€—æ—¶ä»»åŠ¡äº¤ç»™ä¸€ä¸ªå­çº¿ç¨‹å»å¼‚æ­¥æ‰§è¡Œï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¹²ç‚¹å…¶ä»–äº‹æƒ…ï¼Œä¸ç”¨å‚»å‚»ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ç­‰æˆ‘ä»¬çš„äº‹æƒ…å¹²å®Œåï¼Œæˆ‘ä»¬å†é€šè¿‡ `Future` ç±»è·å–åˆ°è€—æ—¶ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å°±æ˜æ˜¾æé«˜äº†ã€‚

è¿™å…¶å®å°±æ˜¯å¤šçº¿ç¨‹ä¸­ç»å…¸çš„ **Future æ¨¡å¼**ï¼Œä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä¸»è¦ç”¨åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼Œå¹¶é Java è¯­è¨€ç‹¬æœ‰ã€‚

åœ¨ Java ä¸­ï¼Œ`Future` ç±»åªæ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä½äº `java.util.concurrent` åŒ…ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™ 4 ä¸ªåŠŸèƒ½ï¼š

- å–æ¶ˆä»»åŠ¡ï¼›
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ;
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ;
- è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

```java
// V ä»£è¡¨äº†Futureæ‰§è¡Œçš„ä»»åŠ¡è¿”å›å€¼çš„ç±»å‹
public interface Future<V> {
    // å–æ¶ˆä»»åŠ¡æ‰§è¡Œ
    // æˆåŠŸå–æ¶ˆè¿”å› trueï¼Œå¦åˆ™è¿”å› false
    boolean cancel(boolean mayInterruptIfRunning);
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    boolean isCancelled();
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
    boolean isDone();
    // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
    V get() throws InterruptedException, ExecutionException;
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¿”å›è®¡ç®—ç»“æœå°±æŠ›å‡º TimeOutException å¼‚å¸¸
    V get(long timeout, TimeUnit unit)

        throws InterruptedException, ExecutionException, TimeoutExceptio

}
```

ç®€å•ç†è§£å°±æ˜¯ï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº† `Future` æ¥å¤„ç†ã€‚ä»»åŠ¡æ‰§è¡ŒæœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™æœŸé—´æˆ‘è¿˜å¯ä»¥å–æ¶ˆä»»åŠ¡ä»¥åŠè·å–ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ `Future` é‚£é‡Œç›´æ¥å–å‡ºä»»åŠ¡æ‰§è¡Œç»“æœã€‚

### Callable å’Œ Future æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `FutureTask` æ¥ç†è§£ `Callable` å’Œ `Future` ä¹‹é—´çš„å…³ç³»ã€‚

`FutureTask` æä¾›äº† `Future` æ¥å£çš„åŸºæœ¬å®ç°ï¼Œå¸¸ç”¨æ¥å°è£… `Callable` å’Œ `Runnable`ï¼Œå…·æœ‰å–æ¶ˆä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆä»¥åŠè·å–ä»»åŠ¡æ‰§è¡Œç»“æœçš„æ–¹æ³•ã€‚`ExecutorService.submit()` æ–¹æ³•è¿”å›çš„å…¶å®å°±æ˜¯ `Future` çš„å®ç°ç±» `FutureTask` ã€‚

```java
<T> Future<T> submit(Callable<T> task);
Future<?> submit(Runnable task);
```

`FutureTask` ä¸å…‰å®ç°äº† `Future`æ¥å£ï¼Œè¿˜å®ç°äº†`Runnable` æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºä»»åŠ¡ç›´æ¥è¢«çº¿ç¨‹æ‰§è¡Œã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`FutureTask` æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä¼ å…¥ `Callable` æˆ–è€… `Runnable` å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œä¼ å…¥ `Runnable` å¯¹è±¡ä¹Ÿä¼šåœ¨æ–¹æ³•å†…éƒ¨è½¬æ¢ä¸º`Callable` å¯¹è±¡ã€‚

```java
public FutureTask(Callable<V> callable) {
    if (callable == null)
        throw new NullPointerException();
    this.callable = callable;
    this.state = NEW;
}
public FutureTask(Runnable runnable, V result) {
    // é€šè¿‡é€‚é…å™¨RunnableAdapteræ¥å°†Runnableå¯¹è±¡runnableè½¬æ¢æˆCallableå¯¹è±¡
    this.callable = Executors.callable(runnable, result);
    this.state = NEW;
}
```

`FutureTask`ç›¸å½“äºå¯¹`Callable` è¿›è¡Œäº†å°è£…ï¼Œç®¡ç†ç€ä»»åŠ¡æ‰§è¡Œçš„æƒ…å†µï¼Œå­˜å‚¨äº† `Callable` çš„ `call` æ–¹æ³•çš„ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

### CompletableFuture ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›å±€é™æ€§æ¯”å¦‚ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ç»„åˆã€è·å–è®¡ç®—ç»“æœçš„ `get()` æ–¹æ³•ä¸ºé˜»å¡è°ƒç”¨ã€‚

Java 8 æ‰è¢«å¼•å…¥`CompletableFuture` ç±»å¯ä»¥è§£å†³`Future` çš„è¿™äº›ç¼ºé™·ã€‚`CompletableFuture` é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ `Future` ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ç¼–æ’ç»„åˆï¼ˆå¯ä»¥å°†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„é“¾å¼è°ƒç”¨ï¼‰ç­‰èƒ½åŠ›ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹ `CompletableFuture` ç±»çš„å®šä¹‰ã€‚

```java
public class CompletableFuture<T> implements Future<T>, CompletionStage<T> {
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`CompletableFuture` åŒæ—¶å®ç°äº† `Future` å’Œ `CompletionStage` æ¥å£ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`CompletionStage` æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¾ˆå¤šè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚

`CompletionStage` æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ`CompletableFuture` çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°ä½ å°±å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚

![](https://oss.javaguide.cn/javaguide/image-20210902093026059.png)

## AQS

### AQS æ˜¯ä»€ä¹ˆï¼Ÿ

AQS çš„å…¨ç§°ä¸º `AbstractQueuedSynchronizer` ï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€å°±æ˜¯æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ã€‚è¿™ä¸ªç±»åœ¨ `java.util.concurrent.locks` åŒ…ä¸‹é¢ã€‚

![](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/Java%20%E7%A8%8B%E5%BA%8F%E5%91%98%E5%BF%85%E5%A4%87%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86%E7%B3%BB%E7%BB%9F%E6%80%BB%E7%BB%93/AQS.png)

AQS å°±æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨ã€‚

```java
public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable {
}
```

AQS ä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€äº›é€šç”¨åŠŸèƒ½çš„å®ç°ï¼Œå› æ­¤ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ `ReentrantLock`ï¼Œ`Semaphore`ï¼Œå…¶ä»–çš„è¯¸å¦‚ `ReentrantReadWriteLock`ï¼Œ`SynchronousQueue`ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚

### AQS çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ **CLH é˜Ÿåˆ—é”** å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚

CLH(Craig,Landin,and Hagersten) é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ã€‚AQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚åœ¨ CLH åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ã€‚

CLH é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oss.javaguide.cn/p3-juejin/40cb932a64694262993907ebda6a0bfe~tplv-k3u1fbpfcp-zoom-1.png)

AQS(`AbstractQueuedSynchronizer`)çš„æ ¸å¿ƒåŸç†å›¾ï¼ˆå›¾æº[Java å¹¶å‘ä¹‹ AQS è¯¦è§£](https://www.cnblogs.com/waterystone/p/4920797.html)ï¼‰å¦‚ä¸‹ï¼š

![](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/Java%20%E7%A8%8B%E5%BA%8F%E5%91%98%E5%BF%85%E5%A4%87%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86%E7%B3%BB%E7%BB%9F%E6%80%BB%E7%BB%93/CLH.png)

AQS ä½¿ç”¨ **int æˆå‘˜å˜é‡ `state` è¡¨ç¤ºåŒæ­¥çŠ¶æ€**ï¼Œé€šè¿‡å†…ç½®çš„ **çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—** æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚

`state` å˜é‡ç”± `volatile` ä¿®é¥°ï¼Œç”¨äºå±•ç¤ºå½“å‰ä¸´ç•Œèµ„æºçš„è·é”æƒ…å†µã€‚

```java
// å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
private volatile int state;
```

å¦å¤–ï¼ŒçŠ¶æ€ä¿¡æ¯ `state` å¯ä»¥é€šè¿‡ `protected` ç±»å‹çš„`getState()`ã€`setState()`å’Œ`compareAndSetState()` è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”ï¼Œè¿™å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯ `final` ä¿®é¥°çš„ï¼Œåœ¨å­ç±»ä¸­æ— æ³•è¢«é‡å†™ã€‚

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {
     return state;
}
 // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) {
     state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
      return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

ä»¥ `ReentrantLock` ä¸ºä¾‹ï¼Œ`state` åˆå§‹å€¼ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ `lock()` æ—¶ï¼Œä¼šè°ƒç”¨ `tryAcquire()` ç‹¬å è¯¥é”å¹¶å°† `state+1` ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† `tryAcquire()` æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ `unlock()` åˆ° `state=`0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆ`state` ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚

å†ä»¥ `CountDownLatch` ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œ`state` ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå`countDown()` ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ `state=0` )ï¼Œä¼š `unpark()` ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» `await()` å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œã€‚

### Semaphore æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` å’Œ `ReentrantLock` éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œè€Œ`Semaphore`(ä¿¡å·é‡)å¯ä»¥ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚

Semaphore çš„ä½¿ç”¨ç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾æœ‰ N(N>5) ä¸ªçº¿ç¨‹æ¥è·å– `Semaphore` ä¸­çš„å…±äº«èµ„æºï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºåŒä¸€æ—¶åˆ» N ä¸ªçº¿ç¨‹ä¸­åªæœ‰ 5 ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°å…±äº«èµ„æºï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œåªæœ‰è·å–åˆ°å…±äº«èµ„æºçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚ç­‰åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾äº†å…±äº«èµ„æºï¼Œå…¶ä»–é˜»å¡çš„çº¿ç¨‹æ‰èƒ½è·å–åˆ°ã€‚

```java
// åˆå§‹å…±äº«èµ„æºæ•°é‡
final Semaphore semaphore = new Semaphore(5);
// è·å–1ä¸ªè®¸å¯
semaphore.acquire();
// é‡Šæ”¾1ä¸ªè®¸å¯
semaphore.release();
```

å½“åˆå§‹çš„èµ„æºä¸ªæ•°ä¸º 1 çš„æ—¶å€™ï¼Œ`Semaphore` é€€åŒ–ä¸ºæ’ä»–é”ã€‚

`Semaphore` æœ‰ä¸¤ç§æ¨¡å¼ï¼šã€‚

- **å…¬å¹³æ¨¡å¼ï¼š** è°ƒç”¨ `acquire()` æ–¹æ³•çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯è¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›
- **éå…¬å¹³æ¨¡å¼ï¼š** æŠ¢å å¼çš„ã€‚

`Semaphore` å¯¹åº”çš„ä¸¤ä¸ªæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public Semaphore(int permits) {
  	sync = new NonfairSync(permits);
}

public Semaphore(int permits, boolean fair) {
  	sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```

**è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤éå…¬å¹³æ¨¡å¼ã€‚**

`Semaphore` é€šå¸¸ç”¨äºé‚£äº›èµ„æºæœ‰æ˜ç¡®è®¿é—®æ•°é‡é™åˆ¶çš„åœºæ™¯æ¯”å¦‚é™æµï¼ˆä»…é™äºå•æœºæ¨¡å¼ï¼Œå®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨ Redis +Lua æ¥åšé™æµï¼‰ã€‚

### Semaphore çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`Semaphore` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `permits`ï¼Œä½ å¯ä»¥å°† `permits` çš„å€¼ç†è§£ä¸ºè®¸å¯è¯çš„æ•°é‡ï¼Œåªæœ‰æ‹¿åˆ°è®¸å¯è¯çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚

è°ƒç”¨`semaphore.acquire()` ï¼Œçº¿ç¨‹å°è¯•è·å–è®¸å¯è¯ï¼Œå¦‚æœ `state >= 0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–æˆåŠŸçš„è¯ï¼Œä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state-1`ã€‚å¦‚æœ `state<0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºè®¸å¯è¯æ•°é‡ä¸è¶³ã€‚æ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚

```java
/**
 *  è·å–1ä¸ªè®¸å¯è¯
 */
public void acquire() throws InterruptedException {
 	 sync.acquireSharedInterruptibly(1);
}
/**
 * å…±äº«æ¨¡å¼ä¸‹è·å–è®¸å¯è¯ï¼Œè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¤±è´¥åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹
 */
public final void acquireSharedInterruptibly(int arg)
    throws InterruptedException {
    if (Thread.interrupted())
      throw new InterruptedException();
        // å°è¯•è·å–è®¸å¯è¯ï¼Œargä¸ºè·å–è®¸å¯è¯ä¸ªæ•°ï¼Œå½“å¯ç”¨è®¸å¯è¯æ•°å‡å½“å‰è·å–çš„è®¸å¯è¯æ•°ç»“æœå°äº0,åˆ™åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚
    if (tryAcquireShared(arg) < 0)
      doAcquireSharedInterruptibly(arg);
}
```

è°ƒç”¨`semaphore.release();` ï¼Œçº¿ç¨‹å°è¯•é‡Šæ”¾è®¸å¯è¯ï¼Œå¹¶ä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state+1`ã€‚é‡Šæ”¾è®¸å¯è¯æˆåŠŸä¹‹åï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°å°è¯•å»ä¿®æ”¹ `state` çš„å€¼ `state=state-1` ï¼Œå¦‚æœ `state>=0` åˆ™è·å–ä»¤ç‰ŒæˆåŠŸï¼Œå¦åˆ™é‡æ–°è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚

```java
// é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯
public void release() {
  	sync.releaseShared(1);
}

// é‡Šæ”¾å…±äº«é”ï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚
public final boolean releaseShared(int arg) {
    //é‡Šæ”¾å…±äº«é”
    if (tryReleaseShared(arg)) {
      //å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
      doReleaseShared();
      return true;
    }
    return false;
}
```

### CountDownLatch æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CountDownLatch` å…è®¸ `count` ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

`CountDownLatch` æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨çš„å€¼åªèƒ½åœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åæ²¡æœ‰ä»»ä½•æœºåˆ¶å†æ¬¡å¯¹å…¶è®¾ç½®å€¼ï¼Œå½“ `CountDownLatch` ä½¿ç”¨å®Œæ¯•åï¼Œå®ƒä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚

### CountDownLatch çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CountDownLatch` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°,å®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `count`ã€‚å½“çº¿ç¨‹ä½¿ç”¨ `countDown()` æ–¹æ³•æ—¶,å…¶å®ä½¿ç”¨äº†`tryReleaseShared`æ–¹æ³•ä»¥ CAS çš„æ“ä½œæ¥å‡å°‘ `state`,ç›´è‡³ `state` ä¸º 0 ã€‚å½“è°ƒç”¨ `await()` æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ `state` ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ`await()` æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ `await()` æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç›´åˆ°`count` ä¸ªçº¿ç¨‹è°ƒç”¨äº†`countDown()`ä½¿stateå€¼è¢«å‡ä¸º0ï¼Œæˆ–è€…è°ƒç”¨`await()`çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šä»é˜»å¡ä¸­è¢«å”¤é†’ï¼Œ`await()` æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œã€‚

### ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ

`CountDownLatch` çš„ä½œç”¨å°±æ˜¯ å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚ä¹‹å‰åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨å¤šçº¿ç¨‹è¯»å–å¤šä¸ªæ–‡ä»¶å¤„ç†çš„åœºæ™¯ï¼Œæˆ‘ç”¨åˆ°äº† `CountDownLatch` ã€‚å…·ä½“åœºæ™¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚

ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± å’Œ count ä¸º 6 çš„`CountDownLatch`å¯¹è±¡ ã€‚ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† count-1ï¼Œè°ƒç”¨`CountDownLatch`å¯¹è±¡çš„ `await()`æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚

ä¼ªä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
public class CountDownLatchExample1 {
    // å¤„ç†æ–‡ä»¶çš„æ•°é‡
    private static final int threadCount = 6;

    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(10);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);
        for (int i = 0; i < threadCount; i++) {
            final int threadnum = i;
            threadPool.execute(() -> {
                try {
                    //å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ
                    //......
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    //è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ
                    countDownLatch.countDown();
                }

            });
        }
        countDownLatch.await();
        threadPool.shutdown();
        System.out.println("finish");
    }
}
```

**æœ‰æ²¡æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å‘¢ï¼Ÿ**

å¯ä»¥ä½¿ç”¨ `CompletableFuture` ç±»æ¥æ”¹è¿›ï¼Java8 çš„ `CompletableFuture` æä¾›äº†å¾ˆå¤šå¯¹å¤šçº¿ç¨‹å‹å¥½çš„æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæˆ‘ä»¬ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºï¼Œä»€ä¹ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œæˆ–è€…ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä»€ä¹ˆçš„éƒ½éå¸¸æ–¹ä¾¿ã€‚

```java
CompletableFuture<Void> task1 =
    CompletableFuture.supplyAsync(()->{
        //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> task6 =
    CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> headerFuture=CompletableFuture.allOf(task1,.....,task6);

try {
    headerFuture.join();
} catch (Exception ex) {
    //......
}
System.out.println("all done. ");
```

ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸€ä¸ª task éƒ½åˆ—å‡ºæ¥ä¸å¤ªç°å®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¾ªç¯æ¥æ·»åŠ ä»»åŠ¡ã€‚

```java
//æ–‡ä»¶å¤¹ä½ç½®
List<String> filePaths = Arrays.asList(...)
// å¼‚æ­¥å¤„ç†æ‰€æœ‰æ–‡ä»¶
List<CompletableFuture<String>> fileFutures = filePaths.stream()
    .map(filePath -> doSomeThing(filePath))
    .collect(Collectors.toList());
// å°†ä»–ä»¬åˆå¹¶èµ·æ¥
CompletableFuture<Void> allFutures = CompletableFuture.allOf(
    fileFutures.toArray(new CompletableFuture[fileFutures.size()])
);
```

### CyclicBarrier æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CyclicBarrier` å’Œ `CountDownLatch` éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” `CountDownLatch` æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ `CountDownLatch` ç±»ä¼¼ã€‚

> `CountDownLatch` çš„å®ç°æ˜¯åŸºäº AQS çš„ï¼Œè€Œ `CycliBarrier` æ˜¯åŸºäº `ReentrantLock`(`ReentrantLock` ä¹Ÿå±äº AQS åŒæ­¥å™¨)å’Œ `Condition` çš„ã€‚

`CyclicBarrier` çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼šè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚

### CyclicBarrier çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CyclicBarrier` å†…éƒ¨é€šè¿‡ä¸€ä¸ª `count` å˜é‡ä½œä¸ºè®¡æ•°å™¨ï¼Œ`count` çš„åˆå§‹å€¼ä¸º `parties` å±æ€§çš„åˆå§‹åŒ–å€¼ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹åˆ°äº†æ …æ è¿™é‡Œäº†ï¼Œé‚£ä¹ˆå°±å°†è®¡æ•°å™¨å‡ 1ã€‚å¦‚æœ count å€¼ä¸º 0 äº†ï¼Œè¡¨ç¤ºè¿™æ˜¯è¿™ä¸€ä»£æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ …æ ï¼Œå°±å°è¯•æ‰§è¡Œæˆ‘ä»¬æ„é€ æ–¹æ³•ä¸­è¾“å…¥çš„ä»»åŠ¡ã€‚

```java
//æ¯æ¬¡æ‹¦æˆªçš„çº¿ç¨‹æ•°
private final int parties;
//è®¡æ•°å™¨
private int count;
```

ä¸‹é¢æˆ‘ä»¬ç»“åˆæºç æ¥ç®€å•çœ‹çœ‹ã€‚

1ã€`CyclicBarrier` é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ `CyclicBarrier(int parties)`ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•å‘Šè¯‰ `CyclicBarrier` æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚

```java
public CyclicBarrier(int parties) {
    this(parties, null);
}

public CyclicBarrier(int parties, Runnable barrierAction) {
    if (parties <= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
}
```

å…¶ä¸­ï¼Œ`parties` å°±ä»£è¡¨äº†æœ‰æ‹¦æˆªçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå½“æ‹¦æˆªçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™å°±æ‰“å¼€æ …æ ï¼Œè®©æ‰€æœ‰çº¿ç¨‹é€šè¿‡ã€‚

2ã€å½“è°ƒç”¨ `CyclicBarrier` å¯¹è±¡è°ƒç”¨ `await()` æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ `dowait(false, 0L)`æ–¹æ³•ã€‚ `await()` æ–¹æ³•å°±åƒæ ‘ç«‹èµ·ä¸€ä¸ªæ …æ çš„è¡Œä¸ºä¸€æ ·ï¼Œå°†çº¿ç¨‹æŒ¡ä½äº†ï¼Œå½“æ‹¦ä½çš„çº¿ç¨‹æ•°é‡è¾¾åˆ° `parties` çš„å€¼æ—¶ï¼Œæ …æ æ‰ä¼šæ‰“å¼€ï¼Œçº¿ç¨‹æ‰å¾—ä»¥é€šè¿‡æ‰§è¡Œã€‚

```java
public int await() throws InterruptedException, BrokenBarrierException {
  try {
    	return dowait(false, 0L);
  } catch (TimeoutException toe) {
   	 throw new Error(toe); // cannot happen
  }
}
```

`dowait(false, 0L)`æ–¹æ³•æºç åˆ†æå¦‚ä¸‹ï¼š

```java
    // å½“çº¿ç¨‹æ•°é‡æˆ–è€…è¯·æ±‚æ•°é‡è¾¾åˆ° count æ—¶ await ä¹‹åçš„æ–¹æ³•æ‰ä¼šè¢«æ‰§è¡Œã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­ count çš„å€¼å°±ä¸º 5ã€‚
    private int count;
    /**
     * Main barrier code, covering the various policies.
     */
    private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException,
               TimeoutException {
        final ReentrantLock lock = this.lock;
        // é”ä½
        lock.lock();
        try {
            final Generation g = generation;

            if (g.broken)
                throw new BrokenBarrierException();

            // å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸
            if (Thread.interrupted()) {
                breakBarrier();
                throw new InterruptedException();
            }
            // coutå‡1
            int index = --count;
            // å½“ count æ•°é‡å‡ä¸º 0 ä¹‹åè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ°è¾¾æ …æ äº†ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†å¯ä»¥æ‰§è¡Œawait æ–¹æ³•ä¹‹åçš„æ¡ä»¶
            if (index == 0) {  // tripped
                boolean ranAction = false;
                try {
                    final Runnable command = barrierCommand;
                    if (command != null)
                        command.run();
                    ranAction = true;
                    // å°† count é‡ç½®ä¸º parties å±æ€§çš„åˆå§‹åŒ–å€¼
                    // å”¤é†’ä¹‹å‰ç­‰å¾…çš„çº¿ç¨‹
                    // ä¸‹ä¸€æ³¢æ‰§è¡Œå¼€å§‹
                    nextGeneration();
                    return 0;
                } finally {
                    if (!ranAction)
                        breakBarrier();
                }
            }

            // loop until tripped, broken, interrupted, or timed out
            for (;;) {
                try {
                    if (!timed)
                        trip.await();
                    else if (nanos > 0L)
                        nanos = trip.awaitNanos(nanos);
                } catch (InterruptedException ie) {
                    if (g == generation && ! g.broken) {
                        breakBarrier();
                        throw ie;
                    } else {
                        // We're about to finish waiting even if we had not
                        // been interrupted, so this interrupt is deemed to
                        // "belong" to subsequent execution.
                        Thread.currentThread().interrupt();
                    }
                }

                if (g.broken)
                    throw new BrokenBarrierException();

                if (g != generation)
                    return index;

                if (timed && nanos <= 0L) {
                    breakBarrier();
                    throw new TimeoutException();
                }
            }
        } finally {
            lock.unlock();
        }
    }
```

## å‚è€ƒ

- ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹
- ã€Šå®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡ã€‹
- å¸¦ä½ äº†è§£ä¸‹ SynchronousQueueï¼ˆå¹¶å‘é˜Ÿåˆ—ä¸“é¢˜ï¼‰ï¼šhttps://juejin.cn/post/7031196740128768037
- é˜»å¡é˜Ÿåˆ— â€” DelayedWorkQueue æºç åˆ†æï¼šhttps://zhuanlan.zhihu.com/p/310621485
- Java å¤šçº¿ç¨‹ï¼ˆä¸‰ï¼‰â€”â€”FutureTask/CompletableFutureï¼šhttps://www.cnblogs.com/iwehdio/p/14285282.html
- Java å¹¶å‘ä¹‹ AQS è¯¦è§£ï¼šhttps://www.cnblogs.com/waterystone/p/4920797.html
- Java å¹¶å‘åŒ…åŸºçŸ³-AQS è¯¦è§£ï¼šhttps://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html
