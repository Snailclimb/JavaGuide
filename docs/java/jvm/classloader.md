---
title: ç±»åŠ è½½å™¨è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰
category: Java
tag:
  - JVM
---

## å›é¡¾ä¸€ä¸‹ç±»åŠ è½½è¿‡ç¨‹

å¼€å§‹ä»‹ç»ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æ¨¡å‹ä¹‹å‰ï¼Œç®€å•å›é¡¾ä¸€ä¸‹ç±»åŠ è½½è¿‡ç¨‹ã€‚

- ç±»åŠ è½½è¿‡ç¨‹ï¼š**åŠ è½½->è¿æ¥->åˆå§‹åŒ–**ã€‚
- è¿æ¥è¿‡ç¨‹åˆå¯åˆ†ä¸ºä¸‰æ­¥ï¼š**éªŒè¯->å‡†å¤‡->è§£æ**ã€‚

![ç±»åŠ è½½è¿‡ç¨‹](https://oss.javaguide.cn/github/javaguide/java/jvm/class-loading-procedure.png)

åŠ è½½æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œä¸»è¦å®Œæˆä¸‹é¢ 3 ä»¶äº‹æƒ…ï¼š

1. é€šè¿‡å…¨ç±»åè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ
2. å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
3. åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ `Class` å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£

## ç±»åŠ è½½å™¨

### ç±»åŠ è½½å™¨ä»‹ç»

ç±»åŠ è½½å™¨ä» JDK 1.0 å°±å‡ºç°äº†ï¼Œæœ€åˆåªæ˜¯ä¸ºäº†æ»¡è¶³ Java Appletï¼ˆå·²ç»è¢«æ·˜æ±°ï¼‰ çš„éœ€è¦ã€‚åæ¥ï¼Œæ…¢æ…¢æˆä¸º Java ç¨‹åºä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œèµ‹äºˆäº† Java ç±»å¯ä»¥è¢«åŠ¨æ€åŠ è½½åˆ° JVM ä¸­å¹¶æ‰§è¡Œçš„èƒ½åŠ›ã€‚

æ ¹æ®å®˜æ–¹ API æ–‡æ¡£çš„ä»‹ç»ï¼š

> A class loader is an object that is responsible for loading classes. The class ClassLoader is an abstract class. Given the binary name of a class, a class loader should attempt to locate or generate data that constitutes a definition for the class. A typical strategy is to transform the name into a file name and then read a "class file" of that name from a file system.
>
> Every Class object contains a reference to the ClassLoader that defined it.
>
> Class objects for array classes are not created by class loaders, but are created automatically as required by the Java runtime. The class loader for an array class, as returned by Class.getClassLoader() is the same as the class loader for its element type; if the element type is a primitive type, then the array class has no class loader.

ç¿»è¯‘è¿‡æ¥å¤§æ¦‚çš„æ„æ€æ˜¯ï¼š

> ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ã€‚`ClassLoader` æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚ç»™å®šç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œç±»åŠ è½½å™¨åº”å°è¯•å®šä½æˆ–ç”Ÿæˆæ„æˆç±»å®šä¹‰çš„æ•°æ®ã€‚å…¸å‹çš„ç­–ç•¥æ˜¯å°†åç§°è½¬æ¢ä¸ºæ–‡ä»¶åï¼Œç„¶åä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–è¯¥åç§°çš„â€œç±»æ–‡ä»¶â€ã€‚
>
> æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ `ClassLoader`ã€‚ä¸è¿‡ï¼Œæ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ `ClassLoader` åˆ›å»ºçš„ï¼Œè€Œæ˜¯ JVM åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ•°ç»„ç±»é€šè¿‡`getClassLoader()`æ–¹æ³•è·å– `ClassLoader` çš„æ—¶å€™å’Œè¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹çš„ `ClassLoader` æ˜¯ä¸€è‡´çš„ã€‚

ä»ä¸Šé¢çš„ä»‹ç»å¯ä»¥çœ‹å‡º:

- ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ï¼Œç”¨äºå®ç°ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŠ è½½è¿™ä¸€æ­¥ã€‚
- æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ `ClassLoader`ã€‚
- æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ `ClassLoader` åˆ›å»ºçš„ï¼ˆæ•°ç»„ç±»æ²¡æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼‰ï¼Œæ˜¯ç”± JVM ç›´æ¥ç”Ÿæˆçš„ã€‚

```java
class Class<T> {
  ...
  private final ClassLoader classLoader;
  @CallerSensitive
  public ClassLoader getClassLoader() {
     //...
  }
  ...
}
```

ç®€å•æ¥è¯´ï¼Œ**ç±»åŠ è½½å™¨çš„ä¸»è¦ä½œç”¨å°±æ˜¯åŠ è½½ Java ç±»çš„å­—èŠ‚ç ï¼ˆ `.class` æ–‡ä»¶ï¼‰åˆ° JVM ä¸­ï¼ˆåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ `Class` å¯¹è±¡ï¼‰ã€‚** å­—èŠ‚ç å¯ä»¥æ˜¯ Java æºç¨‹åºï¼ˆ`.java`æ–‡ä»¶ï¼‰ç»è¿‡ `javac` ç¼–è¯‘å¾—æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡å·¥å…·åŠ¨æ€ç”Ÿæˆæˆ–è€…é€šè¿‡ç½‘ç»œä¸‹è½½å¾—æ¥ã€‚

å…¶å®é™¤äº†åŠ è½½ç±»ä¹‹å¤–ï¼Œç±»åŠ è½½å™¨è¿˜å¯ä»¥åŠ è½½ Java åº”ç”¨æ‰€éœ€çš„èµ„æºå¦‚æ–‡æœ¬ã€å›¾åƒã€é…ç½®æ–‡ä»¶ã€è§†é¢‘ç­‰ç­‰æ–‡ä»¶èµ„æºã€‚æœ¬æ–‡åªè®¨è®ºå…¶æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½ç±»ã€‚

### ç±»åŠ è½½å™¨åŠ è½½è§„åˆ™

JVM å¯åŠ¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰çš„ç±»ï¼Œè€Œæ˜¯æ ¹æ®éœ€è¦å»åŠ¨æ€åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤§éƒ¨åˆ†ç±»åœ¨å…·ä½“ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šå»åŠ è½½ï¼Œè¿™æ ·å¯¹å†…å­˜æ›´åŠ å‹å¥½ã€‚

å¯¹äºå·²ç»åŠ è½½çš„ç±»ä¼šè¢«æ”¾åœ¨ `ClassLoader` ä¸­ã€‚åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªç±»åŠ è½½å™¨æ¥è¯´ï¼Œç›¸åŒäºŒè¿›åˆ¶åç§°çš„ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ã€‚

```java
public abstract class ClassLoader {
  ...
  private final ClassLoader parent;
  // ç”±è¿™ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚
  private final Vector<Class<?>> classes = new Vector<>();
  // ç”±VMè°ƒç”¨ï¼Œç”¨æ­¤ç±»åŠ è½½å™¨è®°å½•æ¯ä¸ªå·²åŠ è½½ç±»ã€‚
  void addClass(Class<?> c) {
        classes.addElement(c);
   }
  ...
}
```

### ç±»åŠ è½½å™¨æ€»ç»“

JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ `ClassLoader`ï¼š

1.  **`BootstrapClassLoader`(å¯åŠ¨ç±»åŠ è½½å™¨)** ï¼šæœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++å®ç°ï¼Œé€šå¸¸è¡¨ç¤ºä¸º nullï¼Œå¹¶ä¸”æ²¡æœ‰çˆ¶çº§ï¼Œä¸»è¦ç”¨æ¥åŠ è½½ JDK å†…éƒ¨çš„æ ¸å¿ƒç±»åº“ï¼ˆ `%JAVA_HOME%/lib`ç›®å½•ä¸‹çš„ `rt.jar` ã€`resources.jar` ã€`charsets.jar`ç­‰ jar åŒ…å’Œç±»ï¼‰ä»¥åŠè¢« `-Xbootclasspath`å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚
2.  **`ExtensionClassLoader`(æ‰©å±•ç±»åŠ è½½å™¨)** ï¼šä¸»è¦è´Ÿè´£åŠ è½½ `%JRE_HOME%/lib/ext` ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ä»¥åŠè¢« `java.ext.dirs` ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚
3.  **`AppClassLoader`(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)** ï¼šé¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»ã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š
>
> - **`rt.jar`** ï¼š rt ä»£è¡¨â€œRunTimeâ€ï¼Œ`rt.jar`æ˜¯ Java åŸºç¡€ç±»åº“ï¼ŒåŒ…å« Java doc é‡Œé¢çœ‹åˆ°çš„æ‰€æœ‰çš„ç±»çš„ç±»æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ `java.xxx.* `éƒ½åœ¨é‡Œé¢ï¼Œæ¯”å¦‚`java.util.*`ã€`java.io.*`ã€`java.nio.*`ã€`java.lang.*`ã€`java.sql.*`ã€`java.math.*`ã€‚
> - Java 9 å¼•å…¥äº†æ¨¡å—ç³»ç»Ÿï¼Œå¹¶ä¸”ç•¥å¾®æ›´æ”¹äº†ä¸Šè¿°çš„ç±»åŠ è½½å™¨ã€‚æ‰©å±•ç±»åŠ è½½å™¨è¢«æ”¹åä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼ˆplatform class loaderï¼‰ã€‚Java SE ä¸­é™¤äº†å°‘æ•°å‡ ä¸ªå…³é”®æ¨¡å—ï¼Œæ¯”å¦‚è¯´ `java.base` æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ä¹‹å¤–ï¼Œå…¶ä»–çš„æ¨¡å—å‡ç”±å¹³å°ç±»åŠ è½½å™¨æ‰€åŠ è½½ã€‚

é™¤äº†è¿™ä¸‰ç§ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥è¿›è¡Œæ‹“å±•ï¼Œä»¥æ»¡è¶³è‡ªå·±çš„ç‰¹æ®Šéœ€æ±‚ã€‚å°±æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Java ç±»çš„å­—èŠ‚ç ï¼ˆ `.class` æ–‡ä»¶ï¼‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ è½½æ—¶å†åˆ©ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¯¹å…¶è§£å¯†ã€‚

![ç±»åŠ è½½å™¨å±‚æ¬¡å…³ç³»å›¾](https://oss.javaguide.cn/github/javaguide/java/jvm/class-loader-parents-delegation-model.png)

é™¤äº† `BootstrapClassLoader` æ˜¯ JVM è‡ªèº«çš„ä¸€éƒ¨åˆ†ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æ˜¯åœ¨ JVM å¤–éƒ¨å®ç°çš„ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ª `ClassLoader`æŠ½è±¡ç±»ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€çš„ç±»ã€‚

æ¯ä¸ª `ClassLoader` å¯ä»¥é€šè¿‡`getParent()`è·å–å…¶çˆ¶ `ClassLoader`ï¼Œå¦‚æœè·å–åˆ° `ClassLoader` ä¸º`null`çš„è¯ï¼Œé‚£ä¹ˆè¯¥ç±»æ˜¯é€šè¿‡ `BootstrapClassLoader` åŠ è½½çš„ã€‚

```java
public abstract class ClassLoader {
  ...
  // çˆ¶åŠ è½½å™¨
  private final ClassLoader parent;
  @CallerSensitive
  public final ClassLoader getParent() {
     //...
  }
  ...
}
```

**ä¸ºä»€ä¹ˆ è·å–åˆ° `ClassLoader` ä¸º`null`å°±æ˜¯ `BootstrapClassLoader` åŠ è½½çš„å‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸º`BootstrapClassLoader` ç”± C++ å®ç°ï¼Œç”±äºè¿™ä¸ª C++ å®ç°çš„ç±»åŠ è½½å™¨åœ¨ Java ä¸­æ˜¯æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ç±»çš„ï¼Œæ‰€ä»¥æ‹¿åˆ°çš„ç»“æœæ˜¯ nullã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè·å– `ClassLoader` çš„å°æ¡ˆä¾‹ï¼š

```java
public class PrintClassLoaderTree {

    public static void main(String[] args) {

        ClassLoader classLoader = PrintClassLoaderTree.class.getClassLoader();

        StringBuilder split = new StringBuilder("|--");
        boolean needContinue = true;
        while (needContinue){
            System.out.println(split.toString() + classLoader);
            if(classLoader == null){
                needContinue = false;
            }else{
                classLoader = classLoader.getParent();
                split.insert(0, "\t");
            }
        }
    }

}
```

è¾“å‡ºç»“æœ(JDK 8 )ï¼š

```
|--sun.misc.Launcher$AppClassLoader@18b4aac2
    |--sun.misc.Launcher$ExtClassLoader@53bd815b
        |--null
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š

- æˆ‘ä»¬ç¼–å†™çš„ Java ç±» `PrintClassLoaderTree` çš„ `ClassLoader` æ˜¯`AppClassLoader`ï¼›
- `AppClassLoader`çš„çˆ¶ `ClassLoader` æ˜¯`ExtClassLoader`ï¼›
- `ExtClassLoader`çš„çˆ¶`ClassLoader`æ˜¯`Bootstrap ClassLoader`ï¼Œå› æ­¤è¾“å‡ºç»“æœä¸º nullã€‚

### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

æˆ‘ä»¬å‰é¢ä¹Ÿè¯´è¯´äº†ï¼Œé™¤äº† `BootstrapClassLoader` å…¶ä»–ç±»åŠ è½½å™¨å‡ç”± Java å®ç°ä¸”å…¨éƒ¨ç»§æ‰¿è‡ª`java.lang.ClassLoader`ã€‚å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå¾ˆæ˜æ˜¾éœ€è¦ç»§æ‰¿ `ClassLoader`æŠ½è±¡ç±»ã€‚

`ClassLoader` ç±»æœ‰ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼š

- `protected Class loadClass(String name, boolean resolve)`ï¼šåŠ è½½æŒ‡å®šäºŒè¿›åˆ¶åç§°çš„ç±»ï¼Œå®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ ã€‚`name` ä¸ºç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œ`resove` å¦‚æœä¸º trueï¼Œåœ¨åŠ è½½æ—¶è°ƒç”¨ `resolveClass(Class<?> c)` æ–¹æ³•è§£æè¯¥ç±»ã€‚
- `protected Class findClass(String name)`ï¼šæ ¹æ®ç±»çš„äºŒè¿›åˆ¶åç§°æ¥æŸ¥æ‰¾ç±»ï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ã€‚

å®˜æ–¹ API æ–‡æ¡£ä¸­å†™åˆ°ï¼š

> Subclasses of `ClassLoader` are encouraged to override `findClass(String name)`, rather than this method.
>
> å»ºè®® `ClassLoader`çš„å­ç±»é‡å†™ `findClass(String name)`æ–¹æ³•è€Œä¸æ˜¯`loadClass(String name, boolean resolve)` æ–¹æ³•ã€‚

å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ `loadClass()` æ–¹æ³•ã€‚

## åŒäº²å§”æ´¾æ¨¡å‹

### åŒäº²å§”æ´¾æ¨¡å‹ä»‹ç»

ç±»åŠ è½½å™¨æœ‰å¾ˆå¤šç§ï¼Œå½“æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå…·ä½“æ˜¯å“ªä¸ªç±»åŠ è½½å™¨åŠ è½½å‘¢ï¼Ÿè¿™å°±éœ€è¦æåˆ°åŒäº²å§”æ´¾æ¨¡å‹äº†ã€‚

æ ¹æ®å®˜ç½‘ä»‹ç»ï¼š

> The ClassLoader class uses a delegation model to search for classes and resources. Each instance of ClassLoader has an associated parent class loader. When requested to find a class or resource, a ClassLoader instance will delegate the search for the class or resource to its parent class loader before attempting to find the class or resource itself. The virtual machine's built-in class loader, called the "bootstrap class loader", does not itself have a parent but may serve as the parent of a ClassLoader instance.

ç¿»è¯‘è¿‡æ¥å¤§æ¦‚çš„æ„æ€æ˜¯ï¼š

> `ClassLoader` ç±»ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥æœç´¢ç±»å’Œèµ„æºã€‚æ¯ä¸ª `ClassLoader` å®ä¾‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„çˆ¶ç±»åŠ è½½å™¨ã€‚éœ€è¦æŸ¥æ‰¾ç±»æˆ–èµ„æºæ—¶ï¼Œ`ClassLoader` å®ä¾‹ä¼šåœ¨è¯•å›¾äº²è‡ªæŸ¥æ‰¾ç±»æˆ–èµ„æºä¹‹å‰ï¼Œå°†æœç´¢ç±»æˆ–èµ„æºçš„ä»»åŠ¡å§”æ‰˜ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ã€‚
> è™šæ‹Ÿæœºä¸­è¢«ç§°ä¸º "bootstrap class loader"çš„å†…ç½®ç±»åŠ è½½å™¨æœ¬èº«æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯å¯ä»¥ä½œä¸º `ClassLoader` å®ä¾‹çš„çˆ¶ç±»åŠ è½½å™¨ã€‚

ä»ä¸Šé¢çš„ä»‹ç»å¯ä»¥çœ‹å‡ºï¼š

- `ClassLoader` ç±»ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥æœç´¢ç±»å’Œèµ„æºã€‚
- åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚
- `ClassLoader` å®ä¾‹ä¼šåœ¨è¯•å›¾äº²è‡ªæŸ¥æ‰¾ç±»æˆ–èµ„æºä¹‹å‰ï¼Œå°†æœç´¢ç±»æˆ–èµ„æºçš„ä»»åŠ¡å§”æ‰˜ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ã€‚

ä¸‹å›¾å±•ç¤ºçš„å„ç§ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»è¢«ç§°ä¸ºç±»åŠ è½½å™¨çš„â€œ**åŒäº²å§”æ´¾æ¨¡å‹(Parents Delegation Model)**â€ã€‚

![ç±»åŠ è½½å™¨å±‚æ¬¡å…³ç³»å›¾](https://oss.javaguide.cn/github/javaguide/java/jvm/class-loader-parents-delegation-model.png)

æ³¨æ„ âš ï¸ï¼šåŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ç§å¼ºåˆ¶æ€§çš„çº¦æŸï¼Œåªæ˜¯ JDK å®˜æ–¹æ¨èçš„ä¸€ç§æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬å› ä¸ºæŸäº›ç‰¹æ®Šéœ€æ±‚æƒ³è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåæ–‡ä¼šä»‹ç»å…·ä½“çš„æ–¹æ³•ã€‚

å…¶å®è¿™ä¸ªåŒäº²ç¿»è¯‘çš„å®¹æ˜“è®©åˆ«äººè¯¯è§£ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç†è§£çš„åŒäº²éƒ½æ˜¯çˆ¶æ¯ï¼Œè¿™é‡Œçš„åŒäº²æ›´å¤šåœ°è¡¨è¾¾çš„æ˜¯â€œçˆ¶æ¯è¿™ä¸€è¾ˆâ€çš„äººè€Œå·²ï¼Œå¹¶ä¸æ˜¯è¯´çœŸçš„æœ‰ä¸€ä¸ª `MotherClassLoader` å’Œä¸€ä¸ª`FatherClassLoader` ã€‚ä¸ªäººè§‰å¾—ç¿»è¯‘æˆå•äº²å§”æ´¾æ¨¡å‹æ›´å¥½ä¸€äº›ï¼Œä¸è¿‡ï¼Œå›½å†…æ—¢ç„¶ç¿»è¯‘æˆäº†åŒäº²å§”æ´¾æ¨¡å‹å¹¶æµä¼ äº†ï¼ŒæŒ‰ç…§è¿™ä¸ªæ¥ä¹Ÿæ²¡é—®é¢˜ï¼Œä¸è¦è¢«è¯¯è§£äº†å°±å¥½ã€‚

å¦å¤–ï¼Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸æ˜¯ä»¥ç»§æ‰¿çš„å…³ç³»æ¥å®ç°çš„ï¼Œè€Œæ˜¯é€šå¸¸ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚

```java
public abstract class ClassLoader {
  ...
  // ç»„åˆ
  private final ClassLoader parent;
  protected ClassLoader(ClassLoader parent) {
       this(checkCreateClassLoader(), parent);
  }
  ...
}
```

åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæœ‰ä¸€æ¡éå¸¸ç»å…¸çš„è®¾è®¡åŸåˆ™ï¼š **ç»„åˆä¼˜äºç»§æ‰¿ï¼Œå¤šç”¨ç»„åˆå°‘ç”¨ç»§æ‰¿ã€‚**

### åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹

åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œé€»è¾‘éå¸¸æ¸…æ™°ï¼Œéƒ½é›†ä¸­åœ¨ `java.lang.ClassLoader` çš„ `loadClass()` ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```java
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        //é¦–å…ˆï¼Œæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡
        Class c = findLoadedClass(name);
        if (c == null) {
            //å¦‚æœ c ä¸º nullï¼Œåˆ™è¯´æ˜è¯¥ç±»æ²¡æœ‰è¢«åŠ è½½è¿‡
            long t0 = System.nanoTime();
            try {
                if (parent != null) {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡çˆ¶ç±»çš„loadClassæ¥åŠ è½½è¯¥ç±»
                    c = parent.loadClass(name, false);
                } else {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯åŠ¨ç±»åŠ è½½å™¨æ¥åŠ è½½è¯¥ç±»
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                //éç©ºçˆ¶ç±»çš„ç±»åŠ è½½å™¨æ— æ³•æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            }

            if (c == null) {
                //å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œåˆ™è°ƒç”¨findClassæ–¹æ³•æ¥åŠ è½½è¯¥ç±»
                //ç”¨æˆ·å¯é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ï¼Œæ¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨
                long t1 = System.nanoTime();
                c = findClass(name);

                //ç”¨äºç»Ÿè®¡ç±»åŠ è½½å™¨ç›¸å…³çš„ä¿¡æ¯
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            //å¯¹ç±»è¿›è¡Œlinkæ“ä½œ
            resolveClass(c);
        }
        return c;
    }
}
```

æ¯å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå…ˆå°†è¯·æ±‚è½¬å‘ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚åœ¨çˆ¶ç±»åŠ è½½å™¨æ²¡æœ‰æ‰¾åˆ°æ‰€è¯·æ±‚çš„ç±»çš„æƒ…å†µä¸‹ï¼Œè¯¥ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•å»åŠ è½½ã€‚

ç»“åˆä¸Šé¢çš„æºç ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ï¼š

- åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ï¼ˆæ¯ä¸ªçˆ¶ç±»åŠ è½½å™¨éƒ½ä¼šèµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼‰ã€‚
- ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ `loadClass()`æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä¸­ã€‚
- åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼ˆè°ƒç”¨è‡ªå·±çš„ `findClass()` æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚

ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š

**JVM åˆ¤å®šä¸¤ä¸ª Java ç±»æ˜¯å¦ç›¸åŒçš„å…·ä½“è§„åˆ™** ï¼šJVM ä¸ä»…è¦çœ‹ç±»çš„å…¨åæ˜¯å¦ç›¸åŒï¼Œè¿˜è¦çœ‹åŠ è½½æ­¤ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€æ ·ã€‚åªæœ‰ä¸¤è€…éƒ½ç›¸åŒçš„æƒ…å†µï¼Œæ‰è®¤ä¸ºä¸¤ä¸ªç±»æ˜¯ç›¸åŒçš„ã€‚å³ä½¿ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ª `Class` æ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸åŒã€‚

### åŒäº²å§”æ´¾æ¨¡å‹çš„å¥½å¤„

åŒäº²å§”æ´¾æ¨¡å‹ä¿è¯äº† Java ç¨‹åºçš„ç¨³å®šè¿è¡Œï¼Œå¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼ˆJVM åŒºåˆ†ä¸åŒç±»çš„æ–¹å¼ä¸ä»…ä»…æ ¹æ®ç±»åï¼Œç›¸åŒçš„ç±»æ–‡ä»¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½äº§ç”Ÿçš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼‰ï¼Œä¹Ÿä¿è¯äº† Java çš„æ ¸å¿ƒ API ä¸è¢«ç¯¡æ”¹ã€‚

å¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œè€Œæ˜¯æ¯ä¸ªç±»åŠ è½½å™¨åŠ è½½è‡ªå·±çš„è¯å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç§°ä¸º `java.lang.Object` ç±»çš„è¯ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šå‡ºç°ä¸¤ä¸ªä¸åŒçš„ `Object` ç±»ã€‚åŒäº²å§”æ´¾æ¨¡å‹å¯ä»¥ä¿è¯åŠ è½½çš„æ˜¯ JRE é‡Œçš„é‚£ä¸ª `Object` ç±»ï¼Œè€Œä¸æ˜¯ä½ å†™çš„ `Object` ç±»ã€‚è¿™æ˜¯å› ä¸º `AppClassLoader` åœ¨åŠ è½½ä½ çš„ `Object` ç±»æ—¶ï¼Œä¼šå§”æ‰˜ç»™ `ExtClassLoader` å»åŠ è½½ï¼Œè€Œ `ExtClassLoader` åˆä¼šå§”æ‰˜ç»™ `BootstrapClassLoader`ï¼Œ`BootstrapClassLoader` å‘ç°è‡ªå·±å·²ç»åŠ è½½è¿‡äº† `Object` ç±»ï¼Œä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå»åŠ è½½ä½ å†™çš„ `Object` ç±»ã€‚

### æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹æ–¹æ³•

~~ä¸ºäº†é¿å…åŒäº²å§”æ‰˜æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œç„¶åé‡å†™ `loadClass()` å³å¯ã€‚~~

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue871](https://github.com/Snailclimb/JavaGuide/issues/871) ï¼‰** ï¼šè‡ªå®šä¹‰åŠ è½½å™¨çš„è¯ï¼Œéœ€è¦ç»§æ‰¿ `ClassLoader` ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ `loadClass()` æ–¹æ³•ã€‚

ä¸ºä»€ä¹ˆæ˜¯é‡å†™ `loadClass()` æ–¹æ³•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹å‘¢ï¼ŸåŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹å·²ç»è§£é‡Šäº†ï¼š

> ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ `loadClass()`æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚

æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ Tomcat æœåŠ¡å™¨ä¸ºäº†èƒ½å¤Ÿä¼˜å…ˆåŠ è½½ Web åº”ç”¨ç›®å½•ä¸‹çš„ç±»ï¼Œç„¶åå†åŠ è½½å…¶ä»–ç›®å½•ä¸‹çš„ç±»ï¼Œå°±è‡ªå®šä¹‰äº†ç±»åŠ è½½å™¨ `WebAppClassLoader` æ¥æ‰“ç ´åŒäº²å§”æ‰˜æœºåˆ¶ã€‚è¿™ä¹Ÿæ˜¯ Tomcat ä¸‹ Web åº”ç”¨ä¹‹é—´çš„ç±»å®ç°éš”ç¦»çš„å…·ä½“åŸç†ã€‚

Tomcat çš„ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š

![Tomcat çš„ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/jvm/tomcat-class-loader-parents-delegation-model.png)

æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸€ä¸‹ Tomcat ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬ææ‡‚ Tomcat éš”ç¦» Web åº”ç”¨çš„åŸç†ï¼Œæ¨èèµ„æ–™æ˜¯[ã€Šæ·±å…¥æ‹†è§£ Tomcat & Jettyã€‹](http://gk.link/a/10Egr)ã€‚

## æ¨èé˜…è¯»

- ã€Šæ·±å…¥æ‹†è§£ Java è™šæ‹Ÿæœºã€‹
- æ·±å…¥åˆ†æ Java ClassLoader åŸç†ï¼šhttps://blog.csdn.net/xyang81/article/details/7292380
- Java ç±»åŠ è½½å™¨(ClassLoader)ï¼šhttp://gityuan.com/2016/01/24/java-classloader/
- Class Loaders in Javaï¼šhttps://www.baeldung.com/java-classloaders
- Class ClassLoader - Oracle å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html
- è€å¤§éš¾çš„ Java ClassLoader å†ä¸ç†è§£å°±è€äº†ï¼šhttps://zhuanlan.zhihu.com/p/51374915
