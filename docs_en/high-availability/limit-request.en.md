---
title: æœåŠ¡é™æµè¯¦è§£
category: é«˜å¯ç”¨
icon: limit_rate
---

é’ˆå¯¹è½¯ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œé™æµå°±æ˜¯å¯¹è¯·æ±‚çš„é€Ÿç‡è¿›è¡Œé™åˆ¶ï¼Œé¿å…ç¬æ—¶çš„å¤§é‡è¯·æ±‚å‡»å®è½¯ä»¶ç³»ç»Ÿã€‚æ¯•ç«Ÿï¼Œè½¯ä»¶ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚å¦‚æœè¯´è¶…è¿‡äº†å…¶å¤„ç†èƒ½åŠ›çš„èŒƒå›´ï¼Œè½¯ä»¶ç³»ç»Ÿå¯èƒ½ç›´æ¥å°±æŒ‚æ‰äº†ã€‚

é™æµå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·çš„è¯·æ±‚æ— æ³•è¢«æ­£ç¡®å¤„ç†æˆ–è€…æ— æ³•ç«‹å³è¢«å¤„ç†ï¼Œä¸è¿‡ï¼Œè¿™å¾€å¾€ä¹Ÿæ˜¯æƒè¡¡äº†è½¯ä»¶ç³»ç»Ÿçš„ç¨³å®šæ€§ä¹‹åå¾—åˆ°çš„æœ€ä¼˜è§£ã€‚

ç°å®ç”Ÿæ´»ä¸­ï¼Œå¤„å¤„éƒ½æœ‰é™æµçš„å®é™…åº”ç”¨ï¼Œå°±æ¯”å¦‚æ’é˜Ÿä¹°ç¥¨æ˜¯ä¸ºäº†é¿å…å¤§é‡ç”¨æˆ·æ¶Œå…¥è´­ç¥¨è€Œå¯¼è‡´å”®ç¥¨å‘˜æ— æ³•å¤„ç†ã€‚

## å¸¸è§é™æµç®—æ³•æœ‰å“ªäº›ï¼Ÿ

ç®€å•ä»‹ç» 4 ç§éå¸¸å¥½ç†è§£å¹¶ä¸”å®¹æ˜“å®ç°çš„é™æµç®—æ³•ï¼

> å›¾ç‰‡æ¥æºäº InfoQ çš„ä¸€ç¯‡æ–‡ç« [ã€Šåˆ†å¸ƒå¼æœåŠ¡é™æµå®æˆ˜ï¼Œå·²ç»ä¸ºä½ æ’å¥½å‘äº†ã€‹](https://www.infoq.cn/article/Qg2tX8fyw5Vt-f3HH673)ã€‚

### å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•

å›ºå®šçª—å£å…¶å®å°±æ˜¯æ—¶é—´çª—å£ï¼Œå…¶åŸç†æ˜¯å°†æ—¶é—´åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„çª—å£ï¼Œåœ¨æ¯ä¸ªçª—å£å†…é™åˆ¶è¯·æ±‚çš„æ•°é‡æˆ–é€Ÿç‡ï¼Œå³å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•è§„å®šäº†ç³»ç»Ÿå•ä½æ—¶é—´å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚

å‡å¦‚æˆ‘ä»¬è§„å®šç³»ç»Ÿä¸­æŸä¸ªæ¥å£ 1 åˆ†é’Ÿåªèƒ½è¢«è®¿é—® 33 æ¬¡çš„è¯ï¼Œä½¿ç”¨å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„å®ç°æ€è·¯å¦‚ä¸‹ï¼š

- å°†æ—¶é—´åˆ’åˆ†å›ºå®šå¤§å°çª—å£ï¼Œè¿™é‡Œæ˜¯ 1 åˆ†é’Ÿä¸€ä¸ªçª—å£ã€‚
- ç»™å®šä¸€ä¸ªå˜é‡ `counter` æ¥è®°å½•å½“å‰æ¥å£å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œåˆå§‹å€¼ä¸º 0ï¼ˆä»£è¡¨æ¥å£å½“å‰ 1 åˆ†é’Ÿå†…è¿˜æœªå¤„ç†è¯·æ±‚ï¼‰ã€‚
- 1 åˆ†é’Ÿä¹‹å†…æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ä¹‹åå°±å°† `counter+1` ï¼Œå½“ `counter=33` ä¹‹åï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ 1 åˆ†é’Ÿå†…æ¥å£å·²ç»è¢«è®¿é—® 33 æ¬¡çš„è¯ï¼‰ï¼Œåç»­çš„è¯·æ±‚å°±ä¼šè¢«å…¨éƒ¨æ‹’ç»ã€‚
- ç­‰åˆ° 1 åˆ†é’Ÿç»“æŸåï¼Œå°† `counter` é‡ç½® 0ï¼Œé‡æ–°å¼€å§‹è®¡æ•°ã€‚

![å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•](https://static001.infoq.cn/resource/image/8d/15/8ded7a2b90e1482093f92fff555b3615.png)

ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ˜“äºç†è§£ã€‚

ç¼ºç‚¹ï¼š

- é™æµä¸å¤Ÿå¹³æ»‘ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é™åˆ¶æŸä¸ªæ¥å£æ¯åˆ†é’Ÿåªèƒ½è®¿é—® 30 æ¬¡ï¼Œå‡è®¾å‰ 30 ç§’å°±æœ‰ 30 ä¸ªè¯·æ±‚åˆ°è¾¾çš„è¯ï¼Œé‚£åç»­ 30 ç§’å°†æ— æ³•å¤„ç†è¯·æ±‚ï¼Œè¿™æ˜¯ä¸å¯å–çš„ï¼Œç”¨æˆ·ä½“éªŒæå·®ï¼
- æ— æ³•ä¿è¯é™æµé€Ÿç‡ï¼Œå› è€Œæ— æ³•åº”å¯¹çªç„¶æ¿€å¢çš„æµé‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é™åˆ¶æŸä¸ªæ¥å£ 1 åˆ†é’Ÿåªèƒ½è®¿é—® 1000 æ¬¡ï¼Œè¯¥æ¥å£çš„ QPS ä¸º 500ï¼Œå‰ 55s è¿™ä¸ªæ¥å£ 1 ä¸ªè¯·æ±‚æ²¡æœ‰æ¥æ”¶ï¼Œå 1s çªç„¶æ¥æ”¶äº† 1000 ä¸ªè¯·æ±‚ã€‚ç„¶åï¼Œåœ¨å½“å‰åœºæ™¯ä¸‹ï¼Œè¿™ 1000 ä¸ªè¯·æ±‚åœ¨ 1s å†…æ˜¯æ²¡åŠæ³•è¢«å¤„ç†çš„ï¼Œç³»ç»Ÿç›´æ¥å°±è¢«ç¬æ—¶çš„å¤§é‡è¯·æ±‚ç»™å‡»å®äº†ã€‚

### æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•

**æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•** ç®—çš„ä¸Šæ˜¯å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„å‡çº§ç‰ˆï¼Œé™æµçš„é¢—ç²’åº¦æ›´å°ã€‚

æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ç›¸æ¯”äºå›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„ä¼˜åŒ–åœ¨äºï¼š**å®ƒæŠŠæ—¶é—´ä»¥ä¸€å®šæ¯”ä¾‹åˆ†ç‰‡** ã€‚

ä¾‹å¦‚æˆ‘ä»¬çš„æ¥å£é™æµæ¯åˆ†é’Ÿå¤„ç† 60 ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ 1 åˆ†é’Ÿåˆ†ä¸º 60 ä¸ªçª—å£ã€‚æ¯éš” 1 ç§’ç§»åŠ¨ä¸€æ¬¡ï¼Œæ¯ä¸ªçª—å£ä¸€ç§’åªèƒ½å¤„ç†ä¸å¤§äº `60(è¯·æ±‚æ•°)/60ï¼ˆçª—å£æ•°ï¼‰` çš„è¯·æ±‚ï¼Œ å¦‚æœå½“å‰çª—å£çš„è¯·æ±‚è®¡æ•°æ€»å’Œè¶…è¿‡äº†é™åˆ¶çš„æ•°é‡çš„è¯å°±ä¸å†å¤„ç†å…¶ä»–è¯·æ±‚ã€‚

å¾ˆæ˜¾ç„¶ï¼Œ **å½“æ»‘åŠ¨çª—å£çš„æ ¼å­åˆ’åˆ†çš„è¶Šå¤šï¼Œæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚**

![æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•](https://static001.infoq.cn/resource/image/ae/15/ae4d3cd14efb8dc7046d691c90264715.png)

ä¼˜ç‚¹ï¼š

- ç›¸æ¯”äºå›ºå®šçª—å£ç®—æ³•ï¼Œæ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•å¯ä»¥åº”å¯¹çªç„¶æ¿€å¢çš„æµé‡ã€‚
- ç›¸æ¯”äºå›ºå®šçª—å£ç®—æ³•ï¼Œæ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•çš„é¢—ç²’åº¦æ›´å°ï¼Œå¯ä»¥æä¾›æ›´ç²¾ç¡®çš„é™æµæ§åˆ¶ã€‚

ç¼ºç‚¹ï¼š

- ä¸å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•ç±»ä¼¼ï¼Œæ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ä¾ç„¶å­˜åœ¨é™æµä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ã€‚
- ç›¸æ¯”è¾ƒäºå›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•ï¼Œæ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•å®ç°å’Œç†è§£èµ·æ¥æ›´å¤æ‚ä¸€äº›ã€‚

### æ¼æ¡¶ç®—æ³•

æˆ‘ä»¬å¯ä»¥æŠŠå‘è¯·æ±‚çš„åŠ¨ä½œæ¯”ä½œæˆæ³¨æ°´åˆ°æ¡¶ä¸­ï¼Œæˆ‘ä»¬å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹å¯ä»¥æ¯”å–»ä¸ºæ¼æ¡¶æ¼æ°´ã€‚æˆ‘ä»¬å¾€æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥æ°´ï¼Œä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ã€‚å½“æ°´è¶…è¿‡æ¡¶æµé‡åˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ¡¶å®¹é‡æ˜¯ä¸å˜çš„ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚

å¦‚æœæƒ³è¦å®ç°è¿™ä¸ªç®—æ³•çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œå‡†å¤‡ä¸€ä¸ªé˜Ÿåˆ—ç”¨æ¥ä¿å­˜è¯·æ±‚ï¼Œç„¶åæˆ‘ä»¬å®šæœŸä»é˜Ÿåˆ—ä¸­æ‹¿è¯·æ±‚æ¥æ‰§è¡Œå°±å¥½äº†ï¼ˆå’Œæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°/é™æµçš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼‰ã€‚

![æ¼æ¡¶ç®—æ³•](https://static001.infoq.cn/resource/image/75/03/75938d1010138ce66e38c6ed0392f103.png)

ä¼˜ç‚¹ï¼š

- å®ç°ç®€å•ï¼Œæ˜“äºç†è§£ã€‚
- å¯ä»¥æ§åˆ¶é™æµé€Ÿç‡ï¼Œé¿å…ç½‘ç»œæ‹¥å¡å’Œç³»ç»Ÿè¿‡è½½ã€‚

ç¼ºç‚¹ï¼š

- æ— æ³•åº”å¯¹çªç„¶æ¿€å¢çš„æµé‡ï¼Œå› ä¸ºåªèƒ½ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå¯¹ç³»ç»Ÿèµ„æºåˆ©ç”¨ä¸å¤Ÿå‹å¥½ã€‚
- æ¡¶æµå…¥æ°´ï¼ˆå‘è¯·æ±‚ï¼‰çš„é€Ÿç‡å¦‚æœä¸€ç›´å¤§äºæ¡¶æµå‡ºæ°´ï¼ˆå¤„ç†è¯·æ±‚ï¼‰çš„é€Ÿç‡çš„è¯ï¼Œé‚£ä¹ˆæ¡¶ä¼šä¸€ç›´æ˜¯æ»¡çš„ï¼Œä¸€éƒ¨åˆ†æ–°çš„è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒï¼Œå¯¼è‡´æœåŠ¡è´¨é‡ä¸‹é™ã€‚

å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨æ¼æ¡¶ç®—æ³•ã€‚

### ä»¤ç‰Œæ¡¶ç®—æ³•

ä»¤ç‰Œæ¡¶ç®—æ³•ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å’Œæ¼æ¡¶ç®—æ³•ç®—æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬çš„ä¸»è§’è¿˜æ˜¯æ¡¶ï¼ˆè¿™é™æµç®—æ³•å’Œæ¡¶è¿‡ä¸å»å•Šï¼‰ã€‚ä¸è¿‡ç°åœ¨æ¡¶é‡Œè£…çš„æ˜¯ä»¤ç‰Œäº†ï¼Œè¯·æ±‚åœ¨è¢«å¤„ç†ä¹‹å‰éœ€è¦æ‹¿åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œè¯·æ±‚å¤„ç†å®Œæ¯•ä¹‹åå°†è¿™ä¸ªä»¤ç‰Œä¸¢å¼ƒï¼ˆåˆ é™¤ï¼‰ã€‚æˆ‘ä»¬æ ¹æ®é™æµå¤§å°ï¼ŒæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡å¾€æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œã€‚å¦‚æœæ¡¶è£…æ»¡äº†ï¼Œå°±ä¸èƒ½ç»§ç»­å¾€é‡Œé¢ç»§ç»­æ·»åŠ ä»¤ç‰Œäº†ã€‚

![ä»¤ç‰Œæ¡¶ç®—æ³•](https://static001.infoq.cn/resource/image/ec/93/eca0e5eaa35dac938c673fecf2ec9a93.png)

ä¼˜ç‚¹ï¼š

- å¯ä»¥é™åˆ¶å¹³å‡é€Ÿç‡å’Œåº”å¯¹çªç„¶æ¿€å¢çš„æµé‡ã€‚
- å¯ä»¥åŠ¨æ€è°ƒæ•´ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ã€‚

ç¼ºç‚¹ï¼š

- å¦‚æœä»¤ç‰Œäº§ç”Ÿé€Ÿç‡å’Œæ¡¶çš„å®¹é‡è®¾ç½®ä¸åˆç†ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜æ¯”å¦‚å¤§é‡çš„è¯·æ±‚è¢«ä¸¢å¼ƒã€ç³»ç»Ÿè¿‡è½½ã€‚
- ç›¸æ¯”äºå…¶ä»–é™æµç®—æ³•ï¼Œå®ç°å’Œç†è§£èµ·æ¥æ›´å¤æ‚ä¸€äº›ã€‚

## é’ˆå¯¹ä»€ä¹ˆæ¥è¿›è¡Œé™æµï¼Ÿ

å®é™…é¡¹ç›®ä¸­ï¼Œè¿˜éœ€è¦ç¡®å®šé™æµå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯é’ˆå¯¹ä»€ä¹ˆæ¥è¿›è¡Œé™æµã€‚å¸¸è§çš„é™æµå¯¹è±¡å¦‚ä¸‹ï¼š

- IP ï¼šé’ˆå¯¹ IP è¿›è¡Œé™æµï¼Œé€‚ç”¨é¢è¾ƒå¹¿ï¼Œç®€å•ç²—æš´ã€‚
- ä¸šåŠ¡ IDï¼šæŒ‘é€‰å”¯ä¸€çš„ä¸šåŠ¡ ID ä»¥å®ç°æ›´é’ˆå¯¹æ€§åœ°é™æµã€‚ä¾‹å¦‚ï¼ŒåŸºäºç”¨æˆ· ID è¿›è¡Œé™æµã€‚
- ä¸ªæ€§åŒ–ï¼šæ ¹æ®ç”¨æˆ·çš„å±æ€§æˆ–è¡Œä¸ºï¼Œè¿›è¡Œä¸åŒçš„é™æµç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œ VIP ç”¨æˆ·ä¸é™æµï¼Œè€Œæ™®é€šç”¨æˆ·é™æµã€‚æ ¹æ®ç³»ç»Ÿçš„è¿è¡ŒæŒ‡æ ‡ï¼ˆå¦‚ QPSã€å¹¶å‘è°ƒç”¨æ•°ã€ç³»ç»Ÿè´Ÿè½½ç­‰ï¼‰ï¼ŒåŠ¨æ€è°ƒæ•´é™æµç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå½“ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜çš„æ—¶å€™ï¼Œæ§åˆ¶æ¯ç§’é€šè¿‡çš„è¯·æ±‚å‡å°‘ã€‚

é’ˆå¯¹ IP è¿›è¡Œé™æµæ˜¯ç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªæ–¹æ¡ˆã€‚ä¸è¿‡ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ³¨æ„ç”¨æˆ·çœŸå® IP åœ°å€çš„æ­£ç¡®è·å–ã€‚å¸¸ç”¨çš„çœŸå® IP è·å–æ–¹æ³•æœ‰ X-Forwarded-For å’Œ TCP Options å­—æ®µæ‰¿è½½çœŸå®æº IP ä¿¡æ¯ã€‚è™½ç„¶ X-Forwarded-For å­—æ®µå¯èƒ½ä¼šè¢«ä¼ªé€ ï¼Œä½†å› ä¸ºå…¶å®ç°ç®€å•æ–¹ä¾¿ï¼Œå¾ˆå¤šé¡¹ç›®è¿˜æ˜¯ç›´æ¥ç”¨çš„è¿™ç§æ–¹æ³•ã€‚

é™¤äº†æˆ‘ä¸Šé¢ä»‹ç»åˆ°çš„é™æµå¯¹è±¡ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–è¾ƒä¸ºå¤æ‚çš„é™æµå¯¹è±¡ç­–ç•¥ï¼Œæ¯”å¦‚é˜¿é‡Œçš„ Sentinel è¿˜æ”¯æŒ [åŸºäºè°ƒç”¨å…³ç³»çš„é™æµ](https://github.com/alibaba/Sentinel/wiki/æµé‡æ§åˆ¶#åŸºäºè°ƒç”¨å…³ç³»çš„æµé‡æ§åˆ¶)ï¼ˆåŒ…æ‹¬åŸºäºè°ƒç”¨æ–¹é™æµã€åŸºäºè°ƒç”¨é“¾å…¥å£é™æµã€å…³è”æµé‡é™æµç­‰ï¼‰ä»¥åŠæ›´ç»†ç»´åº¦çš„ [çƒ­ç‚¹å‚æ•°é™æµ](https://github.com/alibaba/Sentinel/wiki/çƒ­ç‚¹å‚æ•°é™æµ)ï¼ˆå®æ—¶çš„ç»Ÿè®¡çƒ­ç‚¹å‚æ•°å¹¶é’ˆå¯¹çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨è¿›è¡Œæµé‡æ§åˆ¶ï¼‰ã€‚

å¦å¤–ï¼Œä¸€ä¸ªé¡¹ç›®å¯ä»¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚é€‰æ‹©å¤šç§ä¸åŒçš„é™æµå¯¹è±¡æ­é…ä½¿ç”¨ã€‚

## å•æœºé™æµæ€ä¹ˆåšï¼Ÿ

å•æœºé™æµé’ˆå¯¹çš„æ˜¯å•ä½“æ¶æ„åº”ç”¨ã€‚

å•æœºé™æµå¯ä»¥ç›´æ¥ä½¿ç”¨ Google Guava è‡ªå¸¦çš„é™æµå·¥å…·ç±» `RateLimiter` ã€‚ `RateLimiter` åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå¯ä»¥åº”å¯¹çªå‘æµé‡ã€‚

> Guava åœ°å€ï¼š<https://github.com/google/guava>

é™¤äº†æœ€åŸºæœ¬çš„ä»¤ç‰Œæ¡¶ç®—æ³•(å¹³æ»‘çªå‘é™æµ)å®ç°ä¹‹å¤–ï¼ŒGuava çš„`RateLimiter`è¿˜æä¾›äº† **å¹³æ»‘é¢„çƒ­é™æµ** çš„ç®—æ³•å®ç°ã€‚

å¹³æ»‘çªå‘é™æµå°±æ˜¯æŒ‰ç…§æŒ‡å®šçš„é€Ÿç‡æ”¾ä»¤ç‰Œåˆ°æ¡¶é‡Œï¼Œè€Œå¹³æ»‘é¢„çƒ­é™æµä¼šæœ‰ä¸€æ®µé¢„çƒ­æ—¶é—´ï¼Œé¢„çƒ­æ—¶é—´ä¹‹å†…ï¼Œé€Ÿç‡ä¼šé€æ¸æå‡åˆ°é…ç½®çš„é€Ÿç‡ã€‚

æˆ‘ä»¬ä¸‹é¢é€šè¿‡ä¸¤ä¸ªç®€å•çš„å°ä¾‹å­æ¥è¯¦ç»†äº†è§£å§ï¼

æˆ‘ä»¬ç›´æ¥åœ¨é¡¹ç›®ä¸­å¼•å…¥ Guava ç›¸å…³çš„ä¾èµ–å³å¯ä½¿ç”¨ã€‚

```xml
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>31.0.1-jre</version>
</dependency>
```

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Guava å¹³æ»‘çªå‘é™æµçš„ Demoã€‚

```java
import com.google.common.util.concurrent.RateLimiter;

/**
 * å¾®ä¿¡æœ JavaGuide å›å¤"é¢è¯•çªå‡»"å³å¯å…è´¹é¢†å–ä¸ªäººåŸåˆ›çš„ Java é¢è¯•æ‰‹å†Œ
 *
 * @author Guideå“¥
 * @date 2021/10/08 19:12
 **/
public class RateLimiterDemo {

    public static void main(String[] args) {
        // 1s æ”¾ 5 ä¸ªä»¤ç‰Œåˆ°æ¡¶é‡Œä¹Ÿå°±æ˜¯ 0.2s æ”¾ 1ä¸ªä»¤ç‰Œåˆ°æ¡¶é‡Œ
        RateLimiter rateLimiter = RateLimiter.create(5);
        for (int i = 0; i < 10; i++) {
            double sleepingTime = rateLimiter.acquire(1);
            System.out.printf("get 1 tokens: %ss%n", sleepingTime);
        }
    }
}

```

Output:

```bash
get 1 tokens: 0.0s
get 1 tokens: 0.188413s
get 1 tokens: 0.197811s
get 1 tokens: 0.198316s
get 1 tokens: 0.19864s
get 1 tokens: 0.199363s
get 1 tokens: 0.193997s
get 1 tokens: 0.199623s
get 1 tokens: 0.199357s
get 1 tokens: 0.195676s
```

Below is a simple demo of Guava smooth preheating and current limiting.

```java
import com.google.common.util.concurrent.RateLimiter;
import java.util.concurrent.TimeUnit;

/**
 * Search JavaGuide on WeChat and reply to "Interview Assault" to get your own original Java interview manual for free
 *
 * @author Guide brother
 * @date 2021/10/08 19:12
 **/
public class RateLimiterDemo {

    public static void main(String[] args) {
        // 1s puts 5 tokens into the bucket, that is, 0.2s puts 1 token into the bucket
        // The warm-up time is 3s, which means that the card issuance rate will gradually increase to 0.2s in the first 3s. Put 1 token into the bucket.
        RateLimiter rateLimiter = RateLimiter.create(5, 3, TimeUnit.SECONDS);
        for (int i = 0; i < 20; i++) {
            double sleepingTime = rateLimiter.acquire(1);
            System.out.printf("get 1 tokens: %sds%n", sleepingTime);
        }
    }
}
```

Output:

```bash
get 1 tokens: 0.0s
get 1 tokens: 0.561919s
get 1 tokens: 0.516931s
get 1 tokens: 0.463798s
get 1 tokens: 0.41286s
get 1 tokens: 0.356172s
get 1 tokens: 0.300489s
get 1 tokens: 0.252545s
get 1 tokens: 0.203996s
get 1 tokens: 0.198359s
```

In addition, **Bucket4j** is a very good current limiting library based on the token/leaky bucket algorithm.

> Bucket4j address: <https://github.com/vladimir-bukhtoyarov/bucket4j>

Compared with Guava's current limiting tool class, the current limiting function provided by Bucket4j is more comprehensive. Not only does it support stand-alone current limiting and distributed current limiting, it can also integrate monitoring and be used with Prometheus and Grafana.

However, after all, Guava is just a comprehensive tool library, and the out-of-the-box current limiting function it provides is quite practical in many stand-alone scenarios.

The early version of stand-alone current limiting that comes with Spring Cloud Gateway was implemented based on Bucket4j. Later, it was replaced by **Resilience4j**.

Resilience4j is a lightweight fault-tolerant component inspired by Hystrix. Since [Netflix announced that it will no longer actively develop Hystrix](https://github.com/NETFLIX/Hystrix/commit/a7df971cbaddd8c5e976b3cc5f14013fe6ad00e6), both Spring officials and Netflix recommend using Resilience4j for current limiting and fusing.

> Resilience4j address: <https://github.com/resilience4j/resilience4j>

Under normal circumstances, in order to ensure the high availability of the system, the current limiting and circuit breaker of the project must be done together.

Resilience4j not only provides current limiting, but also provides out-of-the-box functions such as fusing, load protection, and automatic retry to ensure system high availability. Moreover, the ecosystem of Resilience4j is also better. Many gateways use Resilience4j for current limiting and circuit breaker.

Therefore, Resilience4j may be a better choice in most scenarios. For some relatively simple current limiting scenarios, Guava or Bucket4j are also good choices.

## How to implement distributed current limiting?

Distributed current limiting is targeted at distributed/microservice application architecture applications. Under this architecture, single-machine current limiting is not applicable because there will be multiple services, and multiple copies of a service may be deployed.

Common solutions for distributed current limiting:

- **Current limiting with middleware**: You can use Sentinel or Redis to implement the corresponding current limiting logic yourself.
- **Gateway layer current limiting**: A relatively common solution, which arranges the current limiting directly at the gateway layer. However, gateway layer current limiting usually requires the help of middleware/framework. For example, Spring Cloud Gateway's distributed current limiting implementation `RedisRateLimiter` is based on Redis+Lua. Another example is that Spring Cloud Gateway can also integrate Sentinel for current limiting.

If you want to manually implement current limiting logic based on Redis, it is recommended to do it with Lua script.

**Why is the Redis+Lua approach recommended? ** There are two main reasons:

- **Reduced network overhead**: We can use Lua scripts to execute multiple Redis commands in batches. These Redis commands will be submitted to the Redis server for execution at one time, which greatly reduces network overhead.
- **Atomicity**: A Lua script can be executed as a command. During the execution of a Lua script, no other scripts or Redis commands will be executed at the same time, ensuring that the operation will not be inserted or interrupted by other instructions.

I wonâ€™t include the specific current limiting script code here. There are many excellent ready-made current limiting scripts on the Internet for your reference. For example, the RateLimiter current limiting plug-in of the Apache gateway project ShenYu implements the token bucket algorithm/concurrent token bucket algorithm, leaky bucket algorithm, and sliding window algorithm based on Redis + Lua.

> ShenYu address: <https://github.com/apache/incubator-shenyu>

![ShenYu rate limit script](https://oss.javaguide.cn/github/javaguide/high-availability/limit-request/shenyu-ratelimit-lua-scripts.png)

In addition, if you donâ€™t want to write Lua scripts yourself, you can also directly use `RRateLimiter` in Redisson to implement distributed current limiting. Its underlying implementation is based on Lua code + token bucket algorithm.

Redisson is an open source Java language Redis client that provides many out-of-the-box features, such as data structure implementations commonly used in Java, distributed locks, delay queues, etc. Moreover, Redisson also supports multiple deployment architectures such as Redis stand-alone, Redis Sentinel, and Redis Cluster.

`RRateLimiter` is very simple to use. We first need to obtain a `RRateLimiter` object, which can be obtained directly through the Redisson client. Then, just set the current limiting rules.

```java
//Create a Redisson client instance
RedissonClient redissonClient = Redisson.create();
// Get a current limiter object named "javaguide.limiter"
RRateLimiter rateLimiter = redissonClient.getRateLimiter("javaguide.limiter");
// Try setting the limiter at a rate of 100 times per hour
// There are two types of RateType, OVERALL is global current limiting, ER_CLIENT is single Client current limiting (it can be considered as single-machine current limiting)
rateLimiter.trySetRate(RateType.OVERALL, 100, 1, RateIntervalUnit.HOURS);
```

Next we call the `acquire()` method or the `tryAcquire()` method to obtain the permission.

```java
// Get a license and wait if the rate of the current limiter is exceeded
// acquire() is a synchronous method, the corresponding asynchronous method: acquireAsync()
rateLimiter.acquire(1);
//Try to obtain a license within 5 seconds, return true if successful, false otherwise
// tryAcquire() is a synchronous method, the corresponding asynchronous method: tryAcquireAsync()
boolean res = rateLimiter.tryAcquire(1, 5, TimeUnit.SECONDS);
```

## Summary

This article mainly introduces common current limiting algorithms, the selection of current limiting objects, and how to implement single-machine current limiting and distributed current limiting respectively.

## refer to- Resilience4j, a lightweight circuit breaker framework for service governance: <https://xie.infoq.cn/article/14786e571c1a4143ad1ef8f19>
- Super detailed analysis of Guava RateLimiter current limiting principle: <https://cloud.tencent.com/developer/article/1408819>
- Practical use of Spring Cloud Gateway current limiting ğŸ‘: <https://www.aneasystone.com/archives/2020/08/spring-cloud-gateway-current-limiting.html>
- Detailed explanation of the implementation principle of Redisson distributed current limiting: <https://juejin.cn/post/7199882882138898489>
- A detailed explanation of Java current limiting interface implementation - Alibaba Cloud Developer: <https://mp.weixin.qq.com/s/A5VYjstIDeVvizNK2HkrTQ>
- Exploration and practice of distributed current limiting solutions - Tencent Cloud Developer: <https://mp.weixin.qq.com/s/MJbEQROGlThrHSwCjYB_4Q>

<!-- @include: @article-footer.snippet.md -->