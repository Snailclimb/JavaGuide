---
title: JMMï¼ˆJava å†…å­˜æ¨¡åž‹ï¼‰è¯¦è§£
category: Java
tag:
  - Javaå¹¶å‘
head:
  - - meta
    - name: keywords
      content: CPU ç¼“å­˜æ¨¡åž‹,æŒ‡ä»¤é‡æŽ’åº,Java å†…å­˜æ¨¡åž‹ï¼ˆJMMï¼‰,happens-before
  - - meta
    - name: description
      content: å¯¹äºŽ Java æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä»Ž Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŽŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢žå¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚
---

JMM(Java å†…å­˜æ¨¡åž‹)ä¸»è¦å®šä¹‰äº†å¯¹äºŽä¸€ä¸ªå…±äº«å˜é‡ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡æ‰§è¡Œå†™æ“ä½œåŽï¼Œè¿™ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡çš„å¯è§æ€§ã€‚

è¦æƒ³ç†è§£é€å½» JMMï¼ˆJava å†…å­˜æ¨¡åž‹ï¼‰ï¼Œæˆ‘ä»¬å…ˆè¦ä»Ž **CPU ç¼“å­˜æ¨¡åž‹å’ŒæŒ‡ä»¤é‡æŽ’åº** è¯´èµ·ï¼

## ä»Ž CPU ç¼“å­˜æ¨¡åž‹è¯´èµ·

**ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ** ç±»æ¯”æˆ‘ä»¬å¼€å‘ç½‘ç«™åŽå°ç³»ç»Ÿä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ Redisï¼‰æ˜¯ä¸ºäº†è§£å†³ç¨‹åºå¤„ç†é€Ÿåº¦å’Œè®¿é—®å¸¸è§„å…³ç³»åž‹æ•°æ®åº“é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚ **CPU ç¼“å­˜åˆ™æ˜¯ä¸ºäº†è§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚**

æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ **å†…å­˜çœ‹ä½œå¤–å­˜çš„é«˜é€Ÿç¼“å­˜**ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ‘ä»¬æŠŠå¤–å­˜çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç”±äºŽå†…å­˜çš„å¤„ç†é€Ÿåº¦è¿œè¿œé«˜äºŽå¤–å­˜ï¼Œè¿™æ ·æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚

æ€»ç»“ï¼š**CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºŽè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºŽè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚**

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚

> **ðŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue#1848](https://github.com/Snailclimb/JavaGuide/issues/1848)ï¼‰**ï¼šå¯¹ CPU ç¼“å­˜æ¨¡åž‹ç»˜å›¾ä¸ä¸¥è°¨çš„åœ°æ–¹è¿›è¡Œå®Œå–„ã€‚

![CPU ç¼“å­˜æ¨¡åž‹ç¤ºæ„å›¾](https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache.png)

çŽ°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheã€‚æœ‰äº› CPU å¯èƒ½è¿˜æœ‰ L4 Cacheï¼Œè¿™é‡Œä¸åšè®¨è®ºï¼Œå¹¶ä¸å¸¸è§

**CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š** å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æŽ¥ä»Ž CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®ŒæˆåŽï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å›ž Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ **å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜** ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++ æ“ä½œçš„è¯ï¼Œå¦‚æžœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä»Ž CPU Cache ä¸­è¯»å–çš„ i=1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† i++ è¿ç®—å®Œä¹‹åŽå†å†™å›ž Main Memory ä¹‹åŽ i=2ï¼Œè€Œæ­£ç¡®ç»“æžœåº”è¯¥æ˜¯ i=3ã€‚

**CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®ï¼ˆæ¯”å¦‚ [MESI åè®®](https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE)ï¼‰æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚** è¿™ä¸ªç¼“å­˜ä¸€è‡´æ€§åè®®æŒ‡çš„æ˜¯åœ¨ CPU é«˜é€Ÿç¼“å­˜ä¸Žä¸»å†…å­˜äº¤äº’çš„æ—¶å€™éœ€è¦éµå®ˆçš„åŽŸåˆ™å’Œè§„èŒƒã€‚ä¸åŒçš„ CPU ä¸­ï¼Œä½¿ç”¨çš„ç¼“å­˜ä¸€è‡´æ€§åè®®é€šå¸¸ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚

![ç¼“å­˜ä¸€è‡´æ€§åè®®](https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache-protocol.png)

æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ“ä½œç³»ç»Ÿå±è”½äº†åº•å±‚ç¡¬ä»¶çš„æ“ä½œç»†èŠ‚ï¼Œå°†å„ç§ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ã€‚äºŽæ˜¯ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿå°±åŒæ ·éœ€è¦è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚

æ“ä½œç³»ç»Ÿé€šè¿‡ **å†…å­˜æ¨¡åž‹ï¼ˆMemory Modelï¼‰** å®šä¹‰ä¸€ç³»åˆ—è§„èŒƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ— è®ºæ˜¯ Windows ç³»ç»Ÿï¼Œè¿˜æ˜¯ Linux ç³»ç»Ÿï¼Œå®ƒä»¬éƒ½æœ‰ç‰¹å®šçš„å†…å­˜æ¨¡åž‹ã€‚

## æŒ‡ä»¤é‡æŽ’åº

è¯´å®Œäº† CPU ç¼“å­˜æ¨¡åž‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ **æŒ‡ä»¤é‡æŽ’åº** ã€‚

ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦/æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æŽ’åºã€‚

**ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æŽ’åºï¼Ÿ** ç®€å•æ¥è¯´å°±æ˜¯ç³»ç»Ÿåœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§ä½ å†™çš„ä»£ç çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

å¸¸è§çš„æŒ‡ä»¤é‡æŽ’åºæœ‰ä¸‹é¢ 2 ç§æƒ…å†µï¼š

- **ç¼–è¯‘å™¨ä¼˜åŒ–é‡æŽ’**ï¼šç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬ JVMã€JIT ç¼–è¯‘å™¨ç­‰ï¼‰åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œé‡æ–°å®‰æŽ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚
- **æŒ‡ä»¤å¹¶è¡Œé‡æŽ’**ï¼šçŽ°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯(Instruction-Level Parallelismï¼ŒILP)æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æžœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚

å¦å¤–ï¼Œå†…å­˜ç³»ç»Ÿä¹Ÿä¼šæœ‰â€œé‡æŽ’åºâ€ï¼Œä½†åˆä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„é‡æŽ’åºã€‚åœ¨ JMM é‡Œè¡¨çŽ°ä¸ºä¸»å­˜å’Œæœ¬åœ°å†…å­˜çš„å†…å®¹å¯èƒ½ä¸ä¸€è‡´ï¼Œè¿›è€Œå¯¼è‡´ç¨‹åºåœ¨å¤šçº¿ç¨‹ä¸‹æ‰§è¡Œå¯èƒ½å‡ºçŽ°é—®é¢˜ã€‚

Java æºä»£ç ä¼šç»åŽ† **ç¼–è¯‘å™¨ä¼˜åŒ–é‡æŽ’ â€”> æŒ‡ä»¤å¹¶è¡Œé‡æŽ’ â€”> å†…å­˜ç³»ç»Ÿé‡æŽ’** çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰å˜æˆæ“ä½œç³»ç»Ÿå¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ã€‚

**æŒ‡ä»¤é‡æŽ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´** ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æŽ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚

å¯¹äºŽç¼–è¯‘å™¨ä¼˜åŒ–é‡æŽ’å’Œå¤„ç†å™¨çš„æŒ‡ä»¤é‡æŽ’åºï¼ˆæŒ‡ä»¤å¹¶è¡Œé‡æŽ’å’Œå†…å­˜ç³»ç»Ÿé‡æŽ’éƒ½å±žäºŽæ˜¯å¤„ç†å™¨çº§åˆ«çš„æŒ‡ä»¤é‡æŽ’åºï¼‰ï¼Œå¤„ç†è¯¥é—®é¢˜çš„æ–¹å¼ä¸ä¸€æ ·ã€‚

- å¯¹äºŽç¼–è¯‘å™¨ï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»åž‹çš„ç¼–è¯‘å™¨é‡æŽ’åºçš„æ–¹å¼æ¥ç¦æ­¢é‡æŽ’åºã€‚

- å¯¹äºŽå¤„ç†å™¨ï¼Œé€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰çš„æ–¹å¼æ¥ç¦æ­¢ç‰¹å®šç±»åž‹çš„å¤„ç†å™¨é‡æŽ’åºã€‚

> å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰æ˜¯ä¸€ç§ CPU æŒ‡ä»¤ï¼Œç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŒ‡ä»¤å‘ç”Ÿé‡æŽ’åºï¼ˆåƒå±éšœä¸€æ ·ï¼‰ï¼Œä»Žè€Œä¿éšœæŒ‡ä»¤æ‰§è¡Œçš„æœ‰åºæ€§ã€‚å¦å¤–ï¼Œä¸ºäº†è¾¾åˆ°å±éšœçš„æ•ˆæžœï¼Œå®ƒä¼šåœ¨å¤„ç†å™¨å†™å…¥å€¼æ—¶ï¼Œå¼ºåˆ¶å°†å†™ç¼“å†²åŒºä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼›åœ¨è¯»å–å€¼ä¹‹å‰ï¼Œä½¿å¤„ç†å™¨æœ¬åœ°ç¼“å­˜ä¸­çš„ç›¸å…³æ•°æ®å¤±æ•ˆï¼Œå¼ºåˆ¶ä»Žä¸»å†…å­˜ä¸­åŠ è½½æœ€æ–°å€¼ï¼Œä»Žè€Œä¿éšœå˜é‡çš„å¯è§æ€§ã€‚

## JMM(Java Memory Model)

### ä»€ä¹ˆæ˜¯ JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ JMMï¼Ÿ

Java æ˜¯æœ€æ—©å°è¯•æä¾›å†…å­˜æ¨¡åž‹çš„ç¼–ç¨‹è¯­è¨€ã€‚ç”±äºŽæ—©æœŸå†…å­˜æ¨¡åž‹å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼ˆæ¯”å¦‚éžå¸¸å®¹æ˜“å‰Šå¼±ç¼–è¯‘å™¨çš„ä¼˜åŒ–èƒ½åŠ›ï¼‰ï¼Œä»Ž Java5 å¼€å§‹ï¼ŒJava å¼€å§‹ä½¿ç”¨æ–°çš„å†…å­˜æ¨¡åž‹ [ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹](http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf) ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œç¼–ç¨‹è¯­è¨€ä¹Ÿå¯ä»¥ç›´æŽ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡åž‹ã€‚ä¸è¿‡ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå†…å­˜æ¨¡åž‹ä¸åŒã€‚å¦‚æžœç›´æŽ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡åž‹ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´åŒæ ·ä¸€å¥—ä»£ç æ¢äº†ä¸€ä¸ªæ“ä½œç³»ç»Ÿå°±æ— æ³•æ‰§è¡Œäº†ã€‚Java è¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå®ƒéœ€è¦è‡ªå·±æä¾›ä¸€å¥—å†…å­˜æ¨¡åž‹ä»¥å±è”½ç³»ç»Ÿå·®å¼‚ã€‚

è¿™åªæ˜¯ JMM å­˜åœ¨çš„å…¶ä¸­ä¸€ä¸ªåŽŸå› ã€‚å®žé™…ä¸Šï¼Œå¯¹äºŽ Java æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä»Ž Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŽŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢žå¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚

**ä¸ºä»€ä¹ˆè¦éµå®ˆè¿™äº›å¹¶å‘ç›¸å…³çš„åŽŸåˆ™å’Œè§„èŒƒå‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸ºå¹¶å‘ç¼–ç¨‹ä¸‹ï¼Œåƒ CPU å¤šçº§ç¼“å­˜å’ŒæŒ‡ä»¤é‡æŽ’è¿™ç±»è®¾è®¡å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œå‡ºçŽ°ä¸€äº›é—®é¢˜ã€‚å°±æ¯”å¦‚è¯´æˆ‘ä»¬ä¸Šé¢æåˆ°çš„æŒ‡ä»¤é‡æŽ’åºå°±å¯èƒ½ä¼šè®©å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå‡ºçŽ°é—®é¢˜ï¼Œä¸ºæ­¤ï¼ŒJMM æŠ½è±¡äº† happens-before åŽŸåˆ™ï¼ˆåŽæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰æ¥è§£å†³è¿™ä¸ªæŒ‡ä»¤é‡æŽ’åºé—®é¢˜ã€‚

JMM è¯´ç™½äº†å°±æ˜¯å®šä¹‰äº†ä¸€äº›è§„èŒƒæ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨è¿™äº›è§„èŒƒæ›´æ–¹ä¾¿åœ°å¼€å‘å¤šçº¿ç¨‹ç¨‹åºã€‚å¯¹äºŽ Java å¼€å‘è€…è¯´ï¼Œä½ ä¸éœ€è¦äº†è§£åº•å±‚åŽŸç†ï¼Œç›´æŽ¥ä½¿ç”¨å¹¶å‘ç›¸å…³çš„ä¸€äº›å…³é”®å­—å’Œç±»ï¼ˆæ¯”å¦‚ `volatile`ã€`synchronized`ã€å„ç§ `Lock`ï¼‰å³å¯å¼€å‘å‡ºå¹¶å‘å®‰å…¨çš„ç¨‹åºã€‚

### JMM æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ

**Java å†…å­˜æ¨¡åž‹ï¼ˆJMMï¼‰** æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œå°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ã€‚

åœ¨ JDK1.2 ä¹‹å‰ï¼ŒJava çš„å†…å­˜æ¨¡åž‹å®žçŽ°æ€»æ˜¯ä»Ž **ä¸»å­˜** ï¼ˆå³å…±äº«å†…å­˜ï¼‰è¯»å–å˜é‡ï¼Œæ˜¯ä¸éœ€è¦è¿›è¡Œç‰¹åˆ«çš„æ³¨æ„çš„ã€‚è€Œåœ¨å½“å‰çš„ Java å†…å­˜æ¨¡åž‹ä¸‹ï¼Œçº¿ç¨‹å¯ä»¥æŠŠå˜é‡ä¿å­˜ **æœ¬åœ°å†…å­˜** ï¼ˆæ¯”å¦‚æœºå™¨çš„å¯„å­˜å™¨ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ç›´æŽ¥åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å†™ã€‚è¿™å°±å¯èƒ½é€ æˆä¸€ä¸ªçº¿ç¨‹åœ¨ä¸»å­˜ä¸­ä¿®æ”¹äº†ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿˜ç»§ç»­ä½¿ç”¨å®ƒåœ¨å¯„å­˜å™¨ä¸­çš„å˜é‡å€¼çš„æ‹·è´ï¼Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´ã€‚

è¿™å’Œæˆ‘ä»¬ä¸Šé¢è®²åˆ°çš„ CPU ç¼“å­˜æ¨¡åž‹éžå¸¸ç›¸ä¼¼ã€‚

**ä»€ä¹ˆæ˜¯ä¸»å†…å­˜ï¼Ÿä»€ä¹ˆæ˜¯æœ¬åœ°å†…å­˜ï¼Ÿ**

- **ä¸»å†…å­˜**ï¼šæ‰€æœ‰çº¿ç¨‹åˆ›å»ºçš„å®žä¾‹å¯¹è±¡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œä¸ç®¡è¯¥å®žä¾‹å¯¹è±¡æ˜¯æˆå‘˜å˜é‡ï¼Œè¿˜æ˜¯å±€éƒ¨å˜é‡ï¼Œç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡éƒ½æ˜¯æ”¾åœ¨ä¸»å†…å­˜ä¸­ã€‚ä¸ºäº†èŽ·å–æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹ŸæœºåŠç¡¬ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨äºŽå¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ã€‚
- **æœ¬åœ°å†…å­˜**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼Œæœ¬åœ°å†…å­˜å­˜å‚¨äº†è¯¥çº¿ç¨‹å·²è¯» / å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æ¯ä¸ªçº¿ç¨‹åªèƒ½æ“ä½œè‡ªå·±æœ¬åœ°å†…å­˜ä¸­çš„å˜é‡ï¼Œæ— æ³•ç›´æŽ¥è®¿é—®å…¶ä»–çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ã€‚å¦‚æžœçº¿ç¨‹é—´éœ€è¦é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥è¿›è¡Œã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM æŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸çœŸå®žå­˜åœ¨ï¼Œå®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚

Java å†…å­˜æ¨¡åž‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![JMM(Java å†…å­˜æ¨¡åž‹)](https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm.png)

ä»Žä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹ 1 ä¸Žçº¿ç¨‹ 2 ä¹‹é—´å¦‚æžœè¦è¿›è¡Œé€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»åŽ†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š

1. çº¿ç¨‹ 1 æŠŠæœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹è¿‡çš„å…±äº«å˜é‡å‰¯æœ¬çš„å€¼åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­åŽ»ã€‚
2. çº¿ç¨‹ 2 åˆ°ä¸»å­˜ä¸­è¯»å–å¯¹åº”çš„å…±äº«å˜é‡çš„å€¼ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼ŒJMM ä¸ºå…±äº«å˜é‡æä¾›äº†å¯è§æ€§çš„ä¿éšœã€‚

ä¸è¿‡ï¼Œå¤šçº¿ç¨‹ä¸‹ï¼Œå¯¹ä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œæœ‰å¯èƒ½è¯±å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

1. çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 åˆ†åˆ«å¯¹åŒä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œï¼Œä¸€ä¸ªæ‰§è¡Œä¿®æ”¹ï¼Œä¸€ä¸ªæ‰§è¡Œè¯»å–ã€‚
2. çº¿ç¨‹ 2 è¯»å–åˆ°çš„æ˜¯çº¿ç¨‹ 1 ä¿®æ”¹ä¹‹å‰çš„å€¼è¿˜æ˜¯ä¿®æ”¹åŽçš„å€¼å¹¶ä¸ç¡®å®šï¼Œéƒ½æœ‰å¯èƒ½ï¼Œå› ä¸ºçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 éƒ½æ˜¯å…ˆå°†å…±äº«å˜é‡ä»Žä¸»å†…å­˜æ‹·è´åˆ°å¯¹åº”çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚

å…³äºŽä¸»å†…å­˜ä¸Žå·¥ä½œå†…å­˜ç›´æŽ¥çš„å…·ä½“äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»Žä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ï¼Œå¦‚ä½•ä»Žå·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¹‹é—´çš„å®žçŽ°ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡åž‹å®šä¹‰æ¥ä»¥ä¸‹å…«ç§åŒæ­¥æ“ä½œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š

- **é”å®šï¼ˆlockï¼‰**: ä½œç”¨äºŽä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå°†ä»–æ ‡è®°ä¸ºä¸€ä¸ªçº¿ç¨‹ç‹¬äº«å˜é‡ã€‚
- **è§£é”ï¼ˆunlockï¼‰**: ä½œç”¨äºŽä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œè§£é™¤å˜é‡çš„é”å®šçŠ¶æ€ï¼Œè¢«è§£é™¤é”å®šçŠ¶æ€çš„å˜é‡æ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚
- **readï¼ˆè¯»å–ï¼‰**ï¼šä½œç”¨äºŽä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»Žä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåŽçš„ load åŠ¨ä½œä½¿ç”¨ã€‚
- **load(è½½å…¥)**ï¼šæŠŠ read æ“ä½œä»Žä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡çš„å‰¯æœ¬ä¸­ã€‚
- **use(ä½¿ç”¨)**ï¼šæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ ç»™æ‰§è¡Œå¼•æ“Žï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æŒ‡ä»¤æ—¶éƒ½ä¼šä½¿ç”¨è¯¥æŒ‡ä»¤ã€‚
- **assignï¼ˆèµ‹å€¼ï¼‰**ï¼šä½œç”¨äºŽå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»Žæ‰§è¡Œå¼•æ“ŽæŽ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚
- **storeï¼ˆå­˜å‚¨ï¼‰**ï¼šä½œç”¨äºŽå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåŽçš„ write æ“ä½œä½¿ç”¨ã€‚
- **writeï¼ˆå†™å…¥ï¼‰**ï¼šä½œç”¨äºŽä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠ store æ“ä½œä»Žå·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚

é™¤äº†è¿™ 8 ç§åŒæ­¥æ“ä½œä¹‹å¤–ï¼Œè¿˜è§„å®šäº†ä¸‹é¢è¿™äº›åŒæ­¥è§„åˆ™æ¥ä¿è¯è¿™äº›åŒæ­¥æ“ä½œçš„æ­£ç¡®æ‰§è¡Œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š

- ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŽŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»Žçº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›žä¸»å†…å­˜ä¸­ã€‚
- ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­ â€œè¯žç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æŽ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆload æˆ– assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®žæ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº† assign å’Œ load æ“ä½œã€‚
- ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åŽï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚
- å¦‚æžœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“Žä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load æˆ– assign æ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚
- å¦‚æžœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸åŽ» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚
- â€¦â€¦

### Java å†…å­˜åŒºåŸŸå’Œ JMM æœ‰ä½•åŒºåˆ«ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼Œå¾ˆå¤šåˆå­¦è€…éžå¸¸å®¹æ˜“æžæ··ã€‚ **Java å†…å­˜åŒºåŸŸå’Œå†…å­˜æ¨¡åž‹æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ä¸¤ä¸ªä¸œè¥¿**ï¼š

- JVM å†…å­˜ç»“æž„å’Œ Java è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶åŒºåŸŸç›¸å…³ï¼Œå®šä¹‰äº† JVM åœ¨è¿è¡Œæ—¶å¦‚ä½•åˆ†åŒºå­˜å‚¨ç¨‹åºæ•°æ®ï¼Œå°±æ¯”å¦‚è¯´å †ä¸»è¦ç”¨äºŽå­˜æ”¾å¯¹è±¡å®žä¾‹ã€‚
- Java å†…å­˜æ¨¡åž‹å’Œ Java çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³ï¼ŒæŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»å°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè§„å®šäº†ä»Ž Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŽŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢žå¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚

### happens-before åŽŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ

happens-before è¿™ä¸ªæ¦‚å¿µæœ€æ—©è¯žç”ŸäºŽ Leslie Lamport äºŽ 1978 å¹´å‘è¡¨çš„è®ºæ–‡[ã€ŠTimeï¼ŒClocks and the Ordering of Events in a Distributed Systemã€‹](https://lamport.azurewebsites.net/pubs/time-clocks.pdf)ã€‚åœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼ŒLeslie Lamport æå‡ºäº†[é€»è¾‘æ—¶é’Ÿ](https://writings.sh/post/logical-clocks)çš„æ¦‚å¿µï¼Œè¿™ä¹Ÿæˆäº†ç¬¬ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿç®—æ³• ã€‚åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸­ï¼Œé€šè¿‡ä¸€ç³»åˆ—è§„åˆ™æ¥å®šä¹‰é€»è¾‘æ—¶é’Ÿçš„å˜åŒ–ï¼Œä»Žè€Œèƒ½é€šè¿‡é€»è¾‘æ—¶é’Ÿæ¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶çš„å…ˆåŽé¡ºåºè¿›è¡Œåˆ¤æ–­ã€‚**é€»è¾‘æ—¶é’Ÿå¹¶ä¸åº¦é‡æ—¶é—´æœ¬èº«ï¼Œä»…åŒºåˆ†äº‹ä»¶å‘ç”Ÿçš„å‰åŽé¡ºåºï¼Œå…¶æœ¬è´¨å°±æ˜¯å®šä¹‰äº†ä¸€ç§ happens-before å…³ç³»ã€‚**

ä¸Šé¢æåˆ°çš„ happens-before è¿™ä¸ªæ¦‚å¿µè¯žç”Ÿçš„èƒŒæ™¯å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œç®€å•äº†è§£å³å¯ã€‚

JSR 133 å¼•å…¥äº† happens-before è¿™ä¸ªæ¦‚å¿µæ¥æè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ happens-before åŽŸåˆ™ï¼Ÿ** happens-before åŽŸåˆ™çš„è¯žç”Ÿæ˜¯ä¸ºäº†ç¨‹åºå‘˜å’Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ä¹‹é—´çš„å¹³è¡¡ã€‚ç¨‹åºå‘˜è¿½æ±‚çš„æ˜¯æ˜“äºŽç†è§£å’Œç¼–ç¨‹çš„å¼ºå†…å­˜æ¨¡åž‹ï¼Œéµå®ˆæ—¢å®šè§„åˆ™ç¼–ç å³å¯ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¿½æ±‚çš„æ˜¯è¾ƒå°‘çº¦æŸçš„å¼±å†…å­˜æ¨¡åž‹ï¼Œè®©å®ƒä»¬å°½å·±æ‰€èƒ½åœ°åŽ»ä¼˜åŒ–æ€§èƒ½ï¼Œè®©æ€§èƒ½æœ€å¤§åŒ–ã€‚happens-before åŽŸåˆ™çš„è®¾è®¡æ€æƒ³å…¶å®žéžå¸¸ç®€å•ï¼š

- ä¸ºäº†å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„çº¦æŸå°½å¯èƒ½å°‘ï¼Œåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æžœï¼ˆå•çº¿ç¨‹ç¨‹åºå’Œæ­£ç¡®æ‰§è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºï¼‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€Žä¹ˆè¿›è¡Œé‡æŽ’åºä¼˜åŒ–éƒ½è¡Œã€‚
- å¯¹äºŽä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æžœçš„é‡æŽ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢è¿™ç§é‡æŽ’åºã€‚

ä¸‹é¢è¿™å¼ æ˜¯ ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦ä¸­çš„ä¸€å¼  JMM è®¾è®¡æ€æƒ³çš„ç¤ºæ„å›¾ï¼Œéžå¸¸æ¸…æ™°ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731155332375.png)

äº†è§£äº† happens-before åŽŸåˆ™çš„è®¾è®¡æ€æƒ³ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ JSR-133 å¯¹ happens-before åŽŸåˆ™çš„å®šä¹‰ï¼š

- å¦‚æžœä¸€ä¸ªæ“ä½œ happens-before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æžœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæŽ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
- ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€ Java å¹³å°çš„å…·ä½“å®žçŽ°å¿…é¡»è¦æŒ‰ç…§ happens-before å…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æžœé‡æŽ’åºä¹‹åŽçš„æ‰§è¡Œç»“æžœï¼Œä¸ŽæŒ‰ happens-before å…³ç³»æ¥æ‰§è¡Œçš„ç»“æžœä¸€è‡´ï¼Œé‚£ä¹ˆ JMM ä¹Ÿå…è®¸è¿™æ ·çš„é‡æŽ’åºã€‚

æˆ‘ä»¬çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
int userNum = getUserNum();   // 1
int teacherNum = getTeacherNum();   // 2
int totalNum = userNum + teacherNum;  // 3
```

- 1 happens-before 2
- 2 happens-before 3
- 1 happens-before 3

è™½ç„¶ 1 happens-before 2ï¼Œä½†å¯¹ 1 å’Œ 2 è¿›è¡Œé‡æŽ’åºä¸ä¼šå½±å“ä»£ç çš„æ‰§è¡Œç»“æžœï¼Œæ‰€ä»¥ JMM æ˜¯å…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ‰§è¡Œè¿™ç§é‡æŽ’åºçš„ã€‚ä½† 1 å’Œ 2 å¿…é¡»æ˜¯åœ¨ 3 æ‰§è¡Œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ 1,2 happens-before 3 ã€‚

**happens-before åŽŸåˆ™è¡¨è¾¾çš„æ„ä¹‰å…¶å®žå¹¶ä¸æ˜¯ä¸€ä¸ªæ“ä½œå‘ç”Ÿåœ¨å¦å¤–ä¸€ä¸ªæ“ä½œçš„å‰é¢ï¼Œè™½ç„¶è¿™ä»Žç¨‹åºå‘˜çš„è§’åº¦ä¸Šæ¥è¯´ä¹Ÿå¹¶æ— å¤§ç¢ã€‚æ›´å‡†ç¡®åœ°æ¥è¯´ï¼Œå®ƒæ›´æƒ³è¡¨è¾¾çš„æ„ä¹‰æ˜¯å‰ä¸€ä¸ªæ“ä½œçš„ç»“æžœå¯¹äºŽåŽä¸€ä¸ªæ“ä½œæ˜¯å¯è§çš„ï¼Œæ— è®ºè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œã€‚**

ä¸¾ä¸ªä¾‹å­ï¼šæ“ä½œ 1 happens-before æ“ä½œ 2ï¼Œå³ä½¿æ“ä½œ 1 å’Œæ“ä½œ 2 ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒJMM ä¹Ÿä¼šä¿è¯æ“ä½œ 1 çš„ç»“æžœå¯¹æ“ä½œ 2 æ˜¯å¯è§çš„ã€‚

### happens-before å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ

happens-before çš„è§„åˆ™å°± 8 æ¡ï¼Œè¯´å¤šä¸å¤šï¼Œé‡ç‚¹äº†è§£ä¸‹é¢åˆ—ä¸¾çš„ 5 æ¡å³å¯ã€‚å…¨è®°æ˜¯ä¸å¯èƒ½çš„ï¼Œå¾ˆå¿«å°±å¿˜è®°äº†ï¼Œæ„ä¹‰ä¸å¤§ï¼Œéšæ—¶æŸ¥é˜…å³å¯ã€‚

1. **ç¨‹åºé¡ºåºè§„åˆ™**ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œ happens-before äºŽä¹¦å†™åœ¨åŽé¢çš„æ“ä½œï¼›
2. **è§£é”è§„åˆ™**ï¼šè§£é” happens-before äºŽåŠ é”ï¼›
3. **volatile variable rule**: A write operation to a volatile variable happens-before a subsequent read operation to the volatile variable. To put it bluntly, the result of a write operation to a volatile variable is visible to any subsequent operations.
4. **Transitive Rule**: If A happens-before B, and B happens-before C, then A happens-before C;
5. **Thread startup rules**: The `start()` method of the Thread object happens-before every action of this thread.

If two operations do not satisfy any of the above happens-before rules, then the order of the two operations is not guaranteed, and the JVM can reorder the two operations.

### What is the relationship between happens-before and JMM?

The relationship between happens-before and JMM can be explained very clearly with a picture in the book "The Art of Java Concurrent Programming".

![The relationship between happenings-before and JMM](https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731084604667.png)

## Letâ€™s look at three important features of concurrent programming

### Atomicity

For one operation or multiple operations, either all operations are executed and will not be interrupted by any factors, or none are executed.

In Java, atomicity can be achieved with the help of `synchronized`, various `Lock` and various atomic classes.

`synchronized` and various `Lock` can ensure that only one thread accesses the code block at any time, thus ensuring atomicity. Various atomic classes use CAS (compare and swap) operations (the `volatile` or `final` keywords may also be used) to ensure atomic operations.

### Visibility

When a thread modifies a shared variable, other threads can immediately see the latest modified value.

In Java, visibility can be achieved with the help of `synchronized`, `volatile` and various `Lock`.

If we declare a variable as `volatile`, this indicates to the JVM that this variable is shared and volatile and will be read from main memory every time it is used.

### Orderliness

Due to instruction reordering, the order in which the code is executed is not necessarily the order in which the code was written.

We also mentioned this when we talked about reordering above:

> **Instruction reordering can ensure consistent serial semantics, but there is no obligation to ensure consistent semantics across multiple threads**, so under multi-threading, instruction reordering may cause some problems.

In Java, the `volatile` keyword can disable instruction reordering optimization.

## Summary

- Java is the first language to try to provide a memory model. Its main purpose is to simplify multi-threaded programming and enhance program portability.
- The CPU can solve the memory cache inconsistency problem by developing a cache coherence protocol (such as the [MESI protocol](https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE)).
- In order to improve execution speed/performance, the computer will reorder instructions when executing program code. To put it simply, when the system executes the code, it does not necessarily execute it in the order of the code you wrote. **Instruction reordering can ensure consistent serial semantics, but there is no obligation to ensure consistent semantics across multiple threads**, so under multi-threading, instruction reordering may cause some problems.
- You can think of JMM as a set of specifications related to concurrent programming defined by Java. In addition to abstracting the relationship between threads and main memory, it also stipulates which concurrency-related principles and specifications must be followed during the conversion process from Java source code to CPU executable instructions. Its main purpose is to simplify multi-threaded programming and enhance program portability.
- JSR 133 introduces the concept of happens-before to describe memory visibility between two operations.

## Reference

- Chapter 3 of "The Art of Concurrent Programming in Java" Java Memory Model
- "In-depth introduction to Java multi-threading": <http://concurrent.redspider.group/RedSpider.html>
- Research on Java memory access reordering: <https://tech.meituan.com/2014/09/23/java-memory-reordering.html>
- Hey, classmate, the Java Memory Model (JMM) you want is here: <https://xie.infoq.cn/article/739920a92d0d27e2053174ef2>
- JSR 133 (Java Memory Model) FAQ: <https://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html>

<!-- @include: @article-footer.snippet.md -->