---
title: JVMåƒåœ¾å›æ”¶è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰
category: Java
tag:
  - JVM
head:
  - - meta
    - name: keywords
      content: åƒåœ¾å›æ”¶,GC ç®—æ³•,åˆ†ä»£å›æ”¶,æ ‡è®°æ¸…é™¤,å¤åˆ¶,æ•´ç†,G1,ZGC
  - - meta
    - name: description
      content: æ€»ç»“ JVM åƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å›æ”¶å™¨ï¼Œè§£æå†…å­˜ç®¡ç†ä¸è°ƒä¼˜è¦ç‚¹ã€‚
---

> å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œéƒ½æ˜¯é’ˆå¯¹çš„æ˜¯ HotSpot è™šæ‹Ÿæœºã€‚
>
> æœ¬æ–‡åŸºäºã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼šJVM é«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹è¿›è¡Œæ€»ç»“è¡¥å……ã€‚
>
> å¸¸è§é¢è¯•é¢˜ï¼š
>
> - å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­»äº¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰ã€‚
> - ç®€å•çš„ä»‹ç»ä¸€ä¸‹å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ï¼ˆè™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„åŒºåˆ«ã€ä½¿ç”¨è½¯å¼•ç”¨èƒ½å¸¦æ¥çš„å¥½å¤„ï¼‰ã€‚
> - å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡
> - å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»
> - åƒåœ¾æ”¶é›†æœ‰å“ªäº›ç®—æ³•ï¼Œå„è‡ªçš„ç‰¹ç‚¹ï¼Ÿ
> - HotSpot ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Ÿ
> - å¸¸è§çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ï¼Ÿ
> - ä»‹ç»ä¸€ä¸‹ CMS,G1 æ”¶é›†å™¨ã€‚
> - Minor Gc å’Œ Full GC æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

## å‰è¨€

å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºé—®é¢˜ã€å½“åƒåœ¾æ”¶é›†æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚

## å †ç©ºé—´çš„åŸºæœ¬ç»“æ„

Java çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ä¸»è¦æ˜¯é’ˆå¯¹å¯¹è±¡å†…å­˜çš„å›æ”¶å’Œå¯¹è±¡å†…å­˜çš„åˆ†é…ã€‚åŒæ—¶ï¼ŒJava è‡ªåŠ¨å†…å­˜ç®¡ç†æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯ **å †** å†…å­˜ä¸­å¯¹è±¡çš„åˆ†é…ä¸å›æ”¶ã€‚

Java å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä½œ **GC å †ï¼ˆGarbage Collected Heapï¼‰**ã€‚

ä»åƒåœ¾å›æ”¶çš„è§’åº¦æ¥è¯´ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ‰€ä»¥ Java å †è¢«åˆ’åˆ†ä¸ºäº†å‡ ä¸ªä¸åŒçš„åŒºåŸŸï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªåŒºåŸŸçš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚

åœ¨ JDK 7 ç‰ˆæœ¬åŠ JDK 7 ç‰ˆæœ¬ä¹‹å‰ï¼Œå †å†…å­˜è¢«é€šå¸¸åˆ†ä¸ºä¸‹é¢ä¸‰éƒ¨åˆ†ï¼š

1. æ–°ç”Ÿä»£å†…å­˜(Young Generation)
2. è€ç”Ÿä»£(Old Generation)
3. æ°¸ä¹…ä»£(Permanent Generation)

ä¸‹å›¾æ‰€ç¤ºçš„ Eden åŒºã€ä¸¤ä¸ª Survivor åŒº S0 å’Œ S1 éƒ½å±äºæ–°ç”Ÿä»£ï¼Œä¸­é—´ä¸€å±‚å±äºè€å¹´ä»£ï¼Œæœ€ä¸‹é¢ä¸€å±‚å±äºæ°¸ä¹…ä»£ã€‚

![å †å†…å­˜ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/jvm/hotspot-heap-structure.png)

**JDK 8 ç‰ˆæœ¬ä¹‹å PermGen(æ°¸ä¹…) å·²è¢« Metaspace(å…ƒç©ºé—´) å–ä»£ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜** ã€‚

å…³äºå †ç©ºé—´ç»“æ„æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œå¯ä»¥å›è¿‡å¤´çœ‹çœ‹ [Java å†…å­˜åŒºåŸŸè¯¦è§£](./memory-area.md) è¿™ç¯‡æ–‡ç« ã€‚

## å†…å­˜åˆ†é…å’Œå›æ”¶åŸåˆ™

### å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åŒºåˆ†é…

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­ Eden åŒºåˆ†é…ã€‚å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GCã€‚ä¸‹é¢æˆ‘ä»¬æ¥è¿›è¡Œå®é™…æµ‹è¯•ä¸€ä¸‹ã€‚

æµ‹è¯•ä»£ç ï¼š

```java
public class GCTest {
  public static void main(String[] args) {
    byte[] allocation1, allocation2;
    allocation1 = new byte[30900*1024];
  }
}
```

é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿è¡Œï¼š
![](https://oss.javaguide.cn/github/javaguide/java/jvm/25178350.png)

æ·»åŠ çš„å‚æ•°ï¼š`-XX:+PrintGCDetails`
![](https://oss.javaguide.cn/github/javaguide/java/jvm/run-with-PrintGCDetails.png)

è¿è¡Œç»“æœ (çº¢è‰²å­—ä½“æè¿°æœ‰è¯¯ï¼Œåº”è¯¥æ˜¯å¯¹åº”äº JDK1.7 çš„æ°¸ä¹…ä»£)ï¼š

![](https://oss.javaguide.cn/github/javaguide/java/jvm/28954286.jpg)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡º Eden åŒºå†…å­˜å‡ ä¹å·²ç»è¢«åˆ†é…å®Œå…¨ï¼ˆå³ä½¿ç¨‹åºä»€ä¹ˆä¹Ÿä¸åšï¼Œæ–°ç”Ÿä»£ä¹Ÿä¼šä½¿ç”¨ 2000 å¤š k å†…å­˜ï¼‰ã€‚

å‡å¦‚æˆ‘ä»¬å†ä¸º `allocation2` åˆ†é…å†…å­˜ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

```java
allocation2 = new byte[900*1024];
```

![](https://oss.javaguide.cn/github/javaguide/java/jvm/28128785.jpg)

ç»™ `allocation2` åˆ†é…å†…å­˜çš„æ—¶å€™ Eden åŒºå†…å­˜å‡ ä¹å·²ç»è¢«åˆ†é…å®Œäº†

å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GCã€‚GC æœŸé—´è™šæ‹Ÿæœºåˆå‘ç° `allocation1` æ— æ³•å­˜å…¥ Survivor ç©ºé—´ï¼Œæ‰€ä»¥åªå¥½é€šè¿‡ **åˆ†é…æ‹…ä¿æœºåˆ¶** æŠŠæ–°ç”Ÿä»£çš„å¯¹è±¡æå‰è½¬ç§»åˆ°è€å¹´ä»£ä¸­å»ï¼Œè€å¹´ä»£ä¸Šçš„ç©ºé—´è¶³å¤Ÿå­˜æ”¾ `allocation1`ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° Full GCã€‚æ‰§è¡Œ Minor GC åï¼Œåé¢åˆ†é…çš„å¯¹è±¡å¦‚æœèƒ½å¤Ÿå­˜åœ¨ Eden åŒºçš„è¯ï¼Œè¿˜æ˜¯ä¼šåœ¨ Eden åŒºåˆ†é…å†…å­˜ã€‚å¯ä»¥æ‰§è¡Œå¦‚ä¸‹ä»£ç éªŒè¯ï¼š

```java
public class GCTest {

  public static void main(String[] args) {
    byte[] allocation1, allocation2,allocation3,allocation4,allocation5;
    allocation1 = new byte[32000*1024];
    allocation2 = new byte[1000*1024];
    allocation3 = new byte[1000*1024];
    allocation4 = new byte[1000*1024];
    allocation5 = new byte[1000*1024];
  }
}

```

### å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£

å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ã€‚

å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„è¡Œä¸ºæ˜¯ç”±è™šæ‹ŸæœºåŠ¨æ€å†³å®šçš„ï¼Œå®ƒä¸å…·ä½“ä½¿ç”¨çš„åƒåœ¾å›æ”¶å™¨å’Œç›¸å…³å‚æ•°æœ‰å…³ã€‚å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£æ˜¯ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼Œæ—¨åœ¨é¿å…å°†å¤§å¯¹è±¡æ”¾å…¥æ–°ç”Ÿä»£ï¼Œä»è€Œå‡å°‘æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶é¢‘ç‡å’Œæˆæœ¬ã€‚

- G1 åƒåœ¾å›æ”¶å™¨ä¼šæ ¹æ® `-XX:G1HeapRegionSize` å‚æ•°è®¾ç½®çš„å †åŒºåŸŸå¤§å°å’Œ `-XX:G1MixedGCLiveThresholdPercent` å‚æ•°è®¾ç½®çš„é˜ˆå€¼ï¼Œæ¥å†³å®šå“ªäº›å¯¹è±¡ä¼šç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚
- Parallel Scavenge åƒåœ¾å›æ”¶å™¨ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼(`XX:ThresholdTolerance`æ˜¯åŠ¨æ€è°ƒæ•´çš„)æ¥å†³å®šä½•æ—¶ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…å¤§å¯¹è±¡ã€‚è€Œæ˜¯ç”±è™šæ‹Ÿæœºæ ¹æ®å½“å‰çš„å †å†…å­˜æƒ…å†µå’Œå†å²æ•°æ®åŠ¨æ€å†³å®šã€‚

### é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£

æ—¢ç„¶è™šæ‹Ÿæœºé‡‡ç”¨äº†åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œé‚£ä¹ˆå†…å­˜å›æ”¶æ—¶å°±å¿…é¡»èƒ½è¯†åˆ«å“ªäº›å¯¹è±¡åº”æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œå“ªäº›å¯¹è±¡åº”æ”¾åœ¨è€å¹´ä»£ä¸­ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡ä¸€ä¸ªå¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ã€‚å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡ Minor GC åä»ç„¶èƒ½å¤Ÿå­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢« Survivor å®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ° Survivor ç©ºé—´ï¼ˆs0 æˆ–è€… s1ï¼‰ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º 1(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ã€‚

å¯¹è±¡åœ¨ Survivor ä¸­æ¯ç†¬è¿‡ä¸€æ¬¡ MinorGC,å¹´é¾„å°±å¢åŠ  1 å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®ã€‚

> ä¿®æ­£ï¼ˆ[issue552](https://github.com/Snailclimb/JavaGuide/issues/552)ï¼‰ï¼šâ€œHotspot éå†æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¹´é¾„ä»å°åˆ°å¤§å¯¹å…¶æ‰€å ç”¨çš„å¤§å°è¿›è¡Œç´¯ç§¯ï¼Œå½“ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº† survivor åŒºçš„ 50% æ—¶ï¼ˆé»˜è®¤å€¼æ˜¯ 50%ï¼Œå¯ä»¥é€šè¿‡ `-XX:TargetSurvivorRatio=percent` æ¥è®¾ç½®ï¼Œå‚è§ [issue1199](https://github.com/Snailclimb/JavaGuide/issues/1199) ï¼‰ï¼Œå–è¿™ä¸ªå¹´é¾„å’Œ MaxTenuringThreshold ä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼â€ã€‚
>
> jdk8 å®˜æ–¹æ–‡æ¡£å¼•ç”¨ï¼š<https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html>ã€‚
>
> ![](https://oss.javaguide.cn/java-guide-blog/image-20210523201742303.png)
>
> **åŠ¨æ€å¹´é¾„è®¡ç®—çš„ä»£ç å¦‚ä¸‹ï¼š**
>
> ```c++
> uint ageTable::compute_tenuring_threshold(size_t survivor_capacity) {
> //survivor_capacityæ˜¯survivorç©ºé—´çš„å¤§å°
> size_t desired_survivor_size = (size_t)((((double)survivor_capacity)*TargetSurvivorRatio)/100);
> size_t total = 0;
> uint age = 1;
> while (age < table_size) {
> //sizesæ•°ç»„æ˜¯æ¯ä¸ªå¹´é¾„æ®µå¯¹è±¡å¤§å°
> total += sizes[age];
> if (total > desired_survivor_size) {
> break;
> }
> age++;
> }
> uint result = age < MaxTenuringThreshold ? age : MaxTenuringThreshold;
> ...
> }
>
> ```
>
> é¢å¤–è¡¥å……è¯´æ˜([issue672](https://github.com/Snailclimb/JavaGuide/issues/672))ï¼š**å…³äºé»˜è®¤çš„æ™‹å‡å¹´é¾„æ˜¯ 15ï¼Œè¿™ä¸ªè¯´æ³•çš„æ¥æºå¤§éƒ¨åˆ†éƒ½æ˜¯ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹è¿™æœ¬ä¹¦ã€‚**
> å¦‚æœä½ å» Oracle çš„å®˜ç½‘é˜…è¯»[ç›¸å…³çš„è™šæ‹Ÿæœºå‚æ•°](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html)ï¼Œä½ ä¼šå‘ç°`-XX:MaxTenuringThreshold=threshold`è¿™é‡Œæœ‰ä¸ªè¯´æ˜
>
> **Sets the maximum tenuring threshold for use in adaptive GC sizing. The largest value is 15. The default value is 15 for the parallel (throughput) collector, and 6 for the CMS collector.é»˜è®¤æ™‹å‡å¹´é¾„å¹¶ä¸éƒ½æ˜¯ 15ï¼Œè¿™ä¸ªæ˜¯è¦åŒºåˆ†åƒåœ¾æ”¶é›†å™¨çš„ï¼ŒCMS å°±æ˜¯ 6.**

### ä¸»è¦è¿›è¡Œ gc çš„åŒºåŸŸ

å‘¨å¿—æ˜å…ˆç”Ÿåœ¨ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ç¬¬äºŒç‰ˆä¸­ P92 å¦‚æ˜¯å†™é“ï¼š

> ~~_â€œè€å¹´ä»£ GCï¼ˆMajor GC/Full GCï¼‰ï¼ŒæŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ GCâ€¦â€¦â€_~~

ä¸Šé¢çš„è¯´æ³•å·²ç»åœ¨ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ç¬¬ä¸‰ç‰ˆä¸­è¢«æ”¹æ­£è¿‡æ¥äº†ã€‚æ„Ÿè°¢ R å¤§çš„å›ç­”ï¼š

![R å¤§çš„å›ç­”](https://oss.javaguide.cn/github/javaguide/java/jvm/rf-hotspot-vm-gc.png)

**æ€»ç»“ï¼š**

é’ˆå¯¹ HotSpot VM çš„å®ç°ï¼Œå®ƒé‡Œé¢çš„ GC å…¶å®å‡†ç¡®åˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š

éƒ¨åˆ†æ”¶é›† (Partial GC)ï¼š

- æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC / Young GCï¼‰ï¼šåªå¯¹æ–°ç”Ÿä»£è¿›è¡Œåƒåœ¾æ”¶é›†ï¼›
- è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC / Old GCï¼‰ï¼šåªå¯¹è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ Major GC åœ¨æœ‰çš„è¯­å¢ƒä¸­ä¹Ÿç”¨äºæŒ‡ä»£æ•´å †æ”¶é›†ï¼›
- æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šå¯¹æ•´ä¸ªæ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

æ•´å †æ”¶é›† (Full GC)ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒºã€‚

### ç©ºé—´åˆ†é…æ‹…ä¿

ç©ºé—´åˆ†é…æ‹…ä¿æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ Minor GC ä¹‹å‰è€å¹´ä»£æœ¬èº«è¿˜æœ‰å®¹çº³æ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„å‰©ä½™ç©ºé—´ã€‚

ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ç¬¬ä¸‰ç« å¯¹äºç©ºé—´åˆ†é…æ‹…ä¿çš„æè¿°å¦‚ä¸‹ï¼š

> JDK 6 Update 24 ä¹‹å‰ï¼Œåœ¨å‘ç”Ÿ Minor GC ä¹‹å‰ï¼Œè™šæ‹Ÿæœºå¿…é¡»å…ˆæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œå¦‚æœè¿™ä¸ªæ¡ä»¶æˆç«‹ï¼Œé‚£è¿™ä¸€æ¬¡ Minor GC å¯ä»¥ç¡®ä¿æ˜¯å®‰å…¨çš„ã€‚å¦‚æœä¸æˆç«‹ï¼Œåˆ™è™šæ‹Ÿæœºä¼šå…ˆæŸ¥çœ‹ `-XX:HandlePromotionFailure` å‚æ•°çš„è®¾ç½®å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥(Handle Promotion Failure);å¦‚æœå…è®¸ï¼Œé‚£ä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœå¤§äºï¼Œå°†å°è¯•è¿›è¡Œä¸€æ¬¡ Minor GCï¼Œå°½ç®¡è¿™æ¬¡ Minor GC æ˜¯æœ‰é£é™©çš„;å¦‚æœå°äºï¼Œæˆ–è€… `-XX: HandlePromotionFailure` è®¾ç½®ä¸å…è®¸å†’é™©ï¼Œé‚£è¿™æ—¶å°±è¦æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡ Full GCã€‚
>
> JDK 6 Update 24 ä¹‹åçš„è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°ï¼Œå°±ä¼šè¿›è¡Œ Minor GCï¼Œå¦åˆ™å°†è¿›è¡Œ Full GCã€‚

## æ­»äº¡å¯¹è±¡åˆ¤æ–­æ–¹æ³•

å †ä¸­å‡ ä¹æ”¾ç€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼Œå¯¹å †åƒåœ¾å›æ”¶å‰çš„ç¬¬ä¸€æ­¥å°±æ˜¯è¦åˆ¤æ–­å“ªäº›å¯¹è±¡å·²ç»æ­»äº¡ï¼ˆå³ä¸èƒ½å†è¢«ä»»ä½•é€”å¾„ä½¿ç”¨çš„å¯¹è±¡ï¼‰ã€‚

### å¼•ç”¨è®¡æ•°æ³•

ç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼š

- æ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨å°±åŠ  1ï¼›
- å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±å‡ 1ï¼›
- ä»»ä½•æ—¶å€™è®¡æ•°å™¨ä¸º 0 çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚

**è¿™ä¸ªæ–¹æ³•å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œä½†æ˜¯ç›®å‰ä¸»æµçš„è™šæ‹Ÿæœºä¸­å¹¶æ²¡æœ‰é€‰æ‹©è¿™ä¸ªç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œå…¶æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚**

![å¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨](https://oss.javaguide.cn/github/javaguide/java/jvm/object-circular-reference.png)

æ‰€è°“å¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨é—®é¢˜ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼šé™¤äº†å¯¹è±¡ `objA` å’Œ `objB` ç›¸äº’å¼•ç”¨ç€å¯¹æ–¹ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å†æ— ä»»ä½•å¼•ç”¨ã€‚ä½†æ˜¯ä»–ä»¬å› ä¸ºäº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å™¨éƒ½ä¸ä¸º 0ï¼Œäºæ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•é€šçŸ¥ GC å›æ”¶å™¨å›æ”¶ä»–ä»¬ã€‚

```java
public class ReferenceCountingGc {
    Object instance = null;
    public static void main(String[] args) {
        ReferenceCountingGc objA = new ReferenceCountingGc();
        ReferenceCountingGc objB = new ReferenceCountingGc();
        objA.instance = objB;
        objB.instance = objA;
        objA = null;
        objB = null;
    }
}
```

### å¯è¾¾æ€§åˆ†æç®—æ³•

è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º **â€œGC Rootsâ€** çš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼ŒèŠ‚ç‚¹æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿çš„è¯ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ï¼Œéœ€è¦è¢«å›æ”¶ã€‚

ä¸‹å›¾ä¸­çš„ `Object 6 ~ Object 10` ä¹‹é—´è™½æœ‰å¼•ç”¨å…³ç³»ï¼Œä½†å®ƒä»¬åˆ° GC Roots ä¸å¯è¾¾ï¼Œå› æ­¤ä¸ºéœ€è¦è¢«å›æ”¶çš„å¯¹è±¡ã€‚

![å¯è¾¾æ€§åˆ†æç®—æ³•](https://oss.javaguide.cn/github/javaguide/java/jvm/jvm-gc-roots.png)

**å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Roots å‘¢ï¼Ÿ**

- è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡
- æœ¬åœ°æ–¹æ³•æ ˆ(Native æ–¹æ³•)ä¸­å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
- æ‰€æœ‰è¢«åŒæ­¥é”æŒæœ‰çš„å¯¹è±¡
- JNIï¼ˆJava Native Interfaceï¼‰å¼•ç”¨çš„å¯¹è±¡

**å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œå°±ä»£è¡¨ä¸€å®šä¼šè¢«å›æ”¶å—ï¼Ÿ**

å³ä½¿åœ¨å¯è¾¾æ€§åˆ†ææ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘é˜¶æ®µâ€ï¼Œè¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼›å¯è¾¾æ€§åˆ†ææ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡è¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œ `finalize` æ–¹æ³•ã€‚å½“å¯¹è±¡æ²¡æœ‰è¦†ç›– `finalize` æ–¹æ³•ï¼Œæˆ– `finalize` æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡æ—¶ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µè§†ä¸ºæ²¡æœ‰å¿…è¦æ‰§è¡Œã€‚

è¢«åˆ¤å®šä¸ºéœ€è¦æ‰§è¡Œçš„å¯¹è±¡å°†ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ï¼Œé™¤éè¿™ä¸ªå¯¹è±¡ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”ï¼Œå¦åˆ™å°±ä¼šè¢«çœŸçš„å›æ”¶ã€‚

> `Object` ç±»ä¸­çš„ `finalize` æ–¹æ³•ä¸€ç›´è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªç³Ÿç³•çš„è®¾è®¡ï¼Œæˆä¸ºäº† Java è¯­è¨€çš„è´Ÿæ‹…ï¼Œå½±å“äº† Java è¯­è¨€çš„å®‰å…¨å’Œ GC çš„æ€§èƒ½ã€‚JDK9 ç‰ˆæœ¬åŠåç»­ç‰ˆæœ¬ä¸­å„ä¸ªç±»ä¸­çš„ `finalize` æ–¹æ³•ä¼šè¢«é€æ¸å¼ƒç”¨ç§»é™¤ã€‚å¿˜æ‰å®ƒçš„å­˜åœ¨å§ï¼
>
> å‚è€ƒï¼š
>
> - [JEP 421: Deprecate Finalization for Removal](https://openjdk.java.net/jeps/421)
> - [æ˜¯æ—¶å€™å¿˜æ‰ finalize æ–¹æ³•äº†](https://mp.weixin.qq.com/s/LW-paZAMD08DP_3-XCUxmg)

### å¼•ç”¨ç±»å‹æ€»ç»“

æ— è®ºæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ³•åˆ¤æ–­å¯¹è±¡å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†ææ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨é“¾æ˜¯å¦å¯è¾¾ï¼Œåˆ¤å®šå¯¹è±¡çš„å­˜æ´»éƒ½ä¸â€œå¼•ç”¨â€æœ‰å…³ã€‚

JDK1.2 ä¹‹å‰ï¼ŒJava ä¸­å¼•ç”¨çš„å®šä¹‰å¾ˆä¼ ç»Ÿï¼šå¦‚æœ reference ç±»å‹çš„æ•°æ®å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ä¸€ä¸ªå¼•ç”¨ã€‚

JDK1.2 ä»¥åï¼ŒJava å¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å››ç§ï¼ˆå¼•ç”¨å¼ºåº¦é€æ¸å‡å¼±ï¼‰ï¼Œå¼ºå¼•ç”¨å°±æ˜¯ Java ä¸­æ™®é€šçš„å¯¹è±¡ï¼Œè€Œè½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨åœ¨ JDK ä¸­å®šä¹‰çš„ç±»åˆ†åˆ«æ˜¯ `SoftReference`ã€`WeakReference`ã€`PhantomReference`ã€‚

![Java å¼•ç”¨ç±»å‹æ€»ç»“](https://oss.javaguide.cn/github/javaguide/java/jvm/java-reference-type.png)

**1ï¼å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰**

å¼ºå¼•ç”¨å®é™…ä¸Šå°±æ˜¯ç¨‹åºä»£ç ä¸­æ™®éå­˜åœ¨çš„å¼•ç”¨èµ‹å€¼ï¼Œè¿™æ˜¯ä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨ï¼Œå…¶ä»£ç å¦‚ä¸‹

```java
String strongReference = new String("abc");
```

å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¿…ä¸å¯å°‘çš„ç”Ÿæ´»ç”¨å“**ï¼Œåƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJava è™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OutOfMemoryError é”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šé éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³é—®é¢˜ã€‚

**2ï¼è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰**

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“**ã€‚è½¯å¼•ç”¨ä»£ç å¦‚ä¸‹

```java
// è½¯å¼•ç”¨
String str = new String("abc");
SoftReference<String> softReference = new SoftReference<String>(str);
```

å¦‚æœå†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼Œå¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚åªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨ã€‚è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚

è½¯å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJAVA è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªè½¯å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚

**3ï¼å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰**

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“**ã€‚å¼±å¼•ç”¨ä»£ç å¦‚ä¸‹ï¼š

```java
String str = new String("abc");
WeakReference<String> weakReference = new WeakReference<>(str);
str = null; //strå˜æˆè½¯å¼•ç”¨ï¼Œå¯ä»¥è¢«æ”¶é›†
```

å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚

å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚

**4ï¼è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰**

"è™šå¼•ç”¨"é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½¢åŒè™šè®¾ï¼Œä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒï¼Œè™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶ã€‚è™šå¼•ç”¨ä»£ç å¦‚ä¸‹ï¼š

```java
String str = new String("abc");
ReferenceQueue queue = new ReferenceQueue();
// åˆ›å»ºè™šå¼•ç”¨ï¼Œè¦æ±‚å¿…é¡»ä¸ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—å…³è”
PhantomReference pr = new PhantomReference(str, queue);
```

**è™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨**ã€‚

**è™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä¸€ä¸ªåŒºåˆ«åœ¨äºï¼š** è™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ã€‚å½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡çš„å†…å­˜ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯å¦å·²ç»åŠ å…¥äº†è™šå¼•ç”¨ï¼Œæ¥äº†è§£è¢«å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å°†è¦è¢«åƒåœ¾å›æ”¶ã€‚ç¨‹åºå¦‚æœå‘ç°æŸä¸ªè™šå¼•ç”¨å·²ç»è¢«åŠ å…¥åˆ°å¼•ç”¨é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å†…å­˜è¢«å›æ”¶ä¹‹å‰é‡‡å–å¿…è¦çš„è¡ŒåŠ¨ã€‚

ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨ç¨‹åºè®¾è®¡ä¸­ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨å¼±å¼•ç”¨ä¸è™šå¼•ç”¨ï¼Œä½¿ç”¨è½¯å¼•ç”¨çš„æƒ…å†µè¾ƒå¤šï¼Œè¿™æ˜¯å› ä¸º**è½¯å¼•ç”¨å¯ä»¥åŠ é€Ÿ JVM å¯¹åƒåœ¾å†…å­˜çš„å›æ”¶é€Ÿåº¦ï¼Œå¯ä»¥ç»´æŠ¤ç³»ç»Ÿçš„è¿è¡Œå®‰å…¨ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼ˆOutOfMemoryï¼‰ç­‰é—®é¢˜çš„äº§ç”Ÿ**ã€‚

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡ï¼Ÿ

è¿è¡Œæ—¶å¸¸é‡æ± ä¸»è¦å›æ”¶çš„æ˜¯åºŸå¼ƒçš„å¸¸é‡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡å‘¢ï¼Ÿ

~~**JDK1.7 åŠä¹‹åç‰ˆæœ¬çš„ JVM å·²ç»å°†è¿è¡Œæ—¶å¸¸é‡æ± ä»æ–¹æ³•åŒºä¸­ç§»äº†å‡ºæ¥ï¼Œåœ¨ Java å †ï¼ˆHeapï¼‰ä¸­å¼€è¾Ÿäº†ä¸€å—åŒºåŸŸå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ã€‚**~~

> **ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue747](https://github.com/Snailclimb/JavaGuide/issues/747)ï¼Œ[reference](https://blog.csdn.net/q5706503/article/details/84640762)ï¼‰**ï¼š
>
> 1. **JDK1.7 ä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒº, æ­¤æ—¶ hotspot è™šæ‹Ÿæœºå¯¹æ–¹æ³•åŒºçš„å®ç°ä¸ºæ°¸ä¹…ä»£**
> 2. **JDK1.7 å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­, è¿™é‡Œæ²¡æœ‰æåˆ°è¿è¡Œæ—¶å¸¸é‡æ± ,ä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²å¸¸é‡æ± è¢«å•ç‹¬æ‹¿åˆ°å †,è¿è¡Œæ—¶å¸¸é‡æ± å‰©ä¸‹çš„ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒº, ä¹Ÿå°±æ˜¯ hotspot ä¸­çš„æ°¸ä¹…ä»£** ã€‚
> 3. **JDK1.8 hotspot ç§»é™¤äº†æ°¸ä¹…ä»£ç”¨å…ƒç©ºé—´(Metaspace)å–è€Œä»£ä¹‹, è¿™æ—¶å€™å­—ç¬¦ä¸²å¸¸é‡æ± è¿˜åœ¨å †, è¿è¡Œæ—¶å¸¸é‡æ± è¿˜åœ¨æ–¹æ³•åŒº, åªä¸è¿‡æ–¹æ³•åŒºçš„å®ç°ä»æ°¸ä¹…ä»£å˜æˆäº†å…ƒç©ºé—´(Metaspace)**

å‡å¦‚åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸² "abc"ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½• String å¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡ "abc" å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿå†…å­˜å›æ”¶çš„è¯è€Œä¸”æœ‰å¿…è¦çš„è¯ï¼Œ"abc" å°±ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± äº†ã€‚

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»ï¼Ÿ

æ–¹æ³•åŒºä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»çš„å‘¢ï¼Ÿ

åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦æ˜¯â€œåºŸå¼ƒå¸¸é‡â€æ¯”è¾ƒç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯â€œæ— ç”¨çš„ç±»â€çš„æ¡ä»¶åˆ™ç›¸å¯¹è‹›åˆ»è®¸å¤šã€‚ç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ 3 ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ **â€œæ— ç”¨çš„ç±»â€**ï¼š

- è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚
- åŠ è½½è¯¥ç±»çš„ `ClassLoader` å·²ç»è¢«å›æ”¶ã€‚
- è¯¥ç±»å¯¹åº”çš„ `java.lang.Class` å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚

è™šæ‹Ÿæœºå¯ä»¥å¯¹æ»¡è¶³ä¸Šè¿° 3 ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ä¸ä½¿ç”¨äº†å°±ä¼šå¿…ç„¶è¢«å›æ”¶ã€‚

## åƒåœ¾æ”¶é›†ç®—æ³•

### æ ‡è®°-æ¸…é™¤ç®—æ³•

æ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰ç®—æ³•åˆ†ä¸ºâ€œæ ‡è®°ï¼ˆMarkï¼‰â€å’Œâ€œæ¸…é™¤ï¼ˆSweepï¼‰â€é˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰æ²¡æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚

å®ƒæ˜¯æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œåç»­çš„ç®—æ³•éƒ½æ˜¯å¯¹å…¶ä¸è¶³è¿›è¡Œæ”¹è¿›å¾—åˆ°ã€‚è¿™ç§åƒåœ¾æ”¶é›†ç®—æ³•ä¼šå¸¦æ¥ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š

1. **æ•ˆç‡é—®é¢˜**ï¼šæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹æ•ˆç‡éƒ½ä¸é«˜ã€‚
2. **ç©ºé—´é—®é¢˜**ï¼šæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ã€‚

![æ ‡è®°-æ¸…é™¤ç®—æ³•](https://oss.javaguide.cn/github/javaguide/java/jvm/mark-and-sweep-garbage-collection-algorithm.png)

å…³äºå…·ä½“æ˜¯æ ‡è®°å¯å›æ”¶å¯¹è±¡ï¼ˆä¸å¯è¾¾å¯¹è±¡ï¼‰è¿˜æ˜¯ä¸å¯å›æ”¶å¯¹è±¡ï¼ˆå¯è¾¾å¯¹è±¡ï¼‰ï¼Œä¼—è¯´çº·çº­ï¼Œä¸¤ç§è¯´æ³•å…¶å®éƒ½æ²¡é—®é¢˜ï¼Œæˆ‘ä¸ªäººæ›´å€¾å‘äºæ˜¯åè€…ã€‚

å¦‚æœæŒ‰ç…§å‰è€…çš„ç†è§£ï¼Œæ•´ä¸ªæ ‡è®°-æ¸…é™¤è¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

1. å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œç»™ä¸€ä¸ªæ ‡è®°ä½ï¼Œå‡è®¾ä¸º 0 (false)ï¼›
2. åœ¨æ ‡è®°é˜¶æ®µï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼ˆæˆ–ç”¨æˆ·å¯ä»¥å¼•ç”¨çš„å¯¹è±¡ï¼‰çš„æ ‡è®°ä½è®¾ç½®ä¸º 1 (true)ï¼›
3. æ‰«æé˜¶æ®µæ¸…é™¤çš„å°±æ˜¯æ ‡è®°ä½ä¸º 0 (false)çš„å¯¹è±¡ã€‚

### å¤åˆ¶ç®—æ³•

ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³•çš„æ•ˆç‡å’Œå†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå¤åˆ¶ï¼ˆCopyingï¼‰æ”¶é›†ç®—æ³•å‡ºç°äº†ã€‚å®ƒå¯ä»¥å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œåï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å»ï¼Œç„¶åå†æŠŠä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·å°±ä½¿æ¯æ¬¡çš„å†…å­˜å›æ”¶éƒ½æ˜¯å¯¹å†…å­˜åŒºé—´çš„ä¸€åŠè¿›è¡Œå›æ”¶ã€‚

![å¤åˆ¶ç®—æ³•](https://oss.javaguide.cn/github/javaguide/java/jvm/copying-garbage-collection-algorithm.png)

è™½ç„¶æ”¹è¿›äº†æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œä½†ä¾ç„¶å­˜åœ¨ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

- **å¯ç”¨å†…å­˜å˜å°**ï¼šå¯ç”¨å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠã€‚
- **ä¸é€‚åˆè€å¹´ä»£**ï¼šå¦‚æœå­˜æ´»å¯¹è±¡æ•°é‡æ¯”è¾ƒå¤§ï¼Œå¤åˆ¶æ€§èƒ½ä¼šå˜å¾—å¾ˆå·®ã€‚

### æ ‡è®°-æ•´ç†ç®—æ³•

æ ‡è®°-æ•´ç†ï¼ˆMark-and-Compactï¼‰ç®—æ³•æ˜¯æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹æå‡ºçš„ä¸€ç§æ ‡è®°ç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡å›æ”¶ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚

![æ ‡è®°-æ•´ç†ç®—æ³•](https://oss.javaguide.cn/github/javaguide/java/jvm/mark-and-compact-garbage-collection-algorithm.png)

ç”±äºå¤šäº†æ•´ç†è¿™ä¸€æ­¥ï¼Œå› æ­¤æ•ˆç‡ä¹Ÿä¸é«˜ï¼Œé€‚åˆè€å¹´ä»£è¿™ç§åƒåœ¾å›æ”¶é¢‘ç‡ä¸æ˜¯å¾ˆé«˜çš„åœºæ™¯ã€‚

### åˆ†ä»£æ”¶é›†ç®—æ³•

å½“å‰è™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œè¿™ç§ç®—æ³•æ²¡æœ‰ä»€ä¹ˆæ–°çš„æ€æƒ³ï¼Œåªæ˜¯æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬å°† Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚

æ¯”å¦‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©â€œå¤åˆ¶â€ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†ã€‚è€Œè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»å‡ ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

**å»¶ä¼¸é¢è¯•é—®é¢˜ï¼š** HotSpot ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Ÿ

æ ¹æ®ä¸Šé¢çš„å¯¹åˆ†ä»£æ”¶é›†ç®—æ³•çš„ä»‹ç»å›ç­”ã€‚

## åƒåœ¾æ”¶é›†å™¨

**å¦‚æœè¯´æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯å†…å­˜å›æ”¶çš„å…·ä½“å®ç°ã€‚**

è™½ç„¶æˆ‘ä»¬å¯¹å„ä¸ªæ”¶é›†å™¨è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¹¶éè¦æŒ‘é€‰å‡ºä¸€ä¸ªæœ€å¥½çš„æ”¶é›†å™¨ã€‚å› ä¸ºç›´åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æ²¡æœ‰æœ€å¥½çš„åƒåœ¾æ”¶é›†å™¨å‡ºç°ï¼Œæ›´åŠ æ²¡æœ‰ä¸‡èƒ½çš„åƒåœ¾æ”¶é›†å™¨ï¼Œ**æˆ‘ä»¬èƒ½åšçš„å°±æ˜¯æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯é€‰æ‹©é€‚åˆè‡ªå·±çš„åƒåœ¾æ”¶é›†å™¨**ã€‚è¯•æƒ³ä¸€ä¸‹ï¼šå¦‚æœæœ‰ä¸€ç§å››æµ·ä¹‹å†…ã€ä»»ä½•åœºæ™¯ä¸‹éƒ½é€‚ç”¨çš„å®Œç¾æ”¶é›†å™¨å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ HotSpot è™šæ‹Ÿæœºå°±ä¸ä¼šå®ç°é‚£ä¹ˆå¤šä¸åŒçš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚

JDK é»˜è®¤åƒåœ¾æ”¶é›†å™¨ï¼ˆä½¿ç”¨ `java -XX:+PrintCommandLineFlags -version` å‘½ä»¤æŸ¥çœ‹ï¼‰ï¼š

- JDK 8: Parallel Scavengeï¼ˆæ–°ç”Ÿä»£ï¼‰+ Parallel Oldï¼ˆè€å¹´ä»£ï¼‰
- JDK 9 ~ JDK22: G1

### Serial æ”¶é›†å™¨

Serialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚å¤§å®¶çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚å®ƒçš„ **â€œå•çº¿ç¨‹â€** çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ **"Stop The World"** ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚

**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![Serial æ”¶é›†å™¨](https://oss.javaguide.cn/github/javaguide/java/jvm/serial-garbage-collector.png)

è™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬å½“ç„¶çŸ¥é“ Stop The World å¸¦æ¥çš„ä¸è‰¯ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥åœ¨åç»­çš„åƒåœ¾æ”¶é›†å™¨è®¾è®¡ä¸­åœé¡¿æ—¶é—´åœ¨ä¸æ–­ç¼©çŸ­ï¼ˆä»ç„¶è¿˜æœ‰åœé¡¿ï¼Œå¯»æ‰¾æœ€ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨çš„è¿‡ç¨‹ä»ç„¶åœ¨ç»§ç»­ï¼‰ã€‚

ä½†æ˜¯ Serial æ”¶é›†å™¨æœ‰æ²¡æœ‰ä¼˜äºå…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„åœ°æ–¹å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå®ƒ**ç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰**ã€‚Serial æ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œè‡ªç„¶å¯ä»¥è·å¾—å¾ˆé«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚Serial æ”¶é›†å™¨å¯¹äºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ¥è¯´æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

### ParNew æ”¶é›†å™¨

ParNew æ”¶é›†å™¨å…¶å®å°±æ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’Œ Serial æ”¶é›†å™¨å®Œå…¨ä¸€æ ·ã€‚

**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![ParNew æ”¶é›†å™¨ ](https://oss.javaguide.cn/github/javaguide/java/jvm/parnew-garbage-collector.png)

å®ƒæ˜¯è®¸å¤šè¿è¡Œåœ¨ Server æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºçš„é¦–è¦é€‰æ‹©ï¼Œé™¤äº† Serial æ”¶é›†å™¨å¤–ï¼Œåªæœ‰å®ƒèƒ½ä¸ CMS æ”¶é›†å™¨ï¼ˆçœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œåé¢ä¼šä»‹ç»åˆ°ï¼‰é…åˆå·¥ä½œã€‚

**å¹¶è¡Œå’Œå¹¶å‘æ¦‚å¿µè¡¥å……ï¼š**

- **å¹¶è¡Œï¼ˆParallelï¼‰**ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚

- **å¹¶å‘ï¼ˆConcurrentï¼‰**ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆä½†ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼‰ï¼Œç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†å™¨è¿è¡Œåœ¨å¦ä¸€ä¸ª CPU ä¸Šã€‚

### Parallel Scavenge æ”¶é›†å™¨

Parallel Scavenge æ”¶é›†å™¨ä¹Ÿæ˜¯ä½¿ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•çš„å¤šçº¿ç¨‹æ”¶é›†å™¨ï¼Œå®ƒçœ‹ä¸Šå»å‡ ä¹å’Œ ParNew éƒ½ä¸€æ ·ã€‚ **é‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„å‘¢ï¼Ÿ**

```bash
-XX:+UseParallelGC

    ä½¿ç”¨ Parallel æ”¶é›†å™¨+ è€å¹´ä»£ä¸²è¡Œ

-XX:+UseParallelOldGC

    ä½¿ç”¨ Parallel æ”¶é›†å™¨+ è€å¹´ä»£å¹¶è¡Œ
```

Parallel Scavenge æ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨ CPUï¼‰ã€‚CMS ç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚æ‰€è°“ååé‡å°±æ˜¯ CPU ä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸ CPU æ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚ Parallel Scavenge æ”¶é›†å™¨æä¾›äº†å¾ˆå¤šå‚æ•°ä¾›ç”¨æˆ·æ‰¾åˆ°æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–æœ€å¤§ååé‡ï¼Œå¦‚æœå¯¹äºæ”¶é›†å™¨è¿ä½œä¸å¤ªäº†è§£ï¼Œæ‰‹å·¥ä¼˜åŒ–å­˜åœ¨å›°éš¾çš„æ—¶å€™ï¼Œä½¿ç”¨ Parallel Scavenge æ”¶é›†å™¨é…åˆè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ï¼ŒæŠŠå†…å­˜ç®¡ç†ä¼˜åŒ–äº¤ç»™è™šæ‹Ÿæœºå»å®Œæˆä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![Parallel Oldæ”¶é›†å™¨è¿è¡Œç¤ºæ„å›¾](https://oss.javaguide.cn/github/javaguide/java/jvm/parallel-scavenge-garbage-collector.png)

**è¿™æ˜¯ JDK1.8 é»˜è®¤æ”¶é›†å™¨**

ä½¿ç”¨ `java -XX:+PrintCommandLineFlags -version` å‘½ä»¤æŸ¥çœ‹

```bash
-XX:InitialHeapSize=262921408 -XX:MaxHeapSize=4206742528 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC
java version "1.8.0_211"
Java(TM) SE Runtime Environment (build 1.8.0_211-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)
```

JDK1.8 é»˜è®¤ä½¿ç”¨çš„æ˜¯ Parallel Scavenge + Parallel Oldï¼Œå¦‚æœæŒ‡å®šäº†-XX:+UseParallelGC å‚æ•°ï¼Œåˆ™é»˜è®¤æŒ‡å®šäº†-XX:+UseParallelOldGCï¼Œå¯ä»¥ä½¿ç”¨-XX:-UseParallelOldGC æ¥ç¦ç”¨è¯¥åŠŸèƒ½

### Serial Old æ”¶é›†å™¨

**Serial æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬**ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ã€‚å®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”ï¼šä¸€ç§ç”¨é€”æ˜¯åœ¨ JDK1.5 ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸ Parallel Scavenge æ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œå¦ä¸€ç§ç”¨é€”æ˜¯ä½œä¸º CMS æ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆã€‚

![Serial æ”¶é›†å™¨](https://oss.javaguide.cn/github/javaguide/java/jvm/serial-garbage-collector.png)

### Parallel Old æ”¶é›†å™¨

**Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬**ã€‚ä½¿ç”¨å¤šçº¿ç¨‹å’Œâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚åœ¨æ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge æ”¶é›†å™¨å’Œ Parallel Old æ”¶é›†å™¨ã€‚

![Parallel Oldæ”¶é›†å™¨è¿è¡Œç¤ºæ„å›¾](https://oss.javaguide.cn/github/javaguide/java/jvm/parallel-scavenge-garbage-collector.png)

### CMS æ”¶é›†å™¨

**CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ã€‚**

**CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ HotSpot è™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œã€‚**

ä»åå­—ä¸­çš„**Mark Sweep**è¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMS æ”¶é›†å™¨æ˜¯ä¸€ç§ **â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•**å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š

- **åˆå§‹æ ‡è®°ï¼š** çŸ­æš‚åœé¡¿ï¼Œæ ‡è®°ç›´æ¥ä¸ root ç›¸è¿çš„å¯¹è±¡ï¼ˆæ ¹å¯¹è±¡ï¼‰ï¼›
- **å¹¶å‘æ ‡è®°ï¼š** åŒæ—¶å¼€å¯ GC å’Œç”¨æˆ·çº¿ç¨‹ï¼Œç”¨ä¸€ä¸ªé—­åŒ…ç»“æ„å»è®°å½•å¯è¾¾å¯¹è±¡ã€‚ä½†åœ¨è¿™ä¸ªé˜¶æ®µç»“æŸï¼Œè¿™ä¸ªé—­åŒ…ç»“æ„å¹¶ä¸èƒ½ä¿è¯åŒ…å«å½“å‰æ‰€æœ‰çš„å¯è¾¾å¯¹è±¡ã€‚å› ä¸ºç”¨æˆ·çº¿ç¨‹å¯èƒ½ä¼šä¸æ–­çš„æ›´æ–°å¼•ç”¨åŸŸï¼Œæ‰€ä»¥ GC çº¿ç¨‹æ— æ³•ä¿è¯å¯è¾¾æ€§åˆ†æçš„å®æ—¶æ€§ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•é‡Œä¼šè·Ÿè¸ªè®°å½•è¿™äº›å‘ç”Ÿå¼•ç”¨æ›´æ–°çš„åœ°æ–¹ã€‚
- **Re-marking:** The re-marking phase is to correct the marking records of that part of the objects that have changed due to the continued running of the user program during concurrent marking. The pause time in this phase is generally slightly longer than the initial marking phase, and much shorter than the concurrent marking phase.
- **Concurrent cleanup:** Start the user thread, and at the same time, the GC thread starts cleaning the unmarked area.

![CMS collector](https://oss.javaguide.cn/github/javaguide/java/jvm/cms-garbage-collector.png)

As can be seen from its name, it is an excellent garbage collector. Its main advantages are: **Concurrent collection, low pause**. But it has the following three obvious shortcomings:

- **Sensitive to CPU resources;**
- **Unable to handle floating garbage;**
- **The recycling algorithm it uses - the "mark-sweep" algorithm will cause a large amount of space fragmentation to be generated at the end of the collection. **

**CMS garbage collector has been marked deprecated in Java 9 and removed in Java 14. **

### G1 Collector

**G1 (Garbage-First) is a server-oriented garbage collector, mainly targeting machines equipped with multiple processors and large-capacity memory. While meeting GC pause time requirements with a very high probability, it also has high throughput performance characteristics. **

Considered an important evolutionary feature of the HotSpot virtual machine in JDK1.7. It has the following characteristics:

- **Parallel and Concurrency**: G1 can make full use of the hardware advantages in CPU and multi-core environments and use multiple CPUs (CPUs or CPU cores) to shorten Stop-The-World pause time. Some other collectors originally need to pause the GC actions executed by the Java thread, but the G1 collector can still allow the Java program to continue executing in a concurrent manner.
- **Generational Collection**: Although G1 can manage the entire GC heap independently without the cooperation of other collectors, it still retains the concept of generational collection.
- **Spatial integration**: Different from CMS's "mark-clear" algorithm, G1 is a collector based on the "mark-sort" algorithm as a whole; locally it is based on the "mark-copy" algorithm.
- **Predictable pauses**: This is another big advantage of G1 over CMS. Reducing pause time is a common focus of G1 and CMS. However, in addition to pursuing low pauses, G1 can also establish a predictable pause time model, allowing users to clearly specify that within a time segment of length M milliseconds, the time spent on garbage collection shall not exceed N milliseconds.

The operation of the G1 collector is roughly divided into the following steps:

- **Initial Marking**: Short pause (Stop-The-World, STW), marking objects that can be directly referenced from GC Roots, that is, marking all directly reachable active objects
- **Concurrent Marking**: Run concurrently with the application and mark all reachable objects. This phase may last longer, depending on the size of the heap and the number of objects.
- **Final Marking**: Short pause (STW) to handle the small number of unprocessed reference changes remaining after the concurrent marking phase.
- **Filtering and Recycling**: Based on the marking results, select areas with high recycling value, copy surviving objects to new areas, and recycle memory in old areas. This phase contains one or more stalls (STW), depending on the complexity of the collection.

![G1 Collector](https://oss.javaguide.cn/github/javaguide/java/jvm/g1-garbage-collector.png)

**The G1 collector maintains a priority list in the background, and each time based on the allowed collection time, it gives priority to the Region with the greatest recycling value (this is the origin of its name Garbage-First)**. This method of using Region to divide memory space and prioritized area recycling ensures that the G1 collector can collect as efficiently as possible within a limited time (breaking the memory into zeros).

**Starting with JDK9, the G1 garbage collector becomes the default garbage collector. **

### ZGC Collector

Like CMS, ParNew, and G1, ZGC also uses a mark-copy algorithm, but ZGC makes significant improvements to this algorithm.

ZGC can control the pause time to within a few milliseconds, and the pause time is not affected by the heap memory size. There will be fewer Stop The World situations, but at the expense of some throughput. ZGC supports a maximum heap memory of 16TB.

ZGC was introduced in Java11 and is in the experimental stage. After multiple versions of iterations, continuous improvements and problem fixes, ZGC can be officially used in Java15.

However, the default garbage collector is still G1. You can enable ZGC with the following parameters:

```bash
java -XX:+UseZGC className
```

In Java21, generational ZGC was introduced, and the pause time can be reduced to less than 1 millisecond.

You can enable generational ZGC with the following parameters:

```bash
java -XX:+UseZGC -XX:+ZGenerational className
```

For a detailed introduction to the ZGC collector, it is recommended to read these articles:

- [Analysis of ZGC from the perspective of previous GC algorithms - JD Technology](https://mp.weixin.qq.com/s/ExkB40cq1_Z0ooDzXn7CVw)
- [Exploration and practice of the new generation garbage collector ZGC - Meituan technical team](https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html)
- [Extreme eight-part article: Detailed explanation of JVM garbage collector G1&ZGC - Alibaba Cloud Developer](https://mp.weixin.qq.com/s/Ywj3XMws0IIK-kiUllN87Q)

## Reference

- "In-depth Understanding of Java Virtual Machine: JVM Advanced Features and Best Practices (Second Edition)"
- The JavaÂ® Virtual Machine Specification - Java SE 8 Edition: <https://docs.oracle.com/javase/specs/jvms/se8/html/index.html>

<!-- @include: @article-footer.snippet.md -->