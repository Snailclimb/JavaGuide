---
title: RocketMQå¸¸è§é—®é¢˜æ€»ç»“
category: é«˜æ€§èƒ½
tag:
  - RocketMQ
  - æ¶ˆæ¯é˜Ÿåˆ—
---

> [æœ¬æ–‡ç”± FrancisQ æŠ•ç¨¿ï¼](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485969&idx=1&sn=6bd53abde30d42a778d5a35ec104428c&chksm=cea245daf9d5cccce631f93115f0c2c4a7634e55f5bef9009fd03f5a0ffa55b745b5ef4f0530&token=294077121&lang=zh_CN#rd) ç›¸æ¯”åŸæ–‡ä¸»è¦è¿›è¡Œäº†ä¸‹é¢è¿™äº›å®Œå–„ï¼š
>
> - [åˆ†æäº† RocketMQ é«˜æ€§èƒ½è¯»å†™çš„åŸå› å’Œé¡ºåºæ¶ˆè´¹çš„å…·ä½“å®ç°](https://github.com/Snailclimb/JavaGuide/pull/2133)
> - [å¢åŠ äº†æ¶ˆæ¯ç±»å‹ã€æ¶ˆè´¹è€…ç±»å‹ã€æ¶ˆè´¹è€…ç»„å’Œç”Ÿäº§è€…ç»„çš„ä»‹ç»](https://github.com/Snailclimb/JavaGuide/pull/2134)

## æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²

æ¶ˆæ¯é˜Ÿåˆ—é¡¾åæ€ä¹‰å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æˆ‘å°±ä¸è§£é‡Šäº†ï¼Œåˆ«å‘Šè¯‰æˆ‘ä½ è¿é˜Ÿåˆ—éƒ½ä¸çŸ¥é“æ˜¯å•¥å§ï¼Ÿ

æ‰€ä»¥é—®é¢˜å¹¶ä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä»€ä¹ˆï¼Œè€Œæ˜¯ **æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿç”¨å®ƒæ¥å¹²è¿™äº›äº‹ä¼šå¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ**

### æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ

æ¶ˆæ¯é˜Ÿåˆ—ç®—æ˜¯ä½œä¸ºåç«¯ç¨‹åºå‘˜çš„ä¸€ä¸ªå¿…å¤‡æŠ€èƒ½å§ï¼Œå› ä¸º**åˆ†å¸ƒå¼åº”ç”¨å¿…å®šæ¶‰åŠåˆ°å„ä¸ªç³»ç»Ÿä¹‹é—´çš„é€šä¿¡é—®é¢˜**ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿåº”è¿è€Œç”Ÿäº†ã€‚å¯ä»¥è¯´åˆ†å¸ƒå¼çš„äº§ç”Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€ï¼Œè€Œåˆ†å¸ƒå¼æ€•æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„æ¦‚å¿µäº†å§ï¼Œæ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ä¸­é—´ä»¶äº†ã€‚

### æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ

#### å¼‚æ­¥

ä½ å¯èƒ½ä¼šåé©³æˆ‘ï¼Œåº”ç”¨ä¹‹é—´çš„é€šä¿¡åˆä¸æ˜¯åªèƒ½ç”±æ¶ˆæ¯é˜Ÿåˆ—è§£å†³ï¼Œå¥½å¥½çš„é€šä¿¡ä¸ºä»€ä¹ˆä¸­é—´éè¦æ’ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘¢ï¼Ÿæˆ‘ä¸èƒ½ç›´æ¥è¿›è¡Œé€šä¿¡å—ï¼Ÿ

å¾ˆå¥½ ğŸ‘ï¼Œä½ åˆæå‡ºäº†ä¸€ä¸ªæ¦‚å¿µï¼Œ**åŒæ­¥é€šä¿¡**ã€‚å°±æ¯”å¦‚ç°åœ¨ä¸šç•Œä½¿ç”¨æ¯”è¾ƒå¤šçš„ `Dubbo` å°±æ˜¯ä¸€ä¸ªé€‚ç”¨äºå„ä¸ªç³»ç»Ÿä¹‹é—´åŒæ­¥é€šä¿¡çš„ `RPC` æ¡†æ¶ã€‚

æˆ‘æ¥ä¸¾ä¸ª ğŸŒ° å§ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªè´­ç¥¨ç³»ç»Ÿï¼Œéœ€æ±‚æ˜¯ç”¨æˆ·åœ¨è´­ä¹°å®Œä¹‹åèƒ½æ¥æ”¶åˆ°è´­ä¹°å®Œæˆçš„çŸ­ä¿¡ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef37fee7e09230.jpg)

æˆ‘ä»¬çœç•¥ä¸­é—´çš„ç½‘ç»œé€šä¿¡æ—¶é—´æ¶ˆè€—ï¼Œå‡å¦‚è´­ç¥¨ç³»ç»Ÿå¤„ç†éœ€è¦ 150ms ï¼ŒçŸ­ä¿¡ç³»ç»Ÿå¤„ç†éœ€è¦ 200ms ï¼Œé‚£ä¹ˆæ•´ä¸ªå¤„ç†æµç¨‹çš„æ—¶é—´æ¶ˆè€—å°±æ˜¯ 150ms + 200ms = 350msã€‚

å½“ç„¶ï¼Œä¹çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚å¯æ˜¯ä»”ç»†ä¸€æƒ³ä½ å°±æ„Ÿè§‰æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘ç”¨æˆ·è´­ç¥¨åœ¨è´­ç¥¨ç³»ç»Ÿçš„æ—¶å€™å…¶å®å°±å·²ç»å®Œæˆäº†è´­ä¹°ï¼Œè€Œæˆ‘ç°åœ¨é€šè¿‡åŒæ­¥è°ƒç”¨éè¦è®©æ•´ä¸ªè¯·æ±‚æ‹‰é•¿æ—¶é—´ï¼Œè€ŒçŸ­ä¿¡ç³»ç»Ÿè¿™ç©æ„åˆä¸æ˜¯å¾ˆæœ‰å¿…è¦ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½å¢å¼ºç”¨æˆ·ä½“éªŒæ„Ÿè€Œå·²ã€‚æˆ‘ç°åœ¨æ•´ä¸ªè°ƒç”¨æµç¨‹å°±æœ‰ç‚¹ **å¤´é‡è„šè½»** çš„æ„Ÿè§‰äº†ï¼Œè´­ç¥¨æ˜¯ä¸€ä¸ªä¸å¤ªè€—æ—¶çš„æµç¨‹ï¼Œè€Œæˆ‘ç°åœ¨å› ä¸ºåŒæ­¥è°ƒç”¨ï¼Œéè¦ç­‰å¾…å‘é€çŸ­ä¿¡è¿™ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ‰è¿”å›ç»“æœã€‚é‚£æˆ‘å¦‚æœå†åŠ ä¸€ä¸ªå‘é€é‚®ä»¶å‘¢ï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef380429cf373e.jpg)

è¿™æ ·æ•´ä¸ªç³»ç»Ÿçš„è°ƒç”¨é“¾åˆå˜é•¿äº†ï¼Œæ•´ä¸ªæ—¶é—´å°±å˜æˆäº† 550msã€‚

å½“æˆ‘ä»¬åœ¨å­¦ç”Ÿæ—¶ä»£éœ€è¦åœ¨é£Ÿå ‚æ’é˜Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å’Œé£Ÿå ‚å¤§å¦ˆå°±æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ¨¡å‹ã€‚

æˆ‘ä»¬éœ€è¦å‘Šè¯‰é£Ÿå ‚å¤§å¦ˆï¼šâ€œå§å§ï¼Œç»™æˆ‘åŠ ä¸ªé¸¡è…¿ï¼Œå†åŠ ä¸ªé…¸è¾£åœŸè±†ä¸ï¼Œå¸®æˆ‘æµ‡ç‚¹æ±ä¸Šå»ï¼Œå¤šæ‰“ç‚¹é¥­å“¦ ğŸ˜‹ğŸ˜‹ğŸ˜‹â€ å’¦~~~ ä¸ºäº†å¤šåƒç‚¹ï¼ŒçœŸæ¶å¿ƒã€‚

ç„¶åå¤§å¦ˆå¸®æˆ‘ä»¬æ‰“é¥­é…èœï¼Œæˆ‘ä»¬çœ‹ç€å¤§å¦ˆé‚£é¢¤æŠ–çš„æ‰‹å’Œæ‰è½çš„åœŸè±†ä¸ä¸ç¦å’½äº†å’½å£æ°´ã€‚

æœ€ç»ˆæˆ‘ä»¬ä»å¤§å¦ˆæ‰‹ä¸­æ¥è¿‡é¥­èœç„¶åå»å¯»æ‰¾åº§ä½äº†...

å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ç»™å¤§å¦ˆå‘é€éœ€è¦çš„ä¿¡æ¯ä¹‹åæˆ‘ä»¬æ˜¯ **åŒæ­¥ç­‰å¾…å¤§å¦ˆç»™æˆ‘é…å¥½é¥­èœ** çš„ï¼Œä¸Šé¢æˆ‘ä»¬åªæ˜¯åŠ äº†é¸¡è…¿å’ŒåœŸè±†ä¸ï¼Œä¸‡ä¸€æˆ‘å†åŠ ä¸€ä¸ªç•ªèŒ„ç‰›è…©ï¼ŒéŸ­èœé¸¡è›‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¤§å¦ˆæ‰“é¥­é…èœçš„æµç¨‹å°±ä¼šå˜é•¿ï¼Œæˆ‘ä»¬ç­‰å¾…çš„æ—¶é—´ä¹Ÿä¼šç›¸åº”çš„å˜é•¿ã€‚

é‚£åæ¥ï¼Œæˆ‘ä»¬å·¥ä½œèµšé’±äº†æœ‰é’±å»é¥­åº—åƒé¥­äº†ï¼Œæˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æ¥ä¸€ç¢—ç‰›è‚‰é¢åŠ ä¸ªè·åŒ…è›‹ **(ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯)** ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨é¥­æ¡Œä¸Šå®‰å¿ƒçš„ç©æ‰‹æœºäº† **(å¹²è‡ªå·±å…¶ä»–äº‹æƒ…)** ï¼Œç­‰åˆ°æˆ‘ä»¬çš„ç‰›è‚‰é¢ä¸Šäº†æˆ‘ä»¬å°±å¯ä»¥åƒäº†ã€‚è¿™å…¶ä¸­æˆ‘ä»¬ä¹Ÿå°±ä¼ è¾¾äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬åˆè½¬è¿‡å¤´å¹²å…¶ä»–äº‹æƒ…äº†ã€‚è¿™å…¶ä¸­è™½ç„¶åšé¢çš„æ—¶é—´æ²¡æœ‰å˜çŸ­ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯å°±å¯ä»¥å¹²å…¶ä»–äº‹æƒ…äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª **å¼‚æ­¥** çš„æ¦‚å¿µã€‚

æ‰€ä»¥ï¼Œä¸ºäº†è§£å†³è¿™ä¸€ä¸ªé—®é¢˜ï¼Œèªæ˜çš„ç¨‹åºå‘˜åœ¨ä¸­é—´ä¹ŸåŠ äº†ä¸ªç±»ä¼¼äºæœåŠ¡å‘˜çš„ä¸­é—´ä»¶â€”â€”æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ¨¡å‹ç»™æ”¹é€ äº†ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef38124f55eaea.jpg)

è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿”å›äº†(æˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æˆ‘ä»¬è¦åƒä»€ä¹ˆç„¶åç©æ‰‹æœº)ï¼Œæ‰€ä»¥æ•´ä¸ªè€—æ—¶åªæ˜¯ 150ms + 10ms = 160msã€‚

> ä½†æ˜¯ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•´ä¸ªæµç¨‹çš„æ—¶é•¿æ˜¯æ²¡å˜çš„ï¼Œå°±åƒä½ ä»…ä»…å‘Šè¯‰æœåŠ¡å‘˜è¦åƒä»€ä¹ˆæ˜¯ä¸ä¼šå½±å“åˆ°åšé¢çš„é€Ÿåº¦çš„ã€‚

#### è§£è€¦

å›åˆ°æœ€åˆåŒæ­¥è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†™ä¸ªä¼ªä»£ç ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef381a505d3e1f.jpg)

é‚£ä¹ˆç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åˆæ·»åŠ äº†ä¸€ä¸ªå‘é€é‚®ä»¶ï¼Œæˆ‘ä»¬å°±å¾—é‡æ–°å»ä¿®æ”¹ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬åˆåŠ ä¸€ä¸ªéœ€æ±‚ï¼šç”¨æˆ·è´­ä¹°å®Œè¿˜éœ€è¦ç»™ä»–åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef381c4e1b1ac7.jpg)

å¦‚æœä½ è§‰å¾—è¿˜è¡Œï¼Œé‚£ä¹ˆæˆ‘è¿™ä¸ªæ—¶å€™ä¸è¦å‘é‚®ä»¶è¿™ä¸ªæœåŠ¡äº†å‘¢ï¼Œæˆ‘æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Œåˆå¾—é‡å¯åº”ç”¨ï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef381f273a66bd.jpg)

è¿™æ ·æ”¹æ¥æ”¹å»æ˜¯ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆ **æ­¤æ—¶æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åœ¨ä¸­é—´è¿›è¡Œè§£è€¦** ã€‚ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åé¢çš„å‘é€çŸ­ä¿¡ã€å‘é€é‚®ä»¶ã€æ·»åŠ ç§¯åˆ†ç­‰ä¸€äº›æ“ä½œéƒ½ä¾èµ–äºä¸Šé¢çš„ `result` ï¼Œè¿™ä¸œè¥¿æŠ½è±¡å‡ºæ¥å°±æ˜¯è´­ç¥¨çš„å¤„ç†ç»“æœå‘€ï¼Œæ¯”å¦‚è®¢å•å·ï¼Œç”¨æˆ·è´¦å·ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åé¢çš„ä¸€ç³»åˆ—æœåŠ¡éƒ½æ˜¯éœ€è¦åŒæ ·çš„æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†ã€‚æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡ **â€œå¹¿æ’­æ¶ˆæ¯â€** æ¥å®ç°ã€‚

æˆ‘ä¸Šé¢æ‰€è®²çš„â€œå¹¿æ’­â€å¹¶ä¸æ˜¯çœŸæ­£çš„å¹¿æ’­ï¼Œè€Œæ˜¯æ¥ä¸‹æ¥çš„ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…å» **è®¢é˜…** ç‰¹å®šçš„ä¸»é¢˜ã€‚æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ä¸»é¢˜å°±å¯ä»¥å«åš `è®¢ç¥¨` ï¼Œæˆ‘ä»¬è´­ä¹°ç³»ç»Ÿä½œä¸ºä¸€ä¸ªç”Ÿäº§è€…å»ç”Ÿäº§è¿™æ¡æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åæ¶ˆè´¹è€…è®¢é˜…äº†è¿™ä¸ªä¸»é¢˜ï¼Œä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚å°±æ¯”å¦‚æˆ‘ä»¬åˆšåˆšç”»çš„é‚£å¼ å›¾ï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨ç”Ÿäº§è€…è¿™è¾¹æˆ‘ä»¬åªéœ€è¦å…³æ³¨ **ç”Ÿäº§æ¶ˆæ¯åˆ°æŒ‡å®šä¸»é¢˜ä¸­** ï¼Œè€Œ **æ¶ˆè´¹è€…åªéœ€è¦å…³æ³¨ä»æŒ‡å®šä¸»é¢˜ä¸­æ‹‰å–æ¶ˆæ¯** å°±è¡Œäº†ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef382674b66892.jpg)

> å¦‚æœæ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯å½“ä¸€ä¸ªæ–°çš„ä¸šåŠ¡æ¥å…¥ï¼Œæˆ‘ä»¬éƒ½è¦åœ¨ä¸»ç³»ç»Ÿè°ƒç”¨æ–°æ¥å£ã€æˆ–è€…å½“æˆ‘ä»¬å–æ¶ˆæŸäº›ä¸šåŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—åœ¨ä¸»ç³»ç»Ÿåˆ é™¤æŸäº›æ¥å£è°ƒç”¨ã€‚æœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦é€è¾¾äº†é˜Ÿåˆ—ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…ï¼Œæ¥ä¸‹æ¥æ”¶åˆ°æ¶ˆæ¯å¦‚ä½•å¤„ç†ï¼Œæ˜¯ä¸‹æ¸¸çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚

#### å‰Šå³°

æˆ‘ä»¬å†æ¬¡å›åˆ°ä¸€å¼€å§‹æˆ‘ä»¬ä½¿ç”¨åŒæ­¥è°ƒç”¨ç³»ç»Ÿçš„æƒ…å†µï¼Œå¹¶ä¸”æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡ç”¨æˆ·è¯·æ±‚è´­ç¥¨æ•´ä¸ªç³»ç»Ÿä¼šå˜æˆä»€ä¹ˆæ ·ï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef382a9756bb1c.jpg)

å¦‚æœï¼Œæ­¤æ—¶æœ‰ä¸€ä¸‡çš„è¯·æ±‚è¿›å…¥è´­ç¥¨ç³»ç»Ÿï¼Œæˆ‘ä»¬çŸ¥é“è¿è¡Œæˆ‘ä»¬ä¸»ä¸šåŠ¡çš„æœåŠ¡å™¨é…ç½®ä¸€èˆ¬ä¼šæ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å‡è®¾è´­ç¥¨ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬åŒæ—¶ä¹Ÿä¼šå‡ºç°ä¸€ä¸‡è°ƒç”¨å‘çŸ­ä¿¡æœåŠ¡çš„è¯·æ±‚ã€‚è€Œå¯¹äºçŸ­ä¿¡ç³»ç»Ÿæ¥è¯´å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ä¸»è¦ä¸šåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é…å¤‡çš„ç¡¬ä»¶èµ„æºå¹¶ä¸ä¼šå¤ªé«˜ï¼Œé‚£ä¹ˆä½ è§‰å¾—ç°åœ¨è¿™ä¸ªçŸ­ä¿¡ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„å³°å€¼ä¹ˆï¼Œä¸”ä¸è¯´èƒ½ä¸èƒ½æ‰¿å—ï¼Œç³»ç»Ÿä¼šä¸ä¼š **ç›´æ¥å´©æºƒ** äº†ï¼Ÿ

çŸ­ä¿¡ä¸šåŠ¡åˆä¸æ˜¯æˆ‘ä»¬çš„ä¸»ä¸šåŠ¡ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ **æŠ˜ä¸­å¤„ç†** å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬æŠŠè´­ä¹°å®Œæˆçš„ä¿¡æ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè€ŒçŸ­ä¿¡ç³»ç»Ÿ **å°½è‡ªå·±æ‰€èƒ½åœ°å»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯** ï¼Œå³ä½¿å¤„ç†é€Ÿåº¦æ…¢ä¸€ç‚¹ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦æˆ‘ä»¬çš„ç³»ç»Ÿæ²¡æœ‰å´©æºƒå°±è¡Œäº†ã€‚

ç•™å¾—æ±Ÿå±±åœ¨ï¼Œè¿˜æ€•æ²¡æŸ´çƒ§ï¼Ÿä½ æ•¢è¯´æ¯æ¬¡å‘é€éªŒè¯ç çš„æ—¶å€™æ˜¯ä¸€å‘ä½ å°±æ”¶åˆ°äº†çš„ä¹ˆï¼Ÿ

#### æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ

å…¶å®ä¸Šé¢æˆ‘å·²ç»è¯´äº†ã€‚**å¼‚æ­¥ã€è§£è€¦ã€å‰Šå³°ã€‚** å“ªæ€•ä½ ä¸Šé¢çš„éƒ½æ²¡çœ‹æ‡‚ä¹Ÿåƒä¸‡è¦è®°ä½è¿™å…­ä¸ªå­—ï¼Œå› ä¸ºä»–ä¸ä»…æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ç²¾åï¼Œæ›´æ˜¯ç¼–ç¨‹å’Œæ¶æ„çš„ç²¾åã€‚

#### æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ

æ²¡æœ‰å“ªä¸€é—¨æŠ€æœ¯æ˜¯â€œé“¶å¼¹â€ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæœ‰å®ƒçš„å‰¯ä½œç”¨ã€‚

æ¯”å¦‚ï¼Œæœ¬æ¥å¥½å¥½çš„ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„è°ƒç”¨ï¼Œæˆ‘ä¸­é—´åŠ äº†ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†æ€ä¹ˆåŠå‘¢ï¼Ÿæ˜¯ä¸æ˜¯ **é™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§** ï¼Ÿ

é‚£è¿™æ ·æ˜¯ä¸æ˜¯è¦ä¿è¯ HA(é«˜å¯ç”¨)ï¼Ÿæ˜¯ä¸æ˜¯è¦æé›†ç¾¤ï¼Ÿé‚£ä¹ˆæˆ‘ **æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚åº¦æ˜¯ä¸æ˜¯ä¸Šå‡äº†** ï¼Ÿ

æŠ›å¼€ä¸Šé¢çš„é—®é¢˜ä¸è®²ï¼Œä¸‡ä¸€æˆ‘å‘é€æ–¹å‘é€å¤±è´¥äº†ï¼Œç„¶åæ‰§è¡Œé‡è¯•ï¼Œè¿™æ ·å°±å¯èƒ½äº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚

æˆ–è€…æˆ‘æ¶ˆè´¹ç«¯å¤„ç†å¤±è´¥äº†ï¼Œè¯·æ±‚é‡å‘ï¼Œè¿™æ ·ä¹Ÿä¼šäº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚

å¯¹äºä¸€äº›å¾®æœåŠ¡æ¥è¯´ï¼Œæ¶ˆè´¹é‡å¤æ¶ˆæ¯ä¼šå¸¦æ¥æ›´å¤§çš„éº»çƒ¦ï¼Œæ¯”å¦‚å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘åŠ äº†å¤šæ¬¡æ˜¯ä¸æ˜¯å¯¹å…¶ä»–ç”¨æˆ·ä¸å…¬å¹³ï¼Ÿ

é‚£ä¹ˆï¼Œåˆ **å¦‚ä½•è§£å†³é‡å¤æ¶ˆè´¹æ¶ˆæ¯çš„é—®é¢˜** å‘¢ï¼Ÿ

å¦‚æœæˆ‘ä»¬æ­¤æ—¶çš„æ¶ˆæ¯éœ€è¦ä¿è¯ä¸¥æ ¼çš„é¡ºåºæ€§æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ç³»åˆ—çš„æœ‰åºæ¶ˆæ¯(å¯¹ä¸€ä¸ª id ä¸º 1 çš„è®°å½•è¿›è¡Œåˆ é™¤å¢åŠ ä¿®æ”¹)ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­ï¼Œå¯¹äºä¸»é¢˜æ˜¯æ— é¡ºåºçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¼è‡´å¯¹äºæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æ²¡æœ‰æŒ‰ç…§ç”Ÿäº§è€…çš„å‘é€é¡ºåºæ¶ˆè´¹ï¼Œæ¯”å¦‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ¶ˆè´¹çš„é¡ºåºä¸ºä¿®æ”¹åˆ é™¤å¢åŠ ï¼Œå¦‚æœè¯¥è®°å½•æ¶‰åŠåˆ°é‡‘é¢çš„è¯æ˜¯ä¸æ˜¯ä¼šå‡ºå¤§äº‹æƒ…ï¼Ÿ

é‚£ä¹ˆï¼Œåˆ **å¦‚ä½•è§£å†³æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹é—®é¢˜** å‘¢ï¼Ÿ

å°±æ‹¿æˆ‘ä»¬ä¸Šé¢æ‰€è®²çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œç”¨æˆ·è´­ç¥¨å®Œæˆä¹‹åæ˜¯ä¸æ˜¯éœ€è¦å¢åŠ è´¦æˆ·ç§¯åˆ†ï¼Ÿåœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨äº‹åŠ¡æ¥è¿›è¡Œè§£å†³ï¼Œå¦‚æœç”¨ `Spring` çš„è¯æˆ‘ä»¬åœ¨ä¸Šé¢ä¼ªä»£ç ä¸­åŠ å…¥ `@Transactional` æ³¨è§£å°±å¥½äº†ã€‚ä½†æ˜¯åœ¨ä¸åŒç³»ç»Ÿä¸­å¦‚ä½•ä¿è¯äº‹åŠ¡å‘¢ï¼Ÿæ€»ä¸èƒ½è¿™ä¸ªç³»ç»Ÿæˆ‘æ‰£é’±æˆåŠŸäº†ä½ é‚£ç§¯åˆ†ç³»ç»Ÿç§¯åˆ†æ²¡åŠ å§ï¼Ÿæˆ–è€…è¯´æˆ‘è¿™æ‰£é’±æ˜æ˜å¤±è´¥äº†ï¼Œä½ é‚£ç§¯åˆ†ç³»ç»Ÿç»™æˆ‘åŠ äº†ç§¯åˆ†ã€‚

é‚£ä¹ˆï¼Œåˆå¦‚ä½• **è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜** å‘¢ï¼Ÿ

æˆ‘ä»¬åˆšåˆšè¯´äº†ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è¿›è¡Œå‰Šå³°æ“ä½œï¼Œé‚£å¦‚æœæˆ‘çš„æ¶ˆè´¹è€…å¦‚æœæ¶ˆè´¹å¾ˆæ…¢æˆ–è€…ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å¾ˆå¿«ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šå°†æ¶ˆæ¯å †ç§¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Ÿ

é‚£ä¹ˆï¼Œåˆå¦‚ä½• **è§£å†³æ¶ˆæ¯å †ç§¯çš„é—®é¢˜** å‘¢ï¼Ÿ

å¯ç”¨æ€§é™ä½ï¼Œå¤æ‚åº¦ä¸Šå‡ï¼Œåˆå¸¦æ¥ä¸€ç³»åˆ—çš„é‡å¤æ¶ˆè´¹ï¼Œé¡ºåºæ¶ˆè´¹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ¶ˆæ¯å †ç§¯çš„é—®é¢˜ï¼Œè¿™æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ€ä¹ˆç”¨å•Š ğŸ˜µï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef382d709abc9d.png)

åˆ«æ€¥ï¼ŒåŠæ³•æ€»æ˜¯æœ‰çš„ã€‚

## RocketMQ æ˜¯ä»€ä¹ˆï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef383014430799.jpg)

å“‡ï¼Œä½ ä¸ªæ··è›‹ï¼ä¸Šé¢ç»™æˆ‘æŠ›å‡ºé‚£ä¹ˆå¤šé—®é¢˜ï¼Œä½ ç°åœ¨åˆè®² `RocketMQ` ï¼Œè¿˜è®©ä¸è®©äººæ´»äº†ï¼Ÿï¼ğŸ¤¬

åˆ«æ€¥åˆ«æ€¥ï¼Œè¯è¯´ä½ ç°åœ¨æ¸…æ¥š `MQ` çš„æ„é€ å—ï¼Œæˆ‘è¿˜æ²¡è®²å‘¢ï¼Œæˆ‘ä»¬å…ˆææ˜ç™½ `MQ` çš„å†…éƒ¨æ„é€ ï¼Œå†æ¥çœ‹çœ‹å¦‚ä½•è§£å†³ä¸Šé¢çš„ä¸€ç³»åˆ—é—®é¢˜å§ï¼Œä¸è¿‡ä½ æœ€å¥½å¸¦ç€é—®é¢˜å»é˜…è¯»å’Œäº†è§£å–”ã€‚

`RocketMQ` æ˜¯ä¸€ä¸ª **é˜Ÿåˆ—æ¨¡å‹** çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå…·æœ‰**é«˜æ€§èƒ½ã€é«˜å¯é ã€é«˜å®æ—¶ã€åˆ†å¸ƒå¼** çš„ç‰¹ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé‡‡ç”¨ `Java` è¯­è¨€å¼€å‘çš„åˆ†å¸ƒå¼çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œç”±é˜¿é‡Œå·´å·´å›¢é˜Ÿå¼€å‘ï¼Œåœ¨ 2016 å¹´åº•è´¡çŒ®ç»™ `Apache`ï¼Œæˆä¸ºäº† `Apache` çš„ä¸€ä¸ªé¡¶çº§é¡¹ç›®ã€‚ åœ¨é˜¿é‡Œå†…éƒ¨ï¼Œ`RocketMQ` å¾ˆå¥½åœ°æœåŠ¡äº†é›†å›¢å¤§å¤§å°å°ä¸Šåƒä¸ªåº”ç”¨ï¼Œåœ¨æ¯å¹´çš„åŒåä¸€å½“å¤©ï¼Œæ›´æœ‰ä¸å¯æ€è®®çš„ä¸‡äº¿çº§æ¶ˆæ¯é€šè¿‡ `RocketMQ` æµè½¬ã€‚

åºŸè¯ä¸å¤šè¯´ï¼Œæƒ³è¦äº†è§£ `RocketMQ` å†å²çš„åŒå­¦å¯ä»¥è‡ªå·±å»æœå¯»èµ„æ–™ã€‚å¬å®Œä¸Šé¢çš„ä»‹ç»ï¼Œä½ åªè¦çŸ¥é“ `RocketMQ` å¾ˆå¿«ã€å¾ˆç‰›ã€è€Œä¸”ç»å†è¿‡åŒåä¸€çš„å®è·µå°±è¡Œäº†ï¼

## é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨è°ˆ `RocketMQ` çš„æŠ€æœ¯æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸¤ä¸ªåè¯æ¦‚å¿µâ€”â€”**é˜Ÿåˆ—æ¨¡å‹** å’Œ **ä¸»é¢˜æ¨¡å‹** ã€‚

é¦–å…ˆæˆ‘é—®ä¸€ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆè¦å«æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

ä½ å¯èƒ½è§‰å¾—å¾ˆå¼±æ™ºï¼Œè¿™ç©æ„ä¸å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—å˜›ï¼Ÿä¸å«æ¶ˆæ¯é˜Ÿåˆ—å«ä»€ä¹ˆï¼Ÿ

çš„ç¡®ï¼Œæ—©æœŸçš„æ¶ˆæ¯ä¸­é—´ä»¶æ˜¯é€šè¿‡ **é˜Ÿåˆ—** è¿™ä¸€æ¨¡å‹æ¥å®ç°çš„ï¼Œå¯èƒ½æ˜¯å†å²åŸå› ï¼Œæˆ‘ä»¬éƒ½ä¹ æƒ¯æŠŠæ¶ˆæ¯ä¸­é—´ä»¶æˆä¸ºæ¶ˆæ¯é˜Ÿåˆ—ã€‚

ä½†æ˜¯ï¼Œå¦‚ä»Šä¾‹å¦‚ `RocketMQ`ã€`Kafka` è¿™äº›ä¼˜ç§€çš„æ¶ˆæ¯ä¸­é—´ä»¶ä¸ä»…ä»…æ˜¯é€šè¿‡ä¸€ä¸ª **é˜Ÿåˆ—** æ¥å®ç°æ¶ˆæ¯å­˜å‚¨çš„ã€‚

### é˜Ÿåˆ—æ¨¡å‹

å°±åƒæˆ‘ä»¬ç†è§£é˜Ÿåˆ—ä¸€æ ·ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶çš„é˜Ÿåˆ—æ¨¡å‹å°±çœŸçš„åªæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ã€‚ã€‚ã€‚æˆ‘ç”»ä¸€å¼ å›¾ç»™å¤§å®¶ç†è§£ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3834ae653469.jpg)

åœ¨ä¸€å¼€å§‹æˆ‘è·Ÿä½ æåˆ°äº†ä¸€ä¸ª **â€œå¹¿æ’­â€** çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªæ¶ˆæ¯å‘é€ç»™å¤šä¸ªæ¶ˆè´¹è€…(æ¯”å¦‚æ­¤æ—¶æˆ‘éœ€è¦å°†ä¿¡æ¯å‘é€ç»™çŸ­ä¿¡ç³»ç»Ÿå’Œé‚®ä»¶ç³»ç»Ÿ)ï¼Œè¿™ä¸ªæ—¶å€™å•ä¸ªé˜Ÿåˆ—å³ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚

å½“ç„¶ä½ å¯ä»¥è®© `Producer` ç”Ÿäº§æ¶ˆæ¯æ”¾å…¥å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæ¯ä¸ªé˜Ÿåˆ—å»å¯¹åº”æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚é—®é¢˜æ˜¯å¯ä»¥è§£å†³ï¼Œåˆ›å»ºå¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”å¤åˆ¶å¤šä»½æ¶ˆæ¯æ˜¯ä¼šå¾ˆå½±å“èµ„æºå’Œæ€§èƒ½çš„ã€‚è€Œä¸”ï¼Œè¿™æ ·å­å°±ä¼šå¯¼è‡´ç”Ÿäº§è€…éœ€è¦çŸ¥é“å…·ä½“æ¶ˆè´¹è€…ä¸ªæ•°ç„¶åå»å¤åˆ¶å¯¹åº”æ•°é‡çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™å°±è¿èƒŒæˆ‘ä»¬æ¶ˆæ¯ä¸­é—´ä»¶çš„ **è§£è€¦** è¿™ä¸€åŸåˆ™ã€‚

### ä¸»é¢˜æ¨¡å‹

é‚£ä¹ˆæœ‰æ²¡æœ‰å¥½çš„æ–¹æ³•å»è§£å†³è¿™ä¸€ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰ï¼Œé‚£å°±æ˜¯ **ä¸»é¢˜æ¨¡å‹** æˆ–è€…å¯ä»¥ç§°ä¸º **å‘å¸ƒè®¢é˜…æ¨¡å‹** ã€‚

> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸€ä¸‹è®¾è®¡æ¨¡å¼é‡Œé¢çš„è§‚å¯Ÿè€…æ¨¡å¼å¹¶ä¸”æ‰‹åŠ¨å®ç°ä¸€ä¸‹ï¼Œæˆ‘ç›¸ä¿¡ä½ ä¼šæœ‰æ‰€æ”¶è·çš„ã€‚

åœ¨ä¸»é¢˜æ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…ç§°ä¸º **å‘å¸ƒè€…(Publisher)** ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…ç§°ä¸º **è®¢é˜…è€…(Subscriber)** ï¼Œå­˜æ”¾æ¶ˆæ¯çš„å®¹å™¨ç§°ä¸º **ä¸»é¢˜(Topic)** ã€‚

å…¶ä¸­ï¼Œå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šä¸»é¢˜ä¸­ï¼Œè®¢é˜…è€…éœ€è¦ **æå‰è®¢é˜…ä¸»é¢˜** æ‰èƒ½æ¥å—ç‰¹å®šä¸»é¢˜çš„æ¶ˆæ¯ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3837887d9a54sds.jpg)

### RocketMQ ä¸­çš„æ¶ˆæ¯æ¨¡å‹

`RocketMQ` ä¸­çš„æ¶ˆæ¯æ¨¡å‹å°±æ˜¯æŒ‰ç…§ **ä¸»é¢˜æ¨¡å‹** æ‰€å®ç°çš„ã€‚ä½ å¯èƒ½ä¼šå¥½å¥‡è¿™ä¸ª **ä¸»é¢˜** åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä½ ä¸Šé¢ä¹Ÿæ²¡æœ‰è®²åˆ°å‘€ï¼

å…¶å®å¯¹äºä¸»é¢˜æ¨¡å‹çš„å®ç°æ¥è¯´æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶çš„åº•å±‚è®¾è®¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°±æ¯”å¦‚ `Kafka` ä¸­çš„ **åˆ†åŒº** ï¼Œ`RocketMQ` ä¸­çš„ **é˜Ÿåˆ—** ï¼Œ`RabbitMQ` ä¸­çš„ `Exchange` ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º **ä¸»é¢˜æ¨¡å‹/å‘å¸ƒè®¢é˜…æ¨¡å‹** å°±æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œé‚£äº›ä¸­é—´ä»¶åªä¸è¿‡ç…§ç€è¿™ä¸ªæ ‡å‡†å»å®ç°è€Œå·²ã€‚

æ‰€ä»¥ï¼Œ`RocketMQ` ä¸­çš„ **ä¸»é¢˜æ¨¡å‹** åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ç”»ä¸€å¼ å›¾ï¼Œå¤§å®¶å°è¯•ç€å»ç†è§£ä¸€ä¸‹ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef383d3e8c9788.jpg)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ•´ä¸ªå›¾ä¸­æœ‰ `Producer Group`ã€`Topic`ã€`Consumer Group` ä¸‰ä¸ªè§’è‰²ï¼Œæˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ä»–ä»¬ã€‚

- `Producer Group` ç”Ÿäº§è€…ç»„ï¼šä»£è¡¨æŸä¸€ç±»çš„ç”Ÿäº§è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªç§’æ€ç³»ç»Ÿä½œä¸ºç”Ÿäº§è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª `Producer Group` ç”Ÿäº§è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬ç”Ÿäº§ç›¸åŒçš„æ¶ˆæ¯ã€‚
- `Consumer Group` æ¶ˆè´¹è€…ç»„ï¼šä»£è¡¨æŸä¸€ç±»çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªçŸ­ä¿¡ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª `Consumer Group` æ¶ˆè´¹è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬æ¶ˆè´¹ç›¸åŒçš„æ¶ˆæ¯ã€‚
- `Topic` ä¸»é¢˜ï¼šä»£è¡¨ä¸€ç±»æ¶ˆæ¯ï¼Œæ¯”å¦‚è®¢å•æ¶ˆæ¯ï¼Œç‰©æµæ¶ˆæ¯ç­‰ç­‰ã€‚

ä½ å¯ä»¥çœ‹åˆ°å›¾ä¸­ç”Ÿäº§è€…ç»„ä¸­çš„ç”Ÿäº§è€…ä¼šå‘ä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œè€Œ **ä¸»é¢˜ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—**ï¼Œç”Ÿäº§è€…æ¯æ¬¡ç”Ÿäº§æ¶ˆæ¯ä¹‹åæ˜¯æŒ‡å®šä¸»é¢˜ä¸­çš„æŸä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„ã€‚

æ¯ä¸ªä¸»é¢˜ä¸­éƒ½æœ‰å¤šä¸ªé˜Ÿåˆ—(åˆ†å¸ƒåœ¨ä¸åŒçš„ `Broker`ä¸­ï¼Œå¦‚æœæ˜¯é›†ç¾¤çš„è¯ï¼Œ`Broker`åˆåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸­)ï¼Œé›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…é›†ç¾¤å¤šå°æœºå™¨å…±åŒæ¶ˆè´¹ä¸€ä¸ª `topic` çš„å¤šä¸ªé˜Ÿåˆ—ï¼Œ**ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹**ã€‚å¦‚æœæŸä¸ªæ¶ˆè´¹è€…æŒ‚æ‰ï¼Œåˆ†ç»„å†…å…¶å®ƒæ¶ˆè´¹è€…ä¼šæ¥æ›¿æŒ‚æ‰çš„æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹ã€‚å°±åƒä¸Šå›¾ä¸­ `Consumer1` å’Œ `Consumer2` åˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œè€Œ `Consumer3` æ˜¯æ²¡æœ‰é˜Ÿåˆ—å¯¹åº”çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²è¦æ§åˆ¶ **æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ä¸ªæ•°å’Œä¸»é¢˜ä¸­é˜Ÿåˆ—ä¸ªæ•°ç›¸åŒ** ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥æ¶ˆè´¹è€…ä¸ªæ•°å°äºé˜Ÿåˆ—ä¸ªæ•°ï¼Œåªä¸è¿‡ä¸å¤ªå»ºè®®ã€‚å¦‚ä¸‹å›¾ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3850c808d707.jpg)

**æ¯ä¸ªæ¶ˆè´¹ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸Šç»´æŠ¤ä¸€ä¸ªæ¶ˆè´¹ä½ç½®** ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºæˆ‘ä»¬åˆšåˆšç”»çš„ä»…ä»…æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ä¸€èˆ¬ä¼šæ¶‰åŠåˆ°å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè€Œæ¯ä¸ªæ¶ˆè´¹è€…ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆè´¹ä½ç½®éƒ½æ˜¯ä¸åŒçš„ã€‚å¦‚æœæ­¤æ—¶æœ‰å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆæ¶ˆæ¯è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¹‹åæ˜¯ä¸ä¼šåˆ é™¤çš„(å› ä¸ºå…¶å®ƒæ¶ˆè´¹è€…ç»„ä¹Ÿéœ€è¦å‘€)ï¼Œå®ƒä»…ä»…æ˜¯ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…ç»„ç»´æŠ¤ä¸€ä¸ª **æ¶ˆè´¹ä½ç§»(offset)** ï¼Œæ¯æ¬¡æ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œç„¶åé˜Ÿåˆ—å†æŠŠç»´æŠ¤çš„æ¶ˆè´¹ä½ç§»åŠ ä¸€ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°åˆšåˆšæ¶ˆè´¹è¿‡çš„æ¶ˆæ¯å†ä¸€æ¬¡è¢«æ¶ˆè´¹äº†ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3857fefaa079.jpg)

å¯èƒ½ä½ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ**ä¸ºä»€ä¹ˆä¸€ä¸ªä¸»é¢˜ä¸­éœ€è¦ç»´æŠ¤å¤šä¸ªé˜Ÿåˆ—** ï¼Ÿ

ç­”æ¡ˆæ˜¯ **æé«˜å¹¶å‘èƒ½åŠ›** ã€‚çš„ç¡®ï¼Œæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä½ æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­ä¹Ÿç»´æŠ¤ç€æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥åšåˆ° **å‘å¸ƒè®¢é˜…æ¨¡å¼** ã€‚å¦‚ä¸‹å›¾ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef38600cdb6d4b.jpg)

ä½†æ˜¯ï¼Œè¿™æ ·æˆ‘ç”Ÿäº§è€…æ˜¯ä¸æ˜¯åªèƒ½å‘ä¸€ä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Ÿåˆå› ä¸ºéœ€è¦ç»´æŠ¤æ¶ˆè´¹ä½ç½®æ‰€ä»¥ä¸€ä¸ªé˜Ÿåˆ—åªèƒ½å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å…¶ä»–çš„ `Consumer` å°±æ²¡æœ‰ç”¨æ­¦ä¹‹åœ°äº†ï¼Ÿä»è¿™ä¸¤ä¸ªè§’åº¦æ¥è®²ï¼Œå¹¶å‘åº¦ä¸€ä¸‹å­å°±å°äº†å¾ˆå¤šã€‚

æ‰€ä»¥æ€»ç»“æ¥è¯´ï¼Œ`RocketMQ` é€šè¿‡**ä½¿ç”¨åœ¨ä¸€ä¸ª `Topic` ä¸­é…ç½®å¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”æ¯ä¸ªé˜Ÿåˆ—ç»´æŠ¤æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®** å®ç°äº† **ä¸»é¢˜æ¨¡å¼/å‘å¸ƒè®¢é˜…æ¨¡å¼** ã€‚

## RocketMQ çš„æ¶æ„å›¾

è®²å®Œäº†æ¶ˆæ¯æ¨¡å‹ï¼Œæˆ‘ä»¬ç†è§£èµ· `RocketMQ` çš„æŠ€æœ¯æ¶æ„èµ·æ¥å°±å®¹æ˜“å¤šäº†ã€‚

`RocketMQ` æŠ€æœ¯æ¶æ„ä¸­æœ‰å››å¤§è§’è‰² `NameServer`ã€`Broker`ã€`Producer`ã€`Consumer` ã€‚æˆ‘æ¥å‘å¤§å®¶åˆ†åˆ«è§£é‡Šä¸€ä¸‹è¿™å››ä¸ªè§’è‰²æ˜¯å¹²å•¥çš„ã€‚

- `Broker`ï¼šä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å˜›ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯åˆ° `Broker` ï¼Œæ¶ˆè´¹è€…ä» `Broker` æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚

  è¿™é‡Œï¼Œæˆ‘è¿˜å¾—æ™®åŠä¸€ä¸‹å…³äº `Broker`ã€`Topic` å’Œ é˜Ÿåˆ—çš„å…³ç³»ã€‚ä¸Šé¢æˆ‘è®²è§£äº† `Topic` å’Œé˜Ÿåˆ—çš„å…³ç³»â€”â€”ä¸€ä¸ª `Topic` ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ª `Topic` å’Œé˜Ÿåˆ—å­˜æ”¾åœ¨å“ªå‘¢ï¼Ÿ

  **ä¸€ä¸ª `Topic` åˆ†å¸ƒåœ¨å¤šä¸ª `Broker`ä¸Šï¼Œä¸€ä¸ª `Broker` å¯ä»¥é…ç½®å¤šä¸ª `Topic` ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»**ã€‚

  å¦‚æœæŸä¸ª `Topic` æ¶ˆæ¯é‡å¾ˆå¤§ï¼Œåº”è¯¥ç»™å®ƒå¤šé…ç½®å‡ ä¸ªé˜Ÿåˆ—(ä¸Šæ–‡ä¸­æåˆ°äº†æé«˜å¹¶å‘èƒ½åŠ›)ï¼Œå¹¶ä¸” **å°½é‡å¤šåˆ†å¸ƒåœ¨ä¸åŒ `Broker` ä¸Šï¼Œä»¥å‡è½»æŸä¸ª `Broker` çš„å‹åŠ›** ã€‚

  `Topic` æ¶ˆæ¯é‡éƒ½æ¯”è¾ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ª `broker` ä¸Šçš„é˜Ÿåˆ—è¶Šå¤šï¼Œåˆ™è¯¥ `broker` å‹åŠ›è¶Šå¤§ã€‚

  ![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef38687488a5a4.jpg)

  > æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦é…ç½®å¤šä¸ª Brokerã€‚

- `NameServer`ï¼šä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰æ¥è§¦è¿‡ `ZooKeeper` å’Œ `Spring Cloud` ä¸­çš„ `Eureka` ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ª **æ³¨å†Œä¸­å¿ƒ** ï¼Œä¸»è¦æä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š**Broker ç®¡ç†** å’Œ **è·¯ç”±ä¿¡æ¯ç®¡ç†** ã€‚è¯´ç™½äº†å°±æ˜¯ `Broker` ä¼šå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° `NameServer` ä¸­ï¼Œæ­¤æ—¶ `NameServer` å°±å­˜æ”¾äº†å¾ˆå¤š `Broker` çš„ä¿¡æ¯(Broker çš„è·¯ç”±è¡¨)ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å°±ä» `NameServer` ä¸­è·å–è·¯ç”±è¡¨ç„¶åç…§ç€è·¯ç”±è¡¨çš„ä¿¡æ¯å’Œå¯¹åº”çš„ `Broker` è¿›è¡Œé€šä¿¡(ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å®šæœŸä¼šå‘ `NameServer` å»æŸ¥è¯¢ç›¸å…³çš„ `Broker` çš„ä¿¡æ¯)ã€‚

- `Producer`ï¼šæ¶ˆæ¯å‘å¸ƒçš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚è¯´ç™½äº†å°±æ˜¯ç”Ÿäº§è€…ã€‚

- `Consumer`ï¼šæ¶ˆæ¯æ¶ˆè´¹çš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥ push æ¨ï¼Œpull æ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆè´¹è€…ã€‚

å¬å®Œäº†ä¸Šé¢çš„è§£é‡Šä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™ç©æ„å¥½ç®€å•ã€‚ä¸å°±æ˜¯è¿™æ ·çš„ä¹ˆï¼Ÿ

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef386c6d1e8bdb.jpg)

å—¯ï¼Ÿä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™è€å®¶ä¼™ `NameServer` å¹²å•¥ç”¨çš„ï¼Œè¿™ä¸å¤šä½™å—ï¼Ÿç›´æ¥ `Producer`ã€`Consumer` å’Œ `Broker` ç›´æ¥è¿›è¡Œç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ¶ˆæ¯ä¸å°±å¥½äº†ä¹ˆï¼Ÿ

ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸Šæ–‡æåˆ°è¿‡ `Broker` æ˜¯éœ€è¦ä¿è¯é«˜å¯ç”¨çš„ï¼Œå¦‚æœæ•´ä¸ªç³»ç»Ÿä»…ä»…é ç€ä¸€ä¸ª `Broker` æ¥ç»´æŒçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª `Broker` çš„å‹åŠ›ä¼šä¸ä¼šå¾ˆå¤§ï¼Ÿæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤šä¸ª `Broker` æ¥ä¿è¯ **è´Ÿè½½å‡è¡¡** ã€‚

å¦‚æœè¯´ï¼Œæˆ‘ä»¬çš„æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç›´æ¥å’Œå¤šä¸ª `Broker` ç›¸è¿ï¼Œé‚£ä¹ˆå½“ `Broker` ä¿®æ”¹çš„æ—¶å€™å¿…å®šä¼šç‰µè¿ç€æ¯ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿè€¦åˆé—®é¢˜ï¼Œè€Œ `NameServer` æ³¨å†Œä¸­å¿ƒå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

> å¦‚æœè¿˜ä¸æ˜¯å¾ˆç†è§£çš„è¯ï¼Œå¯ä»¥å»çœ‹æˆ‘ä»‹ç» `Spring Cloud` çš„é‚£ç¯‡æ–‡ç« ï¼Œå…¶ä¸­ä»‹ç»äº† `Eureka` æ³¨å†Œä¸­å¿ƒã€‚

å½“ç„¶ï¼Œ`RocketMQ` ä¸­çš„æŠ€æœ¯æ¶æ„è‚¯å®šä¸æ­¢å‰é¢é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºä¸Šé¢å›¾ä¸­çš„å››ä¸ªè§’è‰²éƒ½æ˜¯éœ€è¦åšé›†ç¾¤çš„ã€‚æˆ‘ç»™å‡ºä¸€å¼ å®˜ç½‘çš„æ¶æ„å›¾ï¼Œå¤§å®¶å°è¯•ç†è§£ä¸€ä¸‹ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef386fa3be1e53.jpg)

å…¶å®å’Œæˆ‘ä»¬æœ€å¼€å§‹ç”»çš„é‚£å¼ ä¹ä¸ç‰ˆçš„æ¶æ„å›¾ä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¸»è¦æ˜¯ä¸€äº›ç»†èŠ‚ä¸Šçš„å·®åˆ«ã€‚å¬æˆ‘ç»†ç»†é“æ¥ ğŸ¤¨ã€‚

ç¬¬ä¸€ã€æˆ‘ä»¬çš„ `Broker` **åšäº†é›†ç¾¤å¹¶ä¸”è¿˜è¿›è¡Œäº†ä¸»ä»éƒ¨ç½²** ï¼Œç”±äºæ¶ˆæ¯åˆ†å¸ƒåœ¨å„ä¸ª `Broker` ä¸Šï¼Œä¸€æ—¦æŸä¸ª `Broker` å®•æœºï¼Œåˆ™è¯¥`Broker` ä¸Šçš„æ¶ˆæ¯è¯»å†™éƒ½ä¼šå—åˆ°å½±å“ã€‚æ‰€ä»¥ `Rocketmq` æä¾›äº† `master/slave` çš„ç»“æ„ï¼Œ`salve` å®šæ—¶ä» `master` åŒæ­¥æ•°æ®(åŒæ­¥åˆ·ç›˜æˆ–è€…å¼‚æ­¥åˆ·ç›˜)ï¼Œå¦‚æœ `master` å®•æœºï¼Œ**åˆ™ `slave` æä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ¶ˆæ¯** (åé¢æˆ‘è¿˜ä¼šæåˆ°å“¦)ã€‚

ç¬¬äºŒã€ä¸ºäº†ä¿è¯ `HA` ï¼Œæˆ‘ä»¬çš„ `NameServer` ä¹Ÿåšäº†é›†ç¾¤éƒ¨ç½²ï¼Œä½†æ˜¯è¯·æ³¨æ„å®ƒæ˜¯ **å»ä¸­å¿ƒåŒ–** çš„ã€‚ä¹Ÿå°±æ„å‘³ç€å®ƒæ²¡æœ‰ä¸»èŠ‚ç‚¹ï¼Œä½ å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹å‡º `NameServer` çš„æ‰€æœ‰èŠ‚ç‚¹æ˜¯æ²¡æœ‰è¿›è¡Œ `Info Replicate` çš„ï¼Œåœ¨ `RocketMQ` ä¸­æ˜¯é€šè¿‡ **å•ä¸ª Broker å’Œæ‰€æœ‰ NameServer ä¿æŒé•¿è¿æ¥** ï¼Œå¹¶ä¸”åœ¨æ¯éš” 30 ç§’ `Broker` ä¼šå‘æ‰€æœ‰ `Nameserver` å‘é€å¿ƒè·³ï¼Œå¿ƒè·³åŒ…å«äº†è‡ªèº«çš„ `Topic` é…ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªæ­¥éª¤å°±å¯¹åº”è¿™ä¸Šé¢çš„ `Routing Info` ã€‚

ç¬¬ä¸‰ã€åœ¨ç”Ÿäº§è€…éœ€è¦å‘ `Broker` å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œ**éœ€è¦å…ˆä» `NameServer` è·å–å…³äº `Broker` çš„è·¯ç”±ä¿¡æ¯**ï¼Œç„¶åé€šè¿‡ **è½®è¯¢** çš„æ–¹æ³•å»å‘æ¯ä¸ªé˜Ÿåˆ—ä¸­ç”Ÿäº§æ•°æ®ä»¥è¾¾åˆ° **è´Ÿè½½å‡è¡¡** çš„æ•ˆæœã€‚

ç¬¬å››ã€æ¶ˆè´¹è€…é€šè¿‡ `NameServer` è·å–æ‰€æœ‰ `Broker` çš„è·¯ç”±ä¿¡æ¯åï¼Œå‘ `Broker` å‘é€ `Pull` è¯·æ±‚æ¥è·å–æ¶ˆæ¯æ•°æ®ã€‚`Consumer` å¯ä»¥ä»¥ä¸¤ç§æ¨¡å¼å¯åŠ¨â€”â€” **å¹¿æ’­ï¼ˆBroadcastï¼‰å’Œé›†ç¾¤ï¼ˆClusterï¼‰**ã€‚å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œä¸€æ¡æ¶ˆæ¯ä¼šå‘é€ç»™ **åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„æ‰€æœ‰æ¶ˆè´¹è€…** ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹æ¶ˆæ¯åªä¼šå‘é€ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚

## RocketMQ åŠŸèƒ½ç‰¹æ€§

### æ¶ˆæ¯

#### æ™®é€šæ¶ˆæ¯

æ™®é€šæ¶ˆæ¯ä¸€èˆ¬åº”ç”¨äºå¾®æœåŠ¡è§£è€¦ã€äº‹ä»¶é©±åŠ¨ã€æ•°æ®é›†æˆç­‰åœºæ™¯ï¼Œè¿™äº›åœºæ™¯å¤§å¤šæ•°è¦æ±‚æ•°æ®ä¼ è¾“é€šé“å…·æœ‰å¯é ä¼ è¾“çš„èƒ½åŠ›ï¼Œä¸”å¯¹æ¶ˆæ¯çš„å¤„ç†æ—¶æœºã€å¤„ç†é¡ºåºæ²¡æœ‰ç‰¹åˆ«è¦æ±‚ã€‚ä»¥åœ¨çº¿çš„ç”µå•†äº¤æ˜“åœºæ™¯ä¸ºä¾‹ï¼Œä¸Šæ¸¸è®¢å•ç³»ç»Ÿå°†ç”¨æˆ·ä¸‹å•æ”¯ä»˜è¿™ä¸€ä¸šåŠ¡äº‹ä»¶å°è£…æˆç‹¬ç«‹çš„æ™®é€šæ¶ˆæ¯å¹¶å‘é€è‡³ RocketMQ æœåŠ¡ç«¯ï¼Œä¸‹æ¸¸æŒ‰éœ€ä»æœåŠ¡ç«¯è®¢é˜…æ¶ˆæ¯å¹¶æŒ‰ç…§æœ¬åœ°æ¶ˆè´¹é€»è¾‘å¤„ç†ä¸‹æ¸¸ä»»åŠ¡ã€‚æ¯ä¸ªæ¶ˆæ¯ä¹‹é—´éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸”ä¸éœ€è¦äº§ç”Ÿå…³è”ã€‚å¦å¤–è¿˜æœ‰æ—¥å¿—ç³»ç»Ÿï¼Œä»¥ç¦»çº¿çš„æ—¥å¿—æ”¶é›†åœºæ™¯ä¸ºä¾‹ï¼Œé€šè¿‡åŸ‹ç‚¹ç»„ä»¶æ”¶é›†å‰ç«¯åº”ç”¨çš„ç›¸å…³æ“ä½œæ—¥å¿—ï¼Œå¹¶è½¬å‘åˆ° RocketMQ ã€‚

![](https://rocketmq.apache.org/zh/assets/images/lifecyclefornormal-e8a2a7e42a0722f681eb129b51e1bd66.png)

**æ™®é€šæ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ**

- åˆå§‹åŒ–ï¼šæ¶ˆæ¯è¢«ç”Ÿäº§è€…æ„å»ºå¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¾…å‘é€åˆ°æœåŠ¡ç«¯çš„çŠ¶æ€ã€‚
- å¾…æ¶ˆè´¹ï¼šæ¶ˆæ¯è¢«å‘é€åˆ°æœåŠ¡ç«¯ï¼Œå¯¹æ¶ˆè´¹è€…å¯è§ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹çš„çŠ¶æ€ã€‚
- æ¶ˆè´¹ä¸­ï¼šæ¶ˆæ¯è¢«æ¶ˆè´¹è€…è·å–ï¼Œå¹¶æŒ‰ç…§æ¶ˆè´¹è€…æœ¬åœ°çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†çš„è¿‡ç¨‹ã€‚ æ­¤æ—¶æœåŠ¡ç«¯ä¼šç­‰å¾…æ¶ˆè´¹è€…å®Œæˆæ¶ˆè´¹å¹¶æäº¤æ¶ˆè´¹ç»“æœï¼Œå¦‚æœä¸€å®šæ—¶é—´åæ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„å“åº”ï¼ŒRocketMQ ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œé‡è¯•å¤„ç†ã€‚
- æ¶ˆè´¹æäº¤ï¼šæ¶ˆè´¹è€…å®Œæˆæ¶ˆè´¹å¤„ç†ï¼Œå¹¶å‘æœåŠ¡ç«¯æäº¤æ¶ˆè´¹ç»“æœï¼ŒæœåŠ¡ç«¯æ ‡è®°å½“å‰æ¶ˆæ¯å·²ç»è¢«å¤„ç†ï¼ˆåŒ…æ‹¬æ¶ˆè´¹æˆåŠŸå’Œå¤±è´¥ï¼‰ã€‚RocketMQ é»˜è®¤æ”¯æŒä¿ç•™æ‰€æœ‰æ¶ˆæ¯ï¼Œæ­¤æ—¶æ¶ˆæ¯æ•°æ®å¹¶ä¸ä¼šç«‹å³è¢«åˆ é™¤ï¼Œåªæ˜¯é€»è¾‘æ ‡è®°å·²æ¶ˆè´¹ã€‚æ¶ˆæ¯åœ¨ä¿å­˜æ—¶é—´åˆ°æœŸæˆ–å­˜å‚¨ç©ºé—´ä¸è¶³è¢«åˆ é™¤å‰ï¼Œæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥å›æº¯æ¶ˆæ¯é‡æ–°æ¶ˆè´¹ã€‚
- æ¶ˆæ¯åˆ é™¤ï¼šRocketMQ æŒ‰ç…§æ¶ˆæ¯ä¿å­˜æœºåˆ¶æ»šåŠ¨æ¸…ç†æœ€æ—©çš„æ¶ˆæ¯æ•°æ®ï¼Œå°†æ¶ˆæ¯ä»ç‰©ç†æ–‡ä»¶ä¸­åˆ é™¤ã€‚

#### å®šæ—¶æ¶ˆæ¯

åœ¨åˆ†å¸ƒå¼å®šæ—¶è°ƒåº¦è§¦å‘ã€ä»»åŠ¡è¶…æ—¶å¤„ç†ç­‰åœºæ™¯ï¼Œéœ€è¦å®ç°ç²¾å‡†ã€å¯é çš„å®šæ—¶äº‹ä»¶è§¦å‘ã€‚ä½¿ç”¨ RocketMQ çš„å®šæ—¶æ¶ˆæ¯å¯ä»¥ç®€åŒ–å®šæ—¶è°ƒåº¦ä»»åŠ¡çš„å¼€å‘é€»è¾‘ï¼Œå®ç°é«˜æ€§èƒ½ã€å¯æ‰©å±•ã€é«˜å¯é çš„å®šæ—¶è§¦å‘èƒ½åŠ›ã€‚å®šæ—¶æ¶ˆæ¯ä»…æ”¯æŒåœ¨ MessageType ä¸º Delay çš„ä¸»é¢˜å†…ä½¿ç”¨ï¼Œå³å®šæ—¶æ¶ˆæ¯åªèƒ½å‘é€è‡³ç±»å‹ä¸ºå®šæ—¶æ¶ˆæ¯çš„ä¸»é¢˜ä¸­ï¼Œå‘é€çš„æ¶ˆæ¯çš„ç±»å‹å¿…é¡»å’Œä¸»é¢˜çš„ç±»å‹ä¸€è‡´ã€‚åœ¨ 4.x ç‰ˆæœ¬ä¸­ï¼Œåªæ”¯æŒå»¶æ—¶æ¶ˆæ¯ï¼Œé»˜è®¤åˆ†ä¸º 18 ä¸ªç­‰çº§åˆ†åˆ«ä¸ºï¼š1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ è‡ªå®šä¹‰çš„å»¶æ—¶ç­‰çº§å’Œæ—¶é•¿ã€‚åœ¨ 5.x ç‰ˆæœ¬ä¸­ï¼Œå¼€å§‹æ”¯æŒå®šæ—¶æ¶ˆæ¯ï¼Œåœ¨æ„é€ æ¶ˆæ¯æ—¶æä¾›äº† 3 ä¸ª API æ¥æŒ‡å®šå»¶è¿Ÿæ—¶é—´æˆ–å®šæ—¶æ—¶é—´ã€‚

åŸºäºå®šæ—¶æ¶ˆæ¯çš„è¶…æ—¶ä»»åŠ¡å¤„ç†å…·å¤‡å¦‚ä¸‹ä¼˜åŠ¿ï¼š

- **ç²¾åº¦é«˜ã€å¼€å‘é—¨æ§›ä½**ï¼šåŸºäºæ¶ˆæ¯é€šçŸ¥æ–¹å¼ä¸å­˜åœ¨å®šæ—¶é˜¶æ¢¯é—´éš”ã€‚å¯ä»¥è½»æ¾å®ç°ä»»æ„ç²¾åº¦äº‹ä»¶è§¦å‘ï¼Œæ— éœ€ä¸šåŠ¡å»é‡ã€‚
- **é«˜æ€§èƒ½å¯æ‰©å±•**ï¼šä¼ ç»Ÿçš„æ•°æ®åº“æ‰«ææ–¹å¼è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦é¢‘ç¹è°ƒç”¨æ¥å£æ‰«æï¼Œå®¹æ˜“äº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚RocketMQ çš„å®šæ—¶æ¶ˆæ¯å…·æœ‰é«˜å¹¶å‘å’Œæ°´å¹³æ‰©å±•çš„èƒ½åŠ›ã€‚

![](https://rocketmq.apache.org/zh/assets/images/lifecyclefordelay-2ce8278df69cd026dd11ffd27ab09a17.png)

**å®šæ—¶æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ**

- åˆå§‹åŒ–ï¼šæ¶ˆæ¯è¢«ç”Ÿäº§è€…æ„å»ºå¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¾…å‘é€åˆ°æœåŠ¡ç«¯çš„çŠ¶æ€ã€‚
- å®šæ—¶ä¸­ï¼šæ¶ˆæ¯è¢«å‘é€åˆ°æœåŠ¡ç«¯ï¼Œå’Œæ™®é€šæ¶ˆæ¯ä¸åŒçš„æ˜¯ï¼ŒæœåŠ¡ç«¯ä¸ä¼šç›´æ¥æ„å»ºæ¶ˆæ¯ç´¢å¼•ï¼Œè€Œæ˜¯ä¼šå°†å®šæ—¶æ¶ˆæ¯**å•ç‹¬å­˜å‚¨åœ¨å®šæ—¶å­˜å‚¨ç³»ç»Ÿä¸­**ï¼Œç­‰å¾…å®šæ—¶æ—¶åˆ»åˆ°è¾¾ã€‚
- å¾…æ¶ˆè´¹ï¼šå®šæ—¶æ—¶åˆ»åˆ°è¾¾åï¼ŒæœåŠ¡ç«¯å°†æ¶ˆæ¯é‡æ–°å†™å…¥æ™®é€šå­˜å‚¨å¼•æ“ï¼Œå¯¹ä¸‹æ¸¸æ¶ˆè´¹è€…å¯è§ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹çš„çŠ¶æ€ã€‚
- æ¶ˆè´¹ä¸­ï¼šæ¶ˆæ¯è¢«æ¶ˆè´¹è€…è·å–ï¼Œå¹¶æŒ‰ç…§æ¶ˆè´¹è€…æœ¬åœ°çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†çš„è¿‡ç¨‹ã€‚ æ­¤æ—¶æœåŠ¡ç«¯ä¼šç­‰å¾…æ¶ˆè´¹è€…å®Œæˆæ¶ˆè´¹å¹¶æäº¤æ¶ˆè´¹ç»“æœï¼Œå¦‚æœä¸€å®šæ—¶é—´åæ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„å“åº”ï¼ŒRocketMQ ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œé‡è¯•å¤„ç†ã€‚
- æ¶ˆè´¹æäº¤ï¼šæ¶ˆè´¹è€…å®Œæˆæ¶ˆè´¹å¤„ç†ï¼Œå¹¶å‘æœåŠ¡ç«¯æäº¤æ¶ˆè´¹ç»“æœï¼ŒæœåŠ¡ç«¯æ ‡è®°å½“å‰æ¶ˆæ¯å·²ç»è¢«å¤„ç†ï¼ˆåŒ…æ‹¬æ¶ˆè´¹æˆåŠŸå’Œå¤±è´¥ï¼‰ã€‚RocketMQ é»˜è®¤æ”¯æŒä¿ç•™æ‰€æœ‰æ¶ˆæ¯ï¼Œæ­¤æ—¶æ¶ˆæ¯æ•°æ®å¹¶ä¸ä¼šç«‹å³è¢«åˆ é™¤ï¼Œåªæ˜¯é€»è¾‘æ ‡è®°å·²æ¶ˆè´¹ã€‚æ¶ˆæ¯åœ¨ä¿å­˜æ—¶é—´åˆ°æœŸæˆ–å­˜å‚¨ç©ºé—´ä¸è¶³è¢«åˆ é™¤å‰ï¼Œæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥å›æº¯æ¶ˆæ¯é‡æ–°æ¶ˆè´¹ã€‚
- æ¶ˆæ¯åˆ é™¤ï¼šApache RocketMQ æŒ‰ç…§æ¶ˆæ¯ä¿å­˜æœºåˆ¶æ»šåŠ¨æ¸…ç†æœ€æ—©çš„æ¶ˆæ¯æ•°æ®ï¼Œå°†æ¶ˆæ¯ä»ç‰©ç†æ–‡ä»¶ä¸­åˆ é™¤ã€‚

å®šæ—¶æ¶ˆæ¯çš„å®ç°é€»è¾‘éœ€è¦å…ˆç»è¿‡å®šæ—¶å­˜å‚¨ç­‰å¾…è§¦å‘ï¼Œå®šæ—¶æ—¶é—´åˆ°è¾¾åæ‰ä¼šè¢«æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚å› æ­¤ï¼Œå¦‚æœå°†å¤§é‡å®šæ—¶æ¶ˆæ¯çš„å®šæ—¶æ—¶é—´è®¾ç½®ä¸ºåŒä¸€æ—¶åˆ»ï¼Œåˆ™åˆ°è¾¾è¯¥æ—¶åˆ»åä¼šæœ‰å¤§é‡æ¶ˆæ¯åŒæ—¶éœ€è¦è¢«å¤„ç†ï¼Œä¼šé€ æˆç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ†å‘å»¶è¿Ÿï¼Œå½±å“å®šæ—¶ç²¾åº¦ã€‚

#### é¡ºåºæ¶ˆæ¯

é¡ºåºæ¶ˆæ¯ä»…æ”¯æŒä½¿ç”¨ MessageType ä¸º FIFO çš„ä¸»é¢˜ï¼Œå³é¡ºåºæ¶ˆæ¯åªèƒ½å‘é€è‡³ç±»å‹ä¸ºé¡ºåºæ¶ˆæ¯çš„ä¸»é¢˜ä¸­ï¼Œå‘é€çš„æ¶ˆæ¯çš„ç±»å‹å¿…é¡»å’Œä¸»é¢˜çš„ç±»å‹ä¸€è‡´ã€‚å’Œæ™®é€šæ¶ˆæ¯å‘é€ç›¸æ¯”ï¼Œé¡ºåºæ¶ˆæ¯å‘é€å¿…é¡»è¦è®¾ç½®æ¶ˆæ¯ç»„ã€‚ï¼ˆæ¨èå®ç° MessageQueueSelector çš„æ–¹å¼ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚è¦ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§éœ€è¦å•ä¸€ç”Ÿäº§è€…ä¸²è¡Œå‘é€ã€‚

å•çº¿ç¨‹ä½¿ç”¨ MessageListenerConcurrently å¯ä»¥é¡ºåºæ¶ˆè´¹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ MessageListenerOrderly æ‰èƒ½é¡ºåºæ¶ˆè´¹ã€‚

#### äº‹åŠ¡æ¶ˆæ¯

äº‹åŠ¡æ¶ˆæ¯æ˜¯ Apache RocketMQ æä¾›çš„ä¸€ç§é«˜çº§æ¶ˆæ¯ç±»å‹ï¼Œæ”¯æŒåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ä¿éšœæ¶ˆæ¯ç”Ÿäº§å’Œæœ¬åœ°äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ç®€å•æ¥è®²ï¼Œå°±æ˜¯å°†æœ¬åœ°äº‹åŠ¡ï¼ˆæ•°æ®åº“çš„ DML æ“ä½œï¼‰ä¸å‘é€æ¶ˆæ¯åˆå¹¶åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚ä¾‹å¦‚ï¼Œæ–°å¢ä¸€ä¸ªè®¢å•ã€‚åœ¨äº‹åŠ¡æœªæäº¤ä¹‹å‰ï¼Œä¸å‘é€è®¢é˜…çš„æ¶ˆæ¯ã€‚å‘é€æ¶ˆæ¯çš„åŠ¨ä½œéšç€äº‹åŠ¡çš„æˆåŠŸæäº¤è€Œå‘é€ï¼Œéšç€äº‹åŠ¡çš„å›æ»šè€Œå–æ¶ˆã€‚å½“ç„¶çœŸæ­£åœ°å¤„ç†è¿‡ç¨‹ä¸æ­¢è¿™ä¹ˆç®€å•ï¼ŒåŒ…å«äº†åŠæ¶ˆæ¯ã€äº‹åŠ¡ç›‘å¬å’Œäº‹åŠ¡å›æŸ¥ç­‰æ¦‚å¿µï¼Œä¸‹é¢æœ‰æ›´è¯¦ç»†çš„è¯´æ˜ã€‚

## å…³äºå‘é€æ¶ˆæ¯

### **ä¸å»ºè®®å•ä¸€è¿›ç¨‹åˆ›å»ºå¤§é‡ç”Ÿäº§è€…**

Apache RocketMQ çš„ç”Ÿäº§è€…å’Œä¸»é¢˜æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œæ”¯æŒåŒä¸€ä¸ªç”Ÿäº§è€…å‘å¤šä¸ªä¸»é¢˜å‘é€æ¶ˆæ¯ã€‚å¯¹äºç”Ÿäº§è€…çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå»ºè®®éµå¾ªå¤Ÿç”¨å³å¯ã€æœ€å¤§åŒ–å¤ç”¨åŸåˆ™ï¼Œå¦‚æœæœ‰éœ€è¦å‘é€æ¶ˆæ¯åˆ°å¤šä¸ªä¸»é¢˜çš„åœºæ™¯ï¼Œæ— éœ€ä¸ºæ¯ä¸ªä¸»é¢˜éƒ½åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ã€‚

### **ä¸å»ºè®®é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ç”Ÿäº§è€…**

Apache RocketMQ çš„ç”Ÿäº§è€…æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„åº•å±‚èµ„æºï¼Œç±»ä¼¼æ•°æ®åº“çš„è¿æ¥æ± ã€‚å› æ­¤ä¸éœ€è¦åœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶åŠ¨æ€åˆ›å»ºç”Ÿäº§è€…ï¼Œä¸”åœ¨å‘é€ç»“æŸåé”€æ¯ç”Ÿäº§è€…ã€‚è¿™æ ·é¢‘ç¹çš„åˆ›å»ºé”€æ¯ä¼šåœ¨æœåŠ¡ç«¯äº§ç”Ÿå¤§é‡çŸ­è¿æ¥è¯·æ±‚ï¼Œä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

æ­£ç¡®ç¤ºä¾‹ï¼š

```java
Producer p = ProducerBuilder.build();
for (int i =0;i<n;i++){
    Message m= MessageBuilder.build();
    p.send(m);
 }
p.shutdown();
```

## æ¶ˆè´¹è€…åˆ†ç±»

### PushConsumer

é«˜åº¦å°è£…çš„æ¶ˆè´¹è€…ç±»å‹ï¼Œæ¶ˆè´¹æ¶ˆæ¯ä»…ä»…é€šè¿‡æ¶ˆè´¹ç›‘å¬å™¨ç›‘å¬å¹¶è¿”å›ç»“æœã€‚æ¶ˆæ¯çš„è·å–ã€æ¶ˆè´¹çŠ¶æ€æäº¤ä»¥åŠæ¶ˆè´¹é‡è¯•éƒ½é€šè¿‡ RocketMQ çš„å®¢æˆ·ç«¯ SDK å®Œæˆã€‚

PushConsumer çš„æ¶ˆè´¹ç›‘å¬å™¨æ‰§è¡Œç»“æœåˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

- è¿”å›æ¶ˆè´¹æˆåŠŸï¼šä»¥ Java SDK ä¸ºä¾‹ï¼Œè¿”å›`ConsumeResult.SUCCESS`ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯å¤„ç†æˆåŠŸï¼ŒæœåŠ¡ç«¯æŒ‰ç…§æ¶ˆè´¹ç»“æœæ›´æ–°æ¶ˆè´¹è¿›åº¦ã€‚
- è¿”å›æ¶ˆè´¹å¤±è´¥ï¼šä»¥ Java SDK ä¸ºä¾‹ï¼Œè¿”å›`ConsumeResult.FAILURE`ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œéœ€è¦æ ¹æ®æ¶ˆè´¹é‡è¯•é€»è¾‘åˆ¤æ–­æ˜¯å¦è¿›è¡Œé‡è¯•æ¶ˆè´¹ã€‚
- å‡ºç°éé¢„æœŸå¤±è´¥ï¼šä¾‹å¦‚æŠ›å¼‚å¸¸ç­‰è¡Œä¸ºï¼Œè¯¥ç»“æœæŒ‰ç…§æ¶ˆè´¹å¤±è´¥å¤„ç†ï¼Œéœ€è¦æ ¹æ®æ¶ˆè´¹é‡è¯•é€»è¾‘åˆ¤æ–­æ˜¯å¦è¿›è¡Œé‡è¯•æ¶ˆè´¹ã€‚

å…·ä½“å®ç°å¯ä»¥å‚è§è¿™ç¯‡æ–‡ç« [RocketMQ å¯¹ pull å’Œ push çš„å®ç°](http://devedmc.com/archives/1691854198138)ã€‚

ä½¿ç”¨ PushConsumer æ¶ˆè´¹è€…æ¶ˆè´¹æ—¶ï¼Œä¸å…è®¸ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¤„ç†æ¶ˆæ¯ï¼Œå¦åˆ™ RocketMQ æ— æ³•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ã€‚

- é”™è¯¯æ–¹å¼ä¸€ï¼šæ¶ˆæ¯è¿˜æœªå¤„ç†å®Œæˆï¼Œå°±æå‰è¿”å›æ¶ˆè´¹æˆåŠŸç»“æœã€‚æ­¤æ—¶å¦‚æœæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼ŒRocketMQ æœåŠ¡ç«¯æ˜¯æ— æ³•æ„ŸçŸ¥çš„ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œæ¶ˆè´¹é‡è¯•ã€‚
- é”™è¯¯æ–¹å¼äºŒï¼šåœ¨æ¶ˆè´¹ç›‘å¬å™¨å†…å°†æ¶ˆæ¯å†æ¬¡åˆ†å‘åˆ°è‡ªå®šä¹‰çš„å…¶ä»–çº¿ç¨‹ï¼Œæ¶ˆè´¹ç›‘å¬å™¨æå‰è¿”å›æ¶ˆè´¹ç»“æœã€‚æ­¤æ—¶å¦‚æœæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼ŒRocketMQ æœåŠ¡ç«¯åŒæ ·æ— æ³•æ„ŸçŸ¥ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè¿›è¡Œæ¶ˆè´¹é‡è¯•ã€‚
- PushConsumer ä¸¥æ ¼é™åˆ¶äº†æ¶ˆæ¯åŒæ­¥å¤„ç†åŠæ¯æ¡æ¶ˆæ¯çš„å¤„ç†è¶…æ—¶æ—¶é—´ï¼Œé€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
  - æ¶ˆæ¯å¤„ç†æ—¶é—´å¯é¢„ä¼°ï¼šå¦‚æœä¸ç¡®å®šæ¶ˆæ¯å¤„ç†è€—æ—¶ï¼Œç»å¸¸æœ‰é¢„æœŸä¹‹å¤–çš„é•¿æ—¶é—´è€—æ—¶çš„æ¶ˆæ¯ï¼ŒPushConsumer çš„å¯é æ€§ä¿è¯ä¼šé¢‘ç¹è§¦å‘æ¶ˆæ¯é‡è¯•æœºåˆ¶é€ æˆå¤§é‡é‡å¤æ¶ˆæ¯ã€‚
  - æ— å¼‚æ­¥åŒ–ã€é«˜çº§å®šåˆ¶åœºæ™¯ï¼šPushConsumer é™åˆ¶äº†æ¶ˆè´¹é€»è¾‘çš„çº¿ç¨‹æ¨¡å‹ï¼Œç”±å®¢æˆ·ç«¯ SDK å†…éƒ¨æŒ‰æœ€å¤§ååé‡è§¦å‘æ¶ˆæ¯å¤„ç†ã€‚è¯¥æ¨¡å‹å¼€å‘é€»è¾‘ç®€å•ï¼Œä½†æ˜¯ä¸å…è®¸ä½¿ç”¨å¼‚æ­¥åŒ–å’Œè‡ªå®šä¹‰å¤„ç†æµç¨‹ã€‚

### SimpleConsumer

SimpleConsumer æ˜¯ä¸€ç§æ¥å£åŸå­å‹çš„æ¶ˆè´¹è€…ç±»å‹ï¼Œæ¶ˆæ¯çš„è·å–ã€æ¶ˆè´¹çŠ¶æ€æäº¤ä»¥åŠæ¶ˆè´¹é‡è¯•éƒ½æ˜¯é€šè¿‡æ¶ˆè´¹è€…ä¸šåŠ¡é€»è¾‘ä¸»åŠ¨å‘èµ·è°ƒç”¨å®Œæˆã€‚

ä¸€ä¸ªæ¥è‡ªå®˜ç½‘çš„ä¾‹å­ï¼š

```java
// æ¶ˆè´¹ç¤ºä¾‹ï¼šä½¿ç”¨ SimpleConsumer æ¶ˆè´¹æ™®é€šæ¶ˆæ¯ï¼Œä¸»åŠ¨è·å–æ¶ˆæ¯å¤„ç†å¹¶æäº¤ã€‚
ClientServiceProvider provider = ClientServiceProvider.loadService();
String topic = "YourTopic";
FilterExpression filterExpression = new FilterExpression("YourFilterTag", FilterExpressionType.TAG);
SimpleConsumer simpleConsumer = provider.newSimpleConsumerBuilder()
        // è®¾ç½®æ¶ˆè´¹è€…åˆ†ç»„ã€‚
        .setConsumerGroup("YourConsumerGroup")
        // è®¾ç½®æ¥å…¥ç‚¹ã€‚
        .setClientConfiguration(ClientConfiguration.newBuilder().setEndpoints("YourEndpoint").build())
        // è®¾ç½®é¢„ç»‘å®šçš„è®¢é˜…å…³ç³»ã€‚
        .setSubscriptionExpressions(Collections.singletonMap(topic, filterExpression))
        // è®¾ç½®ä»æœåŠ¡ç«¯æ¥å—æ¶ˆæ¯çš„æœ€å¤§ç­‰å¾…æ—¶é—´
        .setAwaitDuration(Duration.ofSeconds(1))
        .build();
try {
    // SimpleConsumer éœ€è¦ä¸»åŠ¨è·å–æ¶ˆæ¯ï¼Œå¹¶å¤„ç†ã€‚
    List<MessageView> messageViewList = simpleConsumer.receive(10, Duration.ofSeconds(30));
    messageViewList.forEach(messageView -> {
        System.out.println(messageView);
        // æ¶ˆè´¹å¤„ç†å®Œæˆåï¼Œéœ€è¦ä¸»åŠ¨è°ƒç”¨ ACK æäº¤æ¶ˆè´¹ç»“æœã€‚
        try {
            simpleConsumer.ack(messageView);
        } catch (ClientException e) {
            logger.error("Failed to ack message, messageId={}", messageView.getMessageId(), e);
        }
    });
} catch (ClientException e) {
    // å¦‚æœé‡åˆ°ç³»ç»Ÿæµæ§ç­‰åŸå› é€ æˆæ‹‰å–å¤±è´¥ï¼Œéœ€è¦é‡æ–°å‘èµ·è·å–æ¶ˆæ¯è¯·æ±‚ã€‚
    logger.error("Failed to receive message", e);
}
```

SimpleConsumer é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- æ¶ˆæ¯å¤„ç†æ—¶é•¿ä¸å¯æ§ï¼šå¦‚æœæ¶ˆæ¯å¤„ç†æ—¶é•¿æ— æ³•é¢„ä¼°ï¼Œç»å¸¸æœ‰é•¿æ—¶é—´è€—æ—¶çš„æ¶ˆæ¯å¤„ç†æƒ…å†µã€‚å»ºè®®ä½¿ç”¨ SimpleConsumer æ¶ˆè´¹ç±»å‹ï¼Œå¯ä»¥åœ¨æ¶ˆè´¹æ—¶è‡ªå®šä¹‰æ¶ˆæ¯çš„é¢„ä¼°å¤„ç†æ—¶é•¿ï¼Œè‹¥å®é™…ä¸šåŠ¡ä¸­é¢„ä¼°çš„æ¶ˆæ¯å¤„ç†æ—¶é•¿ä¸ç¬¦åˆé¢„æœŸï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¥å£æå‰ä¿®æ”¹ã€‚
- éœ€è¦å¼‚æ­¥åŒ–ã€æ‰¹é‡æ¶ˆè´¹ç­‰é«˜çº§å®šåˆ¶åœºæ™¯ï¼šSimpleConsumer åœ¨ SDK å†…éƒ¨æ²¡æœ‰å¤æ‚çš„çº¿ç¨‹å°è£…ï¼Œå®Œå…¨ç”±ä¸šåŠ¡é€»è¾‘è‡ªç”±å®šåˆ¶ï¼Œå¯ä»¥å®ç°å¼‚æ­¥åˆ†å‘ã€æ‰¹é‡æ¶ˆè´¹ç­‰é«˜çº§å®šåˆ¶åœºæ™¯ã€‚
- éœ€è¦è‡ªå®šä¹‰æ¶ˆè´¹é€Ÿç‡ï¼šSimpleConsumer æ˜¯ç”±ä¸šåŠ¡é€»è¾‘ä¸»åŠ¨è°ƒç”¨æ¥å£è·å–æ¶ˆæ¯ï¼Œå› æ­¤å¯ä»¥è‡ªç”±è°ƒæ•´è·å–æ¶ˆæ¯çš„é¢‘ç‡ï¼Œè‡ªå®šä¹‰æ§åˆ¶æ¶ˆè´¹é€Ÿç‡ã€‚

### PullConsumer

æ–½å·¥ä¸­ã€‚ã€‚ã€‚

## æ¶ˆè´¹è€…åˆ†ç»„å’Œç”Ÿäº§è€…åˆ†ç»„

### ç”Ÿäº§è€…åˆ†ç»„

RocketMQ æœåŠ¡ç«¯ 5.x ç‰ˆæœ¬å¼€å§‹ï¼Œ**ç”Ÿäº§è€…æ˜¯åŒ¿åçš„**ï¼Œæ— éœ€ç®¡ç†ç”Ÿäº§è€…åˆ†ç»„ï¼ˆProducerGroupï¼‰ï¼›å¯¹äºå†å²ç‰ˆæœ¬æœåŠ¡ç«¯ 3.x å’Œ 4.x ç‰ˆæœ¬ï¼Œå·²ç»ä½¿ç”¨çš„ç”Ÿäº§è€…åˆ†ç»„å¯ä»¥åºŸå¼ƒæ— éœ€å†è®¾ç½®ï¼Œä¸”ä¸ä¼šå¯¹å½“å‰ä¸šåŠ¡äº§ç”Ÿå½±å“ã€‚

### æ¶ˆè´¹è€…åˆ†ç»„

æ¶ˆè´¹è€…åˆ†ç»„æ˜¯å¤šä¸ªæ¶ˆè´¹è¡Œä¸ºä¸€è‡´çš„æ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡åˆ†ç»„ã€‚æ¶ˆè´¹è€…åˆ†ç»„ä¸æ˜¯å…·ä½“å®ä½“è€Œæ˜¯ä¸€ä¸ªé€»è¾‘èµ„æºã€‚é€šè¿‡æ¶ˆè´¹è€…åˆ†ç»„å®ç°æ¶ˆè´¹æ€§èƒ½çš„æ°´å¹³æ‰©å±•ä»¥åŠé«˜å¯ç”¨å®¹ç¾ã€‚

æ¶ˆè´¹è€…åˆ†ç»„ä¸­çš„è®¢é˜…å…³ç³»ã€æŠ•é€’é¡ºåºæ€§ã€æ¶ˆè´¹é‡è¯•ç­–ç•¥æ˜¯ä¸€è‡´çš„ã€‚

- è®¢é˜…å…³ç³»ï¼šApache RocketMQ ä»¥æ¶ˆè´¹è€…åˆ†ç»„çš„ç²’åº¦ç®¡ç†è®¢é˜…å…³ç³»ï¼Œå®ç°è®¢é˜…å…³ç³»çš„ç®¡ç†å’Œè¿½æº¯ã€‚
- æŠ•é€’é¡ºåºæ€§ï¼šApache RocketMQ çš„æœåŠ¡ç«¯å°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…æ¶ˆè´¹æ—¶ï¼Œæ”¯æŒé¡ºåºæŠ•é€’å’Œå¹¶å‘æŠ•é€’ï¼ŒæŠ•é€’æ–¹å¼åœ¨æ¶ˆè´¹è€…åˆ†ç»„ä¸­ç»Ÿä¸€é…ç½®ã€‚
- æ¶ˆè´¹é‡è¯•ç­–ç•¥ï¼š æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥æ—¶çš„é‡è¯•ç­–ç•¥ï¼ŒåŒ…æ‹¬é‡è¯•æ¬¡æ•°ã€æ­»ä¿¡é˜Ÿåˆ—è®¾ç½®ç­‰ã€‚

RocketMQ æœåŠ¡ç«¯ 5.x ç‰ˆæœ¬ï¼šä¸Šè¿°æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¡Œä¸ºä»å…³è”çš„æ¶ˆè´¹è€…åˆ†ç»„ä¸­ç»Ÿä¸€è·å–ï¼Œå› æ­¤ï¼ŒåŒä¸€åˆ†ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¡Œä¸ºå¿…ç„¶æ˜¯ä¸€è‡´çš„ï¼Œå®¢æˆ·ç«¯æ— éœ€å…³æ³¨ã€‚

RocketMQ æœåŠ¡ç«¯ 3.x/4.x å†å²ç‰ˆæœ¬ï¼šä¸Šè¿°æ¶ˆè´¹é€»è¾‘ç”±æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ¥å£å®šä¹‰ï¼Œå› æ­¤ï¼Œæ‚¨éœ€è¦è‡ªå·±åœ¨æ¶ˆè´¹è€…å®¢æˆ·ç«¯è®¾ç½®æ—¶ä¿è¯åŒä¸€åˆ†ç»„ä¸‹çš„æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¡Œä¸ºä¸€è‡´ã€‚(æ¥è‡ªå®˜æ–¹ç½‘ç«™)

## å¦‚ä½•è§£å†³é¡ºåºæ¶ˆè´¹å’Œé‡å¤æ¶ˆè´¹ï¼Ÿ

å…¶å®ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯æˆ‘åœ¨ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„ä¸€äº›å‰¯ä½œç”¨çš„æ—¶å€™æåˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›é—®é¢˜ä¸ä»…ä»…æŒ‚é’©äº `RocketMQ` ï¼Œè€Œæ˜¯åº”è¯¥æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶éƒ½éœ€è¦å»è§£å†³çš„ã€‚

åœ¨ä¸Šé¢æˆ‘ä»‹ç» `RocketMQ` çš„æŠ€æœ¯æ¶æ„çš„æ—¶å€™æˆ‘å·²ç»å‘ä½ å±•ç¤ºäº† **å®ƒæ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„** ï¼Œè¿™é‡Œä¸æ¶‰åŠè¿ç»´æ–¹é¢çš„æ­å»ºï¼Œå¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»å®˜ç½‘ä¸Šç…§ç€ä¾‹å­æ­å»ºå±äºä½ è‡ªå·±çš„ `RocketMQ` é›†ç¾¤ã€‚

> å…¶å® `Kafka` çš„æ¶æ„åŸºæœ¬å’Œ `RocketMQ` ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ³¨å†Œä¸­å¿ƒä½¿ç”¨äº† `Zookeeper`ã€å®ƒçš„ **åˆ†åŒº** å°±ç›¸å½“äº `RocketMQ` ä¸­çš„ **é˜Ÿåˆ—** ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ä¸åŒä¼šåœ¨åé¢æåˆ°ã€‚

### é¡ºåºæ¶ˆè´¹

åœ¨ä¸Šé¢çš„æŠ€æœ¯æ¶æ„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† **`RocketMQ` åœ¨ä¸»é¢˜ä¸Šæ˜¯æ— åºçš„ã€å®ƒåªæœ‰åœ¨é˜Ÿåˆ—å±‚é¢æ‰æ˜¯ä¿è¯æœ‰åº** çš„ã€‚

è¿™åˆæ‰¯åˆ°ä¸¤ä¸ªæ¦‚å¿µâ€”â€”**æ™®é€šé¡ºåº** å’Œ **ä¸¥æ ¼é¡ºåº** ã€‚

æ‰€è°“æ™®é€šé¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…é€šè¿‡ **åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„** ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚æ™®é€šé¡ºåºæ¶ˆæ¯åœ¨ `Broker` **é‡å¯æƒ…å†µä¸‹ä¸ä¼šä¿è¯æ¶ˆæ¯é¡ºåºæ€§** (çŸ­æš‚æ—¶é—´) ã€‚

æ‰€è°“ä¸¥æ ¼é¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…æ”¶åˆ°çš„ **æ‰€æœ‰æ¶ˆæ¯** å‡æ˜¯æœ‰é¡ºåºçš„ã€‚ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ **å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§** ã€‚

ä½†æ˜¯ï¼Œä¸¥æ ¼é¡ºåºçœ‹èµ·æ¥è™½å¥½ï¼Œå®ç°å®ƒå¯ä¼šä»˜å‡ºå·¨å¤§çš„ä»£ä»·ã€‚å¦‚æœä½ ä½¿ç”¨ä¸¥æ ¼é¡ºåºæ¨¡å¼ï¼Œ`Broker` é›†ç¾¤ä¸­åªè¦æœ‰ä¸€å°æœºå™¨ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¸å¯ç”¨ã€‚ä½ è¿˜ç”¨å•¥ï¼Ÿç°åœ¨ä¸»è¦åœºæ™¯ä¹Ÿå°±åœ¨ `binlog` åŒæ­¥ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬çš„ `MQ` éƒ½æ˜¯èƒ½å®¹å¿çŸ­æš‚çš„ä¹±åºï¼Œæ‰€ä»¥æ¨èä½¿ç”¨æ™®é€šé¡ºåºæ¨¡å¼ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨äº† **æ™®é€šé¡ºåºæ¨¡å¼** ï¼Œæˆ‘ä»¬ä»ä¸Šé¢å­¦ä¹ çŸ¥é“äº†åœ¨ `Producer` ç”Ÿäº§æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›è¡Œè½®è¯¢(å–å†³ä½ çš„è´Ÿè½½å‡è¡¡ç­–ç•¥)æ¥å‘åŒä¸€ä¸»é¢˜çš„ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶æˆ‘æœ‰å‡ ä¸ªæ¶ˆæ¯åˆ†åˆ«æ˜¯åŒä¸€ä¸ªè®¢å•çš„åˆ›å»ºã€æ”¯ä»˜ã€å‘è´§ï¼Œåœ¨è½®è¯¢çš„ç­–ç•¥ä¸‹è¿™ **ä¸‰ä¸ªæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°ä¸åŒé˜Ÿåˆ—** ï¼Œå› ä¸ºåœ¨ä¸åŒçš„é˜Ÿåˆ—æ­¤æ—¶å°±æ— æ³•ä½¿ç”¨ `RocketMQ` å¸¦æ¥çš„é˜Ÿåˆ—æœ‰åºç‰¹æ€§æ¥ä¿è¯æ¶ˆæ¯æœ‰åºæ€§äº†ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3874585e096e.jpg)

é‚£ä¹ˆï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†çš„ä»…ä»…æ˜¯å°†åŒä¸€è¯­ä¹‰ä¸‹çš„æ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªé˜Ÿåˆ—(æ¯”å¦‚è¿™é‡Œæ˜¯åŒä¸€ä¸ªè®¢å•)ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ **Hash å–æ¨¡æ³•** æ¥ä¿è¯åŒä¸€ä¸ªè®¢å•åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­å°±è¡Œäº†ã€‚

RocketMQ å®ç°äº†ä¸¤ç§é˜Ÿåˆ—é€‰æ‹©ç®—æ³•ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°

- è½®è¯¢ç®—æ³•

  - è½®è¯¢ç®—æ³•å°±æ˜¯å‘æ¶ˆæ¯æŒ‡å®šçš„ topic æ‰€åœ¨é˜Ÿåˆ—ä¸­ä¾æ¬¡å‘é€æ¶ˆæ¯ï¼Œä¿è¯æ¶ˆæ¯å‡åŒ€åˆ†å¸ƒ
  - æ˜¯ RocketMQ é»˜è®¤é˜Ÿåˆ—é€‰æ‹©ç®—æ³•

- æœ€å°æŠ•é€’å»¶è¿Ÿç®—æ³•

  - æ¯æ¬¡æ¶ˆæ¯æŠ•é€’çš„æ—¶å€™ç»Ÿè®¡æ¶ˆæ¯æŠ•é€’çš„å»¶è¿Ÿï¼Œé€‰æ‹©é˜Ÿåˆ—æ—¶ä¼˜å…ˆé€‰æ‹©æ¶ˆæ¯å»¶æ—¶å°çš„é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ†å¸ƒä¸å‡åŒ€,æŒ‰ç…§å¦‚ä¸‹è®¾ç½®å³å¯ã€‚

  - ```java
    producer.setSendLatencyFaultEnable(true);
    ```

- ç»§æ‰¿ MessageQueueSelector å®ç°

  - ```java
    SendResult sendResult = producer.send(msg, new MessageQueueSelector() {
        @Override
        public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
            //ä»mqsä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—,å¯ä»¥æ ¹æ®msgç‰¹ç‚¹é€‰æ‹©
            return null;
        }
    }, new Object());
    ```

### ç‰¹æ®Šæƒ…å†µå¤„ç†

#### å‘é€å¼‚å¸¸

é€‰æ‹©é˜Ÿåˆ—åä¼šä¸ Broker å»ºç«‹è¿æ¥ï¼Œé€šè¿‡ç½‘ç»œè¯·æ±‚å°†æ¶ˆæ¯å‘é€åˆ° Broker ä¸Šï¼Œå¦‚æœ Broker æŒ‚äº†æˆ–è€…ç½‘ç»œæ³¢åŠ¨å‘é€æ¶ˆæ¯è¶…æ—¶æ­¤æ—¶ RocketMQ ä¼šè¿›è¡Œé‡è¯•ã€‚

é‡æ–°é€‰æ‹©å…¶ä»– Broker ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå‘é€ï¼Œé»˜è®¤é‡è¯•ä¸¤æ¬¡ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ã€‚

```java
producer.setRetryTimesWhenSendFailed(5);
```

#### æ¶ˆæ¯è¿‡å¤§

æ¶ˆæ¯è¶…è¿‡ 4k æ—¶ RocketMQ ä¼šå°†æ¶ˆæ¯å‹ç¼©ååœ¨å‘é€åˆ° Broker ä¸Šï¼Œå‡å°‘ç½‘ç»œèµ„æºçš„å ç”¨ã€‚

### é‡å¤æ¶ˆè´¹

emmmï¼Œå°±ä¸¤ä¸ªå­—â€”â€” **å¹‚ç­‰** ã€‚åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ª*å¹‚ç­‰* æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚æ¯”å¦‚è¯´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•çš„å¤„ç†ç§¯åˆ†çš„ç³»ç»Ÿï¼Œæ¯å½“æ¥ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™å®ƒå°±è´Ÿè´£ä¸ºåˆ›å»ºè¿™ä¸ªè®¢å•çš„ç”¨æˆ·çš„ç§¯åˆ†åŠ ä¸Šç›¸åº”çš„æ•°å€¼ã€‚å¯æ˜¯æœ‰ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™è®¢å•ç³»ç»Ÿ FrancisQ çš„è®¢å•ä¿¡æ¯ï¼Œå…¶è¦æ±‚æ˜¯ç»™ FrancisQ çš„ç§¯åˆ†åŠ ä¸Š 500ã€‚ä½†æ˜¯ç§¯åˆ†ç³»ç»Ÿåœ¨æ”¶åˆ° FrancisQ çš„è®¢å•ä¿¡æ¯å¤„ç†å®Œæˆä¹‹åè¿”å›ç»™æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æˆåŠŸçš„ä¿¡æ¯çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨(å½“ç„¶è¿˜æœ‰å¾ˆå¤šç§æƒ…å†µï¼Œæ¯”å¦‚ Broker æ„å¤–é‡å¯ç­‰ç­‰)ï¼Œè¿™æ¡å›åº”æ²¡æœ‰å‘é€æˆåŠŸã€‚

é‚£ä¹ˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ²¡æ”¶åˆ°ç§¯åˆ†ç³»ç»Ÿçš„å›åº”ä¼šä¸ä¼šå°è¯•é‡å‘è¿™ä¸ªæ¶ˆæ¯ï¼Ÿé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘å†å‘è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸‡ä¸€å®ƒåˆç»™ FrancisQ çš„è´¦æˆ·åŠ ä¸Š 500 ç§¯åˆ†æ€ä¹ˆåŠå‘¢ï¼Ÿ

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™æˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç° **å¹‚ç­‰** ï¼Œä¹Ÿå°±æ˜¯å¯¹åŒä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ç»“æœï¼Œæ‰§è¡Œå¤šå°‘æ¬¡éƒ½ä¸å˜ã€‚

é‚£ä¹ˆå¦‚ä½•ç»™ä¸šåŠ¡å®ç°å¹‚ç­‰å‘¢ï¼Ÿè¿™ä¸ªè¿˜æ˜¯éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨ **å†™å…¥ `Redis`** æ¥ä¿è¯ï¼Œå› ä¸º `Redis` çš„ `key` å’Œ `value` å°±æ˜¯å¤©ç„¶æ”¯æŒå¹‚ç­‰çš„ã€‚å½“ç„¶è¿˜æœ‰ä½¿ç”¨ **æ•°æ®åº“æ’å…¥æ³•** ï¼ŒåŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šè¢«æ’å…¥å¤šæ¡ã€‚

ä¸è¿‡æœ€ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ **æ ¹æ®ç‰¹å®šåœºæ™¯ä½¿ç”¨ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ** ï¼Œä½ è¦çŸ¥é“ä½ çš„æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¦æ˜¯å®Œå…¨ä¸å¯é‡å¤æ¶ˆè´¹è¿˜æ˜¯å¯ä»¥å¿å—é‡å¤æ¶ˆè´¹çš„ï¼Œç„¶åå†é€‰æ‹©å¼ºæ ¡éªŒå’Œå¼±æ ¡éªŒçš„æ–¹å¼ã€‚æ¯•ç«Ÿåœ¨ CS é¢†åŸŸè¿˜æ˜¯å¾ˆå°‘æœ‰æŠ€æœ¯é“¶å¼¹çš„è¯´æ³•ã€‚

è€Œåœ¨æ•´ä¸ªäº’è”ç½‘é¢†åŸŸï¼Œå¹‚ç­‰ä¸ä»…ä»…é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—çš„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œè¿™äº›å®ç°å¹‚ç­‰çš„æ–¹æ³•ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºï¼Œ**åœ¨å…¶ä»–åœºæ™¯ä¸­æ¥è§£å†³é‡å¤è¯·æ±‚æˆ–è€…é‡å¤è°ƒç”¨çš„é—®é¢˜** ã€‚æ¯”å¦‚å°† HTTP æœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œ**è§£å†³å‰ç«¯æˆ–è€… APP é‡å¤æäº¤è¡¨å•æ•°æ®çš„é—®é¢˜** ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ªå¾®æœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œè§£å†³ `RPC` æ¡†æ¶è‡ªåŠ¨é‡è¯•å¯¼è‡´çš„ **é‡å¤è°ƒç”¨é—®é¢˜** ã€‚

## RocketMQ å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

å¦‚ä½•è§£é‡Šåˆ†å¸ƒå¼äº‹åŠ¡å‘¢ï¼Ÿäº‹åŠ¡å¤§å®¶éƒ½çŸ¥é“å§ï¼Ÿ**è¦ä¹ˆéƒ½æ‰§è¡Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ** ã€‚åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°äº‹åŠ¡ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šæœåŠ¡æ˜¯éƒ¨ç½²åœ¨ä¸åŒç³»ç»Ÿä¹‹é—´çš„ï¼Œè€Œä¸åŒæœåŠ¡ä¹‹é—´åˆéœ€è¦è¿›è¡Œè°ƒç”¨ã€‚æ¯”å¦‚æ­¤æ—¶æˆ‘ä¸‹è®¢å•ç„¶åå¢åŠ ç§¯åˆ†ï¼Œå¦‚æœä¿è¯ä¸äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„è¯ï¼Œå°±ä¼šå‡ºç° A ç³»ç»Ÿä¸‹äº†è®¢å•ï¼Œä½†æ˜¯ B ç³»ç»Ÿå¢åŠ ç§¯åˆ†å¤±è´¥æˆ–è€… A ç³»ç»Ÿæ²¡æœ‰ä¸‹è®¢å•ï¼ŒB ç³»ç»Ÿå´å¢åŠ äº†ç§¯åˆ†ã€‚å‰è€…å¯¹ç”¨æˆ·ä¸å‹å¥½ï¼Œåè€…å¯¹è¿è¥å•†ä¸åˆ©ï¼Œè¿™æ˜¯æˆ‘ä»¬éƒ½ä¸æ„¿æ„è§åˆ°çš„ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•å»è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

Today's more common distributed transaction implementations include 2PC, TCC and transaction messages (half message mechanism). Each implementation has its own specific usage scenarios, but also has its own problems, and neither is a perfect solution.

In `RocketMQ`, **transaction messages plus transaction reverse check mechanism** are used to solve distributed transaction problems. I drew a picture, you can refer to the picture to understand.

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef38798d7a987f.png)

The half message sent in the first step means that this message is invisible to the consumer before the transaction is committed.

> So, how to write a message but not visible to the user? RocketMQ transaction message method is: if the message is a half message, the topic of the original message and the message consumption queue will be backed up, and then **change the topic** to RMQ_SYS_TRANS_HALF_TOPIC. Since the consumer group has not subscribed to the topic, the consumer cannot consume half type messages. ** Then RocketMQ will start a scheduled task to pull messages from the Topic RMQ_SYS_TRANS_HALF_TOPIC for consumption. ** According to the producer group, a service provider is obtained to send a review transaction status request, and based on the transaction status, it is decided whether to submit or rollback the message.

You can imagine that if there is no **transaction anti-checking mechanism** starting from step 5, if there is network fluctuation and step 4 is not sent successfully, this will cause the problem of MQ not knowing whether it needs to be consumed by the consumer. It will be like a headless fly. In `RocketMQ`, the above-mentioned transaction reverse check is used to solve the problem, while in `Kafka`, an exception is usually thrown directly and the user can solve it by himself.

You also need to note that the operation of `MQ Server` pointing to system B is no longer related to system A. That is to say, the distributed transaction in the message queue is - **local transaction and storing messages to the message queue are the same transaction**. This also produces the **eventual consistency** of the transaction, because the entire process is asynchronous, and **each system only needs to guarantee its own part of the transaction**.

Problems encountered in practice: Transaction messages require a transaction listener to monitor whether the local transaction is successful, and the transaction listener interface is only allowed to be implemented once. That means that the local transactions of various transaction messages need to be written in an interface method, which will inevitably produce a lot of coupling and type judgment. Use the Function interface to wrap the entire business process and pass it as a parameter to the interface method of the listener. Then call the apply() method of Function to execute the business, and the transaction will also be executed in the apply() method. Decoupling the listener from the business makes it feasible in a real production environment.

1. Simulate a need to add user browsing records

```java
@PostMapping("/add")
@ApiOperation("Add user browsing history")
public Result<TransactionSendResult> add(Long userId, Long forecastLogId) {

        // Functional programming: Browse records and store them in the database
        Function<String, Boolean> function = transactionId -> viewHistoryHandler.addViewHistory(transactionId, userId, forecastLogId);

        Map<String, Long> hashMap = new HashMap<>();
        hashMap.put("userId", userId);
        hashMap.put("forecastLogId", forecastLogId);
        String jsonString = JSON.toJSONString(hashMap);

        //Send transaction messages; use the Function interface to receive local transaction operations and pass them into the method as a parameter
        TransactionSendResult transactionSendResult = mqProducerService.sendTransactionMessage(jsonString, MQDestination.TAG_ADD_VIEW_HISTORY, function);
        return Result.success(transactionSendResult);
}
```

2. Method of sending transaction messages

```java
/**
 * Send transaction message
 *
 * @param msgBody
 * @param tag
 * @param function
 * @return
 */
public TransactionSendResult sendTransactionMessage(String msgBody, String tag, Function<String, Boolean> function) {
    //Construct the message body
    Message<String> message = buildMessage(msgBody);

    //Construct message delivery information
    String destination = buildDestination(tag);

    TransactionSendResult result = rocketMQTemplate.sendMessageInTransaction(destination, message, function);
    return result;
}
```

3. Producer message listener, only one class is allowed to implement the listener

```java
@Slf4j
@RocketMQTransactionListener
public class TransactionMsgListener implements RocketMQLocalTransactionListener {

    @Autowired
    private RedisService redisService;

    /**
     * Execute local transaction (executed when sending message successfully)
     *
     * @param message
     * @param o
     * @return commit or rollback or unknown
     */
    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) {

        // 1. Get transaction ID
        String transactionId = null;
        try {
            transactionId = message.getHeaders().get("rocketmq_TRANSACTION_ID").toString();
            // 2. Determine whether the incoming function object is empty. If it is empty, it means there is no business to be executed and the message will be discarded directly.
            if (o == null) {
                //Messages returning ROLLBACK status will be discarded
                log.info("Transaction message rolled back, no business needs to be processed transactionId={}", transactionId);
                return RocketMQLocalTransactionState.ROLLBACK;
            }
            // Convert Object o into Function object
            Function<String, Boolean> function = (Function<String, Boolean>) o;
            //Execute business transactions will also be executed in function.apply
            Boolean apply = function.apply(transactionId);
            if (apply) {
                log.info("Transaction submitted, message processed normally transactionId={}", transactionId);
                //Messages that return COMMIT status will be consumed by consumers immediately
                return RocketMQLocalTransactionState.COMMIT;
            }
        } catch (Exception e) {
            log.info("Exception occurred. Return ROLLBACK transactionId={}", transactionId);
            return RocketMQLocalTransactionState.ROLLBACK;
        }
        return RocketMQLocalTransactionState.ROLLBACK;
    }

    /**
     * Transaction review mechanism to check the status of local transactions
     *
     * @param message
     * @return
     */
    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message message) {

        String transactionId = message.getHeaders().get("rocketmq_TRANSACTION_ID").toString();

        // Check redis
        MqTransaction mqTransaction = redisService.getCacheObject("mqTransaction:" + transactionId);
        if (Objects.isNull(mqTransaction)) {
            return RocketMQLocalTransactionState.ROLLBACK;
        }
        return RocketMQLocalTransactionState.COMMIT;
    }
}```

4. In the simulated business scenario, the methods here must be extracted and placed in other classes. If the caller and the callee are in the same class, transaction failure will occur.

```java
@Component
public class ViewHistoryHandler {

    @Autowired
    private IViewHistoryService viewHistoryService;

    @Autowired
    private IMqTransactionService mqTransactionService;

    @Autowired
    private RedisService redisService;

    /**
     * Browsing records stored in database
     *
     * @param transactionId
     * @param userId
     * @param forecastLogId
     * @return
     */
    @Transactional
    public Boolean addViewHistory(String transactionId, Long userId, Long forecastLogId) {
        // Build browsing history
        ViewHistory viewHistory = new ViewHistory();
        viewHistory.setUserId(userId);
        viewHistory.setForecastLogId(forecastLogId);
        viewHistory.setCreateTime(LocalDateTime.now());
        boolean save = viewHistoryService.save(viewHistory);

        //Local transaction information
        MqTransaction mqTransaction = new MqTransaction();
        mqTransaction.setTransactionId(transactionId);
        mqTransaction.setCreateTime(new Date());
        mqTransaction.setStatus(MqTransaction.StatusEnum.VALID.getStatus());

        // 1. You can store transaction information in the database
        mqTransactionService.save(mqTransaction);

        // 2. You can also choose to save redis, which has a validity period of 4 hours. '4 hours' is RocketMQ's built-in maximum review timeout. If it expires and is not confirmed, it will be forced to roll back.
        redisService.setCacheObject("mqTransaction:" + transactionId, mqTransaction, 4L, TimeUnit.HOURS);

        // Release comments, simulate exceptions, and rollback transactions
        // int i = 10 / 0;

        return save;
    }
}
```

5. Consume messages and idempotent processing

```java
@Service
@RocketMQMessageListener(topic = MQDestination.TOPIC, selectorExpression = MQDestination.TAG_ADD_VIEW_HISTORY, consumerGroup = MQDestination.TAG_ADD_VIEW_HISTORY)
public class ConsumerAddViewHistory implements RocketMQListener<Message> {
    // This method will be executed when the message is heard
    @Override
    public void onMessage(Message message) {
        // Idempotent check
        String transactionId = message.getTransactionId();

        // Check redis
        MqTransaction mqTransaction = redisService.getCacheObject("mqTransaction:" + transactionId);

        // No transaction record exists
        if (Objects.isNull(mqTransaction)) {
            return;
        }

        // Consumed
        if (Objects.equals(mqTransaction.getStatus(), MqTransaction.StatusEnum.CONSUMED.getStatus())) {
            return;
        }

        String msg = new String(message.getBody());
        Map<String, Long> map = JSON.parseObject(msg, new TypeReference<HashMap<String, Long>>() {
        });
        Long userId = map.get("userId");
        Long forecastLogId = map.get("forecastLogId");

        //Downstream business processing
        // TODO record user preferences and update user portraits

        // TODO update the number of views of 'Securities Forecast Article' and recalculate the exposure ranking of the article

        //Update status to consumed
        mqTransaction.setUpdateTime(new Date());
        mqTransaction.setStatus(MqTransaction.StatusEnum.CONSUMED.getStatus());
        redisService.setCacheObject("mqTransaction:" + transactionId, mqTransaction, 4L, TimeUnit.HOURS);
        log.info("Message heard: msg={}", JSON.toJSONString(map));
    }
}
```

## How to solve the message accumulation problem?

Above we mentioned a very important function of the message queue - **peak clipping**. So what if this peak is too large and messages accumulate in the queue?

In fact, this problem can be generalized, because there are actually only two causes of message accumulation - producers produce too fast or consumers consume too slowly.

We can think about solving this problem from multiple angles. When the traffic reaches the peak, it is because the producer is producing too fast. We can use some **current limiting and downgrading** methods. Of course, you can also add multiple consumer instances to horizontally expand and increase consumption capacity to match the surge in production. If the consumer's consumption is too slow, we can first check whether the consumer has a large number of consumption errors, or print the log to see if any thread is stuck, lock resources are not released, etc.

> Of course, the fastest way to solve the problem of message accumulation is to add consumer instances, but **at the same time you also need to increase the number of queues per topic**.
>
> Donâ€™t forget that in `RocketMQ`, **a queue will only be consumed by one consumer**. If you just add consumer instances, you will be in the situation where I drew the architecture diagram for you at the beginning.

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef387d939ab66d.jpg)

## What is retroactive consumption?

Retroactive consumption refers to messages that `Consumer` has successfully consumed and needs to be consumed again due to business needs. In `RocketMQ`, after `Broker` delivers a successful message to `Consumer`, the **message still needs to be retained**. And re-consumption is generally based on the time dimension. For example, due to a `Consumer` system failure, the data from 1 hour ago needs to be re-consumed after recovery. Then `Broker` needs to provide a mechanism to roll back the consumption progress according to the time dimension. `RocketMQ` supports retroactive consumption according to time, and the time dimension is accurate to milliseconds.

This is the explanation from the official document. I just copied it and used it as a popular science ğŸ˜ğŸ˜ğŸ˜.

## How RocketMQ ensures high-performance reading and writing

### Traditional IO method

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/31699457085_.pic.jpg)

Traditional IO reading and writing is actually a read + write operation. The whole process will be divided into the following steps:

- The user calls the read() method and starts reading data. At this time, a context switch occurs from user mode to kernel mode, which is the switch shown in the diagram 1
- Copy disk data to kernel cache through DMA- å°†å†…æ ¸ç¼“å­˜åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œè¿™æ ·ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„ä»£ç å°±èƒ½æ‹¿åˆ°æ–‡ä»¶çš„æ•°æ®
- read()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶å°±ä¼šä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼Œä¹Ÿå°±æ˜¯å›¾ç¤ºçš„åˆ‡æ¢ 2
- å½“æˆ‘ä»¬æ‹¿åˆ°æ•°æ®ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨ write()æ–¹æ³•ï¼Œæ­¤æ—¶ä¸Šä¸‹æ–‡ä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå³å›¾ç¤ºåˆ‡æ¢ 3
- CPU å°†ç”¨æˆ·ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° Socket ç¼“å†²åŒº
- å°† Socket ç¼“å†²åŒºæ•°æ®æ‹·è´è‡³ç½‘å¡
- write()æ–¹æ³•è¿”å›ï¼Œä¸Šä¸‹æ–‡é‡æ–°ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼Œå³å›¾ç¤ºåˆ‡æ¢ 4

æ•´ä¸ªè¿‡ç¨‹å‘ç”Ÿäº† 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œ 4 æ¬¡æ•°æ®çš„æ‹·è´ï¼Œè¿™åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è‚¯å®šä¼šä¸¥é‡å½±å“è¯»å†™æ€§èƒ½æ•…å¼•å…¥äº†é›¶æ‹·è´æŠ€æœ¯

### é›¶æ‹·è´æŠ€æœ¯

#### mmap

mmapï¼ˆmemory mapï¼‰æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚

ç®€å•åœ°è¯´å°±æ˜¯å†…æ ¸ç¼“å†²åŒºå’Œåº”ç”¨ç¼“å†²åŒºå…±äº«ï¼Œä»è€Œå‡å°‘äº†ä»è¯»ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºçš„ä¸€æ¬¡ CPU æ‹·è´ã€‚åŸºäºæ­¤ä¸Šè¿°æ¶æ„å›¾å¯å˜ä¸ºï¼š

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/41699457086_.pic.jpg)

åŸºäº mmap IO è¯»å†™å…¶å®å°±å˜æˆ mmap + write çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯ç”¨ mmap æ›¿ä»£ä¼ ç»Ÿ IO ä¸­çš„ read æ“ä½œã€‚

å½“ç”¨æˆ·å‘èµ· mmap è°ƒç”¨çš„æ—¶å€™ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ 1ï¼Œè¿›è¡Œå†…å­˜æ˜ å°„ï¼Œç„¶åæ•°æ®è¢«æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œmmap è¿”å›ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ 2ï¼›éšåç”¨æˆ·è°ƒç”¨ writeï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ 3ï¼Œå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼Œwrite è¿”å›ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ 4ã€‚

å‘ç”Ÿ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œ 3 æ¬¡ IO æ‹·è´æ“ä½œï¼Œåœ¨ Java ä¸­çš„å®ç°ï¼š

```java
FileChannel fileChannel = new RandomAccessFile("test.txt", "rw").getChannel();
MappedByteBuffer mappedByteBuffer = fileChannel.map(FileChannel.MapMode.READ_WRITE, 0, fileChannel.size());
```

#### sendfile

sendfile()è·Ÿ mmap()ä¸€æ ·ï¼Œä¹Ÿä¼šå‡å°‘ä¸€æ¬¡ CPU æ‹·è´ï¼Œä½†æ˜¯å®ƒåŒæ—¶ä¹Ÿä¼šå‡å°‘ä¸¤æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/51699457087_.pic.jpg)

å¦‚å›¾ï¼Œç”¨æˆ·åœ¨å‘èµ· sendfile()è°ƒç”¨æ—¶ä¼šå‘ç”Ÿåˆ‡æ¢ 1ï¼Œä¹‹åæ•°æ®é€šè¿‡ DMA æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä¹‹åå†å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ® CPU æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼Œæœ€åæ‹·è´åˆ°ç½‘å¡ï¼Œsendfile()è¿”å›ï¼Œå‘ç”Ÿåˆ‡æ¢ 2ã€‚å‘ç”Ÿäº† 3 æ¬¡æ‹·è´å’Œä¸¤æ¬¡åˆ‡æ¢ã€‚Java ä¹Ÿæä¾›äº†ç›¸åº” apiï¼š

```java
FileChannel channel = FileChannel.open(Paths.get("./test.txt"), StandardOpenOption.WRITE, StandardOpenOption.CREATE);
//è°ƒç”¨transferToæ–¹æ³•å‘ç›®æ ‡æ•°æ®ä¼ è¾“
channel.transferTo(position, len, target);
```

åœ¨å¦‚ä¸Šä»£ç ä¸­ï¼Œå¹¶æ²¡æœ‰æ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥å°†æ–‡ä»¶çš„æ•°æ®ä¼ è¾“åˆ° target ç›®æ ‡ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œsendfile æ˜¯æ— æ³•çŸ¥é“æ–‡ä»¶çš„å…·ä½“çš„æ•°æ®çš„ï¼›ä½†æ˜¯ mmap ä¸ä¸€æ ·ï¼Œä»–æ˜¯å¯ä»¥ä¿®æ”¹å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®çš„ã€‚å‡è®¾å¦‚æœéœ€è¦å¯¹æ–‡ä»¶çš„å†…å®¹è¿›è¡Œä¿®æ”¹ä¹‹åå†ä¼ è¾“ï¼Œåªæœ‰ mmap å¯ä»¥æ»¡è¶³ã€‚

é€šè¿‡ä¸Šé¢çš„ä¸€äº›ä»‹ç»ï¼Œç»“è®ºæ˜¯åŸºäºé›¶æ‹·è´æŠ€æœ¯ï¼Œå¯ä»¥å‡å°‘ CPU çš„æ‹·è´æ¬¡æ•°å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œä»è€Œå¯ä»¥å®ç°æ–‡ä»¶é«˜æ•ˆçš„è¯»å†™æ“ä½œã€‚

RocketMQ å†…éƒ¨ä¸»è¦æ˜¯ä½¿ç”¨åŸºäº mmap å®ç°çš„é›¶æ‹·è´(å…¶å®å°±æ˜¯è°ƒç”¨ä¸Šè¿°æåˆ°çš„ api)ï¼Œç”¨æ¥è¯»å†™æ–‡ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ RocketMQ ä¸ºä»€ä¹ˆå¿«çš„ä¸€ä¸ªå¾ˆé‡è¦åŸå› ã€‚

## RocketMQ çš„åˆ·ç›˜æœºåˆ¶

ä¸Šé¢æˆ‘è®²äº†é‚£ä¹ˆå¤šçš„ `RocketMQ` çš„æ¶æ„å’Œè®¾è®¡åŸç†ï¼Œä½ æœ‰æ²¡æœ‰å¥½å¥‡

åœ¨ `Topic` ä¸­çš„ **é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿ**

**é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ**

æˆ‘åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ **åŒæ­¥åˆ·ç›˜** å’Œ **å¼‚æ­¥åˆ·ç›˜** åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒä»¬ä¼šç»™æŒä¹…åŒ–å¸¦æ¥ä»€ä¹ˆæ ·çš„å½±å“å‘¢ï¼Ÿ

ä¸‹é¢æˆ‘å°†ç»™ä½ ä»¬ä¸€ä¸€è§£é‡Šã€‚

### åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef387fba311cda-20230814005009889.jpg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨åŒæ­¥åˆ·ç›˜ä¸­éœ€è¦ç­‰å¾…ä¸€ä¸ªåˆ·ç›˜æˆåŠŸçš„ `ACK` ï¼ŒåŒæ­¥åˆ·ç›˜å¯¹ `MQ` æ¶ˆæ¯å¯é æ€§æ¥è¯´æ˜¯ä¸€ç§ä¸é”™çš„ä¿éšœï¼Œä½†æ˜¯ **æ€§èƒ½ä¸Šä¼šæœ‰è¾ƒå¤§å½±å“** ï¼Œä¸€èˆ¬åœ°é€‚ç”¨äºé‡‘èç­‰ç‰¹å®šä¸šåŠ¡åœºæ™¯ã€‚

è€Œå¼‚æ­¥åˆ·ç›˜å¾€å¾€æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¼‚æ­¥åœ°æ‰§è¡Œåˆ·ç›˜æ“ä½œã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨åå°å¼‚æ­¥çº¿ç¨‹æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œ **é™ä½äº†è¯»å†™å»¶è¿Ÿ** ï¼Œæé«˜äº† `MQ` çš„æ€§èƒ½å’Œååé‡ï¼Œä¸€èˆ¬é€‚ç”¨äºå¦‚å‘éªŒè¯ç ç­‰å¯¹äºæ¶ˆæ¯ä¿è¯è¦æ±‚ä¸å¤ªé«˜çš„ä¸šåŠ¡åœºæ™¯ã€‚

ä¸€èˆ¬åœ°ï¼Œ**å¼‚æ­¥åˆ·ç›˜åªæœ‰åœ¨ `Broker` æ„å¤–å®•æœºçš„æ—¶å€™ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®**ï¼Œä½ å¯ä»¥è®¾ç½® `Broker` çš„å‚æ•° `FlushDiskType` æ¥è°ƒæ•´ä½ çš„åˆ·ç›˜ç­–ç•¥(ASYNC_FLUSH æˆ–è€… SYNC_FLUSH)ã€‚

### åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶

ä¸Šé¢çš„åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜æ˜¯åœ¨å•ä¸ªç»“ç‚¹å±‚é¢çš„ï¼Œè€ŒåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸»è¦æ˜¯æŒ‡çš„ `Borker` ä¸»ä»æ¨¡å¼ä¸‹ï¼Œä¸»èŠ‚ç‚¹è¿”å›æ¶ˆæ¯ç»™å®¢æˆ·ç«¯çš„æ—¶å€™æ˜¯å¦éœ€è¦åŒæ­¥ä»èŠ‚ç‚¹ã€‚

- åŒæ­¥å¤åˆ¶ï¼šä¹Ÿå« â€œåŒæ­¥åŒå†™â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**åªæœ‰æ¶ˆæ¯åŒæ­¥åŒå†™åˆ°ä¸»ä»èŠ‚ç‚¹ä¸Šæ—¶æ‰è¿”å›å†™å…¥æˆåŠŸ** ã€‚
- å¼‚æ­¥å¤åˆ¶ï¼š**æ¶ˆæ¯å†™å…¥ä¸»èŠ‚ç‚¹ä¹‹åå°±ç›´æ¥è¿”å›å†™å…¥æˆåŠŸ** ã€‚

ç„¶è€Œï¼Œå¾ˆå¤šäº‹æƒ…æ˜¯æ²¡æœ‰å®Œç¾çš„æ–¹æ¡ˆçš„ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬è¿›è¡Œæ¶ˆæ¯å†™å…¥çš„èŠ‚ç‚¹è¶Šå¤šå°±æ›´èƒ½ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†æ˜¯éšä¹‹çš„æ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼Œæ‰€ä»¥éœ€è¦ç¨‹åºå‘˜æ ¹æ®ç‰¹å®šä¸šåŠ¡åœºæ™¯å»é€‰æ‹©é€‚åº”çš„ä¸»ä»å¤åˆ¶æ–¹æ¡ˆã€‚

é‚£ä¹ˆï¼Œ**å¼‚æ­¥å¤åˆ¶ä¼šä¸ä¼šä¹Ÿåƒå¼‚æ­¥åˆ·ç›˜é‚£æ ·å½±å“æ¶ˆæ¯çš„å¯é æ€§å‘¢ï¼Ÿ**

ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºä¸¤è€…å°±æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œå¯¹äºæ¶ˆæ¯å¯é æ€§æ˜¯é€šè¿‡ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ä¿è¯çš„ï¼Œè€Œåƒå¼‚æ­¥åŒæ­¥å¤åˆ¶ç­–ç•¥ä»…ä»…æ˜¯å½±å“åˆ°äº† **å¯ç”¨æ€§** ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶ä¸»è¦åŸå› **æ˜¯ `RocketMQ` æ˜¯ä¸æ”¯æŒè‡ªåŠ¨ä¸»ä»åˆ‡æ¢çš„ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç”Ÿäº§è€…å°±ä¸èƒ½å†ç»™è¿™ä¸ªä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†**ã€‚

æ¯”å¦‚è¿™ä¸ªæ—¶å€™é‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œåœ¨ä¸»èŠ‚ç‚¹è¿˜æœªå‘é€å®Œéœ€è¦åŒæ­¥çš„æ¶ˆæ¯çš„æ—¶å€™ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œè¿™ä¸ªæ—¶å€™ä»èŠ‚ç‚¹å°±å°‘äº†ä¸€éƒ¨åˆ†æ¶ˆæ¯ã€‚ä½†æ˜¯æ­¤æ—¶ç”Ÿäº§è€…æ— æ³•å†ç»™ä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†ï¼Œ**æ¶ˆè´¹è€…å¯ä»¥è‡ªåŠ¨åˆ‡æ¢åˆ°ä»èŠ‚ç‚¹è¿›è¡Œæ¶ˆè´¹**(ä»…ä»…æ˜¯æ¶ˆè´¹)ï¼Œæ‰€ä»¥åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰çš„æ—¶é—´åªä¼šäº§ç”Ÿä¸»ä»ç»“ç‚¹çŸ­æš‚çš„æ¶ˆæ¯ä¸ä¸€è‡´çš„æƒ…å†µï¼Œé™ä½äº†å¯ç”¨æ€§ï¼Œè€Œå½“ä¸»èŠ‚ç‚¹é‡å¯ä¹‹åï¼Œä»èŠ‚ç‚¹é‚£éƒ¨åˆ†æœªæ¥å¾—åŠå¤åˆ¶çš„æ¶ˆæ¯è¿˜ä¼šç»§ç»­å¤åˆ¶ã€‚

åœ¨å•ä¸»ä»æ¶æ„ä¸­ï¼Œå¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æ•´ä¸ªç³»ç»Ÿä¸èƒ½å†ç”Ÿäº§äº†ã€‚é‚£ä¹ˆè¿™ä¸ªå¯ç”¨æ€§çš„é—®é¢˜èƒ½å¦è§£å†³å‘¢ï¼Ÿ**ä¸€ä¸ªä¸»ä»ä¸è¡Œé‚£å°±å¤šä¸ªä¸»ä»çš„å‘—**ï¼Œåˆ«å¿˜äº†åœ¨æˆ‘ä»¬æœ€åˆçš„æ¶æ„å›¾ä¸­ï¼Œæ¯ä¸ª `Topic` æ˜¯åˆ†å¸ƒåœ¨ä¸åŒ `Broker` ä¸­çš„ã€‚

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef38687488a5asadasfg4.jpg)

ä½†æ˜¯è¿™ç§å¤åˆ¶æ–¹å¼åŒæ ·ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ— æ³•ä¿è¯ **ä¸¥æ ¼é¡ºåº** ã€‚åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†å¦‚ä½•ä¿è¯çš„æ¶ˆæ¯é¡ºåºæ€§æ˜¯é€šè¿‡å°†ä¸€ä¸ªè¯­ä¹‰çš„æ¶ˆæ¯å‘é€åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä½¿ç”¨ `Topic` ä¸‹çš„é˜Ÿåˆ—æ¥ä¿è¯é¡ºåºæ€§çš„ã€‚å¦‚æœæ­¤æ—¶æˆ‘ä»¬ä¸»èŠ‚ç‚¹ A è´Ÿè´£çš„æ˜¯è®¢å• A çš„ä¸€ç³»åˆ—è¯­ä¹‰æ¶ˆæ¯ï¼Œç„¶åå®ƒæŒ‚äº†ï¼Œè¿™æ ·å…¶ä»–èŠ‚ç‚¹æ˜¯æ— æ³•ä»£æ›¿ä¸»èŠ‚ç‚¹ A çš„ï¼Œå¦‚æœæˆ‘ä»¬ä»»æ„èŠ‚ç‚¹éƒ½å¯ä»¥å­˜å…¥ä»»ä½•æ¶ˆæ¯ï¼Œé‚£å°±æ²¡æœ‰é¡ºåºæ€§å¯è¨€äº†ã€‚

è€Œåœ¨ `RocketMQ` ä¸­é‡‡ç”¨äº† `Dledger` è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»–è¦æ±‚åœ¨å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¦æ±‚**è‡³å°‘æ¶ˆæ¯å¤åˆ¶åˆ°åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹ä¹‹å**ï¼Œæ‰ç»™å®¢â¼¾ç«¯è¿”å›å†™â¼ŠæˆåŠŸï¼Œå¹¶ä¸”å®ƒæ˜¯â½€æŒé€šè¿‡é€‰ä¸¾æ¥åŠ¨æ€åˆ‡æ¢ä¸»èŠ‚ç‚¹çš„ã€‚è¿™é‡Œæˆ‘å°±ä¸å±•å¼€è¯´æ˜äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ã€‚

> ä¹Ÿä¸æ˜¯è¯´ `Dledger` æ˜¯ä¸ªå®Œç¾çš„æ–¹æ¡ˆï¼Œè‡³å°‘åœ¨ `Dledger` é€‰ä¸¾è¿‡ç¨‹ä¸­æ˜¯æ— æ³•æä¾›æœåŠ¡çš„ï¼Œè€Œä¸”ä»–å¿…é¡»è¦ä½¿ç”¨ä¸‰ä¸ªèŠ‚ç‚¹æˆ–ä»¥ä¸Šï¼Œå¦‚æœå¤šæ•°èŠ‚ç‚¹åŒæ—¶æŒ‚æ‰ä»–ä¹Ÿæ˜¯æ— æ³•ä¿è¯å¯ç”¨æ€§çš„ï¼Œè€Œä¸”è¦æ±‚æ¶ˆæ¯å¤åˆ¶åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹çš„æ•ˆç‡å’Œç›´æ¥å¼‚æ­¥å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·çš„ã€‚

### å­˜å‚¨æœºåˆ¶

è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬ä¸€å¼€å§‹çš„ä¸‰ä¸ªé—®é¢˜å—ï¼Ÿåˆ°è¿™é‡Œç¬¬ä¸‰ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ã€‚

ä½†æ˜¯ï¼Œåœ¨ `Topic` ä¸­çš„ **é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ** è¿˜æœªè§£å†³ï¼Œå…¶å®è¿™é‡Œæ¶‰åŠåˆ°äº† `RocketMQ` æ˜¯å¦‚ä½•è®¾è®¡å®ƒçš„å­˜å‚¨ç»“æ„äº†ã€‚æˆ‘é¦–å…ˆæƒ³å¤§å®¶ä»‹ç» `RocketMQ` æ¶ˆæ¯å­˜å‚¨æ¶æ„ä¸­çš„ä¸‰å¤§è§’è‰²â€”â€”`CommitLog`ã€`ConsumeQueue` å’Œ `IndexFile` ã€‚

- `CommitLog`: **The storage body of the message body and metadata**, which stores the message body content written by the `Producer` side. The message content is not fixed-length. The default size of a single file is 1G, the length of the file name is 20 digits, zeros are padded on the left, and the remainder is the starting offset. For example, 00000000000000000000 represents the first file, the starting offset is 0, and the file size is 1G=1073741824; when the first file is full, the second file is 00000000001073741824, the starting offset is 1073741824, and so on. Messages are mainly written to the log file sequentially. When the file is full, the next file is written.
- `ConsumeQueue`: Message consumption queue, **The purpose of introduction is mainly to improve the performance of message consumption** (we have also talked about it before). Since `RocketMQ` is a subscription model based on the topic `Topic`, message consumption is for the topic. If you want to traverse the `commitlog` file to retrieve messages based on `Topic`, it is very inefficient. `Consumer` can find messages to be consumed based on `ConsumeQueue`. Among them, `ConsumeQueue` (logical consumption queue) ** serves as the index of the consumer message** and saves the ** starting physical offset `offset` ** of the queue message under the specified `Topic` in `CommitLog`, the message size `size` and the `HashCode` value of the message `Tag`. **The `consumequeue` file can be regarded as a `commitlog` index file based on `topic`, so the `consumequeue` folder is organized as follows: topic/queue/file three-layer organizational structure, the specific storage path is: $HOME/store/consumequeue/{topic}/{queueId}/{fileName}. Similarly, the `consumequeue` file adopts a fixed-length design. Each entry has a total of 20 bytes, which are 8 bytes of the `commitlog` physical offset, 4 bytes of message length, and 8 bytes of tag `hashcode`. A single file consists of 30W entries, and each entry can be accessed randomly like an array. The size of each `ConsumeQueue` file is about 5.72M;
- `IndexFile`: `IndexFile` (index file) provides a method to query messages by key or time interval. This is just a general introduction without any detailed introduction.

In summary, the most important structures of the entire message storage are `CommitLoq` and `ConsumeQueue`. And `ConsumeQueue` can be roughly understood as the queue in `Topic`.

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef3884c02acc72.png)

`RocketMQ` uses a **hybrid storage structure**, that is, all queues under a single instance of `Broker` share a log data file to store messages. What is interesting is that in `Kafka` which is also highly concurrent, a storage file is allocated for each `Topic`. This is a bit like we have a lot of books that need to be put on the bookshelf. `RocketMQ` directly puts them in batches regardless of the type of books, while `Kafka` puts the books into designated classification areas.

And why does `RocketMQ` do this? The reason is to **improve data writing efficiency**, regardless of `Topic`, which means that we have a greater chance of obtaining **batches** of messages for data writing, but it also brings a trouble that when reading messages, we need to traverse the entire large file, which is very time-consuming.

Therefore, `ConsumeQueue` is used in `RocketMQ` as the index file of each queue to **improve the efficiency of reading messages**. We can directly calculate the global position of the index based on the message sequence number of the queue (index sequence number * index fixed length 20), then directly read this index, and then find the message based on the global position of the message recorded in the index.

At this point, you may still be a little vague about the storage architecture of `RocketMQ`. Itâ€™s okay. Letâ€™s understand it with the help of the diagram.

![](https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/16ef388763c25c62.jpg)

emmm, isnâ€™t it a bit complicated ğŸ¤£, donâ€™t be timid when looking at English pictures and documents, just bite the bullet and read down.

> If you donâ€™t understand the above, you must read the process analysis below carefully!

First of all, the top piece is what I just said. You can now directly understand `ConsumerQueue` as `Queue`**.

On the far left side of the figure, the red square represents the message being written, and the dotted square represents the message waiting to be written. When the producer on the left sends a message, he will specify `Topic`, `QueueId` and the specific message content. In `Broker`, it doesn't matter which message you are, he directly stores the entire order in the CommitLog**. According to the `Topic` and `QueueId` specified by the producer, the offset of the message itself in the `CommitLog`, the size of the message itself, and the hash value of the tag are stored in the corresponding `ConsumeQueue` index file. In each queue, `ConsumeOffset` is saved, which is the consumption position of each consumer group (I mentioned it in the architecture, students who forgot can go back and take a look), and when consumers pull messages for consumption, they only need to obtain the next unconsumed message based on `ConsumeOffset`.

The above is my general understanding of the entire message storage architecture (I will not discuss some details here, such as sparse indexes, etc.). I hope it will be helpful to you.

Because there is a knowledge point that I forgot to mention because I was too busy writing it. Itâ€™s hard to think about where to add it, so Iâ€™ll leave it to everyone to think about ğŸ¤”ğŸ¤”.

Why is the `CommitLog` file designed to have a fixed length? Reminder: **Memory mapping mechanism**.

## Summary

Finally finished writing this blog. Do you remember what I said ğŸ˜…?

In this article, I mainly want to introduce to you

1. Reasons for the emergence of message queues
2. The role of message queue (asynchronous, decoupling, peak clipping)
3. A series of problems caused by message queues (message accumulation, repeated consumption, sequential consumption, distributed transactions, etc.)
4. Two message models of message queue-queue and topic mode
5. Analyzed the technical architecture of `RocketMQ` (`NameServer`, `Broker`, `Producer`, `Consumer`)
6. Combined with `RocketMQ` to answer the solution to the side effects of message queue
7. Introduced the storage mechanism and disk flushing strategy of `RocketMQ`.

etc. . .

<!-- @include: @article-footer.snippet.md -->